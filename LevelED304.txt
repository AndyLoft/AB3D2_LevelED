'----------------------------------------------------------------------------' 
'                                                                            ' 
'             AlienBreed 3DII - Editor, revised edition V3.04                ' 
'                  Originaly written by: Andy Clitheroe                      '   
'                    Rewritten by: Jens Vang Petersen                        ' 
'                   Additional work by: Abu_the_monkey                       ' 
'             Contact me:                  Jens Vang Petersen                ' 
'                                       top_cat@post8.tele.dk                ' 
'                                                                            ' 
'----------------------------------------------------------------------------' 
' Memory banks reserved: 
'  001     : P. Sprites..  
'  015     : W. Workbank.. 
'  016     : P. Interface Resource.. 
'  020     : P. GUI data.. 
'  401->499: P. Various work-banks..   
'  500->514: P. Permanent datatypes..
'  599     : P. Pic-files for gadgets..
'  700->720: W. Keep-graphics-data-banks.. 
'  800     : W. Music for Trackplayer  
'----------------------------------------------------------------------------' 
   Set Buffer 650
   Amos To Back 
   VER$="AlienBreed 3DII LevelEd V3.04"
   VDA$="10-08-2023"
   Flush Libs 
   _amos Name "AB3DII_LevelED"
   '
   '
   '
Global MXP,MZ,MCP,TEAM,MOBJ,DEFNCOL,CANVASWIDTH,CANVASHEIGHT,_TXT_BOX_W,STNZ,_EDITMODE,CURLEV$
MXP=800 : MZ=256 : MCP=99 : MOBJ=200 : STNZ=0 : _EDITMODE=0
   '
   '
   '
Dim EMODE$(4),OB$(10),ECHO(MZ),CO(260),I(180),GPAL(16),D_INK(20),W(10,2),LW(10),GAD24(40),GAD16(40),GAD10(50),LOCK(20)
   Dim OPS(20,6),LOPS(20,6),SGAD(120),SPRDATA(20,10)
   Dim TELZO(MZ),TELX(MZ),TELZ(MZ),CPTUL(MCP+1),USED(MZ),WB(MZ,10),UWB(MZ,10)
   Dim BUT$(59),PX(MXP),PY(MXP),ZO(MZ,10),ZP(MZ),WT(MZ,10),ZW(MZ,10,1)
   Dim ZH(MZ,3),ZC(MZ,10),ZB(MZ),UZB(MZ),OBX(MOBJ),OBZ(MOBJ),ZZ(MZ,10)
   Dim UZH(MZ,3),ZPBR(MZ,10,3),ZRG(MZ,2),ZFG(MZ,2),ZWG(MZ,10,3),WD(MZ,10),ZD(MZ),DC(20)
   Dim UZRG(MZ,2),UZFG(MZ,2),UZWG(MZ,10,3)
   Dim VECT$(20),CPTX(MCP+1),CPTY(MCP+1),CPTZ(MCP+1),ZCPT(MZ),UZCPT(MZ)
   Dim RB(MZ),FB(MZ)
   Dim VCPL(MZ),VCPR(MZ),LP(MZ,100),RP(MZ,100),ZU(MZ),PU(MXP)
   Dim PN(MXP),X(4),Y(4),D(MXP,3),SOW(20),PW(MXP),CORD(MZ),LIFTC(20)
   Dim WLI(MZ,10),ZLI(MZ),DMX(30),DMZ(30),DMY(30),PCW(MXP,1)
   Dim SWWL(7,1),SWP(7),KEYGRAPH(3),ZDPT(MZ),ZGPT(MZ),SGO(7)
   Dim DWPT(MZ,10),ZLIPT(20),ZDOPT(20),DRT(20),DLT(20),LRT(20),LLT(20)
   Dim WATH(20),WABH(20),ZWA(MZ),WASP(20),WAPT(MZ)
   Dim DR$(10),DL$(10),LR$(10),LL$(10),BSFX(MZ)
   Dim LSP(20)
   Dim LEVELTEXT$(15),SWT(10),BWT(10),IACE$(15)
   Dim SAM$(61),BSFXNAME(15)
   Dim LABEL$(100),M_REM2(20)
   '
   '
   '
Global EMODE$(),OB$(),ECHO(),CO(),I(),SGAD(),D_INK(),GPAL(),LW(),GAD24(),SAM$(),GAD16(),GAD10(),LOCK()
   Global OPS(),LOPS(),SPRDATA()
   Global TELZO(),TELX(),TELZ(),CPTUL(),USED(),WB(),UWB()
   Global BUT$(),PX(),PY(),ZO(),ZP(),WT(),ZW(),ZH(),ZC(),ZB(),UZB(),OBX(),OBZ(),ZZ()
   Global UZH(),ZPBR(),ZRG(),ZFG(),ZWG(),WD(),ZD(),DC(),UZRG(),UZFG(),UZWG()
   Global CPTX(),CPTY(),CPTZ(),ZCPT(),UZCPT(),RB(),FB()
   Global VCPL(),VCPR(),LP(),RP(),ZU(),PU()
   Global PN(),X(),Y(),D(),SOW(),PW(),CORD(),LIFTC()
   Global WLI(),ZLI()
   Global DMX(),DMZ(),DMY(),PCW(),SWWL(),SWP(),KEYGRAPH()
   Global ZDPT(),ZGPT(),SGO(),DWPT(),ZLIPT(),ZDOPT(),DRT(),DLT(),LRT(),LLT()
   Global WATH(),WABH(),ZWA(),WASP(),WAPT(),DR$(),DL$(),IACE$()
   Global LR$(),LL$(),BSFX(),SWT(),BWT(),LSP()
   Global LEVELTEXT$(),M_REM2()
   Global A$,ALTO,BSFX,CCP,CMODE,CONTP,COBJ,CP,CZ,CZ2,D1,DLOCKED,DWALL
   Global EBX,EZONE,FB,FL,FLH,FR,F_IDCMP
   Global LG,LLOCKED,LS,LWCHUNK,LWGW
   Global MP,MPX,MU,MZ,M
   Global NCPT,NDO,NL,NO,NP,NZ,NWA
   Global OBTO,OFB,OP,OPO,OT,OZFG,OZFGS,OZRG,OZRGS
   Global P1,P2,PAN,PANF,PBR,PBRF,PDTA,PDTAF,PERMCALC,PLX,PLY,PLZ,PLX2,PLY2,PLZ2,PZ
   Global RB,RBO,RECPT,RFH
   Global SC,STQ,STRTANIM,SWN,SCR_MODE
   Global TEAM,TL,TR,TW,TXT,UPORLO
   Global VT,VSUM,WAH,WGH,WGW
   Global X,XL,XM,XO,XRES,XC
   Global Y,YM,YO,YC,YRES
   Global ZC,ZE,ZFG,ZFGS,ZGW,ZIP,ZRG,ZRGS,ZWG,ZWGC,ZWGL,KSH
   Global DIAL1,DIAL2,SHMODE,STMODE,GRIDSET,VER$,VDA$
   Global AUTOSTAIR1,AUTOSTAIR1B,AUTOSTAIR2,AUTOSTAIR3,LINK,PALC
   Global GLINK,GCLIP,GCHECK,GFILE$,PRE1,MPTR,LRO,LGU
   Global O_POINT,O_CPT,CPACK$,P_PRG$
   ' NEVER make these global
   'WX,WY,X1,X2,X3,X4,Y1,Y2,Y3,Y4 
   '
   '  Open Locale 
   '
   GFILE$="LevelED_303.guide"
   If Exist(Dir$+"catalogs") : Exec "Assign Locale: "+Dir$+" add" : End If 
   If Exist(Dir$+"c") : Exec "Assign C: "+Dir$+"C/ add" : End If 
   Open Catalog "AB3DII-Edit.catalog","english"
   Trap Screen Close 0
   _CHECK_TOOLS
   F_IDCMP=$8+$10+$20+$40+$100+$200+$400+$200000
   '
   ' Check assign 
   '
   If Not Exist("Ab3:") : Exec "Assign Ab3: "+Dir$ : End If 
   If Not Exist("Tkg1:") : Exec "Assign Tkg1: Ab3:" : End If 
   If Not Exist("Tkg2:") : Exec "Assign Tkg2: Ab3:" : End If 
   If Not Exist("SFX:") : Exec "Assign SFX: Ab3:" : End If 
   _INIT_PROGRAM
   DIAL1=True : DIAL2=0
   P1=-1 : P2=-2
   _REDRAW
   OP=38 : _INITDEF
   Amos To Back 
   _DO_MAIN
   _END_PROGRAM
End 

Procedure _DO_MAIN
   MSHOW=1 : _wnd Id Activate 9
   Do 
      AC=_wnd Id Next Event
      WN=_wnd Id Event Wnd
      VT=MU*64
      '
      ' Rawkey pressed 
      '
      If AC=$400
         KY=_wnd Id Event Code : KSH=_wnd Id Event Qualifier
         If False
         Else If KSH and %111 : STP=VT*2
         Else If KSH and %110000 : STP=VT*4
         Else If KSH and %1000 : STP=VT*8
         Else : STP=VT
         End If 
         If KY=76 : YO=YO-STP : _REDRAW
         Else If KY=77 : YO=YO+STP : _REDRAW
         Else If KY=78 : XO=XO+STP : _REDRAW
         Else If KY=79 : XO=XO-STP : _REDRAW
         End If 
         If KY=95
            _OPHELP
         End If 
      End If 
      '
      ' VanillaKeys
      '
      
      If Key State(80) : _CYCLEMODEDOWN : Wait 10 : End If 
      If Key State(81) : _CYCLEMODEUP : Wait 10 : End If 

      _CYCLEBUTTON
      
      A$=""
      If AC=$200000
         X=_wnd Id Event X Mouse
         Y=_wnd Id Event Y Mouse*YRES
         XC=X*MU+XO : YC=Y*MU+YO
         A$=Chr$(_wnd Id Event Code)
         _VANILLAKEY
      End If 
      '
      ' Gadget picked
      '
      If AC=$40 or AC=$20
         If WN=1
            _IPICKBUTTON[False]
         Else 
            _IPICKLBUTTON
         End If 
         _wnd Id Activate 0 : MSHOW=0
      End If 
      '
      ' Menu picked
      '
      If AC=$100 : _IMCHECK : _wnd Id Activate 0 : MSHOW=0 : Exit If Param : End If 
      '
      M=0
      _wnd Id Use 0
      If AC=$8
         If WN=0
            M=_wnd Id Event Code
            X=_wnd Id Event X Mouse
            Y=_wnd Id Event Y Mouse*YRES
            XC=X*MU+XO : YC=Y*MU+YO
            If M=232 : M=1
            Else If M=233 : M=2
            Else : M=0
            End If 
            If M
               _MOUSEHIT
            End If 
         End If 
      End If 
      _wnd Id Use 0
      X=_wnd Id X Mouse
      Y=_wnd Id Y Mouse*YRES
      XC=X*MU+XO : YC=Y*MU+YO
      If _scr What Active=_scr Id Base(1)
         WY=_scr Id Y Mouse(1)
         If MSHOW=0 and WY<11
            _wnd Id Activate 9
            MSHOW=1
         Else If MSHOW<>0 and WY>10
            _wnd Id Activate 0
            MSHOW=0
         End If 
      End If 
      If AC=0
         _EVERY
      End If 
      Multi Wait 
   Loop 
End Proc
Procedure _IMCHECK
   M1=_wnd Id Event Menu
   M2=_wnd Id Event Item
   M3=_wnd Id Event Sub

   On M1+1 Gosub MPROJ,MVIEW,MLEVE,MGAME,MTOOL,MMISC
Pop Proc[False]

MPROJ:
   If M2=0 : _IPICKBUTTON[38] : End If 
   If M2=1 : _IPICKBUTTON[6] : _LOAD_LEVEL[""] : End If 
   If M2=2 : _IPICKBUTTON[6] : _SAVE_LEVEL[CURLEV$] : End If 
   '
   If M2=4 : _IPICKBUTTON[6] : _SAVE_LEVEL[""] : End If 
   If M2=5 : _IPICKBUTTON[6] : _CLIP_LEVEL[CURLEV$] : End If 
   If M2=6 : _IPICKBUTTON[6] : _LINK_LEVEL[CURLEV$] : End If 
   If M2=7 : _IPICKBUTTON[6] : _MAKE_LEVEL[CURLEV$,False] : End If 
   If M2=8 : _IPICKBUTTON[6] : _MAKE_LEVEL[CURLEV$,True] : End If 
   '
   If M2=10 : _ICONIFY : End If 
   If M2=11 and M3=0 : Pop Proc[True] : End If 
Return 

MVIEW:
   _wnd Id Use 0
   X=(_wnd Id Width/2)*MU+XO : Y=(_wnd Id Height/2*YRES)*MU+YO
   If M2=0 : MU=MU*2 : VT=VT*2 : XO=X-(_wnd Id Width/2*MU) : YO=Y-(_wnd Id Height/2*YRES*MU) : _REDRAW : End If 
   If M2=1 and MU>1 : MU=MU/2 : VT=VT/2 : XO=X-(_wnd Id Width/2*MU) : YO=Y-(_wnd Id Height/2*YRES*MU) : _REDRAW : End If 
   If M2=2 : MU=4 : VT=MU*32 : XO=X-(_wnd Id Width/2*MU) : YO=Y-(_wnd Id Height/2*YRES*MU) : _REDRAW : End If 
   If M2=4
      If M3=0 : GRIDSET=0 : _REDRAW
      Else If M3=1 : GRIDSET=8 : _REDRAW
      Else If M3=2 : GRIDSET=16 : _REDRAW
      Else If M3=3 : GRIDSET=-8 : _REDRAW
      Else If M3=4 : GRIDSET=-16 : _REDRAW
      End If 
      If M3=5
         If SC=1
            SC=8 : _SHOW_MENU
         Else 
            SC=1 : _SHOW_MENU
         End If 
      End If 
   End If 
   If M2=5 and M3=5 : SHMODE=0 : _SHOW_MENU : _REDRAW : End If 
   If M2=5 : Bchg M3,SHMODE : _SHOW_MENU : _REDRAW : End If 
   If M2=6 and M3=3 : RECPT=0 : _SHOW_MENU : _REDRAW : End If 
   If M2=6 : Bchg M3,RECPT : _SHOW_MENU : _REDRAW : End If 
Return 

MLEVE:
   If M2=0 : _N_SETLEVELTEXT : End If 
   If M2=2
      If STMODE=0
         STMODE=1 : _SHOW_MENU_2 : _REDRAW
      Else 
         STMODE=0 : _SHOW_MENU_2 : _REDRAW
      End If 
   End If 
'   If M2=2 : Bchg 0,STMODE : _SHOW_MENU_2 : _REDRAW : End If  
   If M2=3 : _CHECK_LEVEL : End If 
   If M2=4 : _OPT_ZONES : End If 
   If M2=5 : _OPT_POINTS : End If 
Return 

MGAME:
   Auto View On 
   If M2=0 : _GL_LEVELS : End If 
   If M2=1 : _GL_LGFX : End If 
   If M2=2 : _GL_OBJGFX : End If 
   If M2=3 : _GL_SETVEC : End If 
   If M2=4 : _GL_SFX : End If 
   If M2=5 : _GL_SETBULLET : End If 
   If M2=6 : _GL_SETGUN : End If 
   If M2=7 : _GL_SETALIEN : End If 
   If M2=8 : _GL_SETOBJECT : End If 
   If M2=9 : _GL_SETPLAYER : End If 
   If M2=10 : _GL_SETFLOORDAM : End If 
   If M2=12 : _LOAD_LINK : End If 
   If M2=13 : _SAVE_LINK : End If 
   If M2=14 : _LOAD_DEF_LINK : End If 
   If M2=15 : _SAVE_DEF_LINK : End If 
Return 

MTOOL:
   Auto View On 
   If M2=0 : _TL_LEVELINTRO : End If 
   If M2=1 : _TL_PACKFILE : End If 
   If M2=2 : _TL_DPFILE : End If 
   If M2=3 : _TL_BUILDARCHIVE : End If 
   If M2=4
      If M3=0 : _TL_IFF2WALL : End If 
      If M3=1 : _TL_WALL2IFF : End If 
      If M3=3 : _TL_OBJFRAMECONV : End If 
      If M3=4 : _TL_CONVHQN : End If 
      If M3=5 : _TL_FRAME2IFF : End If 
      If M3=7 : _TL_N_IFF2FLOOR : End If 
      If M3=8 : _TL_N_FLOOR2IFF : End If 
      If M3=10 : _TL_N_IFF2TEXT : End If 
      If M3=11 : _TL_N_TEXT2IFF : End If 
      If M3=13 : _TL_N_IFF2BACK : End If 
      If M3=14 : _TL_N_BACK2IFF : End If 
      If M3=16 : _TL_N_SAMP2FIB : End If 
      If M3=17 : _TL_FIB2SAMPLE : End If 
   End If 
   If M2=5
      If M3=0 : _TL_ED_CFLOOR : End If 
   End If 
   Amos To Back : _scr Id Show 1
Return 

MMISC:
   If M2=0 : _S_PLAY_TRACK : End If 
   If M2=1 : _KILL_TRACK : End If 
   If M2=3 : _SHOW_AG["Main"] : End If 
Return 


   If M1=4
      If M2=1 : _N_SETLEVELTEXT : End If 
      If M2=5 : _STATISTICS[0] : End If 
      If M2=11 : _CHECK_LEVEL : _REDRAW : End If 
      On M2-11 Proc _OPT_ZONES,_OPT_POINTS
   End If 
End Proc[E]

Procedure _CYCLEMODEUP
      _EDITMODE=_EDITMODE+1

   If _EDITMODE>4
      _EDITMODE=4
   End If 
End Proc

Procedure _CYCLEMODEDOWN
   _EDITMODE=_EDITMODE-1

   If _EDITMODE<0
      _EDITMODE=0
   End If 
End Proc

Procedure _CYCLEBUTTON
   If Key State(89)
      _TIDYDEF : OP=37 : _INITDEF
   End If 

   If _EDITMODE=0
      If Key State(82)
         _TIDYDEF : OP=0 : _INITDEF
   End If 
      If Key State(83)
         _TIDYDEF : OP=3 : _INITDEF
      End If 
      If Key State(84)
         _TIDYDEF : OP=1 : _INITDEF
      End If 
      If Key State(85)
         _TIDYDEF : OP=27 : _INITDEF
      End If 
      If Key State(86)
         _TIDYDEF : OP=14 : _INITDEF
      End If 
      If Key State(87)
         _TIDYDEF : OP=17 : _INITDEF
      End If 
   End If 
   If _EDITMODE=1
      If Key State(82)
         _TIDYDEF : OP=21 : _INITDEF
      End If 
      If Key State(83)
         _TIDYDEF : OP=22 : _INITDEF
      End If 
      If Key State(84)
         _TIDYDEF : OP=23 : _INITDEF
      End If 
      If Key State(85)
         _TIDYDEF : OP=24 : _INITDEF
      End If 
      If Key State(86)
         _TIDYDEF : OP=25 : _INITDEF
      End If 
      If Key State(87)
         _TIDYDEF : OP=26 : _INITDEF
      End If 
   End If 
   If _EDITMODE=2
      If Key State(82)
         _TIDYDEF : OP=10 : _INITDEF
      End If 
      If Key State(83)
         _TIDYDEF : OP=13 : _INITDEF
      End If 
      If Key State(84)
         _TIDYDEF : OP=33 : _INITDEF
      End If 
      If Key State(85)
         _TIDYDEF : OP=34 : _INITDEF
      End If 
   End If 
   If _EDITMODE=3
      If Key State(82)
         _TIDYDEF : OP=2 : _INITDEF
      End If 
      If Key State(83)
         _TIDYDEF : OP=5 : _INITDEF
      End If 
      If Key State(84)
         _TIDYDEF : OP=8 : _INITDEF
      End If 
      If Key State(85)
         _TIDYDEF : OP=11 : _INITDEF
      End If 
   End If 
   If _EDITMODE=4
      If Key State(82)
         _TIDYDEF : OP=28 : _INITDEF
      End If 
      If Key State(83)
         _TIDYDEF : OP=35 : _INITDEF
      End If 
      If Key State(84)
         _TIDYDEF : OP=31 : _INITDEF
      End If 
      If Key State(85)
         _TIDYDEF : OP=29 : _INITDEF
      End If 
      If Key State(86)
         _TIDYDEF : OP=32 : _INITDEF
      End If 
   End If 
End Proc

'Procedure _CYCLEBUTTON
'   If OP>37 
'      _TIDYDEF
'      OP=0
'      _INITDEF
'   Else 
'      _TIDYDEF
'      OP=OP+1 
'      _INITDEF
'   End If 
'End Proc

Procedure _IPICKBUTTON[F]
   D1=_wnd Id Event Gadget
   If OP=D1-1 : Pop Proc : End If 
   If F=True : D1=OP+1 : Else If F : D1=F+1 : End If 

   _TIDYDEF

   OP=D1-1

   _INITDEF
End Proc
'
'------------------------------------------------------------------------- 
'   INITIALISERINGS PROCEDURER 
'------------------------------------------------------------------------- 
'
Procedure _CHECK_TOOLS
   SC=8
   GRIDSET=-8
   RECPT=%111
   SHMODE=%10111
   STMODE=0
   CPACK$="LhA a -x %a %f"
   P_PRG$="PPaint:PPaint %f"
   SCR_MODE=Hires+Laced
   YRES=1
   DEFNCOL=16
   CANVASWIDTH=664
   CANVASHEIGHT=532
   _TXT_BOX_W=640
   '
   ' Flags in 'PRE1'
   ' b 0: 1=metric heights
   ' b 1: 1=show height-relative-bar
   ' b 8: 1=show gfx-tiles as 'shadow'
   ' b16: 1=show cords
   ' b17: 1=keep graphics 
   '
   PRE1=0
   '
   '  Tooltypes support 
   '
   N$=_prg Name$
   Trap IC=_icon Get(N$)
   If Errtrap=0
      If _tool Exist(IC,"HELP") : GFILE$=_tool Get$(IC,"HELP") : End If 
      If _tool Exist(IC,"ARC") : GFILE$=_tool Get$(IC,"ARC") : End If 
      If _tool Exist(IC,"PPRG") : P_PRG$=_tool Get$(IC,"PPRG") : End If 
      If _tool Exist(IC,"16COLS") : DEFNCOL=16 : End If 
      If _tool Exist(IC,"32COLS") : DEFNCOL=32 : End If 
      If _tool Exist(IC,"256COLS") : DEFNCOL=256 : End If 
      If _tool Exist(IC,"FastGFX") : Bset 8,PRE1 : End If 
      If _tool Exist(IC,"CacheGFX") : Bset 17,PRE1 : End If 
      If _tool Exist(IC,"OldSM") : YRES=2
      Else If _tool Exist(IC,"AskSM")
         _REQUESTSCREEN[0] : SCR_MODE=Param
      End If 
      If _tool Exist(IC,"GRID")
         W$=_tool Get$(IC,"GRID")
         If W$="OFF" : GRIDSET=0 : End If 
         If W$="D2" : GRIDSET=-16 : End If 
         If W$="D1" : GRIDSET=-8 : End If 
         If W$="L1" : GRIDSET=8 : End If 
         If W$="L2" : GRIDSET=16 : End If 
      End If 
      If _tool Exist(IC,"CanvasWidth")
         W$=_tool Get$(IC,"CanvasWidth")
         CANVASWIDTH=Val(W$)
            If CANVASWIDTH>664
               _TXT_BOX_W=83*8
            End If 
      End If 
      If _tool Exist(IC,"CanvasHeight")
         W$=_tool Get$(IC,"CanvasHeight")
         CANVASHEIGHT=Val(W$)
      End If 
      If _tool Exist(IC,"MUSIC")
         W$=_tool Get$(IC,"MUSIC") : _PLAY_TRACK[W$]
      End If 
   End If 

   '
   ' Check and append filenames.. 
   '
   If Len(Dr Path$(GFILE$))<2
      GFILE$=Dir$+GFILE$
   End If 
End Proc
Procedure _INIT_MSCREEN
   If YRES=1
      If DEFNCOL=16
         Trap _scr Id Open 1,0,0,664,532,4,SCR_MODE,0,VER$
      Else If DEFNCOL=32
         Trap _scr Id Open 1,0,0,664,532,5,SCR_MODE,0,VER$
      Else 
         'changed the 8 bit canvas size to a icon tooltype for better RTG support AL
         Trap _scr Id Open 1,0,0,CANVASWIDTH,CANVASHEIGHT,8,SCR_MODE,0,VER$
      End If 
   Else 
      If DEFNCOL=16
         Trap _scr Id Open 1,0,0,664,266,4,Hires,0,VER$
      Else If DEFNCOL=32
         Trap _scr Id Open 1,0,0,664,266,5,Hires,0,VER$
      Else 
         Trap _scr Id Open 1,0,0,664,266,8,Hires,0,VER$
      End If 
   End If 

   Bank Swap 1,597
   '  
   ' Get 16*16 pics for GT-Gadgets  
   '
   If Exist(Dir$+"EditorGUI.IFF")
      Trap Load Iff Dir$+"EditorGUI.IFF",7
      If Errtrap
         Unpack 598 To 7
      Else 
         Spack 7 To 598
      End If 
   Else 
      Unpack 598 To 7
   End If 
   If YRES=2
      Screen Open 6,Screen Width(7),Screen Height(7)/2,16,Lowres
      Zoom 7,0,0,Screen Width(7)-1,Screen Height(7)-1 To 6,0,0,Screen Width(6)-1,Screen Height(6)-1
   End If 
   WNR=1
   For WY=0 To 128/YRES Step 32/YRES
      For WX=0 To 608 Step 32
         Get Bob WNR,WX,WY To WX+32,WY+32/YRES
         SGAD(WNR)=_gt Make Image(WNR)
         Inc WNR
      Next WX
   Next WY
   Screen 7
   WNR=100
   For WX=0 To 288 Step 24
      For WY=0 To 13 Step 12
         Get Bob WNR,WX,WY+256 To WX+24,WY+12+256
         GAD24(WNR-100)=_gt Make Image(WNR)
         _struct Uword(GAD24(WNR-100),4)=24
         Inc WNR
      Next WY
   Next WX
   WNR=140
   For WX=0 To 288 Step 16
      For WY=0 To 13 Step 12
         Get Bob WNR,WX,WY+280 To WX+16,WY+12+280
         GAD16(WNR-140)=_gt Make Image(WNR)
         Inc WNR
      Next WY
   Next WX
   WNR=180
   For WX=0 To 160 Step 10
      For WY=0 To 11 Step 9
         Get Bob WNR,WX,WY+304 To WX+10,WY+9+304
         GAD10(WNR-180)=_gt Make Image(WNR)
         _struct Uword(GAD10(WNR-180),4)=10
         Inc WNR
      Next WY
   Next WX
   Screen Close 7
   Trap Screen Close 6
   Bank Swap 1,597
   '
   ' Std. colour setup
   '
   _scr Id Set Pal 0,$AAA : GPAL(10)=0 : GPAL(11)=0
   _scr Id Set Pal 1,$0 : GPAL(0)=1 : GPAL(1)=1
   _scr Id Set Pal 2,$FFF : GPAL(14)=2 : GPAL(15)=2
   _scr Id Set Pal 3,$888 : GPAL(8)=3 : GPAL(9)=3
   _scr Id Set Pal 4,$F00
   _scr Id Set Pal 5,$F0
   _scr Id Set Pal 6,$FF0
   _scr Id Set Pal 7,$FF
   _scr Id Set Pal 8,$666 : GPAL(6)=8 : GPAL(7)=8
   _scr Id Set Pal 9,$F
   _scr Id Set Pal 10,$F0F
   _scr Id Set Pal 11,$222 : GPAL(2)=11 : GPAL(3)=11
   _scr Id Set Pal 12,$444 : GPAL(4)=12 : GPAL(5)=12
   _scr Id Set Pal 13,$CCC : GPAL(12)=13 : GPAL(13)=13
   'For A=16 To 31
   '   _scr Id Set Pal A,$888 
   'Next A
   D_INK(0)=1 : D_INK(1)=12 : D_INK(2)=2
   '
   ' Zone-drawing colours 
   '
   D_INK(4)=12 : D_INK(5)=13 : D_INK(6)=9

   D_INK(7)=4 : D_INK(8)=10 : D_INK(9)=9
   '
   ' Zone-Hilite colours
   '
   D_INK(10)=13 : D_INK(11)=2 : D_INK(12)=7
   '
   '
   D_INK(0)=0 : D_INK(1)=12 : D_INK(2)=1
   '
   ' Zone-drawing colours 
   '
   D_INK(4)=3 : D_INK(5)=1 : D_INK(6)=9

   D_INK(7)=4 : D_INK(8)=10 : D_INK(9)=9
   '
   ' Zone-Hilite colours
   '
   D_INK(10)=2 : D_INK(11)=2 : D_INK(12)=7
   '
   ' Grid colours 
   '
   D_INK(13)=13
   '
   ' Palette-loadning 
   '
   FE$="Ab3:Includes/NewEditorpal."
   Trap Kill "Ab3:Includes/Editorpal.16"
   Trap Kill "Ab3:Includes/Editorpal.32"
   Trap Kill "Ab3:Includes/Editorpal.256"
   Trap Kill "Ab3:Includes/Editorpal.256a"
   GMATCH=False
   If DEFNCOL=16
      If Exist(FE$+"16")
         Bload FE$+"16",Varptr(CO(0))
      Else 
         GMATCH=True
      End If 
   Else 
      _scr Id Set Pal 14,$111 : GPAL(1)=14
      _scr Id Set Pal 15,$333 : GPAL(3)=15
      _scr Id Set Pal 16,$555 : GPAL(5)=16
      _scr Id Set Pal 17,$777 : GPAL(7)=17
      _scr Id Set Pal 18,$999 : GPAL(9)=18
      _scr Id Set Pal 19,$BBB : GPAL(11)=19
      _scr Id Set Pal 20,$DDD : GPAL(13)=20
      _scr Id Set Pal 21,$EEE : D_INK(2)=21 : GPAL(14)=21
      If DEFNCOL=32
         If Exist(FE$+"32")
            Bload FE$+"32",Varptr(CO(0))
         Else 
            GMATCH=True
         End If 
      Else 
         If Exist(FE$+"256") and Exist(FE$+"256a")
            Bload FE$+"256",Varptr(CO(0))
            Wload FE$+"256a",401
            S=Start(401) : For A=22 To 255 : _scr Id Set Aga Pal A,Leek(S) : Add S,4 : Next A
            Erase 401
         Else 
            _SET_E_PALETTE[22]
            Bsave FE$+"256",Varptr(CO(0)) To Varptr(CO(0))+256*4
            Reserve As Work 401,255*4
            S=Start(401) : For A=22 To 255 : Loke S,_scr Id Get Aga Pal(A) : Add S,4 : Next A
            Bsave FE$+"256a",Start(401) To Bank End(401)
            Erase 401
         End If 
      End If 
   End If 
   If GMATCH
      For A=0 To 255
         DR=Deek(PALC+A*6) : DG=Deek(PALC+A*6+2) : DB=Deek(PALC+A*6+4)
         C=$FFFFFFF : CO(A)=0
         For B=0 To 15
            WA=Abs(DR-B*16)*3 : WB=Abs(DG-B*16)*5 : WC=Abs(DB-B*16)
            If WA+WB+WC<C : C=WA+WB+WC : CO(A)=GPAL(B) : End If 
         Next B
      Next A
      If DEFNCOL=16
         Bsave FE$+"16",Varptr(CO(0)) To Varptr(CO(0))+256*4
      Else 
         Bsave FE$+"32",Varptr(CO(0)) To Varptr(CO(0))+256*4
      End If 
   End If 
   '
   ' Menu Setup 
   '
   Reserve As Gt Menus 490,120,1

   _gt Add Menu Catalog String$(1100,"Project"),
   _gt Add Item Catalog String$(1176,"About"),"",,
   _gt Add Item Catalog String$(1105,"Load Level"),"",,
   _gt Add Item Catalog String$(1106,"Save Level"),"",,
   _gt Add Item -1,"",,
   _gt Add Item Catalog String$(1106,"Save Level As"),"",,
   _gt Add Item Catalog String$(1107,"Build Clip-file"),"",,
   _gt Add Item Catalog String$(1108,"Link Level"),"",,
   _gt Add Item Catalog String$(1110,"Make Level"),"",,
   _gt Add Item Catalog String$(1178,"Make Full"),"",,
   _gt Add Item -1,"",,
   _gt Add Item "Iconify","",,
   _gt Add Item Catalog String$(1112,"Quit Editor"),"",,
   _gt Add Sub Catalog String$(1139,"I'm outa here"),"",,
   '
   _gt Add Menu Catalog String$(1101,"View"),
   _gt Add Item Catalog String$(1115,"Zoom Out"),"",,
   _gt Add Item Catalog String$(1116,"Zoom In"),"",,
   _gt Add Item Catalog String$(1117,"Zoom Normal"),"",,
   _gt Add Item -1,"",,
   _gt Add Item Catalog String$(1118,"Grid"),"",,
   _gt Add Sub Catalog String$(1140,"Grid Off"),"",,
   _gt Add Sub Catalog String$(1141,"Grid Line 1"),"",,
   _gt Add Sub Catalog String$(1142,"Grid Line 2"),"",,
   _gt Add Sub Catalog String$(1143,"Grid Dots 1"),"",,
   _gt Add Sub Catalog String$(1144,"Grid Dots 2"),"",,
   _gt Add Sub Catalog String$(1204,"Snap"),"",$1,
   _gt Add Item Catalog String$(1119,"Symbols"),"",,
   _gt Add Sub Catalog String$(1164,"Lifts"),"",$1,
   _gt Add Sub Catalog String$(1165,"Doors"),"",$1,
   _gt Add Sub Catalog String$(1166,"Teleports"),"",$1,
   _gt Add Sub Catalog String$(1167,"Heights"),"",$1,
   _gt Add Sub Catalog String$(1168,"Objects"),"",$1,
   _gt Add Sub Catalog String$(1145,"All Off"),"",,
   _gt Add Item Catalog String$(1120,"C. Points"),"",,
   _gt Add Sub Catalog String$(1169,"Physical"),"",$1,
   _gt Add Sub Catalog String$(1170,"Visual"),"",$1,
   _gt Add Sub Catalog String$(1197,"Points"),"",$1,
   _gt Add Sub Catalog String$(1145,"All Off"),"",,
   '
   _gt Add Menu Catalog String$(1102,"Level"),
   _gt Add Item Catalog String$(1121,"Text Strings"),"",,
   _gt Add Item -1,"",,
   _gt Add Item Catalog String$(1177,"Statistics"),"",$1,
   _gt Add Item Catalog String$(1114,"Check Level"),"",,
   _gt Add Item Catalog String$(1186,"Optimize Zones"),"",,
   _gt Add Item Catalog String$(1187,"Optimize Points"),"",,

   _gt Add Menu Catalog String$(1103,"Game-Setup"),
   _gt Add Item Catalog String$(1122,"Levels"),"",,
   _gt Add Item Catalog String$(1203,"Level GFX's"),"",,
   _gt Add Item Catalog String$(1149,"Set Object GFX Frames"),"",,
   _gt Add Item Catalog String$(1153,"Set Vector Filenames"),"",,
   _gt Add Item Catalog String$(1125,"Set Samples"),"",,
   _gt Add Item Catalog String$(1157,"Define Bullet Data"),"",,
   _gt Add Item Catalog String$(1158,"Define Gun Types"),"",,
   _gt Add Item Catalog String$(1159,"Define Alien Stats"),"",,
   _gt Add Item Catalog String$(1160,"Define Object Stats"),"",,
   _gt Add Item Catalog String$(1161,"Define Player Stats"),"",,
   _gt Add Item Catalog String$(1162,"Define Floor Stats"),"",,
   _gt Add Item -1,"",,
   _gt Add Item Catalog String$(1132,"Load Setup"),"",,
   _gt Add Item Catalog String$(1133,"Save Setup"),"",,
   _gt Add Item Catalog String$(1134,"Load Default"),"",,
   _gt Add Item Catalog String$(1135,"Save Default"),"",,
   '
   _gt Add Menu Catalog String$(1104,"Tools"),
   _gt Add Item Catalog String$(1136,"Level-Intro-Texts"),"",,
   _gt Add Item Catalog String$(1137,"Pack file"),"",,
   _gt Add Item Catalog String$(1138,"UnPack file"),"",,
   _gt Add Item Catalog String$(1205,"Build Archive"),"",,
   _gt Add Item Catalog String$(1208,"Converters"),"",,
   _gt Add Sub Catalog String$(1202,"IFF      -> Wall"),"",,
   _gt Add Sub Catalog String$(1171,"Wall     -> IFF"),"",,
   _gt Add Sub -1,"",,
   _gt Add Sub Catalog String$(1206,"IFF      -> GFX frames"),"",,
   _gt Add Sub Catalog String$(1207,"IFF      -> HQN frames"),"",,
   _gt Add Sub Catalog String$(1174,"Frames   -> IFF"),"",,
   _gt Add Sub -1,"",,
   _gt Add Sub Catalog String$(1191,"AGA-IFF  -> Floor"),"",,
   _gt Add Sub Catalog String$(1190,"Floor    -> AGA-IFF"),"",,
   _gt Add Sub -1,"",,
   _gt Add Sub Catalog String$(1193,"AGA-IFF  -> Texture"),"",,
   _gt Add Sub Catalog String$(1192,"Texture  -> AGA-IFF"),"",,
   _gt Add Sub -1,"",,
   _gt Add Sub Catalog String$(1195,"AGA-IFF  -> Backdrop"),"",,
   _gt Add Sub Catalog String$(1194,"Backdrop -> AGA-IFF"),"",,
   _gt Add Sub -1,"",,
   _gt Add Sub Catalog String$(1196,"DTsample -> AB3D-FIB"),"",,
   _gt Add Sub Catalog String$(1175,"Fib      -> Sample"),"",,
   _gt Add Item Catalog String$(1209,"Edit GFX"),"",,
   _gt Add Sub Catalog String$(1210,"Current Floors"),"",,
   '
   _gt Add Menu Catalog String$(1198,"Misc."),
   _gt Add Item Catalog String$(1199,"Play Music"),"",,
   _gt Add Item Catalog String$(1200,"Kill Music"),"",,
   _gt Add Item -1,"",,
   _gt Add Item Catalog String$(1201,"Help"),"",,

   Reserve As Gt Gadgets 491,50,1
   _gt Set Mode 0,"",0,1
   For A=0 To 12
      For B=0 To 2
         _gt Image A*3+B+1,B*32,12+A*32/YRES,$1,SGAD((A*3+B)*2+1),SGAD((A*3+B)*2+2)
      Next B
   Next A

   _wnd Id Open 9,0,0,16,0,$100+$800+$1000,F_IDCMP,0,""
   _wnd Id Titles "",VER$
   _gt Menus Attach 490

   _wnd Id Open 0,96,0,_scr Id Width(1)-96,_scr Id Height(1),$100+$800+$1000+$10000,F_IDCMP,0,""
   _wnd Id Titles "",VER$
   _wnd Id Cls 0
   _gt Menus Attach 490

   _wnd Id Open 1,0,0,96,_scr Id Height(1),$100+$800,F_IDCMP,0,""
   _wnd Id Titles "",VER$
   _wnd Id Cls 3
   _gt Gadgets Attach 491
   _gt Menus Attach 490
   _scr Id Show 1
   _SHOW_MENU
End Proc
Procedure _CLOSE_MAINSCREEN
   Trap _wnd Id Close 9
   Trap _wnd Id Close 3
   Trap _wnd Id Close 2
   Trap _wnd Id Close 1
   Trap _wnd Id Close 0
   _gt Menus Erase 490
   _gt Gadgets Erase 491
   Erase 597
   Trap _gt Gadgets Erase 498
   Trap _gt Gadgets Erase 499
   _KILL_TRACK
   _scr Id Close 1
End Proc
Procedure _SET_E_PALETTE[FC]
   '
   ' Set colour palette for displaying GFX on intuition screens 
   ' C0->C(c) & C251->C255 is kept free (For intuition gadgets).. 
   '
   MC=2^_scr Id Depth(1)-5
   NC=FC
   '
   ' Set colours
   '
   Amcaf Aga Notation On 
   For A=0 To 255 : CO(A)=-1 : Next A
   For A=0 To 255
      DR=Deek(PALC+A*6) : DG=Deek(PALC+A*6+2) : DB=Deek(PALC+A*6+4)
      C=$FFFFFF
      For B=0 To MC+4
         D=_scr Id Get Aga Pal(B)
         CR=Red Val(D) : CG=Green Val(D) : CB=Blue Val(D)
         WA=Abs(DR-CR) : WB=Abs(DG-CG) : WC=Abs(DB-CB)
         If B>NC and B<MC : WA=$1FFFFFF : End If 
         If WA+WB+WC<C : CN=B : C=WA+WB+WC : End If 
      Next B
      If C>8 and NC<MC
         _scr Id Set Aga Pal NC,DR*$10000+DG*$100+DB
         CO(A)=NC
         Inc NC
      Else 
         CO(A)=CN
      End If 
   Next A
   Amcaf Aga Notation Off 
End Proc
Procedure _SET_M_PALETTE
   _scr Id Use 1
   _scr Id Show 1
   Amos To Back 
End Proc
Procedure _SHOW_MENU
   M1=1 : M2=4
   For A=0 To 4
      If Btst(A,SHMODE)
         _gt Menu Set Check M1,M2+1,A
      Else 
         _gt Menu Clear Check M1,M2+1,A
      End If 
   Next A
   For A=0 To 2
      If Btst(A,RECPT)
         _gt Menu Set Check M1,M2+2,A
      Else 
         _gt Menu Clear Check M1,M2+2,A
      End If 
   Next A
   If SC=1
      _gt Menu Clear Check M1,M2,5
   Else 
      SC=8
      _gt Menu Set Check M1,M2,5
   End If 
End Proc

Procedure _SHOW_MENU_2
   M1=2 : M2=2

   If STMODE=0
      _gt Menu Clear Check M1,M2,-1
   End If 

   If STMODE=1
      _gt Menu Set Check M1,M2,-1
   End If 

End Proc

Procedure _NEW_LEVEL[FULL]
   '
   ' Reset common values
   '
   XO=-(128*10) : YO=-(128*6)
   MU=4 : NZ=0 : CZ=0 : ZE=0 : PZ=-1 : NO=0 : NCPT=-1 : PZ=-1
   CONTP=0 : TEAM=-1
   '
   ' Reset zones
   '
   For A=0 To 9
      LEVELTEXT$(A)=Space$(160)
   Next 
   For A=0 To MZ
      UZH(A,0)=5000 : UZH(A,1)=5000 : UZH(A,2)=5000 : ZH(A,2)=256 : ZH(A,1)=-128
      TELZO(A)=-1
      If FULL
         ZP(A)=0 : WAPT(A)=0 : ZWA(A)=0 : ZD(A)=0 : ZLI(A)=0
         ZDPT(A)=0 : ZGPT(A)=0 : CORD(A)=0
         VCPL(A)=0 : VCPR(A)=0 : ZU(A)=0
         BSFX(MZ)=0
         ZCPT(A)=0 : UZCPT(A)=0 : RB(A)=0 : FB(A)=0 : ZD(A)=0 : ZB(A)=0 : UZB(A)=0
         TELX(A)=0 : TELZ(A)=0 : USED(A)=0 : ECHO(A)=0
         For B=0 To 2 : UZRG(A,B)=0 : UZFG(A,B)=0 : ZRG(A,B)=0 : ZFG(A,B)=0 : Next B
         For B=0 To 100 : LP(A,B)=0 : RP(A,B)=0 : Next B
      End If 
      For B=0 To 10
         If FULL
            For C=0 To 3 : UZWG(A,B,C)=0 : ZPBR(A,B,C)=0 : ZWG(A,B,C)=0 : Next C
            For C=0 To 1 : ZW(A,B,C)=0 : Next C
            ZWG(A,B,3)=64 : ZC(A,B)=0 : ZZ(A,B)=0 : WB(A,B)=0 : UWB(A,B)=0
         End If 
         DWPT(A,B)=0 : ZO(A,B)=-1 : WLI(A,B)=0 : WD(A,B)=0 : WT(A,B)=0
      Next B
   Next A
   If FULL
      For A=0 To MXP
         PW(A)=0 : PN(A)=0 : 
         PU(A)=0 : PX(A)=0 : PY(A)=0
         For B=0 To 3 : D(A,B)=0 : Next B
         For B=0 To 1 : PCW(A,B)=0 : Next B
      Next A
      For A=0 To MCP : CPTX(A)=0 : CPTY(A)=0 : CPTZ(A)=0 : CPTUL(A)=0 : Next A
      For A=0 To 200 : OBX(A)=0 : OBZ(A)=0 : Next A
      '
      ' Reset water anim 
      '
      For A=0 To 20
         WASP(A)=0 : WATH(A)=0 : WABH(A)=0
      Next A
   End If 
   GLINK=True : GCLIP=True : GCHECK=True
End Proc
Procedure _END_PROGRAM
   _TIDYDEF
   For I=1 To 20
      If SPRDATA(I,0)>0
         _struct Free SPRDATA(I,0)
      End If 
   Next 
   Trap Dialog Close 1
   Trap Dialog Close 2
   Trap Dialog Close 3
   Trap Screen Close 0
   Trap Screen Close 1
   Trap Screen Close 2
   Trap Screen Close 3
   Trap Screen Close 4
   Trap Screen Close 5
   Trap Screen Close 6
   Trap Screen Close 7
   Close Catalog : Emit Close 
   _CLOSE_MAINSCREEN
   Erase 1
   End 
End Proc

Procedure _STAT_ZONES
'   If OP=7
      If NZ<1 : Pop Proc : End If 
      A=0 : R=0 : STNZ=0
      
      While A<NZ
         If USED(A)=0
            Inc R
            'Inc A 
         End If 
         Inc A
      Wend 
      
      STNZ=A-R
      
'   End If 
End Proc

Procedure _STATISTICS[TY]
   Menu Off : Dialog Freeze 
   Screen To Front 2 : Screen 2 : Flash Off : Cls 0
   Get Palette 0
   Sprite Off 
   Dim W(255)
   Reserve As Work 401,4096
   A$=""
   A$=A$+"BAse   0,0;"
   A$=A$+"SIze   640,180;"
   A$=A$+"SA 2;"
   A$=A$+"BO 0,0,85,SX,SY;"
   A$=A$+"LI 0,0,79,SX;PR 0VA CX,1,0VA,1;"
   A$=A$+"BU 33,576,012,016,007,000,000,001;[UN 000,000,106 BP+;][BR 0;IF 13VA 0>;[ZC 31,13VA 1-;]]"
   A$=A$+"KY 30,000;"
   A$=A$+"BU 34,576,132,016,007,000,000,001;[UN 000,000,104 BP+;][BR 0;IF 13VA 12VA 16- <;[ZC 31,13VA 1+;]]"
   A$=A$+"KY 31,000;"
   A$=A$+"HT 32,016,012,070,016,11VA,0,0,13,1;[]"
   A$=A$+"SV 12,ZV;"
   A$=A$+"VS 31,578,020,012,110,000,16,12VA,001;[ZC 32,ZP;SV 13,ZP;]"
   A$=A$+""
   A$=A$+""
   A$=A$+""
   A$=A$+"BUtton 40,600,12,40,16,00,00,01;[LI 0,0,152 BP 3*+,SX;UN 8,2,178;][BR 1;]"
   A$=A$+"BUtton 41,600,30,40,16,00,00,01;[LI 0,0,152 BP 3*+,SX;UN 8,2,179;][BR 1;]"
   A$=A$+"BUtton 42,600,48,40,16,00,00,01;[LI 0,0,152 BP 3*+,SX;UN 8,2,180;][BR 1;]"
   A$=A$+"BUtton 60,600,SY 28-,40,16,00,00,01;[LI 0,0,152 BP 3*+,SX;UN 8,2,161;][BR 0;]"
   A$=A$+"LI 0,SY 10-,79,SX;"
   A$=A$+"EXit;"
   Dialog Open 17,A$
   Do 
      Fill Start(401) To Bank End(401),0
      Vdialog(17,11)=Start(401) : Vdialog(17,13)=0
      AD=Start(401)
      If TY=0
         WOB=0 : WAL=0
         If NO>0
            For A=0 To NO
               S=Start(12)+A*32 : If Peek(S)=0 : Inc WAL : Else If Peek(S)=1 : Inc WOB : End If 
            Next A
         End If 
         Vdialog$(17,0)=Catalog String$(1300,"General statistics")
         AD=Elmem Inc(AD,Left$(Catalog String$(1301,"Objects placed")+Space$(50),50)+":"+Str$(WOB)+Chr$(10))
         AD=Elmem Inc(AD,Left$(Catalog String$(1302,"Aliens placed")+Space$(50),50)+":"+Str$(WAL)+Chr$(10)+Chr$(10))
         AD=Elmem Inc(AD,Left$(Catalog String$(1303,"Points used")+Space$(50),50)+":"+Str$(NP+1)+" ("+Str$(MXP)-" "+")"+Chr$(10))
         AD=Elmem Inc(AD,Left$(Catalog String$(1304,"Zones used")+Space$(50),50)+":"+Str$(NZ)+" ("+Str$(MZ)-" "+")"+Chr$(10))
         AD=Elmem Inc(AD,Left$(Catalog String$(1305,"Controlpoints used")+Space$(50),50)+":"+Str$(NCPT)+" (99)"+Chr$(10))
      Else If TY=1
         For A=0 To 30 : W(A)=0 : Next A
         If NO>0
            For A=0 To NO
               S=Start(12)+A*32
               If Peek(S)=1 : Inc W(Peek(S+2)) : End If 
            Next A
         End If 
         Vdialog$(17,0)=Catalog String$(1320,"Object statistics")
         For A=0 To 29
            AD=Elmem Inc(AD,Left$(Peek$(LINK+$57B0+A*20,20,Chr$(0))+Space$(50),50)+":"+Str$(W(A))+Chr$(10))
         Next A
      Else If TY=2
         For A=0 To 30 : W(A)=0 : Next A
         If NO>0
            For A=0 To NO
               S=Start(12)+A*32 : If Peek(S)=0 : Inc W(Peek(S+2)) : End If 
            Next A
         End If 
         Vdialog$(17,0)=Catalog String$(1340,"Alien statistics")
         For A=0 To 19
            AD=Elmem Inc(AD,Left$(Peek$(LINK+$34D8+A*20,20,Chr$(0))+Space$(50),50)+":"+Str$(W(A))+Chr$(10))
         Next A
      End If 
      DUMMY=Dialog Run(17)
      For A=0 To 2 : Dialog Update 17,40+A,0 : Next A
      Dialog Update 17,40+TY,1
      Do 
         R=Dialog(17)
         If R=40 : TY=0 : Exit 
         Else If R=41 : TY=1 : Exit 
         Else If R=42 : TY=2 : Exit 
         End If 
         Exit If R=60,2
         Multi Wait 
      Loop 
   Loop 
   Dialog Close 17
   Screen To Front 0
   _SET_M_PALETTE : _REDRAW
   Menu On : Dialog Unfreeze 
End Proc
Procedure _OPT_ZONES
   '
   ' Optimize zones 
   '
   If NZ<1 : Pop Proc : End If 
   A=0 : R=0
   _N_MSG2[Catalog String$(1186,"Optimize Zones"),2]
   While A<NZ-1
      _gt Set Text 1,Catalog String$(1700,"Doing:")+Str$(A)+"/ "+Str$(NZ-1),,,$2
      _gt Set Text 2,Catalog String$(1701,"Empty zones removed:")+Str$(R),,,$2
      If USED(A)=0
         Inc R
         For B=A To NZ
            ECHO(B)=ECHO(B+1) : TELZO(B)=TELZO(B+1) : TELX(B)=TELX(B+1) : TELZ(B)=TELZ(B+1)
            USED(B)=USED(B+1) : ZP(B)=ZP(B+1) : ZB(B)=ZB(B+1) : UZB(B)=UZB(B+1) : ZD(B)=ZD(B+1)
            RB(B)=RB(B+1) : FB(B)=FB(B+1) : VCPL(B)=VCPL(B+1) : VCPR(B)=VCPR(B+1) : ZU(B)=ZU(B+1)
            CORD(B)=CORD(B+1) : ZLI(B)=ZLI(B+1) : ZDPT(B)=ZDPT(B+1) : ZGPT(B)=ZGPT(B+1)
            ZWA(B)=ZWA(B+1) : WAPT(B)=WAPT(B+1) : BSFX(B)=BSFX(B+1)
            For C=0 To 10
               WB(B,C)=WB(B+1,C) : UWB(B,C)=UWB(B+1,C) : ZO(B,C)=ZO(B+1,C)
               WT(B,C)=WT(B+1,C) : ZC(B,C)=ZC(B+1,C) : ZZ(B,C)=ZZ(B+1,C)
               WD(B,C)=WD(B+1,C) : WLI(B,C)=WLI(B+1,C) : DWPT(B,C)=DWPT(B+1,C)
               For D=0 To 1 : ZW(B,C,D)=ZW(B+1,C,D) : Next D
               For D=0 To 3
                  ZPBR(B,C,D)=ZPBR(B+1,C,D) : ZWG(B,C,D)=ZWG(B+1,C,D) : UZWG(B,C,D)=UZWG(B+1,C,D)
               Next D
            Next C
            For C=0 To 100
               LP(B,C)=LP(B+1,C) : RP(B,C)=RP(B+1,C)
            Next C
            For C=0 To 3
               ZH(B,C)=ZH(B+1,C) : UZH(B,C)=UZH(B+1,C)
            Next C
            For C=0 To 2
               ZRG(B,C)=ZRG(B+1,C) : ZFG(B,C)=ZFG(B+1,C) : UZRG(B,C)=UZRG(B+1,C)
               UZFG(B,C)=UZFG(B+1,C)
            Next C
         Next B
         For B=0 To NZ-1
            If TELZO(B)>A : Dec TELZO(B) : End If 
         Next B
         For B=0 To NO
            S=Start(12)+B*32
            If Deek(S+6)>A
               Doke S+6,Deek(S+6)-1
            End If 
         Next B
         For B=0 To MCP
            If CPTZ(B)>A : Dec CPTZ(B) : End If 
         Next B
         If NZ>0
            Dec NZ : USED(NZ)=0
         End If 
         If PLZ>A : Dec PLZ : End If 
         If PLZ2>A : Dec PLZ2 : End If 
         If EZONE>A : Dec EZONE : End If 
         Dec A
         GCLIP=True : GCHECK=True
      End If 
      Inc A
   Wend 
   _R_N_MSG
   _REDRAW
End Proc
Procedure _OPT_POINTS
   '
   '  Optimmize points
   If NP<1 : Pop Proc : End If 
   If NZ<1 : Pop Proc : End If 
   _N_MSG2[Catalog String$(1187,"Optimize Points"),2]
   A=0 : R=0
   While A<NP
      _gt Set Text 1,Catalog String$(1700,"Doing:")+Str$(A)+"/ "+Str$(NP-1),,,$2
      _gt Set Text 2,Catalog String$(1702,"Empty points removed:")+Str$(R),,,$2
      U=True
      For B=0 To NZ-1
         For C=0 To ZP(B)
            If ZO(B,C)=A : U=False : Exit 2 : End If 
         Next C
      Next B
      If U
         Inc R
         For B=A To NP-1
            PX(B)=PX(B+1) : PY(B)=PY(B+1) : PU(B)=PU(B+1) : PN(B)=PN(B+1)
            PW(B)=PW(B+1)
            For C=0 To 3 : D(B,C)=D(B+1,C) : Next C
            For C=0 To 1 : PCW(B,C)=PCW(B+1,C) : Next C
         Next B
         For B=0 To NZ-1
            For C=0 To ZP(B)
               If ZO(B,C)>A : Dec ZO(B,C) : End If 
            Next C
         Next B
         Dec A
         If NP>0
            Dec NP
         End If 
         GCLIP=True : GCHECK=True
      End If 
      Inc A
   Wend 
   _R_N_MSG
   _REDRAW
End Proc
Procedure _INIT_PROGRAM
   '
   '  Check for external programs:
   '
   If Not Exist("Ab3:") : _ERROR[1,0,0] : End If 
   If Not Exist("T:") : _ERROR[1,0,4] : End If 
   If Not Exist("C:Delete") : _ERROR[1,0,5] : End If 
   If Not Exist("C:Lha3") : _ERROR[1,0,6] : End If 
   If Not Exist("C:LhaConv") : _ERROR[1,0,7] : End If 
   If Not Exist("C:SBDepack") : _ERROR[1,0,8] : End If 
   If Not Exist("C:Copy") : _ERROR[1,0,9] : End If 
   '
   '  Get palette data
   '
   If Length(502)<32 : Reserve As Data 502,32*32*2 : End If 
   Trap Bload "ab3:includes/256pal",Start(502)
   PALC=Start(502)
   '
   '  Make text empty 
   '
   LWCHUNK=-200 : WGW=64
   '
   '  Actions for Door-rise 
   '
   DR$(0)=Catalog String$(1000,"Plr Touch+SPC") : DR$(1)=Catalog String$(1001,"Plr Touch") : DR$(2)=Catalog String$(1004,"Bullet Touch")
   DR$(3)=Catalog String$(1005,"Alien Touch") : DR$(4)=Catalog String$(1002,"On Timeout") : DR$(5)=Catalog String$(1003,"Never")
   '
   '  Actions for Door-lower
   '
   DL$(0)=Catalog String$(1002,"On Timeout") : DL$(1)=Catalog String$(1003,"Never")
   '
   '  Actions for Lift-rise 
   '
   LR$(0)=Catalog String$(1000,"Plr Touch+SPC") : LR$(1)=Catalog String$(1001,"Plr Touch")
   LR$(2)=Catalog String$(1002,"On Timeout") : LR$(3)=Catalog String$(1003,"Never")
   '
   '  Actions for Lift-lower
   '
   LL$(0)=Catalog String$(1000,"Plr Touch+SPC") : LL$(1)=Catalog String$(1001,"Plr Touch")
   LL$(2)=Catalog String$(1002,"On Timeout") : LL$(3)=Catalog String$(1003,"Never")
   TXT=-1
   For A=0 To 7 : SWWL(A,0)=-1 : SWWL(A,1)=-1 : Next 
   SWT(0)=0 : BWT(0)=1 : SWT(1)=1 : BWT(1)=0 : SWT(2)=1 : BWT(2)=1
   SWT(3)=1 : BWT(3)=1 : SWT(4)=1 : BWT(4)=1 : SWT(5)=1 : BWT(5)=1
   PCOM=0
   '
   Reserve As Work 10,32*33*2
   Trap Screen Close 0
   EBX=0
   Screen Open 3,320,16,2,Lowres
   Curs Off : Flash Off : Cls 0
   LG=-1
   Reserve As Work 12,(MOBJ+20)*64
   Reserve As Work 14,MZ*64*6
   Fill Start(14) To Bank End(14),-1
'   Reserve As Work 15,220000
    Reserve As Work 15,300000
   _LOAD_DEF_LINK
   '
   ' Setup ASM programs 
   '
   Reserve As Work 11,100*150
   'If Length(510)<20 : Trap Pload "ab3:includes/BETPTS",510
   '   If Errtrap : _ERROR[1,0,3] : End If  
   'End If  
   'If Length(512)<20 : Trap Pload "ab3:includes/findsame.inc",512
   '   If Errtrap : End : End If  
   'End If  
   'If Length(513)<20 : Trap Pload "ab3:includes/shadepal.aminc",513
   '   If Errtrap : End : End If  
   'End If  
   Reserve As Work 9,Length(510)
   Copy Start(510),Bank End(510) To Start(9)
   NP=-1 : CP=NP
   '
   OB$(0)=Catalog String$(11,"Alien")
   OB$(1)=Catalog String$(12,"Object")
   '
   '  edit mode definitions 
   'EMODE$(_EDITMODE) 
   EMODE$(0)=Catalog String$(3000,"Geometry  ")
   EMODE$(1)=Catalog String$(3001,"Textures  ")
   EMODE$(2)=Catalog String$(3002,"Lighting  ")
   EMODE$(3)=Catalog String$(3003,"Objects   ")
   EMODE$(4)=Catalog String$(3004,"CtrlPoints")
   '
   '  Button definitions
   '
   BUT$(0)=Catalog String$(1010,"Add/Delete Point")
   BUT$(1)=Catalog String$(1011,"Define/delete Zone(s)")
   BUT$(2)=Catalog String$(1012,"Add Object")
   BUT$(3)=Catalog String$(1013,"Move Point")
   BUT$(4)=Catalog String$(1014,"Toggle Wall(s)")
   BUT$(5)=Catalog String$(1015,"Move Object")
   BUT$(6)=Catalog String$(1016,"")
   BUT$(7)=Catalog String$(1017,"")
   BUT$(8)=Catalog String$(1018,"Delete Object")
   BUT$(9)=Catalog String$(1019,"")
   BUT$(10)=Catalog String$(1020,"Upper Point Brightness (Presets define zone)")
   BUT$(11)=Catalog String$(1021,"Set Player Start / End Zone")
   BUT$(12)=Catalog String$(1022,"")
   BUT$(13)=Catalog String$(1023,"Lower Point Brightness (Presets define zone)")
   BUT$(14)=Catalog String$(1024,"Define Door Zone")
   BUT$(15)=Catalog String$(1025,"")
   BUT$(16)=Catalog String$(1026,"")
   BUT$(17)=Catalog String$(1027,"Define Lift Zone")
   BUT$(18)=Catalog String$(1028,"Graphics in UPPER zone (Please select a zone)")
   BUT$(19)=Catalog String$(1029,"Graphics in LOWER zone (Please select a zone)")
   BUT$(20)=Catalog String$(1030,"Define Teleporter")
   BUT$(21)=Catalog String$(1031,"Define Roof Graphic")
   BUT$(22)=Catalog String$(1032,"Define Wall Graphic")
   BUT$(23)=Catalog String$(1033,"Define Floor Graphic")
   BUT$(24)=Catalog String$(1034,"UPPER Roof Graphic")
   BUT$(25)=Catalog String$(1035,"UPPER Wall Graphic")
   BUT$(26)=Catalog String$(1036,"UPPER Floor Graphic")
   BUT$(27)=Catalog String$(1037,"Define Heights")
   BUT$(28)=Catalog String$(1038,"Add Control Point")
   BUT$(29)=Catalog String$(1039,"Link Zone to Cpt")
   BUT$(30)=Catalog String$(1040,"Water Height Anim")
   BUT$(31)=Catalog String$(1041,"Link Control Points")
   BUT$(32)=Catalog String$(1042,"Link Upper Zone to Controlpoint")
   BUT$(33)=Catalog String$(1043,"Upper Wall Bright")
   BUT$(34)=Catalog String$(1044,"Lower Wall Bright")
   BUT$(35)=Catalog String$(1045,"Move Control Point")
   BUT$(36)=Catalog String$(1046,"(Lower-)       Set Background SFX for zone (Hold shift to hear):       (-Upper)")
   BUT$(37)=Catalog String$(1047,"")
   BUT$(38)=VER$
   '
   ' Init interface-gadgets 
   '
   Auto View Off 
   Erase 1 : Erase 2 : Erase 597
   '
   ' Init sprites for mouse 
   '
   Screen Open 2,320,200,4,Lowres : Curs Off : Cls 0 : Ink 2
   Paper 0 : Pen 1
   Draw 0,0 To 10,10 : Draw 1,0 To 11,10 : Draw 0,1 To 10,11
   Draw 0,0 To 5,0 : Draw 0,0 To 0,5 : Draw 0,1 To 5,1 : Draw 1,0 To 1,5
   Get Sprite 1,0,0 To 16,16 : Cls 0
   Draw 0,0 To 4,0 : Draw 0,0 To 0,2 : Draw 1,0 To 1,2 : Draw 4,0 To 4,2
   Draw 5,0 To 5,2 : Draw 4,2 To 0,2
   Get Bob 2,0,0 To 16,3 : Cls 0 : Ink 2
   Draw 0,0 To 4,0 : Draw 0,0 To 0,4 : Draw 0,4 To 4,4 : Draw 4,0 To 4,4
   Get Sprite 3,0,0 To 16,5
   Turbo Plot 2,2,1
   Cls 0
   Ink 3 : Box 0,0 To 5,5
   Ink 1 : Box 1,1 To 4,4
   Get Sprite 4,0,0 To 16,7 : Cls 0
   _ALLOCSPRDATA[1,4]
   SPRDATA(4,0)=Param
   Draw 0,0 To 2,2
   Draw 6,0 To 4,2
   Draw 0,6 To 2,4
   Draw 6,6 To 4,4
   Get Sprite 7,0,0 To 16,16
   Screen Open 2,320,256,2,Lowres
   Curs Off : Flash Off : Cls 0
   For A=0 To 100 : Turbo Plot Rnd(15),Rnd(15),1 : Next 
   Get Sprite 5,0,0 To 16,16
   Hot Spot 3,2,2

   'HILITE(0,0)=-1 : HILITE(0,1)=-1 
   'HILITE(1,0)=2 : HILITE(1,1)=-1
   'HILITE(2,0)=5 : HILITE(2,1)=-1
   'HILITE(3,0)=3 : HILITE(3,1)=4 

   XO=-(128*10) : YO=-(128*6)
   MU=4 : NZ=0 : CZ=0 : ZE=0 : PZ=-1
   OP=6 : PX(MXP)=$7FFF : PY(MXP)=$7FFF
   MPTR=1
   _NEW_LEVEL[False]
   _INIT_MSCREEN
End Proc
Procedure _ICONIFY
   _TIDYDEF
   _CLOSE_MAINSCREEN
   WA=Eliconify Begin(0,12,VER$)
   If WA=0
      Repeat 
         Multi Wait 
      Until Eliconify Test
      Trap Eliconify End 
   End If 
   Amos To Back 
   _INIT_MSCREEN
   _REDRAW : _INITDEF
   MSHOW=1 : _wnd Id Activate 9
End Proc
'
'----------------------------------------------------------------------------
'
Procedure _N_SETLEVELTEXT
   'this if else may not be required but eh. AL 
   If CANVASWIDTH<800
      Trap _wnd Id Open 8,0,12,664,240,$2+$8,$40+$200,0,"Text Strings.."
   Else 
      Trap _wnd Id Open 8,0,12,CANVASWIDTH,34*11,$2+$8,$40+$200,0,"Text Strings.."
   End If 

   _wnd Id Titles Catalog String$(1050,"Edit Text-strings"),VER$
   _wnd Id Activate 8

   Reserve As Gt Gadgets 497,30,1
   _gt Set String Mode True,80,True,False

   For A=0 To 9
      _gt String A+10,32,A*34+22,_TXT_BOX_W,12,,Str$(A)-" ","",$0
      _gt String A+20,32,A*34+32,_TXT_BOX_W,12,,"","",$0
   Next A

   '
   ' Use gadgets
   '
   _gt Gadgets Attach 497

   Do 
      '
      ' Update texts 
      '
      For A=0 To 9
         _gt Set String A+10,Left Trim$(Left$(LEVELTEXT$(A),80))+_0$
         _gt Set String A+20,Left Trim$(Right$(LEVELTEXT$(A),80))+_0$
      Next A
      Do 
         '
         ' Wait for event 
         '
         EV=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         '
         ' If gadget pushed 
         '
         If EV=$40
            If Between(9,GA,20)
               LEVELTEXT$(GA-10)=Left$(_gt What String(GA)+Space$(80),80)+Left$(_gt What String(GA+10)+Space$(80),80)
               Exit 
            End If 
            If Between(19,GA,30)
               LEVELTEXT$(GA-20)=Left$(_gt What String(GA-10)+Space$(80),80)+Left$(_gt What String(GA)+Space$(80),80)
               Exit 
            End If 
         End If 
         '
         ' If window closed 
         '
         Exit If EV=$200,2
         Multi Wait 
      Loop 
   Loop 
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497
End Proc
'
Procedure LK[V]
   Loke MP,V : Add MP,4
End Proc
Procedure DK[V]
   Doke MP,V : Add MP,2
End Proc
Procedure PK[V]
   Poke MP,V : Add MP,1
End Proc
Procedure MYPEEK[A]
   D=Peek(A)
   If Btst(7,D)
      D=D or $FFFFFF00
   End If 
End Proc[D]
'
'----------------------------------------------------------------------------  
'
Procedure _MODE_SHOW
   
   _wnd Id Use 0

   WX=0 : WY=4

   _wnd Id Ink D_INK(2),,
   Add WY,8 : M1$="Level"+":"+CURLEV$ : _wnd Id Text WX,WY+8,M1$
   Add WY,8 : M1$="Mode"+":"+EMODE$(_EDITMODE) : _wnd Id Text WX,WY+8,M1$

End Proc

Procedure _STAT_SHOW

   _wnd Id Use 0

   WOB=0 : WAL=0
         If NO>0
            For A=0 To NO-1
            S=Start(12)+A*32 : If Peek(S)=0 : Inc WAL : Else If Peek(S)=1 : Inc WOB : End If 
            Next A
         End If 

   WX=_wnd Id Width-(15*8) : WY=4

   _STAT_ZONES

   _wnd Id Ink D_INK(2),, : Rem D_INK(0),D_INK(0)
      Add WY,8 : M1$="     Aliens"+Str$(WAL) : _wnd Id Text WX,WY+8,M1$
      Add WY,8 : M2$="    Objects"+Str$(WOB) : _wnd Id Text WX,WY+8,M2$
      Add WY,8 : M3$="Total Items"+Str$(NO) : _wnd Id Text WX,WY+8,M3$
      Add WY,8 : M4$="     Points"+Str$(NP+1) : _wnd Id Text WX,WY+8,M4$
      Add WY,8 : M5$="      Zones"+Str$(STNZ) : _wnd Id Text WX,WY+8,M5$
      Add WY,8 : M6$="Ctrl Points"+Str$(NCPT+1) : _wnd Id Text WX,WY+8,M6$

End Proc

Procedure _REDRAW
   _wnd Id Use 0
   _wnd Id Cls D_INK(0)

   '
   '  Make Grid 
   '
'   _wnd Id Ink D_INK(4),D_INK(1),D_INK(1) 
   If GRIDSET>3
   _wnd Id Ink D_INK(13),D_INK(1),D_INK(1)
      For A=YO To YO+(_wnd Id Height*MU) Step(GRIDSET*MU)/YRES
         Y=(T Clip(A,(SC*MU)/YRES)-YO)/MU
         _wnd Id Line 0,Y To _wnd Id Width,Y
      Next A
      For A=XO To XO+(_wnd Id Width*MU) Step GRIDSET*MU
         X=(T Clip(A,SC*MU)-XO)/MU
         _wnd Id Line X,0 To X,_wnd Id Height
      Next A
   Else If GRIDSET<-3
   _wnd Id Ink D_INK(1),D_INK(1),D_INK(1)
      For A=YO To YO+(_wnd Id Height*MU) Step((Abs(GRIDSET)*MU))/YRES
         For B=XO To XO+(_wnd Id Width*MU) Step Abs(GRIDSET)*MU
            X=T Clip(B,SC*MU) : Y=T Clip(A,(SC*MU)/YRES)
            _wnd Id Plot(X-XO)/MU,(Y-YO)/MU
         Next B
      Next A
   End If 
   '
   If NP>-1
      For QA=0 To NP : PTSHOW[PX(QA),PY(QA),1] : Next 
   End If 
   '
   ' Show zones 
   '
   If NZ>-1
      For QA=0 To NZ-1
         If USED(QA) : _ZOSHOW[QA,4] : End If 
      Next 
   End If 
   '
   ' Highlight current zone 
   '
   If CZ>-1
      If USED(CZ) : _ZOSHOW[CZ,10] : End If 
   End If 
   '_OUTLINE[CP]
   If NCPT>=0 and Btst(2,RECPT)
      For QA=0 To NCPT
         CPTPUT[CPTX(QA),CPTY(QA),8-CPTUL(QA)*2]
      Next 
   End If 
   If NCPT>0
      For WA=0 To NCPT-1
         For WB=WA+1 To NCPT
            _CONNECTED[WA,WB,-1]
         Next 
      Next 
   End If 
   '
   ' Objects
   '
   If NO>0 and Btst(4,SHMODE)
      For QA=0 To NO-1
         _OBJPUT[OBX(QA),OBZ(QA),2]
      Next 
   End If 
   If PLX<>0 or PLY<>0 or PLZ<>0
      PTSHOW[PLX,PLY,-1]
   End If 
   If PLX2<>0 or PLY2<>0 or PLZ<>0
      If PLX<>PLX2 or PLY<>PLY2 : PTSHOW[PLX2,PLY2,-2] : End If 
   End If 
End Proc
Procedure _OPHELP
   If OP=0 : _SHOW_AG["A1"] : End If 
   If OP=1 : _SHOW_AG["B1"] : End If 
   If OP=2 : _SHOW_AG["C1"] : End If 
   If OP=3 : _SHOW_AG["A2"] : End If 
   If OP=4 : _SHOW_AG["B2"] : End If 
   If OP=5 : _SHOW_AG["C2"] : End If 
   If OP=6 : _SHOW_AG["A3"] : End If 
   If OP=7 : _SHOW_AG["B3"] : End If 
   If OP=8 : _SHOW_AG["C3"] : End If 
   If OP=9 : _SHOW_AG["A4"] : End If 
   If OP=10 : _SHOW_AG["B4"] : End If 
   If OP=11 : _SHOW_AG["C4"] : End If 
   If OP=12 : _SHOW_AG["A5"] : End If 
   If OP=13 : _SHOW_AG["B5"] : End If 
   If OP=14 : _SHOW_AG["C5"] : End If 
   If OP=15 : _SHOW_AG["A6"] : End If 
   If OP=16 : _SHOW_AG["B6"] : End If 
   If OP=17 : _SHOW_AG["C6"] : End If 
   If OP=18 : _SHOW_AG["A7"] : End If 
   If OP=19 : _SHOW_AG["B7"] : End If 
   If OP=20 : _SHOW_AG["C7"] : End If 
   If OP=21 : _SHOW_AG["A8"] : End If 
   If OP=22 : _SHOW_AG["B8"] : End If 
   If OP=23 : _SHOW_AG["C8"] : End If 
   If OP=24 : _SHOW_AG["A9"] : End If 
   If OP=25 : _SHOW_AG["B9"] : End If 
   If OP=26 : _SHOW_AG["C9"] : End If 
   If OP=27 : _SHOW_AG["A10"] : End If 
   If OP=28 : _SHOW_AG["B10"] : End If 
   If OP=29 : _SHOW_AG["C10"] : End If 
   If OP=30 : _SHOW_AG["A11"] : End If 
   If OP=31 : _SHOW_AG["B11"] : End If 
   If OP=32 : _SHOW_AG["C11"] : End If 
   If OP=33 : _SHOW_AG["A12"] : End If 
   If OP=34 : _SHOW_AG["B12"] : End If 
   If OP=35 : _SHOW_AG["C12"] : End If 
   If OP=36 : _SHOW_AG["A13"] : End If 
   If OP=37 : _SHOW_AG["B13"] : End If 
   If OP=38 : _SHOW_AG["C13"] : End If 
End Proc
'
'----------------------------------------------------------------------------  
'   SHOW procedurer (Update special menus) 
'----------------------------------------------------------------------------  
'
Procedure _SHOWOBJADD
   _gt Gadgets Bank 499
   _gt Set Cycle 1,,OT
   W$=Catalog String$(101,"Type:")+" "
   If OT=0 : W$=W$+Peek$(LINK+$34D8+ALTO*20,20,Chr$(0))
   Else : W$=W$+Peek$(LINK+$57B0+20*OBTO,20,Chr$(0))
   End If 
   _gt Set Text 2,W$,,,
   For A=0 To 15
      If Btst(A,DLOCKED) : _gt Set Checkbox 20+A,1 : Else _gt Set Checkbox 20+A,0 : End If 
   Next 
   For A=0 To 15
      If Btst(A,LLOCKED) : _gt Set Checkbox 40+A,1 : Else _gt Set Checkbox 40+A,0 : End If 
   Next 
   _gt Set Cycle 5,,PERMCALC
   _gt Set Cycle 6,,UPORLO
   If OT=0
      _gt Set Text 7,Catalog String$(106,"Team:"),,,
      _gt Set Integer 17,TEAM
      _gt Set Text 8,Catalog String$(108,"Init Targ Cpt:")+" "+Str$(CONTPT),,,
   Else 
      _gt Set Text 7,Catalog String$(107,"Start Frame:"),,,
      _gt Set Integer 17,STRTANIM+1
      _gt Set Text 8," ",,,
   End If 
   _gt Set Integer 19,TXT
End Proc
Procedure _SHOWHEIGHTS
   _gt Gadgets Bank 499

   If CZ>-1
      For A=0 To 4
         If A=0 : W=UZH(CZ,1) : End If 
         If A=1 : W=UZH(CZ,0) : End If 
         If A=2 : W=ZH(CZ,1) : End If 
         If A=3 : W=ZH(CZ,0) : End If 
         If A=4 : W=ZH(CZ,2) : End If 
         If W=5000
            _gt Set Text A*10+17,Catalog String$(5,"<OFF>"),,,
            _gt Set Integer A*10+18,0
            _gt Set Slider A+6,0,0,9000,,""
         Else 
            If W>0
               W$="-"+Str$(Abs(W)/32)
            Else 
               W$=Str$(Abs(W)/32)
            End If 
            W$=(W$+"m"+Str$(((Abs(W) mod 32))*3))-" "
            _gt Set Text A*10+17,W$,,,
            _gt Set Integer A*10+18,W
            _gt Set Slider A+6,-W+5000,0,9000,,""
         End If 
      Next A
   Else 
      _gt Set Text 17,"?????",,,
      _gt Set Text 27,"?????",,,
      _gt Set Text 37,"?????",,,
      _gt Set Text 47,"?????",,,
      _gt Set Text 57,"?????",,,
      _gt Set Integer 18,0
      _gt Set Integer 28,0
      _gt Set Integer 38,0
      _gt Set Integer 48,0
      _gt Set Integer 58,0
      _gt Set Slider 6,0,0,9000,,""
      _gt Set Slider 7,0,0,9000,,""
      _gt Set Slider 8,0,0,9000,,""
      _gt Set Slider 9,0,0,9000,,""
      _gt Set Slider 10,0,0,9000,,""
   End If 
   If Btst(1,CMODE) : _gt Set Checkbox 15,1 : Else _gt Set Checkbox 15,0 : End If 
   If Btst(2,CMODE) : _gt Set Checkbox 25,1 : Else _gt Set Checkbox 25,0 : End If 
   If Btst(3,CMODE) : _gt Set Checkbox 35,1 : Else _gt Set Checkbox 35,0 : End If 
   If Btst(4,CMODE) : _gt Set Checkbox 45,1 : Else _gt Set Checkbox 45,0 : End If 
   If Btst(5,CMODE) : _gt Set Checkbox 55,1 : Else _gt Set Checkbox 55,0 : End If 

   'If AUTOSTAIR1=5000 : Vdialog$(2,10)=Catalog String$(115,"AutoStair:")+Catalog String$(5,"<OFF>") : Else : Vdialog$(2,10)=Catalog String$(115,"AutoStair:")+Right$(Space$(5)+Str$(AUTOSTAIR1+AUTOSTAIR2),5) : End If 
   'Dialog Update 2,61
   'If Btst(0,PRE1) 
   '   W$=Str$(-AUTOSTAIR2/32)+"m"+Str$(((Abs(AUTOSTAIR2) mod 32))*3)-" " 
   '   If Btst(0,AUTOSTAIR3) : Vdialog$(2,11)=Catalog String$(116,"Upper, Step:")+W$ : Else : Vdialog$(2,11)=Catalog String$(117,"Lower, Step:")+W$ : End If  
   'Else  
   '   If Btst(0,AUTOSTAIR3) : Vdialog$(2,11)=Catalog String$(116,"Upper, Step:")+Str$(AUTOSTAIR2) : Else : Vdialog$(2,11)=Catalog String$(117,"Lower, Step:")+Str$(AUTOSTAIR2) : End If  
   'End If  
End Proc
Procedure _SHOWWALLBRIGHT
   _gt Gadgets Bank 499
   If CZ>-1 and Between(-1,CCP,10)
      If OP=33
         _gt Set Integer 11,UWB(CZ,CCP)
      Else 
         _gt Set Integer 11,WB(CZ,CCP)
      End If 
   Else 
      _gt Set Integer 11,0
   End If 
End Proc
Procedure _SHOWBACKSFX
   _gt Gadgets Bank 499
   For A=0 To 31
      If CZ>-1
         If Btst(A,BSFX(CZ))
            _gt Set Checkbox A+10,1
         Else 
            _gt Set Checkbox A+10,0
         End If 
      Else 
         _gt Set Checkbox A+10,0
      End If 
   Next A
End Proc
Procedure _SHOWWATER
   _gt Gadgets Bank 499
   _gt Set Text 1,Catalog String$(130,"Water Anim Nr:")+Str$(NWA),,,
   _gt Set Integer 21,WATH(NWA)
End Proc
Procedure _SHOWDEFWALL
   If Btst(0,DWALL) : _gt Set Cycle 3,,1 : Else _gt Set Cycle 3,,0 : End If 
End Proc
Procedure _SHOWBRIGHTSLIDE
   _gt Gadgets Bank 499

   PBR=0 : PDTA=0 : PAN=0 : PBRF=0 : PDTAF=0 : PANF=0
   If CZ>-1
      If OP=10 and CP>-1
         For A=0 To ZP(CZ)-1
            If ZO(CZ,A)=CP : C=ZPBR(CZ,A,3) : PDTA=(C/$1000) and $F : PAN=(C/$100) and $F : PBR=C and $FF : C=ZPBR(CZ,A,2) : PDTAF=(C/$1000) and $F : PANF=(C/$100) and $F : PBRF=C and $FF : End If 
         Next 
         PBR=PBR+20 : PBR=PBR and $FF : PBR=PBR-20
         PBRF=PBRF+20 : PBRF=PBRF and $FF : PBRF=PBRF-20
      Else If OP=13 and CP>-1
         For A=0 To ZP(CZ)-1
            If ZO(CZ,A)=CP : C=ZPBR(CZ,A,1) : PDTA=(C/$1000) and $F : PAN=(C/$100) and $F : PBR=C and $FF : C=ZPBR(CZ,A,0) : PDTAF=(C/$1000) and $F : PANF=(C/$100) and $F : PBRF=C and $FF : End If 
         Next 
         PBR=PBR+20 : PBR=PBR and $FF : PBR=PBR-20
         PBRF=PBRF+20 : PBRF=PBRF and $FF : PBRF=PBRF-20
      End If 
   End If 
   _gt Set Text 1,Catalog String$(150,"Bright")+Str$(PBR),,,
   _gt Set Text 3,Catalog String$(151,"Anim")+Str$(PAN),,,
   _gt Set Text 5,Catalog String$(152,"Dist")+Str$(PDTA),,,
   _gt Set Slider 2,PBR+20,0,40,,""
   _gt Set Slider 4,PAN,0,16,,""
   _gt Set Slider 6,PDTA,0,16,,""
   _gt Set Text 11,Catalog String$(150,"Bright")+Str$(PBRF),,,
   _gt Set Text 13,Catalog String$(151,"Anim")+Str$(PANF),,,
   _gt Set Text 15,Catalog String$(152,"Dist")+Str$(PDTAF),,,
   _gt Set Slider 12,PBRF+20,0,40,,""
   _gt Set Slider 14,PANF,0,16,,""
   _gt Set Slider 16,PDTAF,0,16,,""
   If CMODE : _gt Set Image 19,GAD24(1),GAD24(0) : Else _gt Set Image 19,GAD24(0),GAD24(1) : End If 
End Proc
Procedure _SHOWDOOR
   ND=NDO
   _gt Gadgets Bank 499

   _gt Set Text 1,Catalog String$(160,"Door Num:")+Chr$(ND+65),,,
   _gt Set Integer 12,OPS(ND,2)
   _gt Set Integer 13,OPS(ND,0)

   If OPS(ND,3)>0 : _gt Set Text 4,Catalog String$(163,"Opening SFX:")+Left$(Dr File$(Peek$(LINK+$A40+(OPS(ND,3)-1)*64,64,Chr$(0))),11),,, : Else : _gt Set Text 4,Catalog String$(163,"Opening SFX:")+Catalog String$(5,"<OFF>"),,, : End If 
   If OPS(ND,5)>0 : _gt Set Text 5,Catalog String$(164,"Opened SFX :")+Left$(Dr File$(Peek$(LINK+$A40+(OPS(ND,5)-1)*64,64,Chr$(0))),11),,, : Else : _gt Set Text 5,Catalog String$(164,"Opened SFX :")+Catalog String$(5,"<OFF>"),,, : End If 
   _gt Set Integer 16,OPS(ND,1)
   If OPS(ND,4)>0 : _gt Set Text 7,Catalog String$(166,"Closing SFX:")+Left$(Dr File$(Peek$(LINK+$A40+(OPS(ND,4)-1)*64,64,Chr$(0))),11),,, : Else : _gt Set Text 7,Catalog String$(166,"Closing SFX:")+Catalog String$(5,"<OFF>"),,, : End If 
   If OPS(ND,6)>0 : _gt Set Text 8,Catalog String$(167,"Closed SFX :")+Left$(Dr File$(Peek$(LINK+$A40+(OPS(ND,6)-1)*64,64,Chr$(0))),11),,, : Else : _gt Set Text 8,Catalog String$(167,"Closed SFX :")+Catalog String$(5,"<OFF>"),,, : End If 
   _gt Set Cycle 9,,DRT(ND)
   _gt Set Cycle 10,,DLT(ND)
   If OPO<>ND
      F=False : WA=0 : WB=0
      For A=0 To NO-1
         S=Deek(Start(12)+A*32+4)
         T=Peek(Start(12)+A*32)
         If Btst(ND,S) and(T=1) : Bset 0,F : Inc WA : End If 
         If Btst(ND,S) and(T=0) : Bset 1,F : Inc WB : End If 
      Next A
      If F=1 : _gt Set Text 19,Catalog String$(170,"Locked by")+Str$(WA)+"*"+Catalog String$(12,"Object"),,,
      Else If F=2 : _gt Set Text 19,Catalog String$(170,"Locked by")+Str$(WB)+"*"+Catalog String$(11,"Alien"),,,
      Else If F=3 : _gt Set Text 19,Catalog String$(170,"Locked by")+Str$(WA)+"*"+Catalog String$(12,"Object")+"+"+Str$(WB)-" "+"*"+Catalog String$(11,"Alien"),,,
      Else : _gt Set Text 19,Catalog String$(171,"Not Locked"),,,
      End If 
   End If 
   OPO=ND
End Proc
Procedure _SHOWLIFT
   _gt Gadgets Bank 499
   _gt Set Text 1,Catalog String$(180,"Lift Num:")+" "+Chr$(NL+65),,,
   If LSP(NL)=0 : _gt Set Cycle 2,,0
   Else : _gt Set Cycle 2,,1
   End If 
   _gt Set Integer 13,LOPS(NL,0)
   If LOPS(NL,3)>0 : _gt Set Text 4,Catalog String$(183,"Raise SFX  :")+" "+Left$(Dr File$(Peek$(LINK+$A40+(LOPS(NL,3)-1)*64,64,Chr$(0))),11),,, : Else : _gt Set Text 4,Catalog String$(183,"Raise SFX  :")+Catalog String$(5,"<OFF>"),,, : End If 
   If LOPS(NL,5)>0 : _gt Set Text 5,Catalog String$(184,"At Top SFX :")+" "+Left$(Dr File$(Peek$(LINK+$A40+(LOPS(NL,5)-1)*64,64,Chr$(0))),11),,, : Else : _gt Set Text 5,Catalog String$(184,"At Top SFX :")+Catalog String$(5,"<OFF>"),,, : End If 
   _gt Set Integer 16,LOPS(NL,1)
   If LOPS(NL,4)>0 : _gt Set Text 7,Catalog String$(186,"Lower SFX  :")+" "+Left$(Dr File$(Peek$(LINK+$A40+(LOPS(NL,4)-1)*64,64,Chr$(0))),11),,, : Else : _gt Set Text 7,Catalog String$(186,"Lower SFX  :")+Catalog String$(5,"<OFF>"),,, : End If 
   If LOPS(NL,6)>0 : _gt Set Text 8,Catalog String$(187,"At Bot. SFX:")+" "+Left$(Dr File$(Peek$(LINK+$A40+(LOPS(NL,6)-1)*64,64,Chr$(0))),11),,, : Else : _gt Set Text 8,Catalog String$(187,"At Bot. SFX:")+Catalog String$(5,"<OFF>"),,, : End If 
   _gt Set Cycle 9,,LRT(NL)
   _gt Set Cycle 10,,LLT(NL)
   If CZ>-1
      If ZLI(CZ)=NL+1 and Btst(0,PRE1)
         _gt Set Text 11,Catalog String$(190,"Height of lift at top:")+Str$(-ZH(CZ,3)/32)+"m"+Str$(((Abs(ZH(CZ,3)) mod 32))*3)-" ",,,
      Else If ZLI(CZ)=NL+1
         _gt Set Text 11,Catalog String$(190,"Height of lift at top:")+Str$(ZH(CZ,3)),,,
      Else 
         _gt Set Text 11,Catalog String$(190,"Height of lift at top:")+Catalog String$(9,"N/A"),,,
      End If 
   Else 
      _gt Set Text 11,Catalog String$(190,"Height of lift at top:")+Catalog String$(9,"N/A"),,,
   End If 
   If OPO<>NL
      F=False : WA=0 : WB=0
      For A=0 To NO-1
         S=Deek(Start(12)+A*32+8)
         T=Peek(Start(12)+A*32)
         If Btst(NL,S) and(T=1) : Bset 0,F : Inc WA : End If 
         If Btst(NL,S) and(T=0) : Bset 1,F : Inc WB : End If 
      Next A
      If F=1 : _gt Set Text 19,Catalog String$(170,"Locked by")+Str$(WA)+"*"+Catalog String$(12,"Object"),,,
      Else If F=2 : _gt Set Text 19,Catalog String$(170,"Locked by")+Str$(WB)+"*"+Catalog String$(11,"Alien"),,,
      Else If F=3 : _gt Set Text 19,Catalog String$(170,"Locked by")+Str$(WA)+"*"+Catalog String$(12,"Object")+"+"+Str$(WB)-" "+"*"+Catalog String$(11,"Alien"),,,
      Else : _gt Set Text 19,Catalog String$(171,"Not Locked"),,,
      End If 
   End If 
   OPO=NL
End Proc
Procedure _SHOWDEFGFX[FULL]
   Shared W(),BFLX,BFLY,BROX,BROY
   Dim WGX(10),WGY(10),WGU(10)
   If OP=18 : LEV=1 : Else LEV=0 : End If 
   SRE=2
   If FULL
      Trap _wnd Id Use 3
      If Errtrap=0
         Trap _gt Gadgets Remove 499
         Trap _gt Gadgets Erase 499
      End If 
      _wnd Id Open 3,0,CANVASHEIGHT-256,344,256,$2,F_IDCMP,0,""
      _wnd Id Titles BUT$(OP),VER$
      For A=0 To 10 : W(A,0)=0 : W(A,1)=0 : LW(A)=-1 : Next A
      LRO=-1 : LGU=-1
      If CZ<0 : Pop Proc : End If 
      If USED(CZ)=0 : Pop Proc : End If 
      '
      ' Base cords 
      '
      B=ZP(CZ)-1 : A=0
      BROX=4
      BROY=148/SRE
      BFLX=4
      BFLY=260/SRE
      WGX(0)=0 : WGY(0)=0
      WGX(1)=128 : WGY(1)=0
      WGX(2)=256 : WGY(2)=0
      WGX(3)=384 : WGY(3)=0
      WGX(4)=512 : WGY(4)=0
      WGX(5)=0 : WGY(5)=384
      WGX(6)=128 : WGY(6)=384
      WGX(7)=256 : WGY(7)=384
      WGX(8)=384 : WGY(8)=384
      WGX(9)=512 : WGY(9)=384
      For A=0 To 9
         WGX(A)=WGX(A)/SRE+4
         WGY(A)=WGY(A)/SRE+14
      Next A
      WGU=False

      MXX=480/SRE : MXY=216/SRE
      WBX=-$8000 : WBY=-$8000 : WSX=-WBX : WSY=-WBY
      WXO=128/SRE : WYO=(136+12)/SRE
      For A=0 To ZP(CZ)
         If PX(ZO(CZ,A))>WBX : WBX=PX(ZO(CZ,A)) : End If 
         If PX(ZO(CZ,A))<WSX : WSX=PX(ZO(CZ,A)) : End If 
         If PY(ZO(CZ,A))>WBY : WBY=PY(ZO(CZ,A)) : End If 
         If PY(ZO(CZ,A))<WSY : WSY=PY(ZO(CZ,A)) : End If 
      Next 
      WXS=WBX-WSX : WYS=WBY-WSY
      SCL=Max((WXS*10000)/(MXX),(WYS*10000)/(MXY))
      WXO=WXO+(MXX-(WXS*10000)/SCL)/2
      WYO=WYO+(MXY-(WYS*10000)/SCL)/2
      '
      ' Draw zone on window..
      '
      _wnd Id Gr Locate((PX(ZO(CZ,0))-WSX)*10000)/SCL+WXO,((PY(ZO(CZ,0))-WSY)*10000)/SCL+WYO
      For A=1 To ZP(CZ)
         If WT(CZ,A-1)=1 : _wnd Id Ink D_INK(5),D_INK(5),D_INK(5)
         Else If WT(CZ,A-1)=5 : _wnd Id Ink D_INK(9),D_INK(9),D_INK(9)
         Else If WT(CZ,A-1)=2 : _wnd Id Ink D_INK(9),D_INK(9),D_INK(9)
         Else : _wnd Id Ink D_INK(1),D_INK(1),D_INK(1)
         End If 
         WA=A
         WX=((PX(ZO(CZ,WA))-WSX)*10000)/SCL
         WY=((PY(ZO(CZ,WA))-WSY)*10000)/SCL
         _wnd Id Line To WX+WXO,WY+WYO
      Next A
      '
      ' Draw lines to GFX's
      '
      For A=0 To ZP(CZ)-1
         WA=A
         WX=((PX(ZO(CZ,WA))-WSX)*10000)/SCL
         WY=((PY(ZO(CZ,WA))-WSY)*10000)/SCL
         _wnd Id Ink D_INK(1),D_INK(1),D_INK(1)
         _wnd Id Ellipse WX+WXO,WY+WYO,6/SRE,6/SRE
         WXC=((PX(ZO(CZ,WA))-PX(ZO(CZ,WA+1)))/2*10000)/SCL
         WYC=((PY(ZO(CZ,WA))-PY(ZO(CZ,WA+1)))/2*10000)/SCL
         D=$FFFFF
         For B=0 To 9
            DX=(WX-WXC+WXO)-(WGX(B)+64/SRE)
            DY=(WY-WYC+WYO)-(WGY(B)+32/SRE)
            DN=DX^2+DY^2
            If(D>DN) and(WGU(B)=False)
               D=DN : DG=B
            End If 
         Next B
         WGU(DG)=True
         W(A,0)=WGX(DG) : W(A,1)=WGY(DG)
         _wnd Id Ink D_INK(1),D_INK(1),D_INK(1)
         _wnd Id Line WX-WXC+WXO,WY-WYC+WYO To W(A,0)+64/SRE,W(A,1)+32/SRE
      Next A
      '
      ' Gadgets
      '
      B=10 : H=9
      Reserve As Gt Gadgets 499,160,1
      _gt Set Mode 0,"",0,1
      _gt Image 2,6+BFLX,BFLY+32/YRES,1,GAD10(2),GAD10(3)
      _gt Image 4,6+BFLX+B,BFLY+32/YRES,1,GAD10(4),GAD10(5)
      _gt Image 9,6+BFLX,BFLY+32/YRES+H,1,GAD10(8),GAD10(9)
      _gt Image 7,6+BFLX+B,BFLY+32/YRES+H,1,GAD10(10),GAD10(11)
      _gt Image 2+12,6+BROX,BROY+32/YRES,1,GAD10(2),GAD10(3)
      _gt Image 4+12,6+BROX+B,BROY+32/YRES,1,GAD10(4),GAD10(5)
      _gt Image 9+12,6+BROX,BROY+32/YRES+H,1,GAD10(8),GAD10(9)
      _gt Image 7+12,6+BROX+B,BROY+32/YRES+H,1,GAD10(10),GAD10(11)
      For A=0 To ZP(CZ)-1
         _gt Image A*12+24+1,2+W(A,0),W(A,1)+32/YRES,1,GAD10(0),GAD10(1)
         _gt Image A*12+24+6,2+W(A,0)+B,W(A,1)+32/YRES,1,GAD10(16),GAD10(17)
         _gt Image A*12+24+2,2+W(A,0)+B*2,W(A,1)+32/YRES,1,GAD10(2),GAD10(3)
         _gt Image A*12+24+4,2+W(A,0)+B*3,W(A,1)+32/YRES,1,GAD10(4),GAD10(5)
         _gt Image A*12+24+10,2+W(A,0)+B*4,W(A,1)+32/YRES,1,GAD10(18),GAD10(19)
         _gt Image A*12+24+5,2+W(A,0)+B*5,W(A,1)+32/YRES,1,GAD10(6),GAD10(7)
         _gt Image A*12+24+9,2+W(A,0)+B,W(A,1)+32/YRES+H,1,GAD10(8),GAD10(9)
         _gt Image A*12+24+7,2+W(A,0)+B*2,W(A,1)+32/YRES+H,1,GAD10(10),GAD10(11)
         _gt Image A*12+24+3,2+W(A,0)+B*3,W(A,1)+32/YRES+H,1,GAD10(12),GAD10(13)
         _gt Image A*12+24+8,2+W(A,0)+B*4,W(A,1)+32/YRES+H,1,GAD10(14),GAD10(15)
      Next A
      CCC=-1 : For A=0 To 10 : LW(A)=-1 : Next A : LRO=-1 : LGU=-1
      _gt Gadgets Attach 499
   End If 
   If CZ<0 : Pop Proc : End If 
   If USED(CZ)=0 : Pop Proc : End If 
   _wnd Id Use 3
   STQ=1
   If Btst(8,PRE1) : STQ=2 : End If 
   '
   ' draw roof  
   '
   ADR=Start(700)
   If LEV=0
      RER=ZRG(CZ,0)
      ZRGS=ZRG(CZ,1)
   Else 
      RER=UZRG(CZ,0)
      ZRGS=UZRG(CZ,1)
   End If 
   If LRO<>RER
      WXO=BROX : WYO=BROY
      If RER=16
         _wnd Id Ink 9,9,9
         _wnd Id Bar WXO,WYO To WXO+31,WYO+31/YRES
      Else 
         _wnd Id Ink 0,0,0 : _wnd Id Bar WXO,WYO To WXO+31,WYO+31/YRES
         S=ADR+(RER mod 4)+((RER/4) and 3)*256
         For WX=0 To 31 Step STQ
            For WY=0 To 31/YRES Step STQ
               C=CO(Peek(S+WX*8+WY*2048*YRES))
               _wnd Id Ink C,C,C
               _wnd Id Plot WX+WXO,WY+WYO
            Next WY
         Next WX
      End If 
      LRO=RER
      _wnd Id Ink D_INK(5),D_INK(0),D_INK(0)
      _wnd Id Text WXO,WYO+6,Str$(ZRGS)-" "
   End If 
   '
   ' draw floor 
   '
   If LEV=0
      REF=ZFG(CZ,0)
      ZFGS=ZFG(CZ,1)
   Else 
      REF=UZFG(CZ,0)
      ZFGS=UZFG(CZ,1)
   End If 
   If LGU<>REF
      WXO=BFLX : WYO=BFLY
      _wnd Id Ink 0,0,0 : _wnd Id Bar WXO,WYO To WXO+31,WYO+31/YRES
      S=ADR+(REF mod 4)+((REF/4) and 3)*256
      For WX=0 To 31 Step STQ
         For WY=0 To 31/YRES Step STQ
            C=CO(Peek(S+WX*8+WY*2048*YRES))
            _wnd Id Ink C,C,C
            _wnd Id Plot WX+WXO,WY+WYO
         Next WY
      Next WX
      LGU=REF
      _wnd Id Ink D_INK(5),D_INK(0),D_INK(0)
      _wnd Id Text WXO,WYO+6,Str$(ZFGS)-" "
   End If 

   For A=0 To ZP(CZ)-1
      WXO=W(A,0) : WYO=W(A,1)
      If LEV=0
         WGW=ZWG(CZ,A,3) : ZWG=ZWG(CZ,A,0)
         ZWGL=ZWG(CZ,A,1) : ZWGC=ZWG(CZ,A,2)
      Else 
         WGW=UZWG(CZ,A,3) : ZWG=UZWG(CZ,A,0)
         ZWGL=UZWG(CZ,A,1) : ZWGC=UZWG(CZ,A,2)
      End If 
      If LW(A)<>ZWG
         _wnd Id Ink I(1),I(1),I(1) : _wnd Id Bar WXO,WYO To WXO+63,WYO+31/YRES
         Trap ADR=Start(701+ZWGC)
         If Errtrap=0
            WGH=Deek(LINK+$14B60+ZWGC*2) : TS=Max(4,WGH/(128/YRES))
            LG=ZWG+100 : LS=ZWG : LWGW=WGW+100 : XL=LS
            TW=ADR+64*32 : ZIP=(XL*16)/TS
            For WA=ZIP To ZIP+WGW/TS-1 Step STQ
               F=TW+(WA/3)*WGH*2*TS
               If WA mod 3=0
                  For B=0 To Min(32,WGH/TS)/YRES-1 Step STQ
                     C=CO(Peek(ADR+(Deek(F+B*2*TS*YRES) and 31)*2))
                     _wnd Id Ink C,C,C
                     _wnd Id Plot WXO+WA-ZIP,WYO+B
                  Next 
               End If 
               If WA mod 3=1
                  For B=0 To Min(32,WGH/TS)/YRES-1 Step STQ
                     C=CO(Peek(ADR+((Deek(F+B*2*TS*YRES)/32) and 31)*2))
                     _wnd Id Ink C,C,C
                     _wnd Id Plot WXO+WA-ZIP,WYO+B
                  Next 
               End If 
               If WA mod 3=2
                  For B=0 To Min(32,WGH/TS)/YRES-1 Step STQ
                     C=CO(Peek(ADR+((Deek(F+B*2*TS*YRES)/1024) and 31)*2))
                     _wnd Id Ink C,C,C
                     _wnd Id Plot WXO+WA-ZIP,WYO+B
                  Next 
               End If 
            Next 
         Else 
            'Ink 0,0,0 : Bar WXO,WYO To WXO+63,WYO+31
            'Ink 23,0,0 : Text WXO+16,WYO+18,"????"
         End If 
         _wnd Id Ink D_INK(5),D_INK(0),D_INK(0)
         If ZWGL=1
            _wnd Id Text WXO,WYO+6,"L+"
         Else If ZWGL=2
            _wnd Id Text WXO,WYO+6,"L-"
         End If 
         LW(A)=ZWG
      End If 
   Next A
End Proc
Procedure _SHOWDEFGRAPH
   _wnd Id Use 3
   If ZWGC<>LWCHUNK-200
      Do 
         If Not Btst(17,PRE1) : Erase 701+LWCHUNCK-200 : End If 
         LWCHUNK=ZWGC+200
         If Length(701+ZWGC)<100
            _LOAD[701+ZWGC,Peek$(LINK+$14760+ZWGC*64,64,Chr$(0))]
         End If 
         If Length(701+ZWGC)=0 and ZWGC>0 : Dec ZWGC : Else : Exit : End If 
      Loop 
      LG=-200
   End If 
   If ZWG<>(LG-100) or(LWGW-100)<>WGW
      STQ=1
      If Btst(8,PRE1) : STQ=2 : End If 
      WXO=12 : WYO=12

      _wnd Id Ink I(1),I(1),I(1) : _wnd Id Bar WXO,WYO To WXO+127,WYO+63/YRES
      Trap ADR=Start(701+ZWGC)
      If Errtrap=0
         WGH=Deek(LINK+$14B60+ZWGC*2) : TS=Max(2,WGH/(128/YRES))
         LG=ZWG+100 : LS=ZWG : LWGW=WGW+100 : XL=LS
         TW=ADR+64*32 : ZIP=(XL*16)/TS
         For WA=ZIP To ZIP+WGW/TS-1 Step STQ
            F=TW+(WA/3)*WGH*2*TS
            If WA mod 3=0
               For B=0 To Min(64,WGH/TS)/YRES-1 Step STQ
                  C=CO(Peek(ADR+(Deek(F+B*2*TS*YRES) and 31)*2))
                  _wnd Id Ink C,C,C
                  _wnd Id Plot WXO+WA-ZIP,WYO+B
               Next 
            End If 
            If WA mod 3=1
               For B=0 To Min(64,WGH/TS)/YRES-1 Step STQ
                  C=CO(Peek(ADR+((Deek(F+B*2*TS*YRES)/32) and 31)*2))
                  _wnd Id Ink C,C,C
                  _wnd Id Plot WXO+WA-ZIP,WYO+B
               Next 
            End If 
            If WA mod 3=2
               For B=0 To Min(64,WGH/TS)/YRES-1 Step STQ
                  C=CO(Peek(ADR+((Deek(F+B*2*TS*YRES)/1024) and 31)*2))
                  _wnd Id Ink C,C,C
                  _wnd Id Plot WXO+WA-ZIP,WYO+B
               Next 
            End If 
         Next 
      End If 
   End If 
   _wnd Id Ink D_INK(5),D_INK(0),D_INK(0)
   If ZWGL=1
      _wnd Id Text WXO,WYO+6,"L+"
   Else If ZWGL=2
      _wnd Id Text WXO,WYO+6,"L-"
   End If 
End Proc
Procedure _SHOWDEFROOFGRAPH
   _wnd Id Use 3
   If(OZRG<>ZRG) or RB<>RBO or(OZRGS<>ZRGS)
      STQ=1
      If Btst(8,PRE1) : STQ=2 : End If 
      OZRG=ZRG : RBO=RB : OZRGS=ZRGS
      WXO=12 : WYO=12
      If ZRG=16
         _wnd Id Ink 9,9,9
         _wnd Id Bar WXO,WYO To WXO+63,WYO+63
      Else 
         _wnd Id Ink 0,0,0 : _wnd Id Bar WXO,WYO To WXO+63,WYO+63/YRES
         S=Start(700)+(ZRG mod 4)+(ZRG/4)*256
         For WX=0 To 63 Step STQ
            For WY=0 To 63/YRES Step STQ
               C=CO(Peek(S+WX*4+WY*1024*YRES))
               _wnd Id Ink C,C,C
               _wnd Id Plot WX+WXO,WY+WYO
            Next WY
         Next WX
      End If 
      _wnd Id Ink D_INK(5),D_INK(0),D_INK(0)
      _wnd Id Text WXO,WYO+6,Str$(ZRGS)-" "
   End If 
End Proc
Procedure _SHOWDEFFLOORGRAPH
   _wnd Id Use 3
   If(ZFG<>OZFG) or OFB<>FB or(OZFGS<>ZFGS)
      STQ=1
      If Btst(8,PRE1) : STQ=2 : End If 
      OZFG=ZFG : OFB=FB : OZFGS=ZFGS
      WXO=12 : WYO=12
      S=Start(700)+(ZFG mod 4)+(ZFG/4)*256
      _wnd Id Ink 0,0,0 : _wnd Id Bar WXO,WYO To WXO+63,WYO+63/YRES
      For WX=0 To 63 Step STQ
         For WY=0 To 63/YRES Step STQ
            C=CO(Peek(S+WX*4+WY*1024*YRES))
            _wnd Id Ink C,C,C
            _wnd Id Plot WX+WXO,WY+WYO
         Next WY
      Next WX
      LGU=REF
      _wnd Id Ink D_INK(5),D_INK(0),D_INK(0)
      _wnd Id Text WXO,WYO+6,Str$(ZFGS)-" "
   End If 
End Proc
'
'----------------------------------------------------------------------------  
'   COND Procedurer (Special menu checkers)
'----------------------------------------------------------------------------  
'
Procedure _IPICKLBUTTON
   If OP=2 : _COND_ADDOBJ : End If 
   If OP=4 : _COND_DEFWALL : End If 
   If OP=10 : _COND_BRIGHTSLIDE : End If 
   If OP=13 : _COND_BRIGHTSLIDE : End If 
   If OP=14 : _COND_DEFDOOR : End If 
   If OP=17 : _COND_DEFLIFT : End If 
   If OP=18 : _COND_DEFGFX : End If 
   If OP=19 : _COND_DEFGFX : End If 
   If OP=21 : _COND_DEFROOFGRAPH : End If 
   If OP=22 : _COND_DEFGRAPH : End If 
   If OP=23 : _COND_DEFFLOORGRAPH : End If 
   If OP=24 : _COND_DEFROOFGRAPH : End If 
   If OP=25 : _COND_DEFGRAPH : End If 
   If OP=26 : _COND_DEFFLOORGRAPH : End If 
   If OP=27 : _COND_DEFHEIGHTS : End If 
   If OP=30 : _COND_DEFWATER : End If 
   If OP=33 : _COND_DEFWALLBRIGHT : End If 
   If OP=34 : _COND_DEFWALLBRIGHT : End If 
   If OP=36 : _COND_DEFBACKSFX : End If 
End Proc
'
Procedure _COND_DEFGFX
   GA=_wnd Id Event Gadget
   If OP=18 : LEV=1 : Else LEV=0 : End If 

   CCC=(GA/12)-2 : RE=False
   CH=GA mod 12
   If CH=2
      If LEV=0
         If CCC=-1 and ZRG(CZ,0)>0 : Dec ZRG(CZ,0) : RE=True : End If 
         If CCC=-2 and ZFG(CZ,0)>0 : Dec ZFG(CZ,0) : RE=True : End If 
         If CCC>-1
            If ZWG(CZ,CCC,0)>0 : LW(CCC)=-1 : Dec ZWG(CZ,CCC,0) : RE=True
            Else : ZWG(CZ,CCC,0)=0 : RE=True
            End If 
         End If 
      Else 
         If CCC=-1 and UZRG(CZ,0)>0 : Dec UZRG(CZ,0) : RE=True : End If 
         If CCC=-2 and UZFG(CZ,0)>0 : Dec UZFG(CZ,0) : RE=True : End If 
         If CCC>-1
            If UZWG(CZ,CCC,0)>0 : LW(CCC)=-1 : Dec UZWG(CZ,CCC,0) : RE=True
            Else : UZWG(CZ,CCC,0)=0 : RE=True
            End If 
         End If 
      End If 
   Else If CH=4
      If LEV=0
         If CCC=-1 and ZRG(CZ,0)<16 : Inc ZRG(CZ,0) : RE=True : End If 
         If CCC=-2 and ZFG(CZ,0)<15 : Inc ZFG(CZ,0) : RE=True : End If 
         If CCC>-1 : LW(CCC)=-1 : Inc ZWG(CZ,CCC,0) : RE=True : End If 
      Else 
         If CCC=-1 and UZRG(CZ,0)<16 : Inc UZRG(CZ,0) : RE=True : End If 
         If CCC=-2 and UZFG(CZ,0)<15 : Inc UZFG(CZ,0) : RE=True : End If 
         If CCC>-1 : LW(CCC)=-1 : Inc UZWG(CZ,CCC,0) : RE=True : End If 
      End If 
   Else If CH=1
      If LEV=0
         If CCC>-1
            If ZWG(CZ,CCC,2)>0 : Dec ZWG(CZ,CCC,2) : LW(CCC)=-1 : RE=True : End If 
         End If 
      Else 
         If CCC>-1
            If UZWG(CZ,CCC,2)>0 : Dec UZWG(CZ,CCC,2) : LW(CCC)=-1 : RE=True : End If 
         End If 
      End If 
   Else If CH=5
      If LEV=0
         If CCC>-1
            If ZWG(CZ,CCC,2)<15 : Inc ZWG(CZ,CCC,2) : LW(CCC)=-1 : RE=True : End If 
         End If 
      Else 
         If CCC>-1
            If UZWG(CZ,CCC,2)<15 : Inc UZWG(CZ,CCC,2) : LW(CCC)=-1 : RE=True : End If 
         End If 
      End If 
   Else If CH=10
      If LEV=0
         If CCC>-1
            Trap T=Length(701+ZWG(CZ,CCC,2))
            If Errtrap=0
               WGH=Deek(Start(701+ZWG(CZ,CCC,2))+T-2)
               WGWW=(((T-(64*32)-2)/WGH)*3)/2
               LW(CCC)=-1
               ZWG(CZ,CCC,0)=Max(0,(WGWW-ZWG(CZ,CCC,3))/16) : RE=True
            End If 
         End If 
      Else 
         If CCC>-1
            Trap T=Length(701+UZWG(CZ,CCC,2))
            If Errtrap=0
               WGH=Deek(Start(701+UZWG(CZ,CCC,2))+T-2)
               WGWW=(((T-(64*32)-2)/WGH)*3)/2
               LW(CCC)=-1
               UZWG(CZ,CCC,0)=Max(0,(WGWW-UZWG(CZ,CCC,3))/16) : RE=True
            End If 
         End If 
      End If 
   Else If CH=6
      If LEV=0
         If CCC>-1
            LW(CCC)=-1
            ZWG(CZ,CCC,0)=0 : RE=True
         End If 
      Else 
         If CCC>-1
            LW(CCC)=-1
            UZWG(CZ,CCC,0)=0 : RE=True
         End If 
      End If 
   Else If CH=7
      If LEV=0
         If CCC=-1 and ZRG(CZ,1)>-5 : Dec ZRG(CZ,1) : LRO=-1 : RE=True : End If 
         If CCC=-2 and ZFG(CZ,1)>-5 : Dec ZFG(CZ,1) : LGU=-1 : RE=True : End If 
         If CCC>-1
            If ZWG(CZ,CCC,3)>2 : ZWG(CZ,CCC,3)=ZWG(CZ,CCC,3)/2 : LW(CCC)=-1 : RE=True
            Else : ZWG(CZ,CCC,3)=2 : LW(CCC)=-1 : RE=True
            End If 
         End If 
      Else 
         If CCC=-1 and UZRG(CZ,1)>-5 : Dec UZRG(CZ,1) : LRO=-1 : RE=True : End If 
         If CCC=-2 and UZFG(CZ,1)>-5 : Dec UZFG(CZ,1) : LGU=-1 : RE=True : End If 
         If CCC>-1
            If UZWG(CZ,CCC,3)>2 : UZWG(CZ,CCC,3)=UZWG(CZ,CCC,3)/2 : LW(CCC)=-1 : RE=True
            Else : UZWG(CZ,CCC,3)=2 : LW(CCC)=-1 : RE=True
            End If 
         End If 
      End If 
   Else If CH=9
      If LEV=0
         If CCC=-1 and ZRG(CZ,1)<5 : Inc ZRG(CZ,1) : LRO=-1 : RE=True : End If 
         If CCC=-2 and ZFG(CZ,1)<5 : Inc ZFG(CZ,1) : LGU=-1 : RE=True : End If 
         If CCC>-1
            If ZWG(CZ,CCC,3)<256 : ZWG(CZ,CCC,3)=ZWG(CZ,CCC,3)*2 : LW(CCC)=-1 : RE=True
            Else : ZWG(CZ,CCC,3)=256 : LW(CCC)=-1 : RE=True
            End If 
         End If 
      Else 
         If CCC=-1 and UZRG(CZ,1)<5 : Inc UZRG(CZ,1) : LRO=-1 : RE=True : End If 
         If CCC=-2 and UZFG(CZ,1)<5 : Inc UZFG(CZ,1) : LGU=-1 : RE=True : End If 
         If CCC>-1
            If UZWG(CZ,CCC,3)<256 : UZWG(CZ,CCC,3)=UZWG(CZ,CCC,3)*2 : LW(CCC)=-1 : RE=True
            Else : UZWG(CZ,CCC,3)=256 : LW(CCC)=-1 : RE=True
            End If 
         End If 
      End If 
   Else If CH=3
      Gosub S_GFX_2
   Else If CH=8
      Gosub S_GFX_1
   Else If W$="f"
      Gosub S_GFX_F
   End If 
   If RE : _SHOWDEFGFX[False] : End If 
Pop Proc

S_GFX_2:
   E=False
   If LEV=0
      If CCC>-1
         If ZWG(CZ,CCC,1)=0
            ZWG(CZ,CCC,1)=1 : LW(CCC)=-1 : RE=True
         Else 
            ZWG(CZ,CCC,1)=0 : LW(CCC)=-1 : RE=True
         End If 
      End If 
   Else 
      If CCC>-1
         If UZWG(CZ,CCC,1)=0
            UZWG(CZ,CCC,1)=1 : LW(CCC)=-1 : RE=True
         Else 
            UZWG(CZ,CCC,1)=0 : LW(CCC)=-1 : RE=True
         End If 
      End If 
   End If 
Return 
S_GFX_1:
   E=False
   If LEV=0
      If CCC>-1
         If ZWG(CZ,CCC,1)=0
            ZWG(CZ,CCC,1)=2 : LW(CCC)=-1 : RE=True
         Else 
            ZWG(CZ,CCC,1)=0 : LW(CCC)=-1 : RE=True
         End If 
      End If 
   Else 
      If CCC>-1
         If UZWG(CZ,CCC,1)=0
            UZWG(CZ,CCC,1)=2 : LW(CCC)=-1 : RE=True
         Else 
            UZWG(CZ,CCC,1)=0 : LW(CCC)=-1 : RE=True
         End If 
      End If 
   End If 
Return 
S_GFX_F:
   E=False
   If LEV=0
      If CCC>-1
         For A=0 To ZP(CZ)-1
            For B=0 To 3
               ZWG(CZ,A,B)=ZWG(CZ,CCC,B)
            Next B
            LW(A)=-1
         Next A
         RE=True
      End If 
   Else 
      If CCC>-1
         For A=0 To ZP(CZ)-1
            For B=0 To 3
               UZWG(CZ,A,B)=UZWG(CZ,CCC,B)
            Next B
            LW(A)=-1
         Next A
         RE=True
      End If 
   End If 
Return 
End Proc
Procedure _COND_DEFDOOR
   WNDO=NDO : OPO=-1
   C=_wnd Id Event Gadget
   _gt Gadgets Bank 499
   If C=0 : Pop Proc
   Else If C=12 : OPS(NDO,2)=_gt What Integer(12)
   Else If C=13 : OPS(NDO,0)=Range(_gt What Integer(13),0 To 255)
   Else If C=34 : _SELSFX[1,""] : OPS(NDO,3)=Param
   Else If C=35 : _SELSFX[1,""] : OPS(NDO,5)=Param
   Else If C=16 : OPS(NDO,1)=Range(_gt What Integer(16),0 To 255)
   Else If C=37 : _SELSFX[1,""] : OPS(NDO,4)=Param
   Else If C=38 : _SELSFX[1,""] : OPS(NDO,6)=Param
   Else If C=9 : Add DRT(NDO),1,0 To 5
   Else If C=10 : Add DLT(NDO),1,0 To 1
   Else If C=21 : Add NDO,-1,0 To 15
   Else If C=22 : Add NDO,1,0 To 15
   Else If C=23
      NDOX=NDO : Add NDOX,-1,0 To 15
      DRT(NDOX)=DRT(NDO) : DLT(NDOX)=DLT(NDO)
      For A=0 To 6 : OPS(NDOX,A)=OPS(NDO,A) : Next A
      NDO=NDOX
   Else If C=24
      NDOX=NDO : Add NDOX,1,0 To 15
      DRT(NDOX)=DRT(NDO) : DLT(NDOX)=DLT(NDO)
      For A=0 To 6 : OPS(NDOX,A)=OPS(NDO,A) : Next A
      NDO=NDOX
   Else If C=25 and CZ>-1
      E=False
      For A=0 To NZ
         If ZD(A)=NDO+1 and A<>CZ : E=True : End If 
      Next A
      If E : _WRONG[0,1]
      Else If ZD(CZ)>0 : _WRONG[0,2]
      Else If ZLI(CZ)>0 : _WRONG[0,3]
      Else : ZD(CZ)=NDO+1 : CZ2=CZ : _REDRAW
      End If 
   Else If C=26 and CZ>-1 : If ZD(CZ)=NDO+1 : ZD(CZ)=0 : CZ2=-1 : _REDRAW : End If 
   End If 
   If NDO<>WNDO
      If CZ>-1 : _ZOSHOW[CZ,4] : End If 
      For A=0 To NZ : If ZD(A)=NDO+1 : CZ=A : CZ2=CZ : End If : Next A
      If CZ>-1 : _ZOSHOW[CZ,10] : End If 
   End If 
   _SHOWDOOR
End Proc
Procedure _COND_DEFLIFT
   WNL=NL : OPO=-1
   C=_wnd Id Event Gadget
   _gt Gadgets Bank 499
   If _wnd Id Event Qualifier and %111 : D=32 : Else : D=1 : End If 
   If C=0 : Pop Proc
   Else If C=2 : LSP(NL)=1-LSP(NL)
   Else If C=13 : LOPS(NL,0)=Range(_gt What Integer(13),0 To 255)
   Else If C=44 : _SELSFX[1,""] : LOPS(NL,3)=Param
   Else If C=45 : _SELSFX[1,""] : LOPS(NL,5)=Param
   Else If C=16 : LOPS(NL,1)=Range(_gt What Integer(16),0 To 255)
   Else If C=47 : _SELSFX[1,""] : LOPS(NL,4)=Param
   Else If C=48 : _SELSFX[1,""] : LOPS(NL,6)=Param
   Else If C=9 : Add LRT(NL),1 : If LR$(LRT(NL))="" : LRT(NL)=0 : End If 
   Else If C=10 : Add LLT(NL),1 : If LL$(LLT(NL))="" : LLT(NL)=0 : End If 
   Else If C=20 : D1=1 : Pop Proc
   Else If C=21 : Add NL,-1,0 To 15
   Else If C=22 : Add NL,1,0 To 15
   Else If C=23
      NLX=NL : Add NLX,-1,0 To 15
      LRT(NLX)=LRT(NL) : LLT(NLX)=LLT(NL)
      For AA=0 To 6 : LOPS(NLX,AA)=LOPS(NL,AA) : Next 
      LSP(NLX)=LSP(NL) : NL=NLX
   Else If C=24
      NLX=NL : Add NLX,1,0 To 15
      LRT(NLX)=LRT(NL) : LLT(NLX)=LLT(NL)
      For AA=0 To 6 : LOPS(NLX,AA)=LOPS(NL,AA) : Next 
      LSP(NLX)=LSP(NL) : NL=NLX
   Else If C=31 and ZLI(CZ)=NL+1 : ZH(CZ,3)=Range(ZH(CZ,3)+8*D,-4000 To 4999)
   Else If C=32 and ZLI(CZ)=NL+1 : ZH(CZ,3)=Range(ZH(CZ,3)+1*D,-4000 To 4999)
   Else If C=33 and ZLI(CZ)=NL+1 : ZH(CZ,3)=Range(ZH(CZ,3)-1*D,-4000 To 4999)
   Else If C=34 and ZLI(CZ)=NL+1 : ZH(CZ,3)=Range(ZH(CZ,3)-8*D,-4000 To 4999)
   Else If C=25 and CZ>-1
      E=False
      For A=0 To NZ
         If ZLI(A)=NL+1 and A<>CZ : E=True : End If 
      Next A
      If E : _WRONG[0,0]
      Else If ZD(CZ)<>0 : _WRONG[0,2]
      Else If ZLI(CZ)<>0 : _WRONG[0,3]
      Else : ZLI(CZ)=NL+1 : CZ2=CZ : _REDRAW
      End If 
   Else If C=26 and CZ>-1 : If ZLI(CZ)=NL+1 : ZLI(CZ)=0 : CZ2=-1 : _REDRAW : End If 
   End If 
   If NL<>WNL
      If CZ>-1 : _ZOSHOW[CZ,4] : End If 
      For A=0 To NZ : If ZLI(A)=NL+1 : CZ=A : CZ2=CZ : End If : Next A
      If CZ>-1 : _ZOSHOW[CZ,10] : End If 
   End If 
   _SHOWLIFT
End Proc
Procedure _COND_DEFHEIGHTS
   _gt Gadgets Bank 499
   C=_wnd Id Event Gadget
   E=_wnd Id Event Code
   If _wnd Id Event Qualifier and %111 : D=32 : Else : D=1 : End If 
   M=0

   If CZ>-1
      If C=6 : UZH(CZ,1)=-(E-5000) : End If 
      If C=7 : UZH(CZ,0)=-(E-5000) : End If 
      If C=8 : ZH(CZ,1)=-(E-5000) : End If 
      If C=9 : ZH(CZ,0)=-(E-5000) : End If 
      If C=10 : ZH(CZ,2)=-(E-5000) : End If 
      If C=11 : UZH(CZ,1)=Range(UZH(CZ,1)-8*D,-4000 To 5000) : End If 
      If C=12 : UZH(CZ,1)=Range(UZH(CZ,1)-1*D,-4000 To 5000) : End If 
      If C=13 : UZH(CZ,1)=Range(UZH(CZ,1)+1*D,-4000 To 5000) : End If 
      If C=14 : UZH(CZ,1)=Range(UZH(CZ,1)+8*D,-4000 To 5000) : End If 
      If C=15 : Bchg 1,CMODE : End If 
      If C=16 : _SURE["",Catalog String$(1800,"Copy U-Roof Height To All Zones ?")] : If Param : For A=0 To NZ : UZH(A,1)=UZH(CZ,1) : Next A : _REDRAW : End If : End If 
      If C=18 : UZH(CZ,1)=Range(_gt What Integer(18),-4000 To 5000) : End If 

      If C=21 : UZH(CZ,0)=Range(UZH(CZ,0)-8*D,-4000 To 5000) : End If 
      If C=22 : UZH(CZ,0)=Range(UZH(CZ,0)-1*D,-4000 To 5000) : End If 
      If C=23 : UZH(CZ,0)=Range(UZH(CZ,0)+1*D,-4000 To 5000) : End If 
      If C=24 : UZH(CZ,0)=Range(UZH(CZ,0)+8*D,-4000 To 5000) : End If 
      If C=25 : Bchg 2,CMODE : End If 
      If C=26 : _SURE["",Catalog String$(1801,"Copy U-Floor Height To All Zones ?")] : If Param : For A=0 To NZ : UZH(A,0)=UZH(CZ,0) : Next A : _REDRAW : End If : End If 
      If C=28 : UZH(CZ,0)=Range(_gt What Integer(28),-4000 To 5000) : End If 

      If C=31 : ZH(CZ,1)=Range(ZH(CZ,1)-8*D,-4000 To 5000) : End If 
      If C=32 : ZH(CZ,1)=Range(ZH(CZ,1)-1*D,-4000 To 5000) : End If 
      If C=33 : ZH(CZ,1)=Range(ZH(CZ,1)+1*D,-4000 To 5000) : End If 
      If C=34 : ZH(CZ,1)=Range(ZH(CZ,1)+8*D,-4000 To 5000) : End If 
      If C=35 : Bchg 3,CMODE : End If 
      If C=36 : _SURE["",Catalog String$(1802,"Copy L-Roof Height To All Zones ?")] : If Param : For A=0 To NZ : ZH(A,1)=ZH(CZ,1) : Next A : _REDRAW : End If : End If 
      If C=38 : ZH(CZ,1)=Range(_gt What Integer(38),-4000 To 5000) : End If 

      If C=41 : ZH(CZ,0)=Range(ZH(CZ,0)-8*D,-4000 To 5000) : End If 
      If C=42 : ZH(CZ,0)=Range(ZH(CZ,0)-1*D,-4000 To 5000) : End If 
      If C=43 : ZH(CZ,0)=Range(ZH(CZ,0)+1*D,-4000 To 5000) : End If 
      If C=44 : ZH(CZ,0)=Range(ZH(CZ,0)+8*D,-4000 To 5000) : End If 
      If C=45 : Bchg 4,CMODE : End If 
      If C=46 : _SURE["",Catalog String$(1803,"Copy L-Floor Height To All Zones ?")] : If Param : For A=0 To NZ : ZH(A,0)=ZH(CZ,0) : Next A : _REDRAW : End If : End If 
      If C=48 : ZH(CZ,0)=Range(_gt What Integer(48),-4000 To 5000) : End If 

      If C=51 : ZH(CZ,2)=Range(ZH(CZ,2)-8*D,-4000 To 5000) : End If 
      If C=52 : ZH(CZ,2)=Range(ZH(CZ,2)-1*D,-4000 To 5000) : End If 
      If C=53 : ZH(CZ,2)=Range(ZH(CZ,2)+1*D,-4000 To 5000) : End If 
      If C=54 : ZH(CZ,2)=Range(ZH(CZ,2)+8*D,-4000 To 5000) : End If 
      If C=55 : Bchg 5,CMODE : End If 
      If C=56 : _SURE["",Catalog String$(1804,"Copy Water Height To All Zones ?")] : If Param : For A=0 To NZ : ZH(A,2)=ZH(CZ,2) : Next A : _REDRAW : End If : End If 
      If C=58 : ZH(CZ,2)=Range(_gt What Integer(58),-4000 To 5000) : End If 

      If C=61
         If AUTOSTAIR1=5000
            If Btst(0,AUTOSTAIR3) : AUTOSTAIR1=UZH(CZ,0) : AUTOSTAIR1B=UZH(CZ,1) : Else : AUTOSTAIR1=ZH(CZ,0) : AUTOSTAIR1B=ZH(CZ,1) : End If 
         Else 
            AUTOSTAIR1=5000
         End If 
      End If 
      If C=62 : Bchg 0,AUTOSTAIR3 : End If 
      If C=63 : AUTOSTAIR2=Range(AUTOSTAIR2+1,-64 To 64) : End If 
      If C=64 : AUTOSTAIR2=Range(AUTOSTAIR2-1,-64 To 64) : End If 
      '
      '  Check hjder
      '
      If UZH(CZ,0)<5000 and UZH(CZ,1)<5000 : UZH(CZ,1)=Range(UZH(CZ,1),-4000 To UZH(CZ,0)) : UZH(CZ,0)=Range(UZH(CZ,0),UZH(CZ,1) To 5000) : End If 
      If ZH(CZ,0)<5000 and ZH(CZ,1)<5000 : ZH(CZ,1)=Range(ZH(CZ,1),-4000 To ZH(CZ,0)) : ZH(CZ,0)=Range(ZH(CZ,0),ZH(CZ,1) To 5000) : End If 
   End If 
   _SHOWHEIGHTS
End Proc
Procedure _COND_DEFWALLBRIGHT
   C=_wnd Id Event Gadget
   _gt Gadgets Bank 499
   If C=11 and CZ>-1 and Between(-1,CCP,10)
      If OP=33
         UWB(CZ,CCP)=_gt What Integer(11)
      Else 
         WB(CZ,CCP)=_gt What Integer(11)
      End If 
   End If 
   _SHOWWALLBRIGHT
End Proc
Procedure _COND_DEFWATER
   _gt Gadgets Bank 499
   C=_wnd Id Event Gadget
   If C=11 : Add NWA,-1,0 To 20 : End If 
   If C=12 : Add NWA,1,0 To 20 : End If 
   If C=21 : WATH(NWA)=_gt What Integer(21) : End If 
   If C=31 and CZ>-1 : ZWA(CZ)=NWA+1 : WABH(NWA)=ZH(CZ,2) : End If 
   If C=32 and CZ>-1 : ZWA(CZ)=0 : End If 
   _SHOWWATER
End Proc
Procedure _COND_DEFWALL
   C=_wnd Id Event Gadget
   If C=0 : Pop Proc
   Else If C=3 : Bchg 0,DWALL
   End If 
   _SHOWDEFWALL
End Proc
Procedure _COND_DEFBACKSFX
   C=_wnd Id Event Gadget
   KSH=_wnd Id Event Qualifier and %111
   If C=0 : Pop Proc
   Else If C=60 : D1=1 : Pop Proc
   Else If Between(9,C,42) and CZ>-1 and KSH=0 : Bchg C-10,BSFX(CZ)
   Else If Between(9,C,26)
      _PLAY_SAMPLE[Peek$(LINK+$A40+Deek(LINK+$14CA0+(C-10)*2)*64,64,Chr$(0))]
   Else If Between(25,C,42)
      _PLAY_SAMPLE[Peek$(LINK+$A40+Deek(LINK+$14CA0+(C-26)*2)*64,64,Chr$(0))]
   End If 
   _SHOWBACKSFX
End Proc
Procedure _COND_ADDOBJ
   C=_wnd Id Event Gadget
   _gt Gadgets Bank 499
   If C=0 : Pop Proc : End If 
   If C=1 : OT=1-OT
   Else If C=16
      If OT=0 : _SELALI[0,""] : ALTO=Param
      Else : _SELOBJ[0,""] : OBTO=Param
      End If 
   Else If Between(19,C,36) : Bchg C-20,DLOCKED
   Else If Between(39,C,56) : Bchg C-40,LLOCKED
   Else If C=5 : PERMCALC=255-PERMCALC
   Else If C=6 : UPORLO=255-UPORLO
   Else If C=10 : D1=1 : Pop Proc
   Else If C=17
      If OT=0 : TEAM=Range(_gt What Integer(17),-1 To 50)
      Else 
         STRTANIM=Range(_gt What Integer(17)-1,0 To Deek(LINK+$5A08+OBTO*40+12))
      End If 
   Else If C=18 and OT=1 : _OBJFRAMEPICK[0,OBTO,STRTANIM] : STRTANIM=Param-1
   Else If C=19 : TXT=Range(_gt What Integer(19),-1 To 9)
   End If 
   _SHOWOBJADD
End Proc
Procedure _COND_BRIGHTSLIDE
   C=_wnd Id Event Gadget
   D=_wnd Id Event Code
   M=False
   If C=0 : Pop Proc
   Else If C=2 : PBR=D-20 : M=True
   Else If C=4 : PAN=D : M=True
   Else If C=6 : PDTA=D : M=True
   Else If C=12 : PBRF=D-20 : M=True
   Else If C=14 : PANF=D : M=True
   Else If C=16 : PDTAF=D : M=True
   Else If C=19 : CMODE= Not CMODE
   Else If C=20 : D1=1 : Pop Proc
   Else If Between(20,C,31) and OP=13 and CZ>-1
      If C=21
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,1)=1 : ZPBR(CZ,A,0)=-1 and $FF : Next 
      Else If C=22
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,1)=-1 and $FF : ZPBR(CZ,A,0)=1 : Next 
      Else If C=23
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,1)=-15 and $FF : ZPBR(CZ,A,0)=1 : Next 
      Else If C=24
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,1)=1 : ZPBR(CZ,A,0)=-15 and $FF : Next 
      Else If C=25
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,1)=15 : ZPBR(CZ,A,0)=-15 and $FF : Next 
      Else If C=26
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,1)=-15 and $FF : ZPBR(CZ,A,0)=15 : Next 
      Else If C=27
         For A=0 To ZP(CZ)-1 : C=ZO(CZ,A) : ZPBR(CZ,A,1)=((C mod 5)+1)*$100+$F000 : ZPBR(CZ,A,0)=-15 and $FF : Next 
      Else If C=28
         For A=0 To ZP(CZ)-1 : C=ZO(CZ,A) : ZPBR(CZ,A,0)=((C mod 5)+1)*$100+$F000 : ZPBR(CZ,A,1)=-15 and $FF : Next 
      Else If C=29
         For A=0 To ZP(CZ)-1 : C=ZO(CZ,A) : ZPBR(CZ,A,1)=((C mod 5)+1)*$100+$F000 : ZPBR(CZ,A,0)=((C mod 5)+1)*$100+$F000 : Next 
      Else If C=30
         For A=0 To ZP(CZ)-1 : C=ZO(CZ,A) : ZPBR(CZ,A,1)=((C mod 5)+1)*$100+$F000 : C=1000-ZO(CZ,A) : ZPBR(CZ,A,0)=((C mod 5)+1)*$100+$F000 : Next 
      End If 
   Else If Between(20,C,31) and OP=10 and CZ>-1
      If C=21
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,3)=1 : ZPBR(CZ,A,2)=-1 and $FF : Next 
      Else If C=22
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,3)=-1 and $FF : ZPBR(CZ,A,2)=1 : Next 
      Else If C=23
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,3)=-15 and $FF : ZPBR(CZ,A,2)=1 : Next 
      Else If C=24
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,3)=1 : ZPBR(CZ,A,2)=-15 and $FF : Next 
      Else If C=25
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,3)=15 : ZPBR(CZ,A,2)=-15 and $FF : Next 
      Else If C=26
         For A=0 To ZP(CZ)-1 : ZPBR(CZ,A,3)=-15 and $FF : ZPBR(CZ,A,2)=15 : Next 
      Else If C=27
         For A=0 To ZP(CZ)-1 : C=ZO(CZ,A) : ZPBR(CZ,A,3)=((C mod 5)+1)*$100+$F000 : ZPBR(CZ,A,2)=-15 and $FF : Next 
      Else If C=28
         For A=0 To ZP(CZ)-1 : C=ZO(CZ,A) : ZPBR(CZ,A,2)=((C mod 5)+1)*$100+$F000 : ZPBR(CZ,A,3)=-15 and $FF : Next 
      Else If C=29
         For A=0 To ZP(CZ)-1 : C=ZO(CZ,A) : ZPBR(CZ,A,3)=((C mod 5)+1)*$100+$F000 : ZPBR(CZ,A,2)=((C mod 5)+1)*$100+$F000 : Next 
      Else If C=30
         For A=0 To ZP(CZ)-1 : C=ZO(CZ,A) : ZPBR(CZ,A,3)=((C mod 5)+1)*$100+$F000 : C=1000-ZO(CZ,A) : ZPBR(CZ,A,2)=((C mod 5)+1)*$100+$F000 : Next 
      End If 
   Else : Pop Proc
   End If 
   If M and CP>-1 and OP=10
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=CP : 
            ZPBR(CZ,A,3)=(PDTA*$1000)+(PAN*$100)+(PBR and $FF)
            ZPBR(CZ,A,2)=(PDTAF*$1000)+(PANF*$100)+(PBRF and $FF)
         End If 
      Next 
   Else If M and CP>-1 and OP=13
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=CP
            ZPBR(CZ,A,1)=(PDTA*$1000)+(PAN*$100)+(PBR and $FF)
            ZPBR(CZ,A,0)=(PDTAF*$1000)+(PANF*$100)+(PBRF and $FF)
         End If 
      Next 
   End If 
   _SHOWBRIGHTSLIDE
End Proc
Procedure _COND_DEFGRAPH
   C=_wnd Id Event Gadget
   '
   If C=1 and ZWGC>0 : Add ZWGC,-1 : ZWG=0 : End If 
   If C=2 : ZWG=0 : End If 
   If C=3 and ZWG>0 : Add ZWG,-1 : End If 
   If C=4 : Add ZWG,1 : End If 
   If C=5
      Trap T=Length(701+ZWGC)
      If Errtrap=0
         WGH=Deek(Start(701+ZWGC)+T-2)
         WGWW=(((T-(64*32)-2)/WGH)*3)/2
         ZWG=Max(0,(WGWW-WGW)/16)
      End If 
   End If 
   If C=6 : Add ZWGC,1 : ZWG=0 : End If 
   If C=7 and WGW<256 : WGW=WGW*2 : End If 
   If C=8 and WGW>2 : WGW=WGW/2 : End If 
   If C=9 : If ZWGL=0 : ZWGL=1 : Else : ZWGL=0 : End If : End If 
   If C=10 : If ZWGL=0 : ZWGL=2 : Else : ZWGL=0 : End If : End If 
   _SHOWDEFGRAPH
End Proc
Procedure _COND_DEFROOFGRAPH
   C=_wnd Id Event Gadget
   If C=2 : ZRG=0 : End If 
   If C=3 : Add ZRG,-1,0 To 16 : End If 
   If C=4 : Add ZRG,1,0 To 16 : End If 
   If C=5 : ZRG=16 : End If 
   If C=7 : ZRGS=Range(ZRGS-1,-5 To 5) : End If 
   If C=8 : ZRGS=Range(ZRGS+1,-5 To 5) : End If 
   _SHOWDEFROOFGRAPH
End Proc
Procedure _COND_DEFFLOORGRAPH
   C=_wnd Id Event Gadget
   If C=2 : ZFG=0 : End If 
   If C=3 : Add ZFG,-1,0 To 15 : End If 
   If C=4 : Add ZFG,1,0 To 15 : End If 
   If C=5 : ZFG=15 : End If 
   If C=7 : ZFGS=Range(ZFGS-1,-5 To 5) : End If 
   If C=8 : ZFGS=Range(ZFGS+1,-5 To 5) : End If 
   _SHOWDEFFLOORGRAPH
End Proc
'
'----------------------------------------------------------------------------  
'   InitDef PROCEDURER     
'----------------------------------------------------------------------------  
'
Procedure _INITDEF
   _gt Gadgets Bank 491
   '
   If Between(-1,OP,39) : _gt Set Image OP+1,SGAD(OP*2+2),SGAD(OP*2+1) : End If 
   P1=-1 : P2=-2
   '
   If OP=0 : _TLINES[Catalog String$(1051,"LMB to place point"),Catalog String$(1052,"RMB to delete point"),"","","",""] : _INITSPRITE : End If 
   If OP=1 : _INITDEFZONE : End If 
   If OP=2 : _INITOBJ : End If 
   If OP=3 : _TLINES[Catalog String$(1053,"RMB to select point"),Catalog String$(1054,"LMB for new location"),"","","",""] : _INITSPRITE : End If 
   If OP=4 : _INITDEFWALL : End If 
   If OP=5 : _TLINES[Catalog String$(1055,"RMB to select object"),Catalog String$(1054,"LMB for new location"),"","","",""] : End If 
'stats moved to main screen, accessed from title bar option AL 
'   If OP=7 : _STAT_ZONES
'   _TLINES[Catalog String$(1301,"Objects placed")+":"+Str$(NO),Catalog String$(1303,"Points used")+":"+Str$(NP+1),Catalog String$(1304,"Zones used")+":"+Str$(STNZ),Catalog String$(1305,"CONTROLPOINTS USED")+":"+Str$(NCPT+1),"",""] : End If 
   If OP=8 : _TLINE[Catalog String$(1056,"LMB to delete object")] : End If 
   If OP=10 : _INITBRIGHTSLIDE : End If 
   If OP=11 : _TLINES[Catalog String$(1057,"LMB start player one"),Catalog String$(1058,"RMB start player two"),Catalog String$(1059,"point+e to set endzone"),"","",""] : End If 
   If OP=13 : _INITBRIGHTSLIDE : End If 
   If OP=14 : _INITDEFDOOR : End If 
   If OP=17 : _INITDEFLIFT : End If 
   If OP=18 : _INITDEFGFX : End If 
   If OP=19 : _INITDEFGFX : End If 
   If OP=20 : _TLINES[Catalog String$(1060,"RMB = Place/Remove Source"),Catalog String$(1061,"LMB = Destination"),"","","",""] : End If 
   If OP=21 : _INITDEFROOFGRAPH : _SHOWDEFROOFGRAPH : End If 
   If OP=22 : _INITDEFGRAPH : End If 
   If OP=23 : _INITDEFROOFGRAPH : _SHOWDEFFLOORGRAPH : End If 
   If OP=24 : _INITDEFROOFGRAPH : _SHOWDEFROOFGRAPH : End If 
   If OP=25 : _INITDEFGRAPH : End If 
   If OP=26 : _INITDEFROOFGRAPH : _SHOWDEFFLOORGRAPH : End If 
   If OP=27 : _INITDEFHEIGHTS : End If 
   If OP=28 : _TLINES[Catalog String$(1062,"LMB = Place in Lower level"),Catalog String$(1063,"RMB = Place in Upper level"),Catalog String$(1082,"d = Delete ControlPoint"),"","",""] : End If 
   If OP=29 : _TLINES[Catalog String$(1064,"RMB = Select Zone"),Catalog String$(1065,"LMB = Control Point"),Catalog String$(1066,"A = Autolink Zones"),"","",""] : End If 
   If OP=30 : _INITDEFWATER : End If 
   If OP=31 : P1=-1 : P2=-1 : _TLINES[Catalog String$(1067,"LMB = Toggle Physical"),Catalog String$(1068,"RMB = Toggle Visual"),Catalog String$(1069,"V = Autolink visual"),"","",""] : End If 
   If OP=32 : _TLINES[Catalog String$(1070,"RMB = Select Zone"),Catalog String$(1071,"LMB = Control Point"),"","","",""] : End If 
   If OP=33 : _INITWALLBRIGHT : End If 
   If OP=34 : _INITWALLBRIGHT : End If 
   If OP=35 : _TLINES[Catalog String$(1072,"point+g = chooses point"),Catalog String$(1073,"LMB = Place in Lower level"),Catalog String$(1074,"RMB = Place in upper level"),"","",""] : End If 
   If OP=36 : _INITDEFBACKSFX : End If 
   If OP=38 : _INITDEFINFO : End If 
End Proc
'
Procedure _INITDEFBACKSFX
   Reserve As Gt Gadgets 499,100,1

   _gt Set Mode 0,"",1,0
   _gt Set Mode 0,"",0,1
   _gt Set Integer Mode 1,6,1,0

   GD=10 : X=16 : Y=12
   For A=0 To 15
      W$=Left$(Dr File$(Peek$(LINK+$A40+Deek(LINK+$14CA0+A*2)*64,64,Chr$(0))),16)
      _gt Text GD+50,X,Y,128,12,,"",W$,0
      _gt Checkbox GD,X+128,Y,12,12,,"",0
      _gt Text GD+66,X+336,Y,128,12,,"",W$,0
      _gt Checkbox GD+16,X+336+128,Y,12,12,,"",0
      Add Y,12 : Inc GD
      If Y>96 : Y=12 : Add X,148 : End If 
   Next A


   _wnd Id Open 3,0,_scr Id Height(1)-100,_scr Id Width(1),100,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   _SHOWBACKSFX
End Proc
Procedure _INITOBJ
   Dim W1$(2),W2$(2),W3$(2)
   Reserve As Gt Gadgets 499,60,1
   W1$(0)=Catalog String$(100,"Object Type:")+" "+OB$(0)
   W1$(1)=Catalog String$(100,"Object Type:")+" "+OB$(1)

   W2$(0)=Catalog String$(104,"Permanent Calculation:")+" "+Catalog String$(2,"No")
   W2$(1)=Catalog String$(104,"Permanent Calculation:")+" "+Catalog String$(1,"Yes")

   W3$(0)=Catalog String$(105,"Start in Up/Lo Rooms:")+" "+Catalog String$(4,"Lower")
   W3$(1)=Catalog String$(105,"Start in Up/Lo Rooms:")+" "+Catalog String$(3,"Upper")

   _gt Set Mode 0,"",1,0
   _gt Set Mode 0,"",0,1
   _gt Set Integer Mode 1,6,1,0

   _gt Cycle 1,10,12,312,12,,"",Array(W1$(0)),0
   _gt Text 2,10,24,296,12,,"","",1
   _gt Image 16,306,24,1,GAD16(0),GAD16(1)
   _gt Text 3,10,70,118,12,,"",Catalog String$(102,"DOORS HELD:")+" ",0
   _gt Text 4,10,82,118,12,,"",Catalog String$(103,"LIFTS HELD:")+" ",0
   _gt Cycle 5,10,36,312,12,,"",Array(W2$(0)),0
   _gt Cycle 6,336,12,312,12,,"",Array(W3$(0)),0
   _gt Text 7,336,24,160,12,,"","",0
   _gt Integer 17,568,24,64,12,0,"",1256,1
   _gt Image 18,632,24,1,GAD16(0),GAD16(1)
   _gt Text 8,336,36,320,12,,"","",0
   _gt Text 9,336,48,160,12,,"",Catalog String$(109,"Text:"),0
   _gt Integer 19,584,48,64,12,0,"",1256,1
   For A=0 To 15
      _gt Checkbox A+20,128+A*32,70,12,12,,Chr$(A+65),0
      _gt Checkbox A+40,128+A*32,82,12,12,,Chr$(A+65),0
   Next A


   _wnd Id Open 3,0,_scr Id Height(1)-90,_scr Id Width(1),90,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   _SHOWOBJADD
End Proc
Procedure _INITDEFGRAPH
   OPO=-1
   Reserve As Gt Gadgets 499,12,1
   _gt Set Mode 0,"",0,1
   _gt Image 1,176,24,1,GAD10(0),GAD10(1)
   _gt Image 2,186,24,1,GAD10(16),GAD10(17)
   _gt Image 3,196,24,1,GAD10(2),GAD10(3)
   _gt Image 4,206,24,1,GAD10(4),GAD10(5)
   _gt Image 5,216,24,1,GAD10(18),GAD10(19)
   _gt Image 6,226,24,1,GAD10(6),GAD10(7)
   _gt Image 7,186,33,1,GAD10(8),GAD10(9)
   _gt Image 8,196,33,1,GAD10(10),GAD10(11)
   _gt Image 9,206,33,1,GAD10(12),GAD10(13)
   _gt Image 10,216,33,1,GAD10(14),GAD10(15)

   _wnd Id Open 3,0,_scr Id Height(1)-80,_scr Id Width(1),80/YRES,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490
   _ZOSHOW[CZ,10]
   ZWG=0 : LZWG=1 : ZWGC=0 : LWCHUNK=1
   _SHOWDEFGRAPH
End Proc
Procedure _INITDEFROOFGRAPH
   If Length(700)<>65536
      _LOAD[700,Peek$(LINK+$1940,64,Chr$(0))]
   End If 
   OPO=-1
   Reserve As Gt Gadgets 499,12,1
   _gt Set Mode 0,"",0,1
   _gt Image 2,186,24,1,GAD10(16),GAD10(17)
   _gt Image 3,196,24,1,GAD10(2),GAD10(3)
   _gt Image 4,206,24,1,GAD10(4),GAD10(5)
   _gt Image 5,216,24,1,GAD10(18),GAD10(19)
   _gt Image 7,196,33,1,GAD10(8),GAD10(9)
   _gt Image 8,206,33,1,GAD10(10),GAD10(11)
   
   _wnd Id Open 3,0,_scr Id Height(1)-80,_scr Id Width(1),80/YRES,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490
   _ZOSHOW[CZ,10]
   ZFG=0 : ZFGS=0 : OZFG=1 : ZFGS=1
   ZRG=0 : ZRGS=0 : OZRG=1 : ZRGS=1
End Proc
Procedure _INITDEFLIFT
   Dim W1$(2)
   W1$(0)=Catalog String$(181,"Start Pos:")+" "+Catalog String$(7,"Bottom")
   W1$(1)=Catalog String$(181,"Start Pos:")+" "+Catalog String$(8,"Top")

   Reserve As Gt Gadgets 499,50,1
   _gt Set Mode 0,"",1,0
   _gt Set Mode 0,"",0,1
   _gt Text 1,10,12,104,12,,"","",1
   _gt Set Integer Mode 1,6,1,0
   _gt Cycle 2,336,12,304,12,,"",Array(W1$(0)),0
   _gt Text 11,10,24,240,12,,"","",1

   _gt Image 31,250,24,1,GAD16(2),GAD16(3)
   _gt Image 32,266,24,1,GAD16(4),GAD16(5)
   _gt Image 33,282,24,1,GAD16(6),GAD16(7)
   _gt Image 34,298,24,1,GAD16(8),GAD16(9)

   _gt Text 3,10,36,200,12,,"",Catalog String$(182,"Raise Speed:"),0
   _gt Integer 13,224,36,64,12,0,"",1256,1
   _gt Text 6,10,48,200,12,,"",Catalog String$(185,"Lower Speed:"),0
   _gt Integer 16,224,48,64,12,0,"",1256,1

   _gt Text 4,336,24,288,12,,"","",1
   _gt Image 44,624,24,1,GAD16(0),GAD16(1)
   _gt Text 5,336,36,288,12,,"","",1
   _gt Image 45,624,36,1,GAD16(0),GAD16(1)
   _gt Text 7,336,48,288,12,,"","",1
   _gt Image 47,624,48,1,GAD16(0),GAD16(1)
   _gt Text 8,336,60,288,12,,"","",1
   _gt Image 48,624,60,1,GAD16(0),GAD16(1)

   _gt Text 17,10,60,150,12,,"",Catalog String$(168,"Raise Conditions:"),0
   _gt Cycle 9,160,60,160,12,,"",Array(LR$(0)),0
   _gt Text 18,10,72,150,12,,"",Catalog String$(169,"Lower Conditions:"),0
   _gt Cycle 10,160,72,160,12,,"",Array(LL$(0)),0

   _gt Text 19,10,84,500,12,,"","",1
   _gt Image 21,124,12,1,GAD24(2),GAD24(3)
   _gt Image 22,148,12,1,GAD24(4),GAD24(5)
   _gt Image 23,172,12,1,GAD24(6),GAD24(7)
   _gt Image 24,196,12,1,GAD24(8),GAD24(9)
   _gt Button 25,512,84,64,12,,Catalog String$(92,"Place")
   _gt Button 26,576,84,64,12,,Catalog String$(93,"Remove")

   _wnd Id Open 3,0,_scr Id Height(1)-90,_scr Id Width(1),90,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   If CZ>-1 : _ZOSHOW[CZ,4] : End If 
   CZ2=-1 : OPO=-1
   For A=0 To NZ : If ZLI(A)=NL+1 : CZ=A : CZ2=CZ : End If : Next A
   If CZ>-1 : _ZOSHOW[CZ,10] : End If 
   _SHOWLIFT
   DIAL2=2
End Proc
Procedure _INITDEFZONE
   _ZOSHOW[CZ,4] : _ZOSHOW[CZ2,4]
   CZ=-1 : CZ2=-1
   For A=0 To NZ-1
      If USED(A)=0
         CZ=A : ZP(CZ)=0
         For B=0 To 10 : ZO(CZ,B)=-1 : Next B
         Exit 
      End If 
   Next 
   If CZ<0
      If NZ>MZ-1 : _ERROR[0,3,1] : Pop Proc : End If 
      CZ=NZ : ZP(CZ)=0
   End If 
   _TLINES[Catalog String$(1075,"LMB to select points"),Catalog String$(1076,"Start from Low-left point"),Catalog String$(1077,"Select points clock-wise"),"",Catalog String$(1078,"RMB to select zone"),Catalog String$(1081,"'d' to del sel.zone")]
End Proc
Procedure _INITDEFDOOR
   Reserve As Gt Gadgets 499,40,1
   _gt Set Mode 0,"",1,0
   _gt Set Mode 0,"",0,1
   _gt Text 1,10,12,104,12,,"","",1
   _gt Set Integer Mode 1,6,1,0
   _gt Text 2,10,24,200,12,,"",Catalog String$(161,"Stays open for (50=1sec):"),0
   _gt Integer 12,224,24,64,12,0,"",1256,1
   _gt Text 3,10,36,200,12,,"",Catalog String$(162,"Opening Speed:"),0
   _gt Integer 13,224,36,64,12,0,"",1256,1
   _gt Text 6,10,48,200,12,,"",Catalog String$(165,"Closing Speed:"),0
   _gt Integer 16,224,48,64,12,0,"",1256,1

   _gt Text 4,336,24,288,12,,"","",1
   _gt Image 34,624,24,1,GAD16(0),GAD16(1)
   _gt Text 5,336,36,288,12,,"","",1
   _gt Image 35,624,36,1,GAD16(0),GAD16(1)
   _gt Text 7,336,48,288,12,,"","",1
   _gt Image 37,624,48,1,GAD16(0),GAD16(1)
   _gt Text 8,336,60,288,12,,"","",1
   _gt Image 38,624,60,1,GAD16(0),GAD16(1)

   _gt Text 17,10,60,150,12,,"",Catalog String$(168,"Raise Conditions:"),0
   _gt Cycle 9,160,60,160,12,,"",Array(DR$(0)),0
   _gt Text 18,10,72,150,12,,"",Catalog String$(169,"Lower Conditions:"),0
   _gt Cycle 10,160,72,160,12,,"",Array(DL$(0)),0

   _gt Text 19,10,84,500,12,,"","",1
   _gt Image 21,124,12,1,GAD24(2),GAD24(3)
   _gt Image 22,148,12,1,GAD24(4),GAD24(5)
   _gt Image 23,172,12,1,GAD24(6),GAD24(7)
   _gt Image 24,196,12,1,GAD24(8),GAD24(9)
   _gt Button 25,512,84,64,12,,Catalog String$(92,"Place")
   _gt Button 26,576,84,64,12,,Catalog String$(93,"Remove")

   _wnd Id Open 3,0,_scr Id Height(1)-90,_scr Id Width(1),90,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   If CZ>-1 : _ZOSHOW[CZ,4] : End If 
   CZ2=-1 : OPO=-1
   For A=0 To NZ : If ZD(A)=NDO+1 : CZ=A : CZ2=CZ : End If : Next A
   If CZ>-1 : _ZOSHOW[CZ,10] : End If 
   _SHOWDOOR
   DIAL2=2
End Proc
Procedure _INITBRIGHTSLIDE
   PBR=0 : PAN=0 : PDTA=0 : CMODE=False

   Reserve As Gt Gadgets 499,50,1
   _gt Set Mode 0,"",1,0
   _gt Set Mode 0,"",0,1

   _gt Text 40,10,12,56,12,,"",Catalog String$(13,"Roof")+":",0
   _gt Text 1,66,12,88,12,,"","",1
   _gt H Slider 2,154,12,152,12,,"",40*$1000,""
   _gt Text 3,66,24,88,12,,"","",1
   _gt H Slider 4,154,24,152,12,,"",16*$1000,""
   _gt Text 5,66,36,88,12,,"","",1
   _gt H Slider 6,154,36,152,12,,"",16*$1000,""
   _gt Text 41,10,56,56,12,,"",Catalog String$(14,"Floor")+":",0
   _gt Text 11,66,56,88,12,,"","",1
   _gt H Slider 12,154,56,152,12,,"",40*$1000,""
   _gt Text 13,66,68,88,12,,"","",1
   _gt H Slider 14,154,68,152,12,,"",16*$1000,""
   _gt Text 15,66,80,88,12,,"","",1
   _gt H Slider 16,154,80,152,12,,"",16*$1000,""

   _gt Image 19,616,84,1,GAD24(0),GAD24(1)

   _gt Button 21,312,12,192,12,,"Bright; lit from above"
   _gt Button 22,312,24,192,12,,"Bright; lit from below"
   _gt Button 23,312,36,192,12,,"Bright bottom, dark top"
   _gt Button 24,312,48,192,12,,"Bright top, dark bottom"
   _gt Button 25,312,60,192,12,,"Dark, lit from above"
   _gt Button 26,312,72,192,12,,"Dark, lit from below"
   _gt Button 27,504,12,136,12,,"Roof Glowing"
   _gt Button 28,504,24,136,12,,"Floor Glowing"
   _gt Button 29,504,36,136,12,,"Glowing in sync"
   _gt Button 30,504,48,136,12,,"Glowing off sync"

   _wnd Id Open 3,0,_scr Id Height(1)-90,_scr Id Width(1),90,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   _SHOWBRIGHTSLIDE
End Proc
Procedure _INITDEFHEIGHTS
   Reserve As Gt Gadgets 499,60,1
   _gt Set Mode 0,"",1,0
   _gt Set Mode 0,"",0,1
   _gt Set Integer Mode 1,6,1,0

   H=_scr Id Height(1)

   For A=0 To 4
      _gt V Slider A+6,A*11+6,12,11,H-16,,"",0,""
      _gt Text A+1,66,A*40+12,96,12,,"","",0
      _gt Text A*10+17,66,A*40+24,64,12,,"","",1
      _gt Integer A*10+18,66,A*40+36,64,12,,"",0,1
      _gt Image A*10+11,130,A*40+24,1,GAD16(2),GAD16(3)
      _gt Image A*10+12,130,A*40+36,1,GAD16(4),GAD16(5)
      _gt Image A*10+13,146,A*40+36,1,GAD16(6),GAD16(7)
      _gt Image A*10+14,146,A*40+24,1,GAD16(8),GAD16(9)
      _gt Checkbox A*10+15,212,A*40+24,12,12,,Catalog String$(95,"Copy"),0
      _gt Button A*10+16,162,A*40+36,62,12,,Catalog String$(96,"All")
   Next A
   'A$=A$+"BUtton 60,608,31,32,16,00,00,01;[UN 0,0,94 BP+;][BR 0;]" 
   'A$=A$+"BUtton 61,440,0,168,8,00,00,01;[BO 0,0,85,SX,SY;PR 4,0,10VA,1;][BR 0;]"
   'A$=A$+"BUtton 62,440,8,168,8,00,00,01;[BO 0,0,85,SX,SY;PR 4,0,11VA,1;][BR 0;]"
   'A$=A$+"BU     63,608,8,16,7,0,0,001;[UN 0,0,196 BP+;][NW;BR 0;]"
   'A$=A$+"BU     64,624,8,16,7,0,0,001;[UN 0,0,198 BP+;][NW;BR 0;]"

   _wnd Id Open 3,_scr Id Width(1)-222,0,222,_scr Id Height(1),$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   _gt Set Text 1,Catalog String$(110,"Upper Roof :"),,,
   _gt Set Text 2,Catalog String$(111,"Upper Floor:"),,,
   _gt Set Text 3,Catalog String$(112,"Lower Roof :"),,,
   _gt Set Text 4,Catalog String$(113,"Lower Floor:"),,,
   _gt Set Text 5,Catalog String$(114,"Water Level:"),,,

   CMODE=0
   AUTOSTAIR1=5000 : AUTOSTAIR2=-16 : AUTOSTAIR3=0
   _SHOWHEIGHTS
End Proc
Procedure _INITWALLBRIGHT
   Reserve As Gt Gadgets 499,20,1
   _gt Set Mode 0,"",0,1
   _gt Set Integer Mode 1,6,1,0

   _gt Text 1,10,12,104,12,,"",Catalog String$(120,"Brightness offset"),0
   _gt Integer 11,224,12,64,12,0,"",0,1

   _wnd Id Open 3,0,_scr Id Height(1)-90,_scr Id Width(1),90,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   OPO=-1
   _SHOWWALLBRIGHT
End Proc
Procedure _INITDEFWATER
   Reserve As Gt Gadgets 499,40,1
   _gt Set Mode 0,"",1,0
   _gt Set Mode 0,"",0,1
   _gt Set Integer Mode 1,6,1,0
   _gt Text 1,10,12,214,12,,"","",1
   _gt Text 2,10,24,214,12,,"",Catalog String$(131,"Height at top:"),0
   _gt Integer 21,224,24,64,12,0,"",1256,1

   _gt Image 11,224,12,1,GAD24(2),GAD24(3)
   _gt Image 12,248,12,1,GAD24(4),GAD24(5)

   _gt Button 31,512,84,64,12,,Catalog String$(92,"Place")
   _gt Button 32,576,84,64,12,,Catalog String$(93,"Remove")

   _wnd Id Open 3,0,_scr Id Height(1)-90,_scr Id Width(1),90,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   _SHOWWATER
End Proc
Procedure _INITDEFINFO
   'Change Bank Font 999
   'FON1=_struct Alloc(8) 
   '_font Ask Scrn Rastport,FON1
   'F=_font Open(FON1)
   _wnd Id Open 3,96,12,536,256,$2,F_IDCMP,0,""
   '_font Set _wnd What Rport(_wnd Id Base(3)),F
   '_font Set _scr Id Rport(1),F

   _gt Bevel Box 2,16,26,512,16,0
   _gt Bevel Box 2,16,56,512,26,1
   _gt Bevel Box 2,16,96,512,158,1
   WY=36 : Restore INFODAT
   Do 
      Read C,W$
      Exit If W$="EOD"
      W=_rp Len Text(_wnd What Rport(_wnd Id Base(3)),W$)
      W=(_wnd Id Width-W)/2-4
      _wnd Id Ink C,0,0
      _wnd Id Text W+4,WY,W$
      Add WY,10
   Loop 
   _wnd Id Titles BUT$(OP),VER$
   _gt Menus Attach 490

   '_font Close(F)
INFODAT:
   Data 1,Catalog String$(193,"Written By:")+" Jens Vang Petersen (top_cat@post8.tele.dk)."
   Data 0,""
   Data 0,""
   Data 1,Catalog String$(191,"This Program is MailWare, so please send one.")
   Data 2,Catalog String$(192,"English Locale by: Jens Vang Petersen (top_cat@post8.tele.dk)")
   Data 0,""
   Data 0,""
   Data 4,"Written Using:  AMOS Pro   V2.0  "
   Data 4,"                OS DevKit  V1.60 "
   Data 4,"                AMCAF      V1.50b"
   Data 4,"                CRAFT      V1.00 "
   Data 4,"                Turbo Plus V2.00 "
   Data 4,"                Locale     V0.26 "
   Data 4,"                EasyLife   V1.10 "
   Data 4,"                Tools      V1.01 "
   Data 1,"Additional work by: Abu_the_monkey "
   Data 0," "
   Data 0," "
   Data 3,"Buffer Free:"+Str$(Free)
   Data 3,"Chip Free:"+Str$(Chip Free)+"  Fast Free:"+Str$(Fast Free)
   Data 0,"EOD"
End Proc
Procedure _INITDEFWALL
   Dim W1$(2)

   W1$(0)=Catalog String$(140,"Auto Double Wall:")+Catalog String$(5,"<OFF>")
   W1$(1)=Catalog String$(140,"Auto Double Wall:")+Catalog String$(6,"<ON>")

   Reserve As Gt Gadgets 499,10,1
   _gt Set Mode 0,"",1,0
   _gt Set Mode 0,"",0,1
   _gt Text 1,16,20,304,12,,"",Catalog String$(1078,"RMB to select zone"),0
   _gt Text 2,16,32,304,12,,"",Catalog String$(1079,"LMB to select wall"),0
   _gt Cycle 3,16,44,304,12,,"",Array(W1$(0)),0

   _wnd Id Open 3,0,_scr Id Height(1)-90,_scr Id Width(1),90,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _gt Gadgets Attach 499
   _gt Menus Attach 490

   OPO=-1
   _SHOWDEFWALL
End Proc
Procedure _INITDEFGFX
   _ZOSHOW[CZ,4]
   CZ=-1
   '
   ' Data loading 
   '
   If Length(700)<>65536
      Erase 700 : _LOAD[700,Peek$(LINK+$1940,64,Chr$(0))]
   End If 
   For A=0 To 15
      If Length(701+A)<10000
         _LOAD[701+A,Peek$(LINK+$14760+A*64,64,Chr$(0))]
      End If 
   Next A
End Proc
Procedure _INITSPRITE
   VP=_scr What Vport(_scr Id Base(1))
   SPRDATA(4,1)=_struct Alloc(12)
   SPRDATA(4,2)=_spr Get(SPRDATA(4,1),-1)
   If SPRDATA(4,2)
      BC=(SPRDATA(4,2)/2)*4+16
      'For A=0 To 1
      '   SPRDATA(4,A+6)=_scr Id Get Aga Pal(BC+A) 
      '   _scr Id Set Pal BC+A,$888
      'Next A
      BBASE=Leek(Start(1)-8+2+(4*8))
      H=Deek(BBASE+2)
      _spr Set Height SPRDATA(4,1),H
      _spr Change VP,SPRDATA(4,1),SPRDATA(4,0)
   End If 
End Proc
'
'----------------------------------------------------------------------------  
'   Tidy PROCEDURER    
'----------------------------------------------------------------------------  
'
Procedure _TIDYDEF
   '
   _gt Gadgets Bank 491
   For A=0 To 12*3+2
      _gt Set Image A+1,SGAD(A*2+1),SGAD(A*2+2)
   Next A

   If OP=0 : _TIDYGEN : _TIDYSPRITE : End If 
   If OP=1 : _TIDYDEFZONE : End If 
   If OP=2 : _TIDYGEN2 : End If 
   If OP=3 : _TIDYGEN : _TIDYSPRITE : End If 
   If OP=4 : _TIDYGEN2 : End If 
   If OP=5 : _TIDYGEN : End If 
   If OP=7 : _TIDYGEN : End If 
   If OP=8 : _TIDYGEN : End If 
   If OP=10 : _TIDYGEN2 : End If 
   If OP=11 : _TIDYPLACEPLAYER : End If 
   If OP=13 : _TIDYGEN2 : End If 
   If OP=14 : _TIDYGEN2 : End If 
   If OP=17 : _TIDYGEN2 : End If 
   If OP=18 : _TIDYDEFGFX : End If 
   If OP=19 : _TIDYDEFGFX : End If 
   If OP=20 : _TIDYGEN : End If 
   If OP=21 : _TIDYDEFROOFGRAPH : End If 
   If OP=22 : _TIDYDEFGRAPH : End If 
   If OP=23 : _TIDYDEFROOFGRAPH : End If 
   If OP=24 : _TIDYDEFROOFGRAPH : End If 
   If OP=25 : _TIDYDEFGRAPH : End If 
   If OP=26 : _TIDYDEFROOFGRAPH : End If 
   If OP=27 : _TIDYGEN2 : End If 
   If OP=28 : _TIDYGEN : End If 
   If OP=29 : _TIDYGEN : End If 
   If OP=30 : _TIDYGEN2 : End If 
   On OP-30 Proc _TIDYGEN,_TIDYGEN,_TIDYGEN2,_TIDYGEN2,_TIDYGEN,_TIDYGEN2,_DUMMY,_TIDYGEN
   DUMMY=Free
End Proc
'
Procedure _TIDYGEN2
   _ZOSHOW[CZ,4]
   _wnd Id Use 3
   _gt Gadgets Remove 499
   _wnd Id Close 3
   _gt Gadgets Erase 499
   CZ=-1
End Proc
Procedure _TIDYGEN
   _ZOSHOW[CZ,4]
   Trap _wnd Id Close 3
   '_REDRAW 
End Proc
Procedure _TIDYDEFGRAPH
   If Not Btst(17,PRE1)
      For A=701 To 701+15 : Erase A : Next A
   End If 
   _TIDYGEN2
End Proc
Procedure _TIDYDEFROOFGRAPH
   If Not Btst(17,PRE1) : Erase 700 : End If 
   _TIDYGEN2
End Proc
Procedure _TIDYDEFZONE
   If ZO(CZ,0)<>ZO(CZ,ZP(CZ))
      _REM_ZONE
   Else 
      _ZOSHOW[CZ,4]
   End If 
   _ZOSHOW[CZ2,4]
   _TIDYGEN
End Proc
Procedure _TIDYPLACEPLAYER
   _ZOSHOW[PZ,4]
   _TIDYGEN
End Proc
Procedure _TIDYDEFGFX
   '
   ' Close down window and erase gadgets from memory..
   '
   Trap _gt Gadgets Remove 499
   Trap _wnd Id Close 3
   Trap _gt Gadgets Erase 499
   '
   ' Editor clean-up
   '
   If Not Btst(17,PRE1)
      For A=700 To 701+15 : Erase A : Next A
   End If 
   _ZOSHOW[CZ,4]
   CZ=-1
End Proc
Procedure _TIDYSPRITE
   If SPRDATA(4,2)
      _spr Free SPRDATA(4,2)
      BC=(SPRDATA(4,2)/2)*4+16
      'For A=0 To 1
      '   _scr Id Set Aga Pal BC+A,SPRDATA(4,A+6)
      'Next A
   End If 
   _struct Free SPRDATA(4,1)
   SPRDATA(4,1)=0 : SPRDATA(4,2)=0
End Proc
'
'----------------------------------------------------------------------------  
'   Mousepressed PROCEDURER    
'----------------------------------------------------------------------------  
'
Procedure _MOUSEHIT
   If OP=0 : _M_PTADD : End If 
   If OP=1 : _M_DEFZONE : End If 
   If OP=2 : _M_OBJADD : End If 
   If OP=3 : _M_PTMOVE : End If 
   If OP=4 : _M_DEFWALL : End If 
   If OP=5 : _M_OBJMOVE : End If 
   If OP=6 : End If 
   If OP=7 : End If 
   If OP=8 : _M_OBJDEL : End If 
   If OP=9 : End If 
   If OP=10 : _M_DEFUPPERBRIGHT : End If 
   If OP=11 : _M_PLACEPLAYER : End If 
   If OP=12 : End If 
   If OP=13 : _M_DEFLOWERBRIGHT : End If 
   If OP=14 : _M_DEFDOOR : End If 
   If OP=15 : End If 
   If OP=16 : End If 
   If OP=17 : _M_DEFLIFT : End If 
   If OP=18 : _M_DEFGFX : End If 
   If OP=19 : _M_DEFGFX : End If 
   If OP=20 : _M_DEFTELEPORT : End If 
   If OP=21 : _M_DEFROOFGRAPH : End If 
   If OP=22 : _M_DEFWALLGRAPH : End If 
   If OP=23 : _M_DEFFLOORGRAPH : End If 
   If OP=24 : _M_DEFUPPERROOFGRAPH : End If 
   If OP=25 : _M_DEFUPPERWALLGRAPH : End If 
   If OP=26 : _M_DEFUPPERFLOORGRAPH : End If 
   If OP=27 : _M_DEFHEIGHT : End If 
   If OP=28 : _M_PLACECONTPT : End If 
   If OP=29 : _M_CPTNEARTOZONE : End If 
   If OP=30 : _M_DEFWATERANIM : End If 
   If OP=31 : _M_CONNECTCONT : End If 
   If OP=32 : _M_CPTNEARTOUPPERZONE : End If 
   If OP=33 : _M_DEFWALLBRIGHT : End If 
   If OP=34 : _M_DEFWALLBRIGHT : End If 
   If OP=35 : _M_CPTMOVE : End If 
   If OP=36 : _M_DEFBACKSFX : End If 
End Proc
'
Procedure _M_PTADD
   X=T Clip(XC,SC*MU) : Y=T Clip(YC,SC*MU)
   If M=1
      CP=-1
      For A=0 To NP
         If PX(A)=$7FFF and PY(A)=$7FFF
            CP=A : Exit 
         End If 
      Next A
      If CP<0
         If NP>=MXP-1 : _ERROR[0,3,0] : Pop Proc : End If 
         Add NP,1
         CP=NP
      End If 
      PX(CP)=X : PY(CP)=Y
      PTSHOW[X,Y,1]
      _OUTLINE[CP]
      GCLIP=True : GCHECK=True
   Else If M=2
      FINDNEAR[X,Y]
      A=Param
      If A>-1
         CP=A
         F=False
         For A=0 To NZ
            For B=0 To ZP(A)-1
               If ZO(A,B)=CP : F=True : End If 
            Next B
         Next A
         If F : _WRONG[4,0]
         Else : PX(CP)=$7FFF : PY(CP)=$7FFF : CP=-1 : _REDRAW : GCLIP=True : GCHECK=True
         End If 
      End If 
   End If 
End Proc
Procedure _M_PTMOVE
   X=T Clip(XC,SC*MU) : Y=T Clip(YC,SC*MU)
   If M=2 Then FINDNEAR[X,Y] : CP=Param : _OUTLINE[CP]
   If CP=-1 Then Pop Proc
   If M=1 Then PX(CP)=X : PY(CP)=Y : GCLIP=True : GCHECK=True : _REDRAW
End Proc
Procedure _M_DEFZONE
   If M=1
    If NZ=MZ-1 : _ERROR[0,3,1] : Pop Proc : End If 
      If CZ2>-1 : _INITDEFZONE : End If 
      If CZ>=0
         If ZP(CZ)=0 : _NEWZONE : Pop Proc : End If 
         If NP=-1 : Pop Proc : End If 
         X=XC : Y=YC
         FINDNEAR[X,Y] : CP=Param
         If ZP(CZ)<3 and CP=ZO(CZ,0) : Pop Proc : End If 
         If ZP(CZ)>0
            T=1
            For A=1 To ZP(CZ)-1
               If CP=ZO(CZ,A)
                  T=0
               End If 
            Next 
            If T=0
               Pop Proc
            End If 
         End If 
         _OUTLINE[CP]
         ZO(CZ,ZP(CZ))=CP
         WT(CZ,ZP(CZ)-1)=1
         If ZP(CZ)>0 : _JOIN[ZO(CZ,ZP(CZ)-1),ZO(CZ,ZP(CZ)),6] : End If 
         If ZO(CZ,0)=ZO(CZ,ZP(CZ))
            Degree 
            WS=0 : WA=0
            For A=1 To ZP(CZ)
               WX#=PX(ZO(CZ,A))-PX(ZO(CZ,A-1))
               WY#=PY(ZO(CZ,A))-PY(ZO(CZ,A-1))
               If False
               Else If WX#=0 and WY#>0 : W2#=180
               Else If WX#=0 and WY#<0 : W2#=0
               Else If WX#>0 and WY#=0 : W2#=90
               Else If WX#<0 and WY#=0 : W2#=-90
               Else If WX#>0 and WY#>0 : W2#=180-Atan(WX#/WY#)
               Else If WX#>0 and WY#<0 : W2#=-Atan(WX#/WY#)
               Else If WX#<0 and WY#>0 : W2#=-180-Atan(WX#/WY#)
               Else If WX#<0 and WY#<0 : W2#=-Atan(WX#/WY#)
               Else W2#=WA
               End If 
               W1=W2#
               WB=(W1-WA)
               Do 
                  If False
                  Else If WB<-360 : Add WB,360
                  Else If WB>360 : Add WB,-360
                  Else If WB<-180 : WB=WB+360
                  Else If WB>180 : WB=WB-360
                  Else : Exit 
                  End If 
               Loop 
               Add WS,WB
               WA=W1
            Next A
            If WS>0
               For A=1 To ZP(CZ)
                  F=ZO(CZ,A-1) : T=ZO(CZ,A)
                  For Q=0 To NZ-1
                     If USED(Q)
                        For B=0 To ZP(Q)-1
                           If ZO(Q,B)=T and ZO(Q,B+1)=F
                              WT(CZ,A-1)=0
                              WT(Q,B)=0
                              Q=NZ+1 : B=100
                           End If 
                        Next 
                     End If 
                  Next 
               Next A
               _ZOSHOW[CZ,4] : USED(CZ)=1
               If CZ=NZ
                  Add NZ,1
               End If 
               GCLIP=True : GCHECK=True
            Else 
               _WRONG[4,1]
               For A=0 To 10 : ZO(CZ,A)=-1 : Next 
               ZP(CZ)=0 : VSUM=0
            End If 
            _INITDEFZONE
            _REDRAW
         Else 
            Add ZP(CZ),1
            If ZP(CZ)>10
               _WRONG[4,6]
               For A=0 To 10 : ZO(CZ,A)=-1 : Next 
               ZP(CZ)=0
               _REDRAW
            End If 
         End If 
      End If 
   Else If M=2
      X=XC : Y=YC
      If ZO(CZ,0)<>ZO(CZ,ZP(CZ))
         _REM_ZONE2[CZ]
      Else 
         _ZOSHOW[CZ2,4]
      End If 
      _ZOSHOW[CZ,4]
      ZOGET[X,Y]
      P=Param
      If P>=0
         CZ2=P : CZ=CZ2
      End If 
      _ZOSHOW[CZ2,10]
   End If 
End Proc
Procedure _M_DEFWALL
   '
   ' Define wall
   '
   X=XC : Y=YC
   If M=2
      _ZOSHOW[CZ,4]
      ZOGET[X,Y]
      P=Param
      If P>=0
         CZ=P
      End If 
      _ZOSHOW[CZ,10]
      OPO=-1
   Else If M=1
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If WT(CZ,A)<2
            If ZO(CZ,A)=P
               E=True
               For C=0 To NZ
                  If USED(C)
                     For B=1 To ZP(C)
                        If ZO(C,B)=ZO(CZ,A) and ZO(C,B-1)=ZO(CZ,A+1)
                           E=False : Exit 2
                        End If 
                     Next B
                  End If 
               Next C
               If E
                  _WRONG[3,8]
               Else 
                  WT(CZ,A)=1-WT(CZ,A) : _JOIN[ZO(CZ,A),ZO(CZ,A+1),10+WT(CZ,A)]
                  If Btst(0,DWALL)
                     WT(C,B-1)=WT(CZ,A) : _JOIN[ZO(C,B-1),ZO(C,B),4+WT(C,B-1)]
                  End If 
               End If 
               Exit 
            End If 
         End If 
      Next 
   End If 
End Proc
Procedure _M_DEFHEIGHT
   '
   ' Rewritten gfx-control
   '
   X=XC : Y=YC
   ZOGET[X,Y] : P=Param
   If P>-1
      If P<>CZ
         _ZOSHOW[CZ,4]
         If AUTOSTAIR1<5000
            If Btst(0,AUTOSTAIR3)
               Add AUTOSTAIR1,AUTOSTAIR2
               Add AUTOSTAIR1B,AUTOSTAIR2
               UZH(P,0)=AUTOSTAIR1
               UZH(P,1)=AUTOSTAIR1B
            Else 
               Add AUTOSTAIR1,AUTOSTAIR2
               Add AUTOSTAIR1B,AUTOSTAIR2
               ZH(P,0)=AUTOSTAIR1
               ZH(P,1)=AUTOSTAIR1B
            End If 
         Else If CZ>-1
            If Btst(4,CMODE) : ZH(P,0)=ZH(CZ,0) : End If 
            If Btst(3,CMODE) : ZH(P,1)=ZH(CZ,1) : End If 
            If Btst(5,CMODE) : ZH(P,2)=ZH(CZ,2) : End If 
            If Btst(2,CMODE) : UZH(P,0)=UZH(CZ,0) : End If 
            If Btst(1,CMODE) : UZH(P,1)=UZH(CZ,1) : End If 
         End If 
         CZ=P
         _ZOSHOW[CZ,10]
      End If 
   End If 
   _SHOWHEIGHTS
End Proc
Procedure _M_DEFROOFGRAPH
   X=XC : Y=YC
   OZRG=ZRG : RBO=RB
   If M=1
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
         ZRG(CZ,0)=ZRG : RB(CZ)=RB
         ZRG(CZ,1)=ZRGS
      End If 
   End If 
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
         ZRG=ZRG(CZ,0) : RB=RB(CZ)
         ZRGS=ZRG(CZ,1)
         _SHOWDEFROOFGRAPH
      End If 
   End If 
End Proc
Procedure _M_DEFWALLGRAPH
   X=XC : Y=YC
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         If P<>CZ
            _ZOSHOW[CZ,4]
            CZ=P
            _ZOSHOW[CZ,10]
            OPO=-1
         End If 
      End If 
   Else If M=1 and CZ>-1
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P
            ZWG(CZ,A,3)=WGW
            ZWG(CZ,A,0)=ZWG : ZWG(CZ,A,1)=ZWGL : ZWG(CZ,A,2)=ZWGC : Exit 
         End If 
      Next 
   End If 
End Proc
Procedure _M_DEFFLOORGRAPH
   X=XC : Y=YC
   OZFG=ZFG : FBO=FB
   If M=1
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
         ZFG(CZ,0)=ZFG : FB(CZ)=FB
         ZFG(CZ,1)=ZFGS
      End If 
   End If 
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
         ZFG=ZFG(CZ,0) : FB=FB(CZ)
         ZFGS=ZFG(CZ,1)
         _SHOWDEFFLOORGRAPH
      End If 
   End If 
End Proc
Procedure _M_DEFUPPERROOFGRAPH
   X=XC : Y=YC
   OZRG=ZRG : RBO=RB
   If M=1
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
         UZRG(CZ,0)=ZRG : RB(CZ)=RB
         UZRG(CZ,1)=ZRGS
      End If 
   End If 
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
         ZRG=UZRG(CZ,0) : RB=RB(CZ)
         ZRGS=UZRG(CZ,1)
         _SHOWDEFROOFGRAPH
      End If 
   End If 
End Proc
Procedure _M_DEFUPPERWALLGRAPH
   X=XC : Y=YC
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         If P<>CZ
            _ZOSHOW[CZ,4]
            CZ=P
            _ZOSHOW[CZ,10]
            OPO=-1
         End If 
      End If 
   Else If M=1 and CZ>-1
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P
            UZWG(CZ,A,3)=WGW
            UZWG(CZ,A,0)=ZWG : UZWG(CZ,A,1)=ZWGL : UZWG(CZ,A,2)=ZWGC : Exit 
         End If 
      Next 
   End If 
End Proc
Procedure _M_DEFUPPERFLOORGRAPH
   X=XC : Y=YC
   OZFG=ZFG : FBO=FB
   If M=1
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
         UZFG(CZ,0)=ZFG : FB(CZ)=FB
         UZFG(CZ,1)=ZFGS
      End If 
   End If 
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
         ZFG=UZFG(CZ,0) : FB=FB(CZ)
         ZFGS=UZFG(CZ,1)
         _SHOWDEFFLOORGRAPH
      End If 
   End If 
End Proc
Procedure _M_OBJADD
   If M=1
      X=XC : Y=YC
      _ZOSHOW[CZ,4]
      ZOGET[X,Y]
      P=Param
      If P<0 : Pop Proc : End If 
      CZ=P
      _ZOSHOW[CZ,10]
      If NO>=MOBJ-1 : _ERROR[0,3,3] : Pop Proc : End If 
      If OT=0 : Gosub ALIENPUT : End If 
      If OT=1 : Gosub THINGPUT : End If 
      _OBJPUT[X,Y,2]
   Else 
      X=XC : Y=YC
      FINDCONT[X,Y]
      CONTPT=Param
      _SHOWOBJADD
   End If 
   Pop Proc
ALIENPUT:
   S=Start(12)+NO*32
   Poke S,0
   Poke S+2,ALTO
   Doke S+4,DLOCKED
   Doke S+6,CZ
   Doke S+8,LLOCKED
   Poke S+10,UPORLO
   Poke S+11,PERMCALC
   Poke S+12,TEAM
   Doke S+14,TXT
   Doke S+16,CONTPT
   OBX(NO)=X : OBZ(NO)=Y
   Add NO,1
Return 
THINGPUT:
   S=Start(12)+NO*32
   Poke S,1
   Poke S+2,OBTO
   Doke S+4,DLOCKED
   Doke S+6,CZ
   Doke S+8,LLOCKED
   Poke S+10,UPORLO
   Poke S+11,PERMCALC
   Doke S+14,TXT
   Doke S+18,STRTANIM
   If Deek(LINK+$5A1C+OBTO*40)<>0
      D=100000000 : T=-1
      For A=0 To ZP(CZ)-1
         FX=PX(ZO(CZ,A)) : FY=PY(ZO(CZ,A))
         TX=PX(ZO(CZ,A+1)) : TY=PY(ZO(CZ,A+1))
         TX=TX-FX : TY=TY-FY
         PX=X-FX : PY=Y-FY
         NDDD=PX*TY-PY*TX
         If Abs(NDDD)<Abs(D) : D=NDDD : T=A : End If 
      Next 
      FX=PX(ZO(CZ,T)) : FY=PY(ZO(CZ,T))
      TX=PX(ZO(CZ,T+1)) : TY=PY(ZO(CZ,T+1))
      TX=TX-FX : TY=TY-FY
      L#=Sqr(TX^2+TY^2)
      L=L#
      D=D/L
      X=X-(TY*D)/L
      Y=Y+(TX*D)/L
      TX#=TX
      TY#=TY
      Degree 
      If Abs(TX#)>L#
         TX#=L#*Sgn(TX#)
      End If 
      If Abs(TY#)>L#
         TY#=L#*Sgn(TY#)
      End If 
      ANC=Acos(-TX#/L#)
      ANG=ANC
      If TY>0 : ANG=360-ANG : End If 
      ANG=(ANG+360) mod 360
   End If 
   Doke S+12,ANG
   OBX(NO)=X : OBZ(NO)=Y
   Add NO,1
Return 
End Proc
Procedure _M_OBJDEL
   X=XC : Y=YC
   FINDOBJ[X,Y]
   P=Param
   If P>=0
      If P<=(NO-1)
         S=Start(12)+P*32
         D=Start(12)+NO*32-32
         For A=0 To 31 : Poke S+A,Peek(D+A) : Next 
         _OBJPUT[OBX(P),OBZ(P),0]
         OBX(P)=OBX(NO-1) : OBZ(P)=OBZ(NO-1)
      End If 
      NO=NO-1
      For A=0 To 31
         Poke Start(12)+NO*32+A,0
      Next 
   End If 
End Proc
Procedure _M_OBJMOVE
   X=XC : Y=YC
   If M=2
      FINDOBJ[X,Y]
      COBJ=Param
   End If 
   If M=1
      If COBJ>=0
         ZOGET[X,Y] : P=Param
         OBX(COBJ)=X : OBZ(COBJ)=Y
         S=Start(12)+COBJ*32
         Doke S+6,P
         _REDRAW
         _ZOSHOW[P,10]
      End If 
   End If 
End Proc
Procedure _M_PLACEPLAYER
   X=XC : Y=YC
   If M=1
      'ZOSHO[PLZ,4]
      ZOGET[X,Y] : P=Param : If P>=0 : PLZ=P : End If 
      PLX=X : PLY=Y : _REDRAW
      'ZOSHO[PLZ,10] 
   End If 
   If M=2
      'ZOSHO[PLZ2,4] 
      ZOGET[X,Y] : P=Param : If P>=0 : PLZ2=P : End If 
      PLX2=X : PLY2=Y : _REDRAW
      'ZOSHO[PLZ2,10]
   End If 
End Proc
Procedure _M_DEFDOOR
   X=XC : Y=YC
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         If P<>CZ
            _ZOSHOW[CZ,4]
            CZ=P
            _ZOSHOW[CZ,10]
            OPO=-1
         End If 
      End If 
   Else If M=1
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P
            If WT(CZ,A)=0
               If ZLI(CZ)>0
                  _WRONG[3,2]
               Else If ZD(CZ)>0
                  _WRONG[3,3]
               Else If CZ2<0
                  _WRONG[3,4]
               Else 
                  E=True
                  For B=1 To ZP(CZ2)
                     If ZO(CZ2,B)=ZO(CZ,A) and ZO(CZ2,B-1)=ZO(CZ,A+1)
                        E=False : Exit 
                     End If 
                  Next B
                  If E
                     _WRONG[3,6]
                  Else 
                     WT(CZ,A)=2
                     WD(CZ,A)=NDO+1
                     WT(CZ2,B-1)=2
                     WD(CZ2,B-1)=NDO+1
                  End If 
               End If 
            Else If WT(CZ,A)=2
               E=True
               If CZ2>-1
                  For B=1 To ZP(CZ2)
                     If ZO(CZ2,B)=ZO(CZ,A) and ZO(CZ2,B-1)=ZO(CZ,A+1)
                        E=False : Exit 
                     End If 
                  Next B
               End If 
               If Not E
                  WT(CZ2,B-1)=0
                  WD(CZ2,B-1)=0
               End If 
               WT(CZ,A)=0
               WD(CZ,A)=0
            Else If WT(CZ,A)=1
               _WRONG[3,0]
            Else 
               _WRONG[3,1]
            End If 
            _ZOSHOW[CZ,10]
            Exit 
         End If 
      Next 
   End If 
End Proc
Procedure _M_DEFLIFT
   X=XC : Y=YC
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         If P<>CZ
            _ZOSHOW[CZ,4]
            CZ=P
            _ZOSHOW[CZ,10]
            OPO=-1
         End If 
      End If 
      _SHOWLIFT
   Else If M=1
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P
            If WT(CZ,A)=0
               If ZLI(CZ)>0
                  _WRONG[3,2]
               Else If ZD(CZ)>0
                  _WRONG[3,3]
               Else If CZ2<0
                  _WRONG[3,5]
               Else 
                  E=True
                  For B=1 To ZP(CZ2)
                     If ZO(CZ2,B)=ZO(CZ,A) and ZO(CZ2,B-1)=ZO(CZ,A+1)
                        E=False : Exit 
                     End If 
                  Next B
                  If E
                     _WRONG[3,7]
                  Else 
                     WT(CZ,A)=5
                     'WT(CZ2,B-1)=5 
                     WLI(CZ,A)=NL+1
                     'WLI(CZ2,B-1)=NL+1 
                  End If 
               End If 
            Else If WT(CZ,A)=5
               'E=True
               'For B=1 To ZP(CZ2)
               '   If ZO(CZ2,B)=ZO(CZ,A) and ZO(CZ2,B-1)=ZO(CZ,A+1) 
               '      E=False : Exit  
               '   End If 
               'Next B
               'If Not E
               '   WT(CZ2,B-1)=0
               '   WLI(CZ2,B-1)=0 
               'End If  
               WT(CZ,A)=0
               WLI(CZ,A)=0
            Else If WT(CZ,A)=1
               _WRONG[3,0]
            Else 
               _WRONG[3,1]
            End If 
            _ZOSHOW[CZ,10]
            Exit 
         End If 
      Next 
      _SHOWLIFT
   End If 
End Proc
Procedure _M_DEFTELEPORT
   X=XC : Y=YC
   If M=2
      _ZOSHOW[CZ,4]
      ZOGET[X,Y]
      CZ=Param
      _ZOSHOW[CZ,10]
   End If 
   If M=1
      ZOGET[X,Y] : P=Param
      If P>=0 and CZ>=0
         TELZO(CZ)=P : TELX(CZ)=X : TELZ(CZ)=Y
         GCHECK=True
      Else 
         GCHECK=True
         TELZO(CZ)=-1
      End If 
      _REDRAW
   End If 
End Proc
Procedure _M_DEFUPPERBRIGHT
   X=XC : Y=YC
   If M=2
      _ZOSHOW[CZ,4]
      ZOGET[X,Y]
      P=Param
      If P>=0
         CZ=P
      End If 
      CP=-1
      _OUTLINE[CP]
      _ZOSHOW[CZ,10]
   End If 
   If M=1 and CZ>-1
      FINDNEARZONE[CZ,X,Y]
      CP=Param
      _OUTLINE[CP]
      If CMODE
         For A=0 To ZP(CZ)-1
            If ZO(CZ,A)=CP : ZPBR(CZ,A,3)=(PDTA*$1000)+(PAN*$100)+(PBR and $FF) : ZPBR(CZ,A,2)=(PDTAF*$1000)+(PANF*$100)+(PBRF and $FF) : End If 
         Next 
      End If 
      _SHOWBRIGHTSLIDE
   End If 
End Proc
Procedure _M_DEFLOWERBRIGHT
   X=XC : Y=YC
   If M=2
      _ZOSHOW[CZ,4]
      ZOGET[X,Y]
      P=Param
      If P>=0
         CZ=P
      End If 
      CP=-1
      _OUTLINE[CP]
      _ZOSHOW[CZ,10]
   End If 
   If M=1 and CZ>-1
      FINDNEARZONE[CZ,X,Y]
      CP=Param
      _OUTLINE[CP]
      If CMODE
         For A=0 To ZP(CZ)-1
            If ZO(CZ,A)=CP : ZPBR(CZ,A,1)=(PDTA*$1000)+(PAN*$100)+(PBR and $FF) : ZPBR(CZ,A,0)=(PDTAF*$1000)+(PANF*$100)+(PBRF and $FF) : End If 
         Next 
      End If 
      _SHOWBRIGHTSLIDE
   End If 
End Proc
Procedure _M_DEFWATERANIM
   X=XC : Y=YC
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         If P<>CZ
            _ZOSHOW[CZ,4]
            CZ=P
            _ZOSHOW[CZ,10]
         End If 
      End If 
   End If 
End Proc
Procedure _M_DEFWALLBRIGHT
   X=XC : Y=YC
   If M=2
      ZOGET[X,Y] : P=Param
      If P>-1
         If P<>CZ
            _ZOSHOW[CZ,4]
            CZ=P
            _ZOSHOW[CZ,10]
            OPO=-1 : CCP=-1
         End If 
      End If 
      _SHOWWALLBRIGHT
   Else If M=1
      FINDNEARZONE[CZ,X,Y]
      P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P
            _ZOSHOW[CZ,10]
            _JOIN[ZO(CZ,A),ZO(CZ,A+1),7]
            CCP=A : Exit 
         End If 
      Next 
      _SHOWWALLBRIGHT
   End If 
End Proc
Procedure _M_CPTNEARTOZONE
   X=XC : Y=YC
   If M=2
      ZOGET[X,Y]
      P=Param
      If P>=0
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
      End If 
      If ZCPT(CZ)>-1 and ZCPT(CZ)<=NCPT
         HIGHCONT[ZCPT(CZ)]
      End If 
   End If 
   If M=1
      'check if zone selected first
      If CZ<0
         Pop Proc
      End If 
      FINDCONT[X,Y]
      P=Param
      If P>-1
         ZCPT(CZ)=P
         HIGHCONT[ZCPT(CZ)]
      End If 
      GLINK=True
   End If 
End Proc
Procedure _M_CPTNEARTOUPPERZONE
   X=XC : Y=YC
   If M=2
      ZOGET[X,Y]
      P=Param
      If P>=0
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
      End If 
      If UZCPT(CZ)>-1 and UZCPT(CZ)<=NCPT
         HIGHCONT[UZCPT(CZ)]
      End If 
   End If 
   If M=1
      FINDCONT[X,Y]
      P=Param
      If P>-1
         UZCPT(CZ)=P
         HIGHCONT[UZCPT(CZ)]
      End If 
      GLINK=True
   End If 
End Proc
Procedure _M_PLACECONTPT
   ' OP=28
   X=XC : Y=YC
   ZOGET[X,Y]
   Z=Param
   If Z<0 Then Pop Proc
   If NCPT>=MCP-1 : _ERROR[0,3,2] : Pop Proc : End If 
   Add NCPT,1
   CPTX(NCPT)=X
   CPTY(NCPT)=Y
   CPTZ(NCPT)=Z
   If M=1 Then CPTUL(NCPT)=0 Else CPTUL(NCPT)=1
   CPTPUT[X,Y,8-CPTUL(NCPT)*2]
   GLINK=True
End Proc
Procedure _M_CPTMOVE
   ' OP=35
   X=XC : Y=YC
   If P1<0 Then Pop Proc
   ZOGET[X,Y]
   Z=Param
   If Z<0 Then Pop Proc
   CPTX(P1)=X
   CPTY(P1)=Y
   CPTZ(P1)=Z
   If M=1 Then CPTUL(P1)=0 Else CPTUL(P1)=1
   _REDRAW
   GLINK=True
End Proc
Procedure _M_CONNECTCONT
   X=XC : Y=YC
   FINDCONT[X,Y]
   If P1<0
      P1=Param
      'For B=0 To NCPT-1 
      '   If B<>P1 : _CONNECTED[P1,B,P1] : End If  
      'Next  
      Pop Proc
   End If 
   P2=Param
   If P2=-1 Then Pop Proc
   If P1=P2 Then Pop Proc
   N=Start(11)
   Q=Peek(N+P1*100+P2)
   W=Peek(N+P2*100+P1)
   If Q or W
      If Q=1 and W=1
         _JOINCOORDS[CPTX(P1),CPTY(P1),CPTX(P2),CPTY(P2),0]
      End If 
      If Q=2 and W=2
         _JOINCOORDS[CPTX(P1),CPTY(P1),CPTX(P2),CPTY(P2),0]
      End If 
      If Q=1 and W=2
         _JOINCOORDS[CPTX(P1),CPTY(P1),CPTX(P2),CPTY(P2),0]
         XD=CPTX(P2)-CPTX(P1)
         YD=CPTY(P2)-CPTY(P1)
         LD=Sqr(XD^2+YD^2)
         XD=(XD*30)/LD
         YD=(YD*30)/LD
         _JOINCOORDS[CPTX(P2)-XD,CPTY(P2)-YD,CPTX(P2)-XD*2-YD/2,CPTY(P2)-YD*2+XD/2,0]
         _JOINCOORDS[CPTX(P2)-XD,CPTY(P2)-YD,CPTX(P2)-XD*2+YD/2,CPTY(P2)-YD*2-XD/2,0]
      End If 
      If Q=2 and W=1
         XD=CPTX(P2)-CPTX(P1)
         YD=CPTY(P2)-CPTY(P1)
         LD=Sqr(XD^2+YD^2)
         XD=(XD*30)/LD
         YD=(YD*30)/LD
         _JOINCOORDS[CPTX(P1),CPTY(P1),CPTX(P2),CPTY(P2),0]
         _JOINCOORDS[CPTX(P1)+XD,CPTY(P1)+YD,CPTX(P1)+XD*2-YD/2,CPTY(P1)+YD*2+XD/2,0]
         _JOINCOORDS[CPTX(P1)+XD,CPTY(P1)+YD,CPTX(P1)+XD*2+YD/2,CPTY(P1)+YD*2-XD/2,0]
      End If 
   End If 
   If M=1
      If Peek(N+P1*100+P2)<>1
         Poke N+P1*100+P2,1
         If Peek(N+P2*100+P1)=0
            Poke N+P2*100+P1,2
         End If 
      Else 
         Poke N+P1*100+P2,0
         If Peek(N+P2*100+P1)=1
            Poke N+P1*100+P2,2
         Else 
            Poke N+P2*100+P1,0
         End If 
      End If 
      GLINK=True
   Else 
      If Peek(N+P1*100+P2)=2
         Poke N+P1*100+P2,0
         Poke N+P2*100+P1,0
      Else 
         Poke N+P1*100+P2,2
         Poke N+P2*100+P1,2
      End If 
      GLINK=True
   End If 
   _CONNECTED[P1,P2,-1]
   P1=-1
   P2=-1
End Proc
Procedure _M_DEFBACKSFX
   X=XC : Y=YC
   _ZOSHOW[CZ,4]
   ZOGET[X,Y] : P=Param : If P>=0 Then CZ=P
   _ZOSHOW[CZ,10]
   If CZ<0 Then Pop Proc
   _SHOWBACKSFX
End Proc
Procedure _M_DEFGFX
   '
   '
   '
   X=XC : Y=YC
   If M=1
      ZOGET[X,Y] : P=Param
      If P>-1
         _ZOSHOW[CZ,4]
         CZ=P
         _ZOSHOW[CZ,10]
      End If 
      _SHOWDEFGFX[True]
   End If 
End Proc
'
'----------------------------------------------------------------------------  
'   VanillaKey PROCEDURER    
'----------------------------------------------------------------------------  
'
Procedure _VANILLAKEY
   If OP=1 : _V_DEFZONE : End If 
   If OP=2 : _V_OBJADD : End If 
   If OP=4 : _V_DEFWALL : End If 
   If OP=11 : _V_PLACEPLAYER : End If 
   If OP=22 : _V_DEFWALLGRAPH : End If 
   If OP=25 : _V_DEFUPPERWALLGRAPH : End If 
   If OP=28 : _V_PLACECONTPT : End If 
   If OP=29 : _V_CPTNEARTOZONE : End If 
   If OP=31 : _V_CONNECTCONT : End If 
   If OP=35 : _V_CPTMOVE : End If 
End Proc
'
Procedure _V_DEFZONE
   If A$="d" and CZ2>=0
      If ZD(CZ2)<>0
         _WRONG[4,4]
      Else If ZLI(CZ2)<>0
         _WRONG[4,5]
      Else 
         T=1
         For A=0 To ZP(CZ2)-1
            If WD(CZ2,A)>0
               _WRONG[4,2] : T=0 : A=100
            Else If WLI(CZ2,A)>0
               _WRONG[4,3] : T=0 : A=100
            End If 
         Next 
         If T<>0
            _REM_ZONE2[CZ2]
         End If 
      End If 
      _INITDEFZONE
      GCLIP=True : GCHECK=True
   End If 
End Proc
Procedure _V_DEFWALL
   '
   ' Define wall
   '
   If A$="," and CZ>0 Then _ZOSHOW[CZ,4] : CZ=CZ-1 : _ZOSHOW[CZ,10]
   If A$="." and CZ<NZ-1 Then _ZOSHOW[CZ,4] : CZ=CZ+1 : _ZOSHOW[CZ,10]
   X=XC : Y=YC
   If A$="b"
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P and(WT(CZ,A)=0 or WT(CZ,A)=3)
            WT(CZ,A)=3-WT(CZ,A) : _JOIN[ZO(CZ,A),ZO(CZ,A+1),10+WT(CZ,A)]
         End If 
      Next 
   Else If A$="v"
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P and(WT(CZ,A)=0 or WT(CZ,A)=4)
            WT(CZ,A)=4-WT(CZ,A) : _JOIN[ZO(CZ,A),ZO(CZ,A+1),10+WT(CZ,A)]
         End If 
      Next 
   End If 
End Proc
Procedure _V_DEFWALLGRAPH
   X=XC : Y=YC
   If A$="f" and CZ>-1
      For A=0 To ZP(CZ)-1
         ZWG(CZ,A,3)=WGW
         ZWG(CZ,A,0)=ZWG : ZWG(CZ,A,1)=ZWGL : ZWG(CZ,A,2)=ZWGC
      Next 
   Else If A$="g" and CZ>-1
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P
            WGW=ZWG(CZ,A,3)
            ZWG=ZWG(CZ,A,0) : ZWGL=ZWG(CZ,A,1) : ZWGC=ZWG(CZ,A,2)
            Exit 
         End If 
      Next 
      _SHOWDEFGRAPH
   End If 
End Proc
Procedure _V_DEFUPPERWALLGRAPH
   X=XC : Y=YC
   If A$="f" and CZ>-1
      For A=0 To ZP(CZ)-1
         UZWG(CZ,A,3)=WGW
         UZWG(CZ,A,0)=ZWG : UZWG(CZ,A,1)=ZWGL : UZWG(CZ,A,2)=ZWGC
      Next 
   Else If A$="g" and CZ>-1
      FINDNEARZONE[CZ,X,Y] : P=Param
      For A=0 To ZP(CZ)-1
         If ZO(CZ,A)=P
            WGW=UZWG(CZ,A,3)
            ZWG=UZWG(CZ,A,0) : ZWGL=UZWG(CZ,A,1) : ZWGC=UZWG(CZ,A,2) : A=200
         End If 
      Next 
      _SHOWDEFGRAPH
   End If 
End Proc
Procedure _V_OBJADD
   If A$="g"
      X=XC : Y=YC
      DI=100000000
      For A=0 To NO-1
         DX=OBX(A)-X
         DY=OBZ(A)-Y
         D=DX^2+DY^2
         If D<DI
            DI=D : T=A
         End If 
      Next 
      S=Start(12)+T*32
      OT=Peek(S)
      If OT=0
         ALTO=Peek(S+2)
         DLOCKED=Deek(S+4)
         LLOCKED=Deek(S+8)
         UPORLO=Peek(S+10)
         PERMCALC=Peek(S+11)
         TEAM=Speek(S+12)
         TXT=Sdeek(S+14)
         CONTPT=Deek(S+16)
         _SHOWOBJADD
      Else 
         OBTO=Peek(S+2)
         DLOCKED=Deek(S+4)
         LLOCKED=Deek(S+8)
         UPORLO=Peek(S+10)
         PERMCALC=Peek(S+11)
         TXT=Sdeek(S+14)
         STRTANIM=Deek(S+18)
         _SHOWOBJADD
      End If 
   End If 
   If A$="p"
      X=XC : Y=YC
      DI=100000000
      For A=0 To NO-1
         DX=OBX(A)-X
         DY=OBZ(A)-Y
         D=DX^2+DY^2
         If D<DI
            DI=D : T=A
         End If 
      Next 
      S=Start(12)+T*32
      OT=Peek(S)
      If OT=0
         Poke S,0
         Poke S+2,ALTO
         Doke S+4,DLOCKED
         Doke S+8,LLOCKED
         Poke S+10,UPORLO
         Poke S+11,PERMCALC
         Poke S+12,TEAM
         Doke S+14,TXT
         Doke S+16,CONTPT
      Else 
         Poke S,1
         Poke S+2,OBTO
         Doke S+4,DLOCKED
         Doke S+8,LLOCKED
         Poke S+10,UPORLO
         Poke S+11,PERMCALC
         Doke S+14,TXT
         Doke S+18,STRTANIM
      End If 
   End If 
End Proc
Procedure _V_PLACEPLAYER
   X=XC : Y=YC
   If A$="e"
      'ZOSHO[PLZ,4]
      ZOGET[X,Y] : P=Param : If P>=0 : EZONE=P : End If 
      _REDRAW
      'ZOSHO[PLZ,10] 
   End If 
End Proc
Procedure _V_CPTNEARTOZONE
   X=XC : Y=YC
   If A$="A"
      N=Start(11)
      For A=0 To NZ-1
         For B=0 To ZP(A)-1
            ZZ(A,B)=-1
            For C=0 To NZ-1
               For D=0 To ZP(C)-1
                  If ZO(A,B)=ZO(C,D+1) and ZO(A,B+1)=ZO(C,D)
                     ZZ(A,B)=C
                     D=ZP(C) : C=NZ
                  End If 
               Next 
            Next 
         Next 
      Next 
      For AZ=0 To NZ-1
         TX=0 : TY=0
         For B=0 To ZP(AZ)-1
            TX=TX+PX(ZO(AZ,B))
            TY=TY+PY(ZO(AZ,B))
         Next 
         TX=TX/ZP(AZ)
         TY=TY/ZP(AZ)
         VX=(TX-XO)/MU*XRES : VY=(TY-YO)/MU
         Turbo Plot VX,VY,10
         DDD=100000000
         For A=0 To NCPT
            X1=CPTX(A) : X2=TX
            Y1=CPTY(A) : Y2=TY
            DX=X2-X1 : DY=Y2-Y1
            ND=DX^2+DY^2
            If ND<DDD
               Z1=CPTZ(A) : Z2=AZ
               If Z1<>Z2
                  Repeat 
                     DL=DX*(PY(ZO(Z1,0))-Y1)-DY*(PX(ZO(Z1,0))-X1)
                     For C=1 To ZP(Z1)
                        ' find exit from this zone...
                        DR=DX*(PY(ZO(Z1,C))-Y1)-DY*(PX(ZO(Z1,C))-X1)
                        If DL<0 and DR>=0
                           T=C
                           C=100
                        End If 
                        DL=DR
                     Next 
                     _JOINCOORDS[PX(ZO(Z1,T)),PY(ZO(Z1,T)),PX(ZO(Z1,T-1)),PY(ZO(Z1,T-1)),15]
                     Z1=ZZ(Z1,T-1)
                  Until Z1=Z2 or Z1<0
               End If 
               If Z1=Z2
                  PQ=A
                  DDD=ND
               End If 
            End If 
         Next 
         ZCPT(AZ)=PQ
      Next 
      GLINK=True
   End If 
End Proc
Procedure _V_CPTMOVE
   ' OP=35
   X=XC : Y=YC
   If A$="g"
      FINDCONT[X,Y] : P1=Param
   End If 
End Proc
Procedure _V_CONNECTCONT
   If A$="V"
      Gosub AUTOLINK
      GLINK=True
   End If 
   Pop Proc
AUTOLINK:
   ' link up all control points visually
   Reserve As Gt Gadgets 498,10,1
   _gt Set Mode 0,"",0,1
   _gt Text 1,16,16,288,12,,"","Zone Update:",1
   _gt Text 2,16,32,288,12,,"","ControlPoints:",1

   _wnd Id Open 2,160,128,320,52,$2,$0,0,""
   _gt Gadgets Attach 498
   _wnd Id Titles "AutoLinking Visual",VER$
   N=Start(11)
   If NCPT>0
      For A=0 To NZ-1
         _gt Set Text 1,"Zone Update:"+Str$(A)+" of"+Str$(NZ-1),,,
         For B=0 To ZP(A)-1
            ZZ(A,B)=-1
            For C=0 To NZ-1
               For D=0 To ZP(C)-1
                  If ZO(A,B)=ZO(C,D+1) and ZO(A,B+1)=ZO(C,D)
                     ZZ(A,B)=C
                     D=ZP(C) : C=NZ
                  End If 
               Next 
            Next 
         Next 
      Next 
      For A=0 To NCPT-1
         _gt Set Text 2,"ControlPoints:"+Str$(A)+" of"+Str$(NCPT-1),,,
         For B=A+1 To NCPT
            If Peek(N+A*100+B)<>1 and Peek(N+B*100+A)<>1
               Poke N+A*100+B,0
               Poke N+B*100+A,0
               ' check for link...  
               PHYS=1
               X1=CPTX(A) : X2=CPTX(B)
               Y1=CPTY(A) : Y2=CPTY(B)
               DX=X2-X1 : DY=Y2-Y1
               Z1=CPTZ(A) : Z2=CPTZ(B)
               Repeat 
                  DL=DX*(PY(ZO(Z1,0))-Y1)-DY*(PX(ZO(Z1,0))-X1)
                  For C=1 To ZP(Z1)
                     ' find exit from this zone...
                     DR=DX*(PY(ZO(Z1,C))-Y1)-DY*(PX(ZO(Z1,C))-X1)
                     If DL<=0 and DR>=0
                        T=C
                        C=100
                     End If 
                     DL=DR
                  Next 
                  _JOINCOORDS[PX(ZO(Z1,T)),PY(ZO(Z1,T)),PX(ZO(Z1,T-1)),PY(ZO(Z1,T-1)),15]
                  Z1=ZZ(Z1,T-1)
               Until Z1=Z2 or Z1<0
               If Z1=Z2
                  Poke N+A*100+B,2 : Poke(N+B*100+A),2
               End If 
            End If 
         Next 
      Next 
      _REDRAW
   End If 
   GLINK=True

   _gt Gadgets Remove 498
   _gt Gadgets Erase 498
   _wnd Id Close 2
Return 
End Proc
Procedure _V_PLACECONTPT
   '
   ' Remove Controlpoints 
   '
   If A$="d"
      X=XC : Y=YC
      FINDCONT[X,Y]
      P=Param
      If P>-1
         HIGHCONT[ZCPT(CZ)]
         N=Start(11)
         For A=P To NCPT
            CPTX(A)=CPTX(A+1)
            CPTY(A)=CPTY(A+1)
            CPTZ(A)=CPTZ(A+1)
            CPTUL(A)=CPTUL(A+1)
            For B=0 To NCPT
               Poke N+B*100+A,Peek(N+B*100+A+1)
            Next B
         Next A
         For A=P To NCPT
            For B=0 To NCPT
               Poke N+A*100+B,Peek(N+(A+1)*100+B)
            Next B
         Next A
         Dec NCPT
         For A=0 To NZ
            If ZCPT(A)>P : Dec ZCPT(A) : End If 
            If ZCPT(A)=0 : ZCPT(A)=-1 : End If 
         Next A
      End If 
      _REDRAW
      GLINK=True
   End If 
End Proc
'
'----------------------------------------------------------------------------  
'   Every PROCEDURER   
'----------------------------------------------------------------------------  
'
Procedure _EVERY
   If OP=0 : _EVERY_MARKPOINT : End If 
   If OP=3 : _EVERY_MARKPOINT : End If 
   If OP=4 : _EVERY_SHOWWALL : End If 
   If OP=14 : _EVERY_SHOWWALL : End If 
   If OP=17 : _EVERY_SHOWWALL : End If 
   If OP=22 : _EVERY_SHOWWALL : End If 
   If OP=25 : _EVERY_SHOWWALL : End If 
   If STMODE=1 : _STAT_SHOW : End If 
   _MODE_SHOW
End Proc
'
Procedure _EVERY_SHOWWALL
   If CZ>-1
      X=XC : Y=YC
      _FINDNEARZONE2[CZ,X,Y] : P=Param
      If P>-1 and P<>OPO
         OPO=P
         _ZOSHOW[CZ,10]
         _JOIN[ZO(CZ,OPO),ZO(CZ,OPO+1),7]
      End If 
   End If 
End Proc
Procedure _EVERY_MARKPOINT
   If SPRDATA(4,2)
      _wnd Id Use 0
      X=T Clip(XC,SC*MU) : Y=T Clip(YC,SC*MU)
      WX=(X-XO)/MU : WY=((Y-YO)/MU)/YRES
      Add WX,_wnd Id X
      If WX>0 and WY>0
         VP=_scr What Vport(_scr Id Base(1))
         _spr Move VP,SPRDATA(4,1),WX-8,WY-(6/YRES)
      End If 
   End If 
End Proc
'
'----------------------------------------------------------------------------  
'   Varoious     
'----------------------------------------------------------------------------  
'
Procedure _SELSFX[M,N$]
   If N$="" : N$=Catalog String$(200,"Select a SFX-sample (Hold 'Shift' to hear it)") : End If 
   _SELGEN[LINK+$A40,60,64,N$,M,1]
   P=Param
End Proc[P]
Procedure _SELGFX[M,N$]
   If N$="" : N$=Catalog String$(201,"Select a GFX-Frame file") : End If 
   _SELGEN[LINK+$2C0,30,64,N$,M,0]
   P=Param
End Proc[P]
Procedure _SELVEC[M,N$]
   If N$="" : N$=Catalog String$(202,"Select a Vector file") : End If 
   _SELGEN[LINK+$13FE0,30,64,N$,M,0]
   P=Param
End Proc[P]
Procedure _SELOBJ[M,N$]
   _SELOBJ2[M,LINK,N$]
   P=Param
End Proc[P]
Procedure _SELOBJ2[M,AD,N$]
   If N$="" : N$=Catalog String$(203,"Select an Object") : End If 
   _SELGEN[AD+$57B0,30,20,N$,M,0]
   P=Param
End Proc[P]
Procedure _SELBUL[M,N$]
   _SELBUL2[M,LINK,N$]
   P=Param
End Proc[P]
Procedure _SELBUL2[M,AD,N$]
   If N$="" : N$=Catalog String$(204,"Select a BulletType") : End If 
   _SELGEN[AD+$3230,20,20,N$,M,0]
   P=Param
End Proc[P]
Procedure _SELALI[M,N$]
   _SELALI2[M,LINK,N$]
   P=Param
End Proc[P]
Procedure _SELALI2[M,AD,N$]
   If N$="" : N$=Catalog String$(205,"Select an Alien") : End If 
   _SELGEN[AD+$34D8,20,20,N$,M,0]
   P=Param
End Proc[P]
Procedure _SELGEN[ADR_I,NR_I,J_I,T$,M,M2]
   _scr Id Show 1
   Dim W$(NR_I+M)
   If M=1
      W$(0)=Catalog String$(15,"<<NONE>>")
      For A=0 To NR_I-1
         W$(A+1)=Peek$(ADR_I+A*J_I,J_I,Chr$(0))
      Next A
   Else 
      For A=0 To NR_I-1
         W$(A)=Peek$(ADR_I+A*J_I,J_I,Chr$(0))
      Next A
   End If 
   Reserve As Gt Gadgets 498,2,1
   _gt Set Mode 0,"",0,1
   _gt Set Listview Mode ,,,16,0,
   _gt Listview 1,16,12,544,88,,"",Array(W$(0)),0
   _wnd Id Open 2,0,128,568,90,$2,F_IDCMP,0,""
   _gt Gadgets Attach 498
   _wnd Id Titles T$,VER$

   Do 
      AC=_wnd Id Next Event
      GA=_wnd Id Event Gadget
      KS=_wnd Id Event Qualifier and %11111
      If _wnd Id Event Wnd=2 and AC=$40
         If GA=1
            P=_wnd Id Event Code
            If KS
               If M
                  _PLAY_SAMPLE[Peek$(ADR_I+(P-1)*J_I,J_I,Chr$(0))]
               Else 
                  _PLAY_SAMPLE[Peek$(ADR_I+P*J_I,J_I,Chr$(0))]
               End If 
            Else 
               Exit 
            End If 
         End If 
      End If 
      Multi Wait 
   Loop 
   _gt Gadgets Remove 498
   _gt Gadgets Erase 498
   _wnd Id Close 2
End Proc[P]
'
Procedure _SELLEVEL[N$]

   Reserve As Gt Gadgets 498,21,1
   _gt Set Mode 0,"",0,1
   For A=0 To 15
      _gt Button A+1,16,16+A*12,384,12,,Chr$(A+65)+" - "+Peek$(LINK+$40+A*40,40,Chr$(0))
   Next A
   _gt Button 20,16,220,384,12,,Catalog String$(15,"<<NONE>>")

   _wnd Id Open 2,0,128,400,236,$2,$40,0,""
   _gt Gadgets Attach 498
   If N$="" : _wnd Id Titles Catalog String$(206,"Select a Level"),VER$
   Else : _wnd Id Titles N$,VER$
   End If 

   F$=""
   Do 
      AC=_wnd Id Next Event
      If _wnd Id Event Wnd=2 and AC=$40
         P=_wnd Id Event Gadget
         If P=20
            Exit 
         Else 
            F$=Chr$(64+P)
            Exit 
         End If 
      End If 
      Multi Wait 
   Loop 

   _gt Gadgets Remove 498
   _gt Gadgets Erase 498
   _wnd Id Close 2
End Proc[F$]
'
Procedure _FRAMEPICK[M,OG,SV]
   Dim C(32),W1$(1)
   W1$(0)=Catalog String$(211,"Flip:")+" "+Catalog String$(2,"No")
   W1$(1)=Catalog String$(211,"Flip:")+" "+Catalog String$(1,"Yes")

   FRN=Abs(SV)
   If FRN<1 : FRN=1 : End If 
   F$=Peek$(LINK+$2C0+OG*64,64,Chr$(0))
   If SV<0 Then FLIP=1 Else FLIP=0
   _LOAD[15,F$+".256pal"]
   If Param=0 : Pop Proc : End If 

   _scr Id Open 2,0,64,_scr Id Width(1)/2,148,6,SCR_MODE and $FFFF1000,0,"Breed Editor Work"

   _wnd Id Open 2,0,20,_scr Id Width(2),148,$2,F_IDCMP,0,"Levels.."
   _wnd Id Titles Catalog String$(530,"Set Object Frames"),VER$
   _wnd Id Activate 2
   _scr Id Show 2
   Reserve As Gt Gadgets 498,30,2

   _gt Text 1,138,20,182,12,,"","",1
   _gt Image 2,138,44,1,GAD24(2),GAD24(3)
   _gt Image 3,162,44,1,GAD24(4),GAD24(5)
   _gt Button 4,186,44,134,12,,Catalog String$(1,"Yes")
   If Btst(0,M)
      _gt Cycle 5,138,56,182,12,,"",Array(W1$(0)),0
   End If 
   '
   ' Set colours
   '
   For A=0 To 31
      B=Peek(Start(15)+A*2)
      DR=Deek(PALC+B*6) : DG=Deek(PALC+B*6+2) : DB=Deek(PALC+B*6+4)
      _scr Id Set Aga Pal A+8,DR*$10000+DG*$100+DB
      C(A)=A+8
   Next 
   Erase 401 : Erase 402
   _LOAD[401,F$+".ptr"]
   _LOAD[402,F$+".wad"]

   _gt Gadgets Attach 498
   If Length(401)>0 and Length(402)>0
      Do 
         LX=Deek(LINK+$39B0+OG*256+(FRN-1)*8)
         LY=Deek(LINK+$39B0+OG*256+(FRN-1)*8+2)
         LW=Deek(LINK+$39B0+OG*256+(FRN-1)*8+4)*2
         LH=Deek(LINK+$39B0+OG*256+(FRN-1)*8+6)*2

         _wnd Id Ink 0,0,0
         W=_wnd Id Width-16
         _wnd Id Bar 8,16 To 128+8,128+16
         For WAA=0 To Min(127,LW)
            WA=WAA+LX
            OF=Leek(Start(401)+WA*4)
            If OF>=$2000000 : SS=2
            Else If OF>=$1000000 : SS=1
            Else : SS=0
            End If 
            OF=OF and $FFFFFF
            AP=Start(402)+OF+(LY*2)
            For WB=0 To Min(127,LH)
               C=Deek(AP) : Add AP,2
               If SS=0 : _wnd Id Ink C(C mod 32),0,0 : End If 
               If SS=1 : _wnd Id Ink C((C/32) mod 32),0,0 : End If 
               If SS=2 : _wnd Id Ink C((C/1024) mod 32),0,0 : End If 
               If FLIP=0
                  _wnd Id Plot WAA+8,WB+16
               Else 
                  _wnd Id Plot Min(127,LW)-WAA+8,WB+16
               End If 
            Next WB
         Next WAA

         _gt Set Text 1,Catalog String$(210,"Frame:")+Str$(FRN),,,
         If Btst(0,M)
            _gt Set Cycle 5,,FLIP
         End If 
         Do 
            AC=_wnd Id Next Event
            If _wnd Id Event Wnd<>2 : AC=0 : End If 
            If AC=$40
               C=_wnd Id Event Gadget
               If C=2 : FRN=Max(FRN-1,1) : Exit 
               Else If C=3 : FRN=Min(FRN+1,64) : Exit 
               Else If C=4 : Exit 2
               Else If C=5 and Btst(0,M) : FLIP=1-FLIP : Exit 
               End If 
            End If 
            Multi Wait 
         Loop 
      Loop 
      If FLIP=1
         FRN=-FRN
      End If 
   End If 
   _gt Gadgets Remove 498
   _wnd Id Close 2
   _gt Gadgets Erase 498
   _scr Id Close 2
   _scr Id Use 1
   _scr Id Show 1
End Proc[FRN]
Procedure _VFRAMEPICK[M,OG,SV]
   FRN=Abs(SV)
   If FRN<1 : FRN=1 : End If 
   If SV<0 Then FLIP=1 Else FLIP=0

   _wnd Id Open 2,0,20,_scr Id Width(1)/2,140,$2,F_IDCMP,0,"Levels.."
   _wnd Id Titles Catalog String$(530,"Set Object Frames"),VER$
   _wnd Id Activate 2
   Reserve As Gt Gadgets 498,30,2

   _gt Text 1,130,20,182,12,,"","",1
   _gt Image 2,130,44,1,GAD24(2),GAD24(3)
   _gt Image 3,154,44,1,GAD24(4),GAD24(5)
   _gt Button 4,178,44,134,12,,Catalog String$(1,"Yes")

   Do 
      _wnd Id Ink 0,0,0
      _wnd Id Bar 8,16 To 128+8,128+16

      _wnd Id Ink 1,0,0
      _wnd Id Text 8,20,Catalog String$(216,"Sorry, But This editor")
      _wnd Id Text 8,30,Catalog String$(217,"Can't show VectorFrames")
      _wnd Id Text 8,40,Catalog String$(218,"Look out for an update")

      _gt Set Text 1,Catalog String$(210,"Frame:")+Str$(FRN),,,
      Do 
         AC=_wnd Id Next Event
         If _wnd Id Event Wnd<>2 : AC=0 : End If 
         If AC=$40
            C=_wnd Id Event Gadget
            If C=2 : FRN=Max(FRN-1,1) : Exit 
            Else If C=3 : FRN=Min(FRN+1,64) : Exit 
            Else If C=4 : Exit 2
            End If 
         End If 
         Multi Wait 
      Loop 
   Loop 
   _gt Gadgets Remove 498
   _wnd Id Close 2
   _gt Gadgets Erase 498
End Proc[FRN]
Procedure _OBJFRAMEPICK[M,OB,SV]
   Dim C(32)
   FRN=Abs(SV)
   If FRN<1 : FRN=1 : End If 
   OBD=LINK+$5EB8+OB*120
   OBDS=LINK+$5A08+OB*20*2
   OGS=-1

   _scr Id Open 2,0,64,_scr Id Width(1)/2,148,6,SCR_MODE and $FFFF1000,0,"Breed Editor Work"

   _wnd Id Open 2,0,20,_scr Id Width(2),148,$2,F_IDCMP,0,"Levels.."
   _wnd Id Titles Catalog String$(530,"Set Object Frames"),VER$
   _wnd Id Activate 2
   _scr Id Show 2
   Reserve As Gt Gadgets 498,30,2

   _gt Text 1,138,20,182,12,,"","",1
   _gt Image 2,138,44,1,GAD24(2),GAD24(3)
   _gt Image 3,162,44,1,GAD24(4),GAD24(5)
   _gt Button 4,186,44,67,12,,Catalog String$(1,"Yes")
   If Btst(0,M)
      _gt Button 5,253,44,67,12,,Catalog String$(2,"No")
   End If 

   _wnd Id Open 2,0,128,_scr Id Width(2),140,$2,$40,0,""
   '
   _gt Gadgets Attach 498
   _wnd Id Activate 2

   If Deek(OBDS+2)=0
      TYPE=0
   Else 
      TYPE=1
      _LOAD[401,Peek$(LINK+$1980,64,Chr$(0))]
   End If 
   Do 
      _wnd Id Ink 0,0,0
      _wnd Id Bar 8,16 To 128+8,128+16
      FRN=Range(FRN,1 To Deek(OBDS+12)+1)
      OG=Peek(OBD+(FRN-1)*6)
      SV=Peek(OBD+(FRN-1)*6+1)
      If SV>127 : SV=256-SV : End If 
      If OGS<>OG
         OGS=OG
         If TYPE=0
            F$=Peek$(LINK+$2C0+OG*64,64,Chr$(0))
            _LOAD[15,F$+".256pal"]
            For A=0 To 31
               B=Peek(Start(15)+A*2)
               DR=Deek(PALC+B*6) : DG=Deek(PALC+B*6+2) : DB=Deek(PALC+B*6+4)
               _scr Id Set Aga Pal A+8,DR*$10000+DG*$100+DB
               C(A)=A+8
            Next 
            Erase 401 : Erase 402
            _LOAD[401,F$+".ptr"]
            _LOAD[402,F$+".wad"]
         Else 
            'F$=Peek$(LINK+$13FE0+OG*64,64,Chr$(0))
            '_LOAD[15,F$]
         End If 
      End If 
      If TYPE=0
         LX=Deek(LINK+$39B0+OG*256+Abs(SV)*8)
         LY=Deek(LINK+$39B0+OG*256+Abs(SV)*8+2)
         LW=Min(Deek(LINK+$39B0+OG*256+Abs(SV)*8+4)*2,360)
         LH=Min(Deek(LINK+$39B0+OG*256+Abs(SV)*8+6)*2,128)
         If SV<0 : FLIP=1 Else FLIP=0 : End If 

         For WAA=0 To Min(127,LW)
            WA=WAA+LX
            OF=Leek(Start(401)+WA*4)
            If OF>=$2000000 : SS=2
            Else If OF>=$1000000 : SS=1
            Else : SS=0
            End If 
            OF=OF and $FFFFFF
            AP=Start(402)+OF+(LY*2)
            For WB=0 To Min(127,LH)
               C=Deek(AP) : Add AP,2
               If SS=0 : _wnd Id Ink C(C mod 32),0,0 : End If 
               If SS=1 : _wnd Id Ink C((C/32) mod 32),0,0 : End If 
               If SS=2 : _wnd Id Ink C((C/1024) mod 32),0,0 : End If 
               If FLIP=0
                  _wnd Id Plot WAA+8,WB+16
               Else 
                  _wnd Id Plot Min(127,LW)-WAA+8,WB+16
               End If 
            Next WB
         Next WAA
      Else 
         _wnd Id Ink 0,0,0
         W=_wnd Id Width-16
         _wnd Id Bar 8,16 To 128+8,128+16

         _wnd Id Ink 2,1,1
         _wnd Id Text 12,20,Catalog String$(216,"Sorry, But This editor")
         _wnd Id Text 12,30,Catalog String$(217,"Can't show VectorFrames")
         _wnd Id Text 12,40,Catalog String$(218,"Look out for an update")
      End If 
      _gt Set Text 1,Catalog String$(210,"Frame:")+Str$(FRN),,,
      'If FRN=1 : Print " F"; : End If 
      'If Deek(OBDS+12)+1=FRN : Print " L"; : End If 
      'If Btst(0,M) : Locate 25,4 : Print Catalog String$(219,"Esc = None"); : End If  
      Do 
         AC=_wnd Id Next Event
         If AC=$40
            C=_wnd Id Event Gadget
            If C=2 and FRN>1 : Dec FRN : Exit 
            Else If C=3 and FRN<Deek(OBDS+12)+1 : Inc FRN : Exit 
            Else If C=4 : Exit 2
            Else If C=5 and Btst(0,M) : FRN=0 : Exit 2
            End If 
         End If 
         Multi Wait 
      Loop 
   Loop 
   _gt Gadgets Remove 498
   _wnd Id Close 2
   _gt Gadgets Erase 498
   _scr Id Close 2
   _scr Id Use 1
   _scr Id Show 1
End Proc[FRN]
Procedure _DUMMY
End Proc

Procedure _REM_ZONE
   _REM_ZONE2[CZ]
End Proc
Procedure _REM_ZONE2[N]
   For A=1 To ZP(N)
      F=ZO(N,A-1) : T=ZO(N,A)
      For Q=0 To NZ-1
         If USED(Q)
            For B=0 To ZP(Q)-1
               If ZO(Q,B)=T and ZO(Q,B+1)=F
                  WT(N,A-1)=1 : WD(N,A-1)=0 : WLI(N,A-1)=0
                  WT(Q,B)=1 : WD(Q,B)=0 : WLI(Q,B)=0
                  Exit 2
               End If 
            Next 
         End If 
      Next 
   Next A
   For A=0 To 10 : ZO(N,A)=-1 : WLI(N,A)=0 : WD(N,A)=0 : Next A
   USED(N)=0 : ZP(N)=0 : _REDRAW
End Proc
Procedure _NEWZONE
   X=(X*MU)+XO : Y=Y*MU+YO
   If CZ=-1 Then Pop Proc
   If CZ<0 : Pop Proc : End If 
   For A=0 To 10 : ZO(CZ,A)=-1 : WLI(CZ,A)=0 : WD(CZ,A)=0 : Next A
   FINDNEAR[X,Y] : CP=Param
   _OUTLINE[CP]
   ZO(CZ,0)=CP
   ZP(CZ)=1
End Proc
Procedure _PLAY_SAMPLE[F$]
   '
   ' Depacker setup 
   '
   Dim F(15),DIFF(512)
   'Dme Sam Stop  
   'Change Mouse 3
   Erase 401 : Erase 402
   _LOAD[401,F$]
   If Param
      If Peek$(Start(401),4)="CSFX"
         F(0)=-34 : F(1)=-21 : F(2)=-13 : F(3)=-8 : F(4)=-5 : F(5)=-3 : F(6)=-2
         F(7)=-1 : F(8)=0 : F(9)=1 : F(10)=2 : F(11)=3 : F(12)=5 : F(13)=8
         F(14)=13 : F(15)=21
         For N=-256 To 256
            D=Abs(F(0)-N) : F=0
            For FF=1 To 15
               If Abs(F(FF)-N)<D : D=Abs(F(FF)-N) : F=FF : End If 
            Next 
            DIFF(N+256)=F
         Next 
         Reserve As Chip Work 402,Leek(Start(401)+4)
         B=Start(402) : V=Peek(Start(401)+8)
         If Btst(7,V) : V=V or $FFFFFF00 : End If 
         For A=Start(401)+9 To Bank End(401)-1
            WD1=Peek(A)/16
            WD2=Peek(A) mod 16
            If Btst(7,WD1) : WD1=WD1 or $FFFFFF00 : End If 
            If Btst(7,WD2) : WD2=WD2 or $FFFFFF00 : End If 
            Poke B,V : Inc B : V=V+F(WD1)
            Poke B,V : Inc B : V=V+F(WD2)
         Next 
      Else 
         Reserve As Chip Work 402,Length(401)
         Copy Start(401),Bank End(401) To Start(402)
      End If 
      'Doke Start(402),0 
      Pt Raw Play 255,Start(402),Length(402),8000
      'Bsave "T:AB3DEdit.samp",Start(402) To Bank End(402) 
      'Exec "Play16 T:AB3DEdit.samp FREQ=8000" 
      'Dme Sam Raw %1111,Start(402),Length(402),8000 
      'Wait(Length(402)*50)/8000 
      'Kill "T:AB3DEdit.samp"
      'Dme Sam Stop %11
   End If 
   'Change Mouse 1
End Proc
'
Procedure _S_PLAY_TRACK
   _S_FILE[0,Catalog String$(1199,"Play Music"),"Ab3:Music/","#?",""]
   F$=Param$
   If F$>""
      _PLAY_TRACK[F$]
   End If 
End Proc
Procedure _PLAY_TRACK[F$]
   Pt Stop 
   Erase 800
   _LOAD[-800,F$]
   Pt Cia Speed 125
   Trap Pt Play 800
End Proc
Procedure _KILL_TRACK
   Pt Stop 
   Erase 800
End Proc
'
'----------------------------------------------------------------------------  
'    DISC CONTROL PROCEDURES 
'----------------------------------------------------------------------------  
'
Procedure _SAVE_LEVEL[F$]
   If NZ<1
      Goto S_END
   End If 
   If F$<"A"
      _SELLEVEL[""]
      F$=Param$
   End If 
   If F$<"A"
      Goto S_END
   End If 
   '
   '  Save a level to disk
   '
   LP$=Peek$(LINK,64,Chr$(0))
   If LP$=""
      LP$="ab3:levels/"
   End If 
   LP$=LP$+"level_"+F$

   If F$<>CURLEV$
      If Exist(LP$+"/twolev.dat")
         _SURE["","Overwrite level "+F$]
         If Param=0 : Goto S_END : End If 
      End If 
   End If 

   MPTR=-1 : Change Mouse 3
   For A=0 To NZ
      If USED(A)=0
         ZO(A,0)=MXP
         ZO(A,1)=MXP
         ZO(A,2)=MXP
         ZO(A,3)=MXP
         ZO(A,4)=MXP
         ZP(A)=4
      End If 
   Next A
   On Error Goto S_ERR
   EM$="Initialize"
   Def Fn MY$(PQ)=(Str$(PQ)-" ")
   EM$="'Main Save'"
   _N_MSG2[Catalog String$(240,"Calculating level data..."),0]
   MP=Start(15)
   '
   '* START *********************************** 
   For A=0 To 9
      For B=1 To 160
         PK[Asc(Mid$(LEVELTEXT$(A),B,1))]
      Next 
   Next 
   DK[PLX]
   DK[-PLY]
   DK[PLZ]
   DK[PLX2]
   DK[-PLY2]
   DK[PLZ2]
   DK[NCPT+1]
   DK[NP+16]
   DK[NZ-1]
   DK[0]
   DK[NO+62]
   BASE=MP
   LK[0] : LK[0] : LK[0] : LK[0] : LK[0] : LK[0] : LK[0] : LK[0]
   '* CONTROLPOINTS ***************************   
   If NCPT>=0
      For A=0 To NCPT
         DK[CPTX(A)]
         DK[-CPTY(A)]
         If CPTUL(A)=0
            DK[(ZH(CPTZ(A),CPTUL(A))+ZH(CPTZ(A),1))/2]
         Else 
            DK[(UZH(CPTZ(A),CPTUL(A))+UZH(CPTZ(A),1))/2]
         End If 
         DK[CPTUL(A)]
      Next 
   End If 
   Loke BASE+20,MP-Start(15)
   If NO>0
      For A=0 To NO-1
         LK[OBX(A)*65536]
         LK[-OBZ(A)*65536]
      Next 
   End If 
   For A=0 To 62
      LK[0] : LK[0]
   Next 
   Loke BASE+8,MP-Start(15)
   If NO>0
      S=Start(12)
      For A=0 To NO-1
         ST=MP
         DK[A]
         DK[0]
         WATT=Peek(S+11) : If WATT<>0 : WATT=128 : End If 
         If Peek(S)=0 : Gosub ALIENSAVE : End If 
         If Peek(S)=1 : Gosub THINGSAVE : End If 
         Add S,32
      Next 
   End If 
   Loke BASE+12,MP-Start(15)
   For A=NO To NO+19
      DK[A] : DK[-10] : DK[0]
      PK[20] : PK[20]
      LK[0]
      DK[-1]
      PK[16] : PK[16] : PK[2] : PK[0]
      For QQ=1 To 23 : DK[0] : Next 
   Next 
   Loke BASE+16,MP-Start(15)
   For A=NO+20 To NO+39
      DK[A] : DK[-10] : DK[0]
      PK[20] : PK[20]
      LK[0]
      DK[-1]
      PK[16] : PK[16] : PK[2] : PK[0]
      For QQ=1 To 23 : DK[0] : Next 
   Next 
   ' Other nasty data.... 
   For A=NO+40 To NO+59
      DK[A] : DK[-10] : DK[0]
      PK[20] : PK[20]
      LK[0]
      DK[-1]
      PK[16] : PK[16] : PK[2] : PK[0]
      For QQ=1 To 23 : DK[0] : Next 
   Next 
   Loke BASE+24,MP-Start(15)
   DK[NO+60] : DK[0] : DK[0]
   PK[64] : PK[64]
   LK[0]
   DK[-1]
   PK[32] : PK[32]
   PK[-1] : PK[-1]
   For QQ=1 To 7 : DK[0] : Next 
   DK[10]
   For QQ=1 To 15 : DK[0] : Next 
   Loke BASE+28,MP-Start(15)
   DK[NO+61] : DK[0] : DK[0]
   PK[64] : PK[64]
   LK[0]
   DK[-1]
   PK[32] : PK[32]
   PK[-1] : PK[-1]
   FLH=0 : RFH=-100
   For QQ=1 To 23 : DK[0] : Next 
   '
   DK[NO+62] : DK[0] : DK[0]
   PK[64] : PK[32]
   LK[9*65536]
   DK[-1]
   PK[32] : PK[16]
   PK[-1] : PK[-1]
   For QQ=1 To 23 : DK[0] : Next 
   DK[-1]
   Loke BASE,MP-Start(15)
   For S=0 To 7
      If SWWL(S,0)>-1 and SWWL(S,1)>-1
         A=SWWL(S,0) : B=SWWL(S,1)
         LX=PX(ZO(A,B)) : LY=PY(ZO(A,B))
         RX=PX(ZO(A,B+1)) : RY=PY(ZO(A,B+1))
         MX=(LX+RX)/2 : MY=(LY+RY)/2
         RX=RX-LX : RY=RY-LY
         L=Sqr(RX^2+RY^2)
         LX=MX-(32*RX)/L : LY=MY-(32*RY)/L
         RX=MX+(32*RX)/L : RY=MY+(32*RY)/L
         PX(NP+S+S+1)=LX : PY(NP+S+S+1)=LY
         PX(NP+S+S+2)=RX : PY(NP+S+S+2)=RY
      End If 
   Next 
   If NP<>-1
      For A=0 To NP+16
         DK[PX(A)] : DK[-PY(A)]
      Next 
      For A=0 To NZ-1
         For B=0 To 9
            For C=0 To 3
               DK[ZPBR(A,B,C)]
            Next 
         Next 
      Next 
      SPLIB=MP
      For A=0 To NZ-1
         For B=0 To ZP(A)-1
            DK[ZO(A,B)]
         Next 
         If ZP(A)<10
            For B=ZP(A) To 9
               DK[-1]
            Next 
         End If 
      Next 
   End If 
   DK[EZONE]
   Loke BASE+4,MP-Start(15)
   If NZ<>-1
      T=0
      For A=0 To NZ
         If ZP(A)>0
            For B=0 To ZP(A)-1
               If ZO(A,B)>ZO(A,B+1)
                  X1=PX(ZO(A,B)) : Y1=-PY(ZO(A,B))
                  X2=PX(ZO(A,B+1)) : Y2=-PY(ZO(A,B+1))
                  DK[X1] : DK[Y1] : DK[X2-X1] : DK[Y2-Y1]
                  X2#=X2-X1 : Y2#=Y2-Y1
                  L#=Sqr(X2#*X2#+Y2#*Y2#)
                  L=L#
                  XA#=(X2#*20.0)/L#
                  YA#=(Y2#*20.0)/L#
                  XA=YA#-XA#
                  YA=-(XA#+YA#)
               Else 
                  X1=PX(ZO(A,B+1)) : Y1=-PY(ZO(A,B+1))
                  X2=PX(ZO(A,B)) : Y2=-PY(ZO(A,B))
                  X2#=X2-X1 : Y2#=Y2-Y1
                  L#=Sqr(X2#*X2#+Y2#*Y2#)+1E-15
                  L=L#
                  XA#=(X2#*20.0)/L#
                  YA#=(Y2#*20.0)/L#
                  XA=-(YA#-XA#)
                  YA=(XA#+YA#)
                  DK[X2] : DK[Y2] : DK[X1-X2] : DK[Y1-Y2]
               End If 
               If BWT(WT(A,B))=1
                  For C=0 To NZ
                     For D=0 To ZP(C)-1
                        If ZO(A,B)=ZO(C,D+1) and ZO(A,B+1)=ZO(C,D)
                           ZZ(A,B)=C
                           D=ZP(C) : C=NZ
                        End If 
                     Next 
                  Next 
                  If WT(A,B)<>3 and WT(A,B)<>4
                     H1=ZH(ZZ(A,B),0)
                     H2=ZH(ZZ(A,B),1)
                     DK[ZZ(A,B)]
                  Else 
                     H1=900 : H2=900
                     DK[-1]
                  End If 
               Else 
                  DK[-1]
               End If 
               DK[L] : PK[XA] : PK[YA] : DK[0]
               ZW(A,B,0)=T : ZW(A,B,1)=T : Add T,1
            Next 
         End If 
      Next 
   End If 
   T=0
   For A=0 To NP : PW(A)=-1 : Next 
   For A=0 To NZ-1
      For B=0 To ZP(A)-1
         'If USED(A)
            If WT(A,B)=1
               PW(ZO(A,B))=T
               PCW(ZO(A,B),1)=ZO(A,B+1)
               PCW(ZO(A,B+1),0)=ZO(A,B)
            End If 
         'End If  
         Add T,1
      Next 
   Next 
   DK[NZ]
   For A=0 To NZ-1
      BT=0 : UT=0
      For B=0 To ZP(A)-1
         For C=0 To 1
            PB=ZPBR(A,B,C) and $FF
            If PB>127 : PB=PB-256 : End If 
            BT=BT+PB
         Next 
         For C=0 To 1
            PB=ZPBR(A,B,C+2) and $FF
            If PB>127 : PB=PB-256 : End If 
            UT=UT+PB
         Next 
      Next 
      'If USED(A)
         BT=BT/(ZP(A)*2)
         UT=UT/(ZP(A)*2)
         ZB(A)=BT : UZB(A)=UT
      'Else  
      '   ZB(A)=1 : UZB(A)=1 
      'End If  
   Next 
   For A=0 To NZ-1
      If ZP(A)>0
         ZBPT=MP
         For B=0 To ZP(A)-1
            DK[ZW(A,B,1)]
         Next 
         DK[-1]
         '
         L=ZP(A)-1
         For B=0 To ZP(A)-1
            If PW(ZO(A,B))<>-1
               If ZO(A,L)<>PCW(ZO(A,B),0)
                  DK[PW(PCW(ZO(A,B),0))]
               End If 
               If ZO(A,B+1)<>PCW(ZO(A,B),1)
                  DK[PW(ZO(A,B))]
               End If 
            End If 
            L=(L+1) mod ZP(A)
         Next 
         DK[-2]
         ZDPT(A)=MP
         DK[A]
         LK[ZH(A,0)*256]
         LK[ZH(A,1)*256]
         LK[UZH(A,0)*256]
         LK[UZH(A,1)*256]
         LK[ZH(A,2)*256]
         DK[ZB(A)]
         DK[UZB(A)]
         PK[ZCPT(A)] : PK[UZCPT(A)]
         LK[BSFX(A)]
         DK[ZBPT-ZDPT(A)]
         ZPPT=MP
         DK[0]
         S=Start(14)+(A*64*6)
         BACK=0
         For QQ=0 To NZ : ZU(QQ)=0 : Next 
         For B=0 To 63
            C=Deek(S)
            If C<>65535
               ZU(C)=1
               If ZRG(C,0)=16
                  BACK=1
               End If 
            End If 
            Add S,6
         Next 
         ZU(A)=1
         If BACK=1 or ZRG(A,0)=16
            PK[-1]
         Else 
            PK[0]
         End If 
         PK[ECHO(A)]
         DK[TELZO(A)] : DK[TELX(A)] : DK[-TELZ(A)]
         DK[ZFG(A,0)] : DK[UZFG(A,0)]
         S=Start(14)+(A*64*6)
         For B=0 To NP+16 : PU(B)=0 : Next 
         For K=0 To ZP(A)-1
            PU(ZO(A,K))=1
         Next 
         For K=0 To 7
            If SWWL(K,0)=A
               PU(NP+K+K+1)=1
               PU(NP+K+K+2)=1
            End If 
         Next 
         VAT=0
         DK[A]
         DK[-1]
         CORD=0
         BTS=0
         For QQ=0 To ZP(A)-1
            If WT(A,QQ)<>1
               Bset BTS,CORD
               Bset BTS+1,CORD
               Bset BTS+2,CORD
               Add BTS,3
            End If 
         Next 
         LK[CORD]
         For B=0 To 63
            If Deek(S)<>65535
               L=Deek(S)
               CORD=Leek(S+2)
               BTS=0
               For K=0 To ZP(L)-1
                  If USED(L)
                     PU(ZO(L,K))=1
                  End If 
                  If WT(L,K)<>1
                     If ZU(ZZ(L,K))=1
                        Bset BTS,CORD
                     End If 
                  End If 
                  Add BTS,3
               Next 
               For K=0 To 7
                  If SWWL(K,0)=L
                     PU(NP+K+K+1)=1
                     PU(NP+K+K+2)=1
                  End If 
               Next 
               DK[Deek(S)]
               DK[0]
               LK[CORD]
               Add VAT,1
            End If 
            Add S,6
         Next 
         LK[-1]
         TMPT=MP
         Doke ZPPT,TMPT-ZDPT(A)
         T=0
         M$=""
         For B=0 To NP+16
            If PU(B)=1
               DK[B]
            End If 
         Next 
         DK[-1]
      End If 
   Next 
   Bsave LP$+"/twolev.bin",Start(15) To MP
   _PACK[LP$+"/twolev.bin"]
   '
   '
   EM$="'Graphics save'"
   _N_MSG2[Catalog String$(241,"Calculating graphics file..."),0]
   MP=Start(15)
   ' Pointer to door/Lift/switch/Graphiclist data 
   LK[0] : LK[0] : LK[0] : LK[0]
   If NZ>0
      For A=0 To NZ-1 : LK[ZDPT(A)-Start(15)] : Next 
      Loke Start(15)+12,MP-Start(15)
      ZGAPT=MP
      For A=0 To NZ-1 : LK[0] : LK[0] : Next 
      For A=0 To NZ-1
         B=MP-Start(15)
         Loke ZGAPT+(A*8),B
         DK[A]
         If ZP(A)>0
            For B=0 To ZP(A)-1
               X1=PX(ZO(A,B)) : Y1=PY(ZO(A,B))
               X2=PX(ZO(A,B+1)) : Y2=PY(ZO(A,B+1))
               L=Sqr((X2-X1)^2+(Y2-Y1)^2)
               L=L/2
               GW=ZWG(A,B,3)
               If ZWG(A,B,1)=1 : L=(L and(-GW)) : L=L+GW : End If 
               If ZWG(A,B,1)=2
                  L=(L and(-GW))
                  If L=0 : L=L+GW : End If 
               End If 
               W=ZWG(A,B,0)*65536
               CH=Deek(LINK+$14B60+ZWG(A,B,2)*2)-1
               CSV=0 : Repeat : Inc CSV : Until 2^CSV>=CH+1
               GW=GW-1
               NB=(B+1) mod ZP(A)
               If WT(A,B)=0
                  H2=ZH(A,0) : H1=ZH(A,1)
                  OH1=UZH(ZZ(A,B),1)
                  OH2=UZH(ZZ(A,B),0)
                  OH3=ZH(ZZ(A,B),1)
                  OH4=ZH(ZZ(A,B),0)
                  If OH1>OH3
                     OH1=-5000 : OH2=-5000
                  End If 
                  If H1<OH1
                     BBV=0+0
                     VO=-Min(OH1,H2) and 255
                     PK[-1] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W+VO]
                     DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[H1*256] : LK[Min(OH1,H2)*256]
                     PK[WB(A,B)] : PK[ZZ(A,B)]
                  End If 
                  If H1<OH3 and H2>OH2
                     BBV=0+0
                     TBV=0+1
                     VO=-Min(OH3,H2) and 255
                     PK[-1] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W+VO]
                     DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[Max(OH2,H1)*256] : LK[Min(H2,OH3)*256]
                     PK[WB(A,B)] : PK[ZZ(A,B)]
                  End If 
                  If H2>OH4
                     TBV=1
                     BBV=0+0
                     VO=(-H2) and 255
                     PK[B+16] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W+VO]
                     DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[Max(OH4,H1)*256] : LK[H2*256]
                     PK[WB(A,B)] : PK[ZZ(A,B)]
                  End If 
                  For S=0 To 7
                     If SWWL(S,0)=A and SWWL(S,1)=B
                        DK[0] : DK[NP+S+S+1] : DK[NP+S+S+2] : DK[0] : DK[31]
                        SGO(S)=MP-Start(15)
                        SW=(-ZH(A,0)) and 31
                        LK[SW]
                        DK[11] : PK[31] : PK[5] : DK[31]
                        LK[(ZH(A,0)-64)*256] : LK[(ZH(A,0)-32)*256]
                        PK[WB(A,B)] : PK[ZZ(A,B)]
                     End If 
                  Next 
               End If 
               If WT(A,B)=1
                  TBV=1 : BBV=0
                  VO=(-ZH(A,0)) and 255
                  PK[B] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                  LK[W+VO]
                  DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                  LK[ZH(A,1)*256] : LK[ZH(A,0)*256]
                  PK[WB(A,B)] : PK[ZZ(A,B)]
                  For S=0 To 7
                     If SWWL(S,0)=A and SWWL(S,1)=B
                        DK[0] : DK[NP+S+S+1] : DK[NP+S+S+2] : DK[0] : DK[31]
                        SGO(S)=MP-Start(15)
                        SW=(-ZH(A,0)) and 31
                        LK[SW]
                        DK[11] : PK[31] : PK[5] : DK[31]
                        LK[(ZH(A,0)-64)*256] : LK[(ZH(A,0)-32)*256]
                        DK[WB(A,B)]
                     End If 
                  Next 
               End If 
               If WT(A,B)=3
                  VO=(-ZH(A,0)) and 255
                  DK[13] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                  LK[W+VO]
                  DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                  LK[ZH(A,1)*256] : LK[ZH(A,0)*256]
                  PK[WB(A,B)] : PK[ZZ(A,B)]
               End If 
               If WT(A,B)=4
                  VO=(-ZH(A,0)) and 255
                  DK[13] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                  LK[W+VO]
                  DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                  LK[ZH(A,1)*256] : LK[ZH(A,0)*256]
                  PK[WB(A,B)] : PK[ZZ(A,B)]
               End If 
               If WT(A,B)=2
                  TBV=8 : BBV=0
                  H1=ZH(A,0) : H2=ZH(ZZ(A,B),0)
                  If H2<H1
                     VO=(-H1) and 255
                     PK[-1] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W+VO]
                     DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[H2*256] : LK[H1*256]
                     PK[WB(A,B)] : PK[ZZ(A,B)]
                  End If 
                  H1=ZH(A,1) : H2=ZH(ZZ(A,B),0)
                  TBV=1 : BBV=8+0
                  If H2>H1
                     VO=(-H2) and 255
                     DWPT(A,B)=MP-Start(15)
                     PK[B+16] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W+VO]
                     DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[H1*256] : LK[H2*256]
                     PK[WB(A,B)] : PK[ZZ(A,B)]
                  End If 
               End If 
               If WT(A,B)=5
                  TBV=8+0 : BBV=0
                  H1=ZH(A,0) : H2=ZH(A,3)
                  DWPT(A,B)=MP-Start(15)
                  PK[B+16] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                  LK[W]
                  DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                  LK[H2*256] : LK[H1*256]
                  PK[WB(A,B)] : PK[ZZ(A,B)]
                  TBV=1 : BBV=8+1
                  H1=ZH(A,1) : H2=ZH(ZZ(A,B),1)
                  If H2>H1
                     VO=(-H2) and 255
                     PK[-1] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W+VO]
                     DK[ZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[H1*256] : LK[H2*256]
                     PK[WB(A,B)] : PK[ZZ(A,B)]
                  End If 
               End If 
            Next 
            FL=1 : RO=2
            K$=""
            If FB(A)=1
               FL=8
            End If 
            If ZLI(A)>0
               ZLIPT(ZLI(A)-1)=MP-Start(15)
            End If 
            DK[FL] : DK[ZH(A,0)*4] : DK[ZP(A)-1]
            For B=0 To ZP(A)-1
               DK[ZO(A,B)+(B*16*256)]
            Next 
            DK[ZO(A,0)]
            R=ZFG(A,0) : R=(R/4)*256+(R mod 4)
            DK[ZFG(A,1)] : DK[R] : DK[0]
            If ZD(A)>0
               ZDOPT(ZD(A)-1)=MP-Start(15)
            End If 
            If RB(A)=1
               RO=9
            End If 
            If ZRG(A,0)<16
               DK[RO] : DK[ZH(A,1)*4] : DK[ZP(A)-1]
               For B=0 To ZP(A)-1
                  DK[ZO(A,B)+(B*16*256)]
               Next 
               DK[ZO(A,0)]
               R=ZRG(A,0) : R=(R/4)*256+(R mod 4)
               DK[ZRG(A,1)] : DK[R] : DK[0]
            End If 
            If(ZH(A,2)<ZH(A,0)) or ZWA(A)<>0
               DK[4]
               DK[0]
               WAPT(A)=MP-Start(15)
               DK[7] : DK[ZH(A,2)*4] : DK[ZP(A)-1]
               For B=0 To ZP(A)-1
                  DK[ZO(A,B)+(B*16*256)]
               Next 
               DK[ZO(A,0)]
               R=ZRG(A,0) : R=(R/4)*256+(R mod 4)
               DK[-1] : DK[R] : DK[0]
               DK[4]
               DK[1]
            Else 
               DK[4]
               DK[2]
            End If 
            LK[-1]
         End If 
         If UZH(A,0)<ZH(A,1)
            B=MP-Start(15)
            Loke ZGAPT+(A*8)+4,B
            DK[A]
            If ZP(A)>0
               For B=0 To ZP(A)-1
                  NB=(B+1) mod ZP(A)
                  X1=PX(ZO(A,B)) : Y1=PY(ZO(A,B))
                  X2=PX(ZO(A,B+1)) : Y2=PY(ZO(A,B+1))
                  L=Sqr((X2-X1)^2+(Y2-Y1)^2)
                  L=L/2
                  GW=UZWG(A,B,3)
                  If UZWG(A,B,1)=1
                     L=(L and(-GW))
                     L=L+GW
                  End If 
                  If UZWG(A,B,1)=2
                     L=(L and(-GW))
                     If L=0
                        L=L+GW
                     End If 
                  End If 
                  W=UZWG(A,B,0)*65536
                  CH=Deek(LINK+$14B60+ZWG(A,B,2)*2)-1
                  CSV=0 : Repeat : Inc CSV : Until 2^CSV>=CH+1
                  GW=GW-1
                  If WT(A,B)=0
                     H2=UZH(A,0) : H1=UZH(A,1)
                     OH1=UZH(ZZ(A,B),1)
                     OH2=UZH(ZZ(A,B),0)
                     OH3=ZH(ZZ(A,B),1)
                     OH4=ZH(ZZ(A,B),0)
                     If OH1>OH3
                        OH1=-5000 : OH2=-5000
                     End If 
                     If H1<OH1
                        TBV=1 : BBV=0
                        PK[-1] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                        LK[W]
                        DK[UZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                        LK[H1*256] : LK[Min(OH1,H2)*256]
                        PK[UWB(A,B)] : PK[ZZ(A,B)]
                     End If 
                     If H1<OH3 and H2>OH2
                        TBV=1 : BBV=0
                        PK[-1] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                        LK[W]
                        DK[UZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                        LK[Max(OH2,H1)*256] : LK[Min(H2,OH3)*256]
                        PK[UWB(A,B)] : PK[ZZ(A,B)]
                     End If 
                     If H2>OH4
                        TBV=1 : BBV=0
                        PK[B+16] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                        LK[W]
                        DK[UZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                        LK[Max(OH4,H1)*256] : LK[H2*256]
                        PK[UWB(A,B)] : PK[ZZ(A,B)]
                     End If 
                  End If 
                  If WT(A,B)=1
                     TBV=1 : BBV=0
                     PK[B] : PK[0] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W]
                     DK[UZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[UZH(A,1)*256] : LK[UZH(A,0)*256]
                     PK[UWB(A,B)] : PK[ZZ(A,B)]
                  End If 
                  If WT(A,B)=3
                     DK[13] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W]
                     DK[UZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[UZH(A,1)*256] : LK[UZH(A,0)*256]
                     PK[UWB(A,B)] : PK[ZZ(A,B)]
                  End If 
                  If WT(A,B)=4
                     DK[13] : DK[ZO(A,B)] : DK[ZO(A,B+1)] : PK[B] : PK[NB] : DK[L]
                     LK[W]
                     DK[UZWG(A,B,2)] : PK[CH] : PK[CSV] : PK[GW] : PK[TBV*16+BBV]
                     LK[UZH(A,1)*256] : LK[UZH(A,0)*256]
                     PK[UWB(A,B)] : PK[ZZ(A,B)]
                  End If 
               Next 
               FL=1 : RO=2
               K$=""
               If FB(A)=1 : FL=8 : End If 
               If ZLI(A)>0 : ZLIPT(ZLI(A)-1)=MP-Start(15) : End If 
               DK[FL] : DK[UZH(A,0)*4] : DK[ZP(A)-1]
               For B=0 To ZP(A)-1 : DK[ZO(A,B)+(B*16*256)] : Next B
               DK[ZO(A,0)]
               R=UZFG(A,0) : R=(R/4)*256+(R mod 4)
               DK[ZFG(A,1)] : DK[R] : DK[0]
               If ZD(A)>0 : ZDOPT(ZD(A)-1)=MP-Start(15) : End If 
               If RB(A)=1 : RO=9 : End If 
               If UZRG(A,0)<16
                  DK[RO] : DK[UZH(A,1)*4] : DK[ZP(A)-1]
                  For B=0 To ZP(A)-1 : DK[ZO(A,B)+(B*16*256)] : Next 
                  DK[ZO(A,0)]
                  R=UZRG(A,0) : R=(R/4)*256+(R mod 4)
                  DK[ZRG(A,1)] : DK[R] : DK[0]
               End If 
               If UZH(A,2)<UZH(A,0)
                  DK[4]
                  DK[0]
                  DK[7] : DK[UZH(A,2)*4] : DK[ZP(A)-1]
                  For B=0 To ZP(A)-1 : DK[ZO(A,B)+(B*16*256)] : Next B
                  DK[ZO(A,0)]
                  R=UZRG(A,0) : R=(R/4)*256+(R mod 4)
                  DK[-1] : DK[R] : DK[0]
                  DK[4]
                  DK[1]
               Else 
                  DK[4]
                  DK[2]
               End If 
               LK[-1]
            End If 
         End If 
      Next A
      Loke Start(15),MP-Start(15)
      For D=0 To 20
         US=0
         For A=0 To NZ-1
            If ZD(A)=D+1
               US=1
               DK[ZH(A,0)*4] : DK[ZH(A,1)*4]
               For QWE=0 To 6
                  DK[OPS(D,QWE)]
               Next QWE
               TX=0 : TZ=0
               For W=0 To ZP(A)-1
                  Add TX,PX(ZO(A,W))
                  Add TZ,PY(ZO(A,W))
               Next W
               TX=TX/ZP(A) : TZ=TZ/ZP(A)
               DK[TX] : DK[-TZ]
               DK[ZH(A,0)*4] : DK[0]
               LK[ZDOPT(ZD(A)-1)]
               DK[A]
               DK[DC(D)] : PK[DRT(D)] : PK[DLT(D)]
            End If 
         Next A
         For A=0 To NZ-1
            For B=0 To ZP(A)-1
               If WD(A,B)=D+1
                  DK[ZW(A,B,0)]
                  LK[DWPT(A,B)]
                  LK[ZWG(A,B,0)*4096]
               End If 
            Next B
         Next A
         If US=1 : DK[-1] : End If 
      Next D
      DK[999]
      Loke Start(15)+4,MP-Start(15)
      For L=0 To 20
         US=0
         For A=0 To NZ
            If ZLI(A)=L+1
               US=1
               DK[ZH(A,0)*4] : DK[ZH(A,3)*4]
               For QWE=0 To 6 : DK[LOPS(L,QWE)] : Next QWE
               TX=0 : TZ=0
               For W=0 To ZP(A)-1
                  Add TX,PX(ZO(A,W))
                  Add TZ,PY(ZO(A,W))
               Next 
               TX=TX/ZP(A) : TZ=TZ/ZP(A)
               DK[TX] : DK[-TZ]
               If LSP(L)=0
                  DK[ZH(A,0)*4]
               Else 
                  DK[ZH(A,3)*4]
               End If 
               DK[0]
               LK[ZLIPT(L)]
               DK[A]
               DK[LIFTC(L)] : PK[LRT(L)] : PK[LLT(L)]
            End If 
         Next A
         For A=0 To NZ-1
            For B=0 To ZP(A)-1
               If WLI(A,B)=L+1 : DK[ZW(A,B,0)] : LK[DWPT(A,B)] : LK[ZWG(A,B,0)*4096] : End If 
            Next B
         Next A
         If US=1 : DK[-1] : End If 
      Next L
      DK[999]
      For S=0 To 20
         LK[WATH(S)*256] : LK[WABH(S)*256]
         LK[WATH(S)*256] : DK[128]
         For A=0 To NZ-1
            If ZWA(A)=S+1 : DK[A] : LK[WAPT(A)] : End If 
         Next A
         DK[-1]
      Next S
      Loke Start(15)+8,MP-Start(15)
      For S=0 To 7
         DK[SWWL(S,0)]
         PK[0] : PK[0]
         DK[NP+S+S+1]
         If SWWL(S,0)<>-1
            LK[SGO(S)]
         Else 
            LK[0]
         End If 
         LK[0]
      Next S
      Bsave LP$+"/twolev.graph.bin",Start(15) To MP
      _PACK[LP$+"/twolev.graph.bin"]
   End If 
   EM$="'Includes'"
   '
   _N_MSG2[Catalog String$(242,"Saving level")+" "+F$,0]
   '
   MP=Start(15)
   Loke MP,NCPT : Add MP,4
   If NCPT>=0
      For A=0 To NCPT
         Loke MP,CPTX(A) : Loke MP+4,CPTY(A)
         Doke MP+8,CPTZ(A) : Doke MP+10,CPTUL(A)
         Add MP,12
      Next 
   End If 
   For A=0 To 20
      Doke MP,DC(A)
      Doke MP+2,DRT(A)
      Doke MP+4,DLT(A)
      For Q=0 To 6
         Doke MP+6+Q*2,OPS(A,Q)
      Next 
      Add MP,20
   Next 
   For A=0 To 20
      Doke MP,LIFTC(A)
      Doke MP+2,LSP(A)
      Doke MP+4,LRT(A)
      Doke MP+6,LLT(A)
      For Q=0 To 6 : Doke MP+8+Q*2,LOPS(A,Q) : Next 
      Add MP,22
   Next 
   For A=0 To 7
      Doke MP,SWWL(A,0)
      Doke MP+2,SWWL(A,1)
      Add MP,4
   Next 
   Doke MP,NO : Add MP,2
   If NO>0
      For A=0 To NO-1 : Loke MP,OBX(A) : Loke MP+4,OBZ(A) : Add MP,8 : Next 
   End If 
   Doke MP,NP : Add MP,2
   If NP>-1
      For A=0 To NP
         Loke MP,PX(A)
         Loke MP+4,PY(A)
         Add MP,8
      Next 
   End If 
   Doke MP,NZ : Add MP,2
   If NZ>-1
      For A=0 To NZ
         Loke MP,TELZO(A) : Add MP,4
         Loke MP,TELX(A) : Add MP,4
         Loke MP,TELZ(A) : Add MP,4
         Doke MP,ZB(A) : Add MP,2
         Doke MP,UZB(A) : Add MP,2
         Doke MP,ZCPT(A) : Add MP,2
         Doke MP,UZCPT(A) : Add MP,2
         Doke MP,ZP(A) : Add MP,2
         For B=0 To ZP(A)
            Doke MP,ZO(A,B)
            Doke MP+2,WT(A,B)
            Doke MP+4,ZC(A,B)
            Doke MP+6,ZWG(A,B,0)
            Doke MP+8,ZWG(A,B,1)
            Doke MP+10,ZWG(A,B,2)
            Doke MP+12,ZWG(A,B,3)
            Doke MP+14,UZWG(A,B,0)
            Doke MP+16,UZWG(A,B,1)
            Doke MP+18,UZWG(A,B,2)
            Doke MP+20,UZWG(A,B,3)
            Doke MP+22,WD(A,B)
            Doke MP+24,WLI(A,B)
            Doke MP+26,WB(A,B)
            Doke MP+28,UWB(A,B)
            Doke MP+30,ZPBR(A,B,0)
            Doke MP+32,ZPBR(A,B,1)
            Doke MP+34,ZPBR(A,B,2)
            Doke MP+36,ZPBR(A,B,3)
            Add MP,38
         Next 
         Loke MP,ZH(A,0) : Add MP,4
         Loke MP,ZH(A,1) : Add MP,4
         Loke MP,ZH(A,2) : Add MP,4
         Loke MP,ZH(A,3) : Add MP,4
         Loke MP,UZH(A,0) : Add MP,4
         Loke MP,UZH(A,1) : Add MP,4
         Loke MP,UZH(A,2) : Add MP,4
         Loke MP,UZH(A,3) : Add MP,4
         Poke MP,ZRG(A,0) : Poke MP+1,ZFG(A,0) : Add MP,2
         Poke MP,ZRG(A,1)+10 : Poke MP+1,ZFG(A,1)+10 : Add MP,2
         Poke MP,UZRG(A,0) : Poke MP+1,UZFG(A,0) : Add MP,2
         Poke MP,UZRG(A,1)+10 : Poke MP+1,UZFG(A,1)+10 : Add MP,2
         Doke MP,ZD(A) : Add MP,2
         Doke MP,ZLI(A) : Add MP,2
         Poke MP,RB(A) : Add MP,1
         Poke MP,FB(A) : Add MP,1
         S=Start(14)+(A*64*6)
         For B=0 To 63
            Doke MP,Deek(S) : Doke MP+2,Deek(S+2) : Doke MP+4,Deek(S+4)
            Add MP,6 : Add S,6
         Next 
      Next 
   End If 
   Loke MP,PLX
   Loke MP+4,PLY
   Doke MP+8,PLZ
   Add MP,10
   Loke MP,PLX2
   Loke MP+4,PLY2
   Doke MP+8,PLZ2
   Add MP,10
   For A=0 To 9
      Poke$ MP,LEVELTEXT$(A) : Add MP,160
   Next 
   DK[EZONE]
   For A=0 To NZ-1
      LK[BSFX(A)]
   Next 
   For A=0 To NZ-1
      LK[ECHO(A)]
   Next 
   LK[1234567890]
   For A=0 To 20
      LK[WASP(A)]
      LK[WATH(A)]
      LK[WABH(A)]
   Next A
   For A=0 To NZ-1
      PK[ZWA(A)]
   Next A
   Bsave LP$+"/twolev.dat",Start(15) To MP
   Bsave LP$+"/twolev.obj",Start(12) To Start(12)+200*32
   Bsave LP$+"/twolev.links",Start(11) To Start(11)+100*100
'--------- 
'not sure this is the right place for this...
   CURLEV$=F$
'--------- 
S_END:
   _R_N_MSG
   _wnd Id Activate 0
   '_UPD_IFACE[OP+1]
   On Error 
   _REDRAW
Pop Proc
ALIENSAVE:
   ' First put in the dummy effort: 
   For RT=1 To 15
   LK[0] : Next 
   Poke ST+16,3
   Doke ST+12,-1
   ST=MP
   DK[A]
   DK[0]
   For RT=1 To 15 : LK[0] : Next 
   TP=Peek(S+10)
   If TP=0
      H=ZH(Deek(S+6),0)
   Else 
      H=UZH(Deek(S+6),0)
   End If 
   H=(H-8)*2
   Poke ST+63,TP
   Poke ST+62,WATT
   Poke ST+16,0
   Poke ST+54,Peek(S+2)
   Doke ST+50,Deek(S+4)
   Doke ST+12,Deek(S+6)
   Doke ST+52,Deek(S+8)
   Poke ST+18,Deek(LINK+$3688+Peek(S+2)*42)
   Poke ST+19,0
   Doke ST+28,ZCPT(Deek(S+6))
   Poke ST+21,Peek(S+12)
   Doke ST+24,Deek(S+14)
   Doke ST+32,Deek(S+16)
Return 
THINGSAVE:
   For RT=1 To 15
   LK[0] : Next 
   TP=Peek(S+10)
   If TP=0
      H=ZH(Deek(S+6),0)
   Else 
      H=UZH(Deek(S+6),0)
   End If 
   H=(H-8)*2
   Poke ST+63,TP
   Poke ST+62,WATT
   Poke ST+16,1
   Poke ST+54,Peek(S+2)
   Doke ST+50,Deek(S+4)
   Doke ST+12,Deek(S+6)
   Doke ST+52,Deek(S+8)
   Doke ST+24,Deek(S+14)
   Doke ST+34,Deek(S+18)
   ANQ=Deek(S+12)
   ANQ=(ANQ*8192)/360
   ANQ=ANQ and 8190
   Doke ST+30,ANQ
Return 
S_ERR:
   _ERRTXT["Save Error During "+EM$+":",Err$(Errn)]
   Resume S_END
End Proc
Procedure _LOAD_LEVEL[F$]
   If F$<"A"
      _SELLEVEL[""]
      F$=Param$
   End If 
   If F$<"A"
      Goto L_END
   End If 
   MPTR=-1 : Change Mouse 3
   LP$=Peek$(LINK,64,Chr$(0))
   If LP$=""
      LP$="ab3:levels/"
   End If 
   LP$=LP$+"level_"+F$
   _N_MSG2[Catalog String$(243,"Loading level data..."),0]
   _NEW_LEVEL[False]
   Trap Bload LP$+"/twolev.dat",Start(15)
   If Errtrap : _WRONG[10,0] : Goto L_END : End If 
   MP=Start(15)
   NCPT=Leek(MP)
   Add MP,4
   If NCPT>=0
      For A=0 To NCPT
         CPTX(A)=Leek(MP) : CPTY(A)=Leek(MP+4)
         CPTZ(A)=Deek(MP+8) : CPTUL(A)=Deek(MP+10)
         Add MP,12
      Next 
   End If 
   For A=0 To 20
      DC(A)=Deek(MP)
      DRT(A)=Deek(MP+2)
      DLT(A)=Deek(MP+4)
      For Q=0 To 6
         OPS(A,Q)=Deek(MP+6+Q*2)
      Next 
      Add MP,20
   Next 
   For A=0 To 20
      LIFTC(A)=Deek(MP) and %111111111111
      LSP(A)=Deek(MP+2)
      LRT(A)=Deek(MP+4)
      LLT(A)=Deek(MP+6)
      For Q=0 To 6
         LOPS(A,Q)=Deek(MP+8+Q*2)
      Next 
      Add MP,22
   Next 
   '**********************************************
   '* TAKE OUT FOR OTHER LEVEL  
   '**********************************************
   For A=0 To 7
      SWWL(A,0)=Deek(MP)
      SWWL(A,1)=Deek(MP+2)
      If SWWL(A,0)=65535 Then SWWL(A,0)=-1
      If SWWL(A,1)=65535 Then SWWL(A,1)=-1
      Add MP,4
   Next 
   '****************************
   NO=Deek(MP) : Add MP,2
   If NO>0
      For A=0 To NO-1
         OBX(A)=Leek(MP) : OBZ(A)=Leek(MP+4) : Add MP,8
      Next 
   End If 
   NP=Deek(MP) : Add MP,2
   If NP>-1
      For A=0 To NP
         PX(A)=Leek(MP)
         PY(A)=Leek(MP+4)
         Add MP,8
      Next 
   End If 
   NZ=Deek(MP) : Add MP,2
   If NZ>-1
      For A=0 To NZ
         TELZO(A)=Leek(MP) : Add MP,4
         TELX(A)=Leek(MP) : Add MP,4
         TELZ(A)=Leek(MP) : Add MP,4
         ZB(A)=Deek(MP) : Add MP,2
         UZB(A)=Deek(MP) : Add MP,2
         ZCPT(A)=Deek(MP) : Add MP,2
         UZCPT(A)=Deek(MP) : Add MP,2
         If ZB(A)>32767
            ZB(A)=ZB(A)-65536
         End If 
         ZP(A)=Deek(MP) : Add MP,2
         If ZP(A)>0
            USED(A)=1
         End If 
         For B=0 To ZP(A)
            ZO(A,B)=Deek(MP)
            WT(A,B)=Deek(MP+2)
            ZC(A,B)=Deek(MP+4)
            ZWG(A,B,0)=Deek(MP+6)
            ZWG(A,B,1)=Deek(MP+8)
            ZWG(A,B,2)=Deek(MP+10)
            ZWG(A,B,3)=Deek(MP+12)
            If ZWG(A,B,3)=0
               ZWG(A,B,3)=64
            End If 
            UZWG(A,B,0)=Deek(MP+14)
            UZWG(A,B,1)=Deek(MP+16)
            UZWG(A,B,2)=Deek(MP+18)
            UZWG(A,B,3)=Deek(MP+20)
            If UZWG(A,B,3)=0
               UZWG(A,B,3)=64
            End If 
            WD(A,B)=Deek(MP+22)
            WLI(A,B)=Deek(MP+24)
            WB(A,B)=Deek(MP+26)
            If WB(A,B)>32767
               WB(A,B)=WB(A,B)-65536
            End If 
            UWB(A,B)=Deek(MP+28)
            If UWB(A,B)>32767
               UWB(A,B)=UWB(A,B)-65536
            End If 
            For C=0 To 3
               ZPBR(A,B,C)=Deek(MP+30+C+C)
               If ZPBR(A,B,C)>32767
                  ZPBR(A,B,C)=ZPBR(A,B,C)-65536
               End If 
            Next 
            Add MP,38
         Next 
         ZH(A,0)=Leek(MP) : Add MP,4
         ZH(A,1)=Leek(MP) : Add MP,4
         ZH(A,2)=Leek(MP) : Add MP,4
         ZH(A,3)=Leek(MP) : Add MP,4
         UZH(A,0)=Leek(MP) : Add MP,4
         UZH(A,1)=Leek(MP) : Add MP,4
         UZH(A,2)=Leek(MP) : Add MP,4
         UZH(A,3)=Leek(MP) : Add MP,4
         ZRG(A,0)=Peek(MP) : ZFG(A,0)=Peek(MP+1) : Add MP,2
         ZRG(A,1)=Peek(MP)-10 : ZFG(A,1)=Peek(MP+1)-10 : Add MP,2
         UZRG(A,0)=Peek(MP) : UZFG(A,0)=Peek(MP+1) : Add MP,2
         UZRG(A,1)=Peek(MP)-10 : UZFG(A,1)=Peek(MP+1)-10 : Add MP,2
         ZD(A)=Deek(MP) : Add MP,2
         ZLI(A)=Deek(MP) : Add MP,2
         RB(A)=Peek(MP) : Add MP,1
         FB(A)=Peek(MP) : Add MP,1
         S=Start(14)+(A*64*6)
         For B=0 To 63
            Doke S,Deek(MP)
            Doke S+2,Deek(MP+2)
            Doke S+4,Deek(MP+4)
            Add MP,6 : Add S,6
         Next 
      Next 
   End If 
   PLX=Leek(MP)
   PLY=Leek(MP+4)
   PLZ=Deek(MP+8)
   Add MP,10
   PLX2=Leek(MP)
   PLY2=Leek(MP+4)
   PLZ2=Deek(MP+8)
   Add MP,10
   For A=0 To 9
      LEVELTEXT$(A)=""
      For B=1 To 160
         LEVELTEXT$(A)=LEVELTEXT$(A)+Chr$(Peek(MP)) : Add MP,1
      Next 
   Next 
   EZONE=Deek(MP) : Add MP,2
   For A=0 To NZ-1
      BSFX(A)=Leek(MP) : Add MP,4
   Next 
   For A=0 To NZ-1
      ECHO(A)=Leek(MP) : Add MP,4
   Next 
   If Leek(MP)=1234567890
      Add MP,4
      For A=0 To 20
         WASP(A)=Leek(MP) : Add MP,4
         WATH(A)=Leek(MP) : Add MP,4
         WABH(A)=Leek(MP) : Add MP,4
      Next A
      For A=0 To NZ-1
         ZWA(A)=Peek(MP) : Inc MP
      Next A
   End If 
   Trap Bload LP$+"/twolev.obj",Start(12)
   If Errtrap : _WRONG[10,1] : Goto L_END : End If 
   Trap Bload LP$+"/twolev.links",Start(11)
   If Errtrap : _WRONG[10,2] : Goto L_END : End If 
   For A=0 To 99
      For B=0 To 99
         Q=Peek(Start(11)+A*100+B)
         W=Peek(Start(11)+B*100+A)
         If Q=1 and W=0
            Poke Start(11)+A*100+B,0
         End If 
         If Q=0 and W=1
            Poke Start(11)+B*100+A,0
         End If 
      Next 
   Next 
   For A=0 To NZ
      If ZO(A,0)=MXP
         USED(A)=0
         For B=0 To 10 : ZO(A,B)=-1 : Next B
         ZP(A)=0
      End If 
   Next A
   GLINK=False : GCLIP=False
   CURLEV$=F$
L_END:
   _R_N_MSG
   _wnd Id Activate 0
   '_UPD_IFACE[OP+1]
   _REDRAW
End Proc
Procedure _CLIP_LEVEL[F$]
'   If F$<"A"
'      _SELLEVEL[""] 
'      F$=Param$ 
'   End If 
   If F$<"A"
      Pop Proc
   End If 

   LP$=Peek$(LINK,64,Chr$(0))
   If LP$="" : LP$="ab3:levels/" : End If 
   LP$=LP$+"level_"+F$
   For A=0 To NZ
      If USED(A)=0
         ZO(A,0)=MXP : ZO(A,1)=MXP : ZO(A,2)=MXP : ZO(A,3)=MXP
         ZO(A,4)=MXP : ZP(A)=4
      End If 
   Next A
   On Error Goto C_ERR
   _N_MSG[Catalog String$(244,"Clipping"),""]
   COUNTER=0
   ' Make a list of which zones are connected to which. 
   F$=LP$+"/twolev.clips"
   For A=0 To NP : PW(A)=0 : PCW(A,0)=-1 : PCW(A,1)=-1 : Next 
   For A=0 To NZ-1
      If ZP(A)>0
         For B=0 To ZP(A)-1
            If WT(A,B)=1
               PCW(ZO(A,B),1)=ZO(A,B+1)
               PCW(ZO(A,B+1),0)=ZO(A,B)
            End If 
            If BWT(WT(A,B))=1
               For C=0 To NZ-1
                     For D=0 To ZP(C)-1
                     If ZO(A,B)=ZO(C,D+1) and ZO(A,B+1)=ZO(C,D)
                        ZZ(A,B)=C
                        D=ZP(C) : C=NZ
                     End If 
                  Next 
               Next 
            Else 
               PW(ZO(A,B))=1
            End If 
         Next 
      End If 
   Next 
   MP=Start(15)
   ' Need to go through every zone to see what we can see!
   If NZ=0 Then Pop Proc
   For F=0 To NZ-1
      '
      N$=Str$((F*100)/(NZ))-" "
      _gt Set Text 1,Catalog String$(245,"Done:")+" "+N$+"%",,,
      For A=0 To NZ-1
         ZU(A)=0
         VCPL(A)=0 : VCPR(A)=0
      Next 
      T=Start(14)+F*64*6
      ZU(F)=1
      ' Flag to see if we have added any new zones this time round.
      NZU=1
      P=1
      NZIL=0
      While NZU=1
         NZU=0
         TMPNZIL=NZIL
         For A=0 To NZ-1
            If ZU(A)=P
               For C=0 To ZP(A)-1
                  NWT=WT(A,(C+1) mod ZP(A))
                  If WT(A,C)<>1
                     Z=ZZ(A,C)
                     If ZU(Z)=0
                        ' We are not going back on ourselves here so 
                        ' maybe add this zone on end of list.
                        ' Now check to see if this new zone we have
                        ' added is visible.
                        If P+1>1
                           Gosub LRBORD
                           FLB=FL : TLB=TL : FRB=FR : TRB=TR
                           FL=ZO(F,FL)
                           TL=ZO(Z,TL)
                           FR=ZO(F,FR)
                           TR=ZO(Z,TR)
                           X(0)=PX(FL) : Y(0)=PY(FL)
                           X(1)=PX(TL) : Y(1)=PY(TL)
                           X(2)=PX(TR) : Y(2)=PY(TR)
                           X(3)=PX(FR) : Y(3)=PY(FR)
                           X(4)=PX(FL) : Y(4)=PY(FL)
                           ' the above now hold the pts between which we have to check. 
                           'Now see what zones are inbetween! 
                           Gosub BETPTS
                           B=0
                           INVIS=0
                           NWALLS=1
                           While B<=NP and INVIS=0
                              CP=B
                              If CP<>FL and CP<>FR
                                 If PU(CP)=-3
                                    'PU(CP)=NWALLS 
                                    CCP=PCW(CP,0)
                                    OFL=0 : OFR=0
                                    CHA=1
                                    If TL=TR and PW(TR)<>0 : PU(TL)=-2 : End If 
                                    If FL=FR and PW(FR)<>0 : PU(FL)=-4 : End If 
                                    While CHA=1
                                       CHA=0
                                       If PU(CCP)=-3 or PU(CCP)=0
                                          PU(CCP)=NWALLS : CHA=1
                                       End If 
                                       If PU(CCP)<-3
                                          OFL=-1
                                       End If 
                                       If PU(CCP)>-3 and PU(CCP)<0
                                          OFL=1
                                       End If 
                                       CCP=PCW(CCP,0)
                                    Wend 
                                    CCP=CP
                                    If TL=TR and PW(TR)<>0 : PU(TL)=-4 : End If 
                                    If FL=FR and PW(FR)<>0 : PU(FL)=-2 : End If 
                                    CHA=1
                                    While CHA=1
                                       CHA=0
                                       If PU(CCP)=-3 or PU(CCP)=0
                                          PU(CCP)=NWALLS : CHA=1
                                       End If 
                                       If PU(CCP)<-3
                                          OFR=-1
                                       End If 
                                       If PU(CCP)>-3 and PU(CCP)<0
                                          OFR=1
                                       End If 
                                       CCP=PCW(CCP,1)
                                    Wend 
                                    If(OFL=-1 and OFR=1) or(OFL=1 and OFR=-1)
                                       INVIS=1
                                    End If 
                                    SOW(NWALLS)=0
                                    If OFL=-1 and OFR=-1
                                       SOW(NWALLS)=-1
                                    End If 
                                    If OFL=1 and OFR=1
                                       SOW(NWALLS)=1
                                    End If 
                                    Add NWALLS,1
                                 End If 
                              End If 
                              If FL=FR and PW(FR)<>0 : PU(FL)=-3 : End If 
                              If TL=TR and PW(TR)<>0 : PU(TL)=-3 : End If 
                              If PW(B)=1
                                 If PU(B)=-4 and PU(PCW(B,1))=-2
                                    If FR=FL or TR=TL
                                       OL=0 : RO=0
                                       FX=PX(B)
                                       FY=PY(B)
                                       TX=PX(PCW(B,1))
                                       TY=PY(PCW(B,1))
                                       TX=TX-FX
                                       TY=TY-FY
                                       For ZEB=0 To ZP(F)-1
                                          PX=PX(ZO(F,ZEB))-FX
                                          PY=PY(ZO(F,ZEB))-FX
                                          D=PX*TY-TX*PY
                                          If D>0 : OL=1 : End If 
                                          If D<0 : RO=1 : End If 
                                       Next 
                                       If RO=0 or OL=0
                                          For ZEB=0 To ZP(F)-1
                                             PX=PX(ZO(F,ZEB))-FX
                                             PY=PY(ZO(F,ZEB))-FX
                                             D=PX*TY-TX*PY
                                             If D>0 : OL=1 : End If 
                                             If D<0 : RO=1 : End If 
                                          Next 
                                       End If 
                                       If RO=1 and OL=1
                                          INVIS=1
                                       End If 
                                    Else 
                                       INVIS=1
                                    End If 
                                 End If 
                                 If PU(B)=-2 and PU(PCW(B,1))=-4
                                    If FL=FR or TR=TL
                                       OL=0 : RO=0
                                       FX=PX(B)
                                       FY=PY(B)
                                       TX=PX(PCW(B,1))
                                       TY=PY(PCW(B,1))
                                       TX=TX-FX
                                       TY=TY-FY
                                       For ZEB=0 To ZP(F)-1
                                          PX=PX(ZO(F,ZEB))-FX
                                          PY=PY(ZO(F,ZEB))-FX
                                          D=PX*TY-TX*PY
                                          If D>0 : OL=1 : End If 
                                          If D<0 : RO=1 : End If 
                                       Next 
                                       If RO=0 or OL=0
                                          For ZEB=0 To ZP(F)-1
                                             PX=PX(ZO(F,ZEB))-FX
                                             PY=PY(ZO(F,ZEB))-FX
                                             D=PX*TY-TX*PY
                                             If D>0 : OL=1 : End If 
                                             If D<0 : RO=1 : End If 
                                          Next 
                                       End If 
                                       If RO=1 and OL=1
                                          INVIS=1
                                       End If 
                                    Else 
                                       INVIS=1
                                    End If 
                                 End If 
                              End If 
                              Add B,1
                           Wend 
                           If INVIS=0
                              VCPL(Z)=0 : VCPR(Z)=0
                              If NWALLS>1
                                 For BQ=1 To NWALLS-1
                                    If SOW(BQ)=-1
                                       ' all leftclip points
                                       For W=0 To NP
                                          If PU(W)=BQ
                                             PU(W)=-10
                                             LP(Z,VCPL(Z))=W : Add VCPL(Z),1
                                          End If 
                                       Next 
                                    End If 
                                    If SOW(BQ)=1
                                       ' all rightclip points 
                                       For W=0 To NP
                                          If PU(W)=BQ
                                             PU(W)=-20
                                             RP(Z,VCPR(Z))=W : Add VCPR(Z),1
                                          End If 
                                       Next 
                                    End If 
                                 Next 
                                 ' Now process left and right clip points to
                                 ' exclude unnecessary ones.  
                                 ' First eliminate all but most clockwise r clip
                                 ' pt on target zone. 
                                 Gosub RIGHTONEONLY
                                 Gosub LEFTONEONLY
                                 If LCPOTZ>0 and RCPOTZ>0 and TL<>TR
                                    ' get rid of any clips farther away. 
                                    FX=PX(LCPOTZ) : FY=PY(LCPOTZ)
                                    TX=PX(RCPOTZ)-FX : TY=PY(RCPOTZ)-FY
                                    If VCPL(Z)>1
                                       For BQ=0 To VCPL(Z)-1
                                          PPP=LP(Z,BQ)
                                          If PPP<>LCPOTZ and PPP<>RCPOTZ
                                             PX=PX(PPP)-FY : PY=PY(PPP)-FY
                                             D=PY*TX-PX*TY
                                             If D<=0
                                                LP(Z,BQ)=-1
                                             End If 
                                          End If 
                                       Next 
                                       TPT=0
                                       For BQ=0 To VCPL(Z)-1
                                          If LP(Z,BQ)<>-1
                                             LP(Z,TPT)=LP(Z,BQ)
                                             Add TPT,1
                                          End If 
                                       Next 
                                       VCPL(Z)=TPT
                                    End If 
                                    If VCPR(Z)>1
                                       For BQ=0 To VCPR(Z)-1
                                          PPP=RP(Z,BQ)
                                          If PPP<>LCPOTZ and PPP<>RCPOTZ
                                             PX=PX(PPP)-FY : PY=PY(PPP)-FY
                                             D=PY*TX-PX*TY
                                             If D<=0
                                                RP(Z,BQ)=-1
                                             End If 
                                          End If 
                                       Next 
                                       TPT=0
                                       For BQ=0 To VCPR(Z)-1
                                          If RP(Z,BQ)<>-1
                                             RP(Z,TPT)=RP(Z,BQ)
                                             Add TPT,1
                                          End If 
                                       Next 
                                       VCPR(Z)=TPT
                                    End If 
                                 End If 
                                 If VCPL(Z)>0
                                    BLFL=-1
                                    FX=PX(FL) : FY=PY(FL)
                                    TX=PX(TL)-FX : TY=PY(TL)-FY
                                    For BQ=0 To VCPL(Z)-1
                                       PX=PX(LP(Z,BQ))-FX : PY=PY(LP(Z,BQ))-FY
                                       D=PY*TX-PX*TY
                                       If D>0 or(TX=0 and TY=0)
                                          BLFL=BQ
                                          TX=PX : TY=PY
                                       End If 
                                    Next 
                                    BLFR=-1
                                    FX=PX(FR) : FY=PY(FR)
                                    TX=PX(FL)-FX : TY=PY(FL)-FY
                                    For BQ=0 To VCPL(Z)-1
                                       PX=PX(LP(Z,BQ))-FX : PY=PY(LP(Z,BQ))-FY
                                       D=PY*TX-PX*TY
                                       If D>0 or(TX=0 and TY=0)
                                          BLFR=BQ
                                          TX=PX : TY=PY
                                       End If 
                                    Next 
                                    If BLFL=BLFR
                                       ' only one clip point needed.
                                       LP(Z,0)=LP(Z,BLFL)
                                       VCPL(Z)=1
                                    End If 
                                 End If 
                                 If VCPR(Z)>0
                                    BRFL=-1
                                    FX=PX(FL) : FY=PY(FL)
                                    TX=PX(FR)-FX : TY=PY(FR)-FY
                                    For BQ=0 To VCPR(Z)-1
                                       PX=PX(RP(Z,BQ))-FX : PY=PY(RP(Z,BQ))-FY
                                       D=PY*TX-PX*TY
                                       If D<0
                                          BRFL=BQ
                                          TX=PX : TY=PY
                                       End If 
                                    Next 
                                    BRFR=-1
                                    FX=PX(FR) : FY=PY(FR)
                                    TX=PX(TR)-FX : TY=PY(TR)-FY
                                    For BQ=0 To VCPR(Z)-1
                                       PX=PX(RP(Z,BQ))-FX : PY=PY(RP(Z,BQ))-FY
                                       D=PY*TX-PX*TY
                                       If D<=0
                                          BRFR=BQ
                                          TX=PX : TY=PY
                                       End If 
                                    Next 
                                    If BRFL=BRFR
                                       ' only one clip point needed.
                                       RP(Z,0)=RP(Z,BRFL)
                                       VCPR(Z)=1
                                    End If 
                                 End If 
                                 ' *****************************************************
                                 ' Another waste of time bug fix. 
                                 ' Picking pairs of leftclips, is 
                                 ' the target zone completely on one
                                 ' side of the line joining them? 
                                 Gosub ELIMINLEFT
                                 Gosub ELIMINRIGHT
                                 If VCPL(Z)>0 and VCPR(Z)>0
                                    Doke Start(9)+50,ZP(F)-1
                                    Doke Start(9)+52,ZP(Z)-1
                                    Loke Start(9)+12,Varptr(LP(Z,0))
                                    Loke Start(9)+16,Varptr(RP(Z,0))
                                    Doke Start(9)+20,VCPL(Z)-1
                                    Doke Start(9)+22,VCPR(Z)-1
                                    Loke Start(9)+42,Varptr(ZO(F,0))
                                    Loke Start(9)+46,Varptr(ZO(Z,0))
                                    Doke Start(9)+40,2
                                    Call Start(9)+54
                                    INVIS=Deek(Start(9)+40)
                                    If INVIS=0
                                       ZU(Z)=P+1 : NZU=1
                                       Gosub CALCORDER
                                    End If 
                                 Else 
                                    ZU(Z)=P+1 : NZU=1
                                    Gosub CALCORDER
                                 End If 
                                 ' *******************************************************************
                              Else 
                                 Gosub CALCORDER
                                 ZU(Z)=P+1 : NZU=1
                              End If 
                           End If 
                        Else 
                           ZU(Z)=P+1 : NZU=1
                        End If 
                     End If 
                  End If 
               Next 
            End If 
         Next 
         Add P,1
      Wend 
      For A=0 To 63
         Loke T+A*6,$FFFFFFFF
         Doke T+A*6+2,$FFFF
      Next 
      TMP=P
      '
      For A=0 To NZ-1
         If ZU(A)>0
            For B=0 To ZP(A)-1
               PU(ZO(A,B))=-100
            Next 
         End If 
      Next 
      For A=0 To NZ-1
         If ZU(A)>0
            If VCPL(A)>0
               For B=0 To VCPL(A)-1
                  If LP(A,B)>0
                     If PU(LP(A,B))<>-100
                        LP(A,B)=-1
                     End If 
                  End If 
               Next 
            End If 
            If VCPR(A)>0
               For B=0 To VCPR(A)-1
                  If RP(A,B)>0
                     If PU(RP(A,B))<>-100
                        RP(A,B)=-1
                     End If 
                  End If 
               Next 
            End If 
         End If 
      Next 
      '
      CV=0
      For P=2 To TMP
         For A=0 To NZ-1
            If ZU(A)=P
               Doke T,A
               Loke T+2,CORD(A)
               Add CV,1
               D=0
               While D<VCPL(A)
                  If LP(A,D)<>-1
                     DK[LP(A,D)]
                  End If 
                  Add D,1
               Wend 
               DK[-1]
               D=0
               While D<VCPR(A)
                  If(RP(A,D)<>-1)
                     DK[RP(A,D)]
                  End If 
                  Add D,1
               Wend 
               DK[-2]
               Add T,6
            End If 
         Next 
      Next 
      If T-Start(14)>Length(14)
         Bell 
         End 
      End If 
      '
   Next 
   For A=0 To NP
      DK[PCW(A,0)] : DK[PCW(A,1)]
   Next 
   Bsave F$,Start(15) To MP
   _PACK[F$]
   GCLIP=False
C_END:
   _R_N_MSG
   _wnd Id Activate 0
   On Error 
   '_UPD_IFACE[OP+1]
Pop Proc
'
'
ELIMINLEFT:
   If VCPL(Z)>1
      Loke Start(9)+46,Varptr(ZO(Z,0))
      Doke Start(9)+52,ZP(Z)-1
      Doke Start(9)+20,VCPL(Z)
      Loke Start(9)+12,Varptr(LP(Z,0))
      Doke Start(9)+40,3
      Call Start(9)+54
      VCPL(Z)=Deek(Start(9)+40)
   End If 
Return 
'  
ELIMINRIGHT:
   If VCPR(Z)>1
      Loke Start(9)+46,Varptr(ZO(Z,0))
      Doke Start(9)+52,ZP(Z)-1
      Doke Start(9)+20,VCPR(Z)-1
      Loke Start(9)+12,Varptr(RP(Z,0))
      Doke Start(9)+40,4
      Call Start(9)+54
      VCPR(Z)=Deek(Start(9)+40)
   End If 
Return 
CALCORDER:
   Doke Start(9)+40,1
   Loke Start(9)+42,Varptr(ZO(F,0))
   Loke Start(9)+46,Varptr(ZO(Z,0))
   Loke Start(9)+12,Varptr(WT(Z,0))
   Doke Start(9)+50,ZP(F)-1
   Doke Start(9)+52,ZP(Z)-1
   Call Start(9)+54
   CORD(Z)=Leek(Start(9)+50)
Return 
'
CHKBET:
Return 
'
RIGHTONEONLY:
   RCPOTZ=-1
   If VCPR(Z)>0
      BQ=TLB
      PU(FR)=-20
      If PU(ZO(Z,BQ))<>-20
         BQ=(BQ+ZP(Z)-1) mod ZP(Z)
         While PU(ZO(Z,BQ))<>-20 and BQ<>TRB
            BQ=(BQ+ZP(Z)-1) mod ZP(Z)
         Wend 
      End If 
      If PU(ZO(Z,BQ))=-20
         RCPOTZ=ZO(Z,BQ)
         BQW=(BQ+1) mod ZP(Z)
         While BQW<>BQ
            If PU(ZO(Z,BQW))=-20
               For AAA=0 To VCPR(Z)-1
                  If RP(Z,AAA)=ZO(Z,BQW)
                     RP(Z,AAA)=-1
                  End If 
               Next 
            End If 
            BQW=(BQW+1) mod ZP(Z)
         Wend 
         TPT=0
         For BQ=0 To VCPR(Z)-1
            If RP(Z,BQ)<>-1
               RP(Z,TPT)=RP(Z,BQ)
               Add TPT,1
            End If 
         Next 
         VCPR(Z)=TPT
      End If 
   End If 
Return 
'
LEFTONEONLY:
   LCPOTZ=-1
   If VCPL(Z)>0
      BQ=TRB
      PU(FL)=-10
      If PU(ZO(Z,BQ))<>-10
         BQ=(BQ+1) mod ZP(Z)
         While(PU(ZO(Z,BQ))<>-10) and(BQ<>TLB)
            BQ=(BQ+1) mod ZP(Z)
         Wend 
      End If 
      If PU(ZO(Z,BQ))=-10
         LCPOTZ=ZO(Z,BQ)
         BQW=(BQ+1) mod ZP(Z)
         While BQW<>BQ
            If PU(ZO(Z,BQW))=-10
               For AAA=0 To VCPL(Z)-1
                  If LP(Z,AAA)=ZO(Z,BQW)
                     LP(Z,AAA)=-1
                  End If 
               Next 
            End If 
            BQW=(BQW+1) mod ZP(Z)
         Wend 
         TPT=0
         For BQ=0 To VCPL(Z)-1
            If LP(Z,BQ)<>-1
               LP(Z,TPT)=LP(Z,BQ)
               Add TPT,1
            End If 
         Next 
         VCPL(Z)=TPT
      End If 
   End If 
Return 
'  
BETPTS:
   Loke Start(9),Varptr(D(0,0))
   Loke Start(9)+4,Varptr(PX(0))
   Loke Start(9)+8,Varptr(PY(0))
   Doke Start(9)+12,X(0)
   Doke Start(9)+14,Y(0)
   Doke Start(9)+16,X(1)
   Doke Start(9)+18,Y(1)
   Doke Start(9)+20,X(2)
   Doke Start(9)+22,Y(2)
   Doke Start(9)+24,X(3)
   Doke Start(9)+26,Y(3)
   Doke Start(9)+28,NP
   Loke Start(9)+30,Varptr(PW(0))
   Loke Start(9)+34,Varptr(PU(0))
   If FL<>FR and TL<>TR
      Doke Start(9)+38,0
   End If 
   If FL=FR and TL<>TR
      Doke Start(9)+38,1
   End If 
   If FL<>FR and TL=TR
      Doke Start(9)+38,2
   End If 
   Doke Start(9)+40,0
   Call Start(9)+54
   PU(FL)=-5 : PU(TL)=-5 : PU(TR)=-1 : PU(FR)=-1
Return 
'
LRBORD:
   ' Find the two bordering lines joining the two zones.
   FL=0 : TL=0 : FR=0 : TR=0
   If ZO(F,FL)=ZO(Z,TL) Then FL=FL+1
   If ZO(F,FR)=ZO(Z,TR) Then FR=FR+1
   CHANGED=1
   While CHANGED=1
      CHANGED=0
      NL=(TL+ZP(Z)-1) mod ZP(Z)
      D=0
      X=PX(ZO(F,FL)) : Y=PY(ZO(F,FL))
      DX=PX(ZO(Z,TL)) : DY=PY(ZO(Z,TL))
      DX=DX-X : DY=DY-Y : TMPTL=TL
      While NL<>TMPTL
         PX=PX(ZO(Z,NL))-X : PY=PY(ZO(Z,NL))-Y
         ND=DY*PX-DX*PY
         If ND>0
            DX=PX : DY=PY : TL=NL : CHANGED=1
         End If 
         NL=(NL+ZP(Z)-1) mod ZP(Z)
      Wend 
      '
      NL=(FL+1) mod ZP(F)
      D=0
      X=PX(ZO(F,FL)) : Y=PY(ZO(F,FL))
      DX=PX(ZO(Z,TL)) : DY=PY(ZO(Z,TL))
      X=X-DX : Y=Y-DY : TMPFL=FL
      While NL<>TMPFL
         PX=PX(ZO(F,NL))-DX : PY=PY(ZO(F,NL))-DY
         ND=X*PY-Y*PX
         If ND>0
            X=PX : Y=PY : FL=NL : CHANGED=1
         End If 
         NL=(NL+1) mod ZP(F)
      Wend 
   Wend 
   '
   CHANGED=1
   While CHANGED=1
      CHANGED=0
      NR=(TR+1) mod ZP(Z)
      D=0
      X=PX(ZO(F,FR)) : Y=PY(ZO(F,FR))
      DX=PX(ZO(Z,TR)) : DY=PY(ZO(Z,TR))
      DX=DX-X : DY=DY-Y : TMPTR=TR
      While NR<>TMPTR
         PX=PX(ZO(Z,NR))-X : PY=PY(ZO(Z,NR))-Y
         ND=DY*PX-DX*PY
         If ND<0
            DX=PX : DY=PY : TR=NR : CHANGED=1
         End If 
         NR=(NR+1) mod ZP(Z)
      Wend 
      '
      NR=(FR+ZP(F)-1) mod ZP(F)
      D=0
      X=PX(ZO(F,FR)) : Y=PY(ZO(F,FR))
      DX=PX(ZO(Z,TR)) : DY=PY(ZO(Z,TR))
      X=X-DX : Y=Y-DY : TMPFR=FR
      While NR<>TMPFR
         PX=PX(ZO(F,NR))-DX : PY=PY(ZO(F,NR))-DY
         ND=X*PY-Y*PX
         If ND<0
            X=PX : Y=PY : FR=NR : CHANGED=1
         End If 
         NR=(NR+ZP(F)-1) mod ZP(F)
      Wend 
   Wend 
Return 
C_ERR:
   _ERRTXT["Clip Error:",Err$(Errn)]
   Resume C_END
End Proc
Procedure _LINK_LEVEL[F$]
'   If F$<"A"
'      _SELLEVEL[""] 
'      F$=Param$ 
'   End If 
   If F$<"A"
      Pop Proc
   End If 
   LP$=Peek$(LINK,64,Chr$(0))
   If LP$=""
      LP$="ab3:levels/"
   End If 
   LP$=LP$+"level_"+F$
   On Error Goto L_ERR
   _N_MSG2[Catalog String$(246,"Doing Link-philez, hang on might be long"),0]
   NU=100
   Erase 112
   Reserve As Work 115,NU^2
   Reserve As Work 111,NU^2
   Reserve As Work 114,NU^2
   Reserve As Work 113,(NU^2)*2
   Bload LP$+"/twolev.links",Start(111)
   Reserve As Work 112,Length(511)
   Copy Start(511),Bank End(511) To Start(112)
   N=Start(112)
   Loke N,Start(111)
   Loke N+4,Start(114)
   Loke N+8,Start(113)
   Doke N+12,NU
   GO=Start(112)+14
   S=Start(111) : T=Start(115)
   For A=0 To NU-1
      For B=0 To NU-1
         If Peek(S)=2
            Poke T,1
         Else 
            Poke T,Peek(S)
         End If 
         Add T,1
         Add S,1
      Next 
   Next 
   Call GO
   Bsave LP$+"/twolev.map",Start(114) To Start(114)+NU*NU
   Loke N,Start(115)
   Call GO
   Bsave LP$+"/twolev.flymap",Start(114) To Start(114)+NU*NU
   GLINK=False
L_END:
   _R_N_MSG
   _wnd Id Activate 0
   On Error 
   '_UPD_IFACE[OP+1]
   Pop Proc
L_ERR:
   _ERRTXT["Linkup Error:",Err$(Errn)]
   Resume L_END
End Proc
Procedure _MAKE_LEVEL[F$,F]
'   If F$<"A"
'      _SELLEVEL[""] 
'      F$=Param$ 
'   End If 
   If F$<"A"
      Pop Proc
   End If 
   C=True
   'If GCHECK or F
   '   _CHECK_LEVEL 
   '   C=Param
   'End If  
   If C
      If GCLIP or F
         _CLIP_LEVEL[F$]
      End If 
      _SAVE_LEVEL[F$]
      If GLINK or F
         _LINK_LEVEL[F$]
      End If 
   End If 
End Proc
Procedure _CHECK_LEVEL
   Dim FER(30)

   _N_MSG2[Catalog String$(1600,"Level Checking.."),6]
   E=False
   '
   '  Zone checker
   '
   Degree 
   ERRCVX=False : EZ=-1 : STATUS=True : IERR=True
   E=False
   For A=0 To NZ-1
      _gt Set Text 1,Catalog String$(1601,"Zones:")+Str$(A)+" /"+Str$(NZ-1),,,$2
      If TELZO(A)>-1
         If USED(TELZO(A))=0 : TELZO(A)=0 : End If 
      End If 
      '
      ' Bordering zone check 
      '  
      For B=1 To ZP(A)
         F=ZO(A,B-1) : T=ZO(A,B)
         For C=0 To NZ-1
            If USED(C)
               For D=0 To ZP(C)-1
                  If ZO(C,D)=T and ZO(C,D+1)=F
                     If WT(C,D)=2 and ZD(A)=0 : WT(C,D)=0 : End If 
                     If WT(C,D)=5 and ZLI(A)=0 : WT(C,D)=0 : End If 
                     If WT(C,D)<>2 : WD(C,D)=0 : End If 
                     If WT(C,D)<>5 : WLI(C,D)=0 : End If 
                  End If 
               Next D
            End If 
         Next C
      Next B
      For B=0 To 10
         If WT(A,B)<>2 : WD(A,B)=0 : End If 
         If WT(A,B)<>5 : WLI(C,D)=0 : End If 
      Next B
      If USED(A)
         '
         ' Check convexity
         '  
         WS=0 : WA=0 : E1=0 : E2=0
         For D=1 To ZP(A)
            WX#=PX(ZO(A,D))-PX(ZO(A,D-1))
            WY#=PY(ZO(A,D))-PY(ZO(A,D-1))
            If False
            Else If WX#=0 and WY#>0 : W2#=180
            Else If WX#=0 and WY#<0 : W2#=0
            Else If WX#>0 and WY#=0 : W2#=90
            Else If WX#<0 and WY#=0 : W2#=-90
            Else If WX#>0 and WY#>0 : W2#=180-Atan(WX#/WY#)
            Else If WX#>0 and WY#<0 : W2#=-Atan(WX#/WY#)
            Else If WX#<0 and WY#>0 : W2#=-180-Atan(WX#/WY#)
            Else If WX#<0 and WY#<0 : W2#=-Atan(WX#/WY#)
            Else W2#=WA
            End If 
            W1=W2#
            WB=(W1-WA)
            Do 
               If False
               Else If WB<-360 : Add WB,360
               Else If WB>360 : Add WB,-360
               Else If WB<-180 : WB=WB+360
               Else If WB>180 : WB=WB-360
               Else : Exit 
               End If 
            Loop 
            WA=W1
            If WB<0 and D>1 and E1=0
               Inc FER(1) : E1=1 : E=True
               _gt Set Text 2,Catalog String$(1610,"Non-Convex zones:")+Str$(FER(1)),,,$2
               If FER(1)=1
                  FERR=1 : Gosub FATAERROR
                  If IERR=0 : ERRZ=A : Exit 2 : End If 
               End If 
            Else If WB<90 and D>1 and E2=0
               Inc FER(2)
               _gt Set Text 3,Catalog String$(1611,"Sharp-corner zones:")+Str$(FER(2)),,,$2
            End If 
         Next D
      End If 
   Next A
   If IERR
      For A=0 To NP
         _gt Set Text 5,Catalog String$(1602,"Points:")+Str$(A)+" /"+Str$(NP),,,$2
         ZOGET[PX(A),PY(A)] : B=Param
         If B>=0
            D=True
            For C=0 To ZP(B)
               If ZO(B,C)=A : D=False : Exit : End If 
            Next C
            If D
               Inc FER(11)
               _gt Set Text 6,Catalog String$(1630,"Points inside zones:")+Str$(FER(11)),,,$2
               E=True
               If FER(11)=1
                  FERR=11 : Gosub FATAERROR
                  If IERR=0 : ERRZ=B : Exit : End If 
               End If 
            End If 
         End If 
      Next A
   End If 
'
'somewhere IERR gets set to something other than 1 or 0 so checking for not 0 instead of =1 for now    
'moved the string out of the request command AL
'
   If IERR<>0
      T0$=Catalog String$(1649,"Finished Checking")
      M=_request Choice(_wnd Id Base(0),"",T0$,"OK")
   End If 
   _R_N_MSG
   GCHECK=False
   If IERR=0
'
      _TIDYDEF : OP=1
      _INITDEF : _SHOW_MENU : CZ=ERRZ
      GCHECK=True
   End If 
   _REDRAW
Pop Proc[IERR]

FATAERROR:
   T0$=Catalog String$(1650,"Serious error found:")
   T1$=Catalog String$(1651,"Ignore")
   T2$=Catalog String$(1652,"Show")
   If FERR=1 : T$=Catalog String$(1653,"Non-convex zone found")
   Else If FERR=11 : T$=Catalog String$(1654,"Point found inside zone")
   End If 
   M=_request Choice(_wnd Id Base(0),T0$,T$,T1$+"|"+T2$)
'
'edited this into a single line AL 
   If M=0 : IERR=False : Else : IERR=True : End If 
'
Return 
End Proc
'
Procedure _LOAD_LINK
   '
   ' Get link phile-data
   '
   _S_FILE[0,Catalog String$(250,"Load Linkfile"),"ab3:includes/","*.lnk",""]
   F$=Param$
   If Exist(F$) and F$<>""
      _N_MSG2["",0]
      _LOAD[400,F$]
      For A=700 To 720 : Erase A : Next A
      _R_N_MSG
   End If 
   LINK=Start(400)
End Proc
Procedure _SAVE_LINK
   '
   ' Save link phile-data 
   '
   _S_FILE[1,Catalog String$(251,"Save Linkfile"),"ab3:includes/","*.lnk",""]
   F$=Param$
   If F$<>""
      _N_MSG2["",0]
      If Up Case$(Right$(F$,4))<>".LNK" : F$=F$+".lnk" : End If 
      Trap Bsave F$,Start(400) To Bank End(400)
      _PACK[F$]
      _R_N_MSG
   End If 
End Proc
Procedure _LOAD_DEF_LINK
   '
   ' Get link phile-data
   '
   F$="ab3:includes/test.lnk"
   _N_MSG2["",0]
   Reserve As Work 400,86268
   _LOAD[400,F$]
   FL=Param
   For A=700 To 720 : Erase A : Next A
   '
   ' Set Standard Values
   '
   If FL=0
      AD=Start(400)
      '
      ' Default levelnames 
      '
      Fill Start(400) To Bank End(400),0
      For A=0 To 15
         B$="                LEVEL  "+Chr$(65+A)
         Poke$ AD+$40+A*40,Left$(B$+Space$(40),40)
      Next A
      '
      ' Default bullets
      '
      For A=0 To 19
         B$="BULLET TYPE "+Chr$(A+65) : Poke$ AD+$3230+A*20,Left$(B$+Space$(20),20)
      Next A
      '
      ' Default aliens 
      '
      For A=0 To 19
         A$="ALIEN "+Chr$(A+65)
         Poke$ AD+$34D8+A*20,Left$(A$+Space$(20),20)
         For B=0 To 10
            ANBAS=AD+$82D0+A*2420+B*220
            Poke ANBAS+8,-1
            For C=1 To 19
               Poke ANBAS+C*11,-1
               Poke ANBAS+C*11+8,-1
            Next C
         Next B
      Next A
      '
      ' Default gunname & bullets
      '
      For A=0 To 9
         G$="GUN "+Chr$(A+65)
         Poke$ AD+$33C0+A*20,G$
         Doke AD+$3488+A*8,A
      Next A
   End If 
   LINK=Start(400)
   _R_N_MSG
End Proc
Procedure _SAVE_DEF_LINK
   '
   ' Save link phile-data 
   '
   _N_MSG2["",0]
   F$="ab3:includes/test.lnk"
   Trap Bsave F$,Start(400) To Bank End(400)
   _PACK[F$]
   _R_N_MSG
End Proc
'
Procedure _LOAD[B,F$]
   FL=0
   If Exist(F$) and F$<>""
      If File Length(F$)>20
         FL=0
         Exec "Copy "+F$+" T:EdW"
         Exec "SBDepack T:EdW"
         Trap FL=File Length("T:EdW")
         If FL>0
            BN=Abs(B)
            If Length(BN)<FL
               If B>0
                  Reserve As Work B,FL
               Else 
                  Reserve As Chip Work Abs(B),FL
               End If 
            End If 
            Trap Bload "T:EdW",Start(Abs(B))
            Trap Kill "T:EdW"
            If Peek$(Start(Abs(B)),4)="=SB=" : FL=0 : End If 
         End If 
      End If 
   End If 
End Proc[FL]
Procedure _PACK[F$]
   If Not Exist("C:Delete") : _WRONG[1,0] : E=True
   Else If Not Exist("C:Lha3") : _WRONG[1,1] : E=True
   Else If Not Exist("C:LhaConv") : _WRONG[1,2] : E=True
   End If 
   If Not E and Exist(F$)
      Open Out 1,"T:AB-tst"
      Print #1,"DUMMY"
      Close 1
      Open Out 1,"t:AB-Led1"
      Print #1,"FailAt 10000"+Chr$(10);
      Print #1,"ab3:"+Chr$(10);
      Print #1,"Lha3 a t:clip "+F$+" cspeed=5 hdrlvl=0"+Chr$(10);
      Print #1,"Delete >nil: t:clip.lha.cat"+Chr$(10);
      Print #1,"LhaConv t:clip.lha "+F$+Chr$(10);
      Print #1,"Delete >nil: t:clip.lha"+Chr$(10);
      Print #1,"Delete >nil: T:AB-tst"+Chr$(10);
      Print #1,"Endcli"+Chr$(10);
      Close 1
      Exec "Newcli from t:AB-Led1"
      Repeat 
         For A=0 To 10
            Multi Wait 
         Next A
      Until Not Exist("T:AB-tst")
   End If 
End Proc
'
'----------------------------------------------------------------------------  
'   Procedures to put something on the map...
'----------------------------------------------------------------------------  
'
Procedure _ZOSHOW[Z,C]
   If Z<0 Then Pop Proc
   If ZP(Z)=0 Then Pop Proc
   If USED(Z)=0 Then Pop Proc
   WX=0 : WY=0
   For A=0 To ZP(Z)-1
      WX=WX+PX(ZO(Z,A)) : WY=WY+PY(ZO(Z,A))
      CC=WT(Z,A)+C
      If WT(Z,A)>1 Then CC=C+2
      If C=0 Then CC=0
      _JOIN[ZO(Z,A),ZO(Z,A+1),CC]
   Next 
   WXS=WX : WYS=WY
   WY=((WYS/ZP(Z)-YO)/MU-8)/YRES
   _wnd Id Ink D_INK(2),D_INK(0),D_INK(0)
   If ZD(Z)>0 and Btst(1,SHMODE)
      WX=WXS/ZP(Z) : WX=(WX-XO)/MU : Add WY,8 : M$="D"+Chr$(ZD(Z)+64) : _wnd Id Text WX-8,WY+4,M$
   End If 
   If ZLI(Z)>0 and Btst(0,SHMODE)
      WX=WXS/ZP(Z) : WX=(WX-XO)/MU : Add WY,8 : M$="L"+Chr$(ZLI(Z)+64) : _wnd Id Text WX-8,WY+4,M$
   End If 
   If TELZO(Z)>-1 and Btst(2,SHMODE)
      WX=WXS/ZP(Z) : WX=(WX-XO)/MU : Add WY,8 : M$=("T"+Str$(Z)+"S")-" " : _wnd Id Text WX-8,WY+4,M$
   End If 
   If Btst(2,SHMODE)
      For A=0 To NZ
         If TELZO(A)=Z : WX=TELX(A) : WY=TELZ(A) : WY=((WY-YO)/MU)/YRES : WX=(WX-XO)/MU : M$=("T"+Str$(A)+"D")-" " : _wnd Id Text WX-8,WY+4,M$ : End If 
      Next A
   End If 
   If Btst(3,SHMODE)
      WY=((WYS/ZP(Z)-YO)/MU-12)/YRES : If WX=WXS : WX=WXS/ZP(Z) : WX=(WX-XO)/MU-28 : Else : WX=WX+22 : End If 
      If UZH(Z,1)=5000 : _wnd Id Text WX,WY,"UR<Off>" : Else _wnd Id Text WX,WY,"UR"+Str$(UZH(Z,1)) : End If 
      If UZH(Z,0)=5000 : _wnd Id Text WX,WY+8,"UF<Off>" : Else _wnd Id Text WX,WY+8,"UF"+Str$(UZH(Z,0)) : End If 
      _wnd Id Text WX,WY+16,"LR"+Str$(ZH(Z,1))
      _wnd Id Text WX,WY+24,"LF"+Str$(ZH(Z,0))
      _wnd Id Text WX,WY+32,"WA"+Str$(ZH(Z,2))
   End If 
   If Z=EZONE
      _wnd Id Ink D_INK(2),D_INK(0),D_INK(0)
      WX=WXS/ZP(Z) : WY=WYS/ZP(Z) : WX=(WX-XO)/MU : WY=((WY-YO)/MU)/YRES : M$="END" : _wnd Id Text WX-12,WY+4,M$
   End If 
   For A=0 To 7
      If SWWL(A,0)=Z
         B=SWWL(A,1)
         LX=PX(ZO(Z,B)) : LY=PY(ZO(Z,B))
         RX=PX(ZO(Z,B+1)) : RY=PY(ZO(Z,B+1))
         MX=(LX+RX)/2
         MY=(LY+RY)/2
         MX=(MX-XO)/MU*XRES
         MY=(MY-YO)/MU
         Ink 1,0
         M$="S"+(Str$(A)-" ") : Text MX-8,MY,M$
      End If 
   Next 
End Proc
Procedure _OBJPUT[X,Y,C]
   _wnd Id Use 0
   X=(X-XO)/MU : Y=((Y-YO)/MU)/YRES
   If Y>0
      _wnd Id Ink D_INK(C),D_INK(C),D_INK(C)
      _wnd Id Ellipse X,Y,4,4/YRES
      _wnd Id Line X-2,Y To X+2,Y
      _wnd Id Line X,Y-2/YRES To X,Y+2/YRES
   End If 
End Proc
Procedure _CONNECTED[A,B,P]
   If A<B : Swap A,B : End If 
   'If A=P or B=P Then C1=12 : C2=15 : C3=13
   'Else C1=6 : C2=8 : C3=7 
   C1=6 : C2=8 : C3=7
   If RECPT<>0
      N=Start(11)
      Q=Peek(N+A*100+B) : W=Peek(N+B*100+A)
      If Q or W
         If Q=1 and W=1 and Btst(0,RECPT)
            _JOINCOORDS[CPTX(A),CPTY(A),CPTX(B),CPTY(B),C1]
         Else If Q=2 and W=2 and Btst(1,RECPT)
            _JOINCOORDS[CPTX(A),CPTY(A),CPTX(B),CPTY(B),C2]
         Else If Q=1 and W=2 and Btst(0,RECPT)
            _JOINCOORDS[CPTX(A),CPTY(A),CPTX(B),CPTY(B),C1]
            XD=CPTX(B)-CPTX(A) : YD=CPTY(B)-CPTY(A)
            LD=Sqr(XD^2+YD^2)
            XD=(XD*30)/LD : YD=(YD*30)/LD
            _JOINCOORDS[CPTX(B)-XD,CPTY(B)-YD,CPTX(B)-XD*2-YD/2,CPTY(B)-YD*2+XD/2,C3]
            _JOINCOORDS[CPTX(B)-XD,CPTY(B)-YD,CPTX(B)-XD*2+YD/2,CPTY(B)-YD*2-XD/2,C3]
         Else If Q=2 and W=1 and Btst(0,RECPT)
            XD=CPTX(B)-CPTX(A) : YD=CPTY(B)-CPTY(A)
            LD=Sqr(XD^2+YD^2)
            XD=(XD*30)/LD : YD=(YD*30)/LD
            _JOINCOORDS[CPTX(A),CPTY(A),CPTX(B),CPTY(B),C1]
            _JOINCOORDS[CPTX(A)+XD,CPTY(A)+YD,CPTX(A)+XD*2-YD/2,CPTY(A)+YD*2+XD/2,C3]
            _JOINCOORDS[CPTX(A)+XD,CPTY(A)+YD,CPTX(A)+XD*2+YD/2,CPTY(A)+YD*2-XD/2,C3]
         End If 
      End If 
   End If 
End Proc
Procedure _JOIN[SP,EP,C]
   If SP<0 or EP<0 : Pop Proc : End If 
   _wnd Id Use 0
   _wnd Id Ink D_INK(C),D_INK(C),D_INK(C)
   X1=(PX(SP)-XO)/MU : Y1=((PY(SP)-YO)/MU)/YRES
   X2=(PX(EP)-XO)/MU : Y2=((PY(EP)-YO)/MU)/YRES
   If Y1>Y2
      X1=X1+1 : X2=X2+1
      Swap X1,X2 : Swap Y1,Y2
   End If 
   If X2>X1
      Y1=Y1+1 : Y2=Y2+1
   End If 
   _wnd Id Line X1,Y1 To X2,Y2
End Proc
Procedure _JOINCOORDS[X1,Y1,X2,Y2,C]
   _wnd Id Use 0
   X1=(X1-XO)/MU : X2=(X2-XO)/MU
   Y1=((Y1-YO)/MU)/YRES : Y2=((Y2-YO)/MU)/YRES
   _wnd Id Ink D_INK(C),D_INK(C),D_INK(C)
   _wnd Id Line X1,Y1 To X2,Y2
End Proc
Procedure HIGHCONT[PT]
   If O_CPT>-1
      CPTPUT[CPTX(O_CPT),CPTY(O_CPT),8-CPTUL(O_CPT)*2]
   End If 
   If PT>-1
      CPTPUT[CPTX(PT),CPTY(PT),5]
   End If 
   O_CPT=PT
   'If PT<0 Then Pop Proc 
   'WX=CPTX(PT) : WY=CPTY(PT) 
   'WX=(WX-XO)/MU*XRES : WY=(WY-YO)/MU
   'Sprite 2,X Hard(2,WX-3),Y Hard(2,WY-3),4
End Proc
Procedure PTSHOW[WX,WY,C]
   If WX<$70000000 and WY<$70000000
      WX=(WX-XO)/MU : WY=((WY-YO)/MU)/YRES
      _wnd Id Use 0
      If C=-1
         _wnd Id Ink D_INK(1),D_INK(0),D_INK(0)
         _wnd Id Text WX-8,WY+4,"P1"
      Else If C=-2
         _wnd Id Ink D_INK(1),D_INK(0),D_INK(0)
         _wnd Id Text WX-8,WY+4,"P2"
      Else 
         _wnd Id Ink D_INK(C),D_INK(0),D_INK(C)
         _wnd Id Bar WX-2,WY-(2/YRES) To WX+2,WY+(2/YRES)
      End If 
   End If 
End Proc
Procedure CPTPUT[WX,WY,C]
   _wnd Id Use 0
   WX=(WX-XO)/MU
   WY=((WY-YO)/MU)/YRES
   If Between(-1,WX,_wnd Id Width) and Between(-1,WY,_wnd Id Height)
      _wnd Id Ink D_INK(C),1,1
      _wnd Id Rect WX-2,WY-2/YRES To WX+2,WY+2/YRES
      _wnd Id Line WX,WY-4/YRES To WX,WY+4/YRES
      _wnd Id Line WX-4,WY To WX+4,WY
   End If 
End Proc
Procedure PTCLR[WX,WY]
   PTSHOW[WX,WY,0]
End Proc
Procedure _OUTLINE[PT]
   If O_POINT>-1
      PTSHOW[PX(O_POINT),PY(O_POINT),1]
   End If 
   If PT>-1
      PTSHOW[PX(PT),PY(PT),5]
   End If 
   O_POINT=PT
End Proc
'
'----------------------------------------------------------------------------  
'   Procedures to find something on the map... 
'----------------------------------------------------------------------------  
'
Procedure FINDNEAR[WX,WY]
   MD=10000000
   P=-1
   If NP>-1
      For A=0 To NP
         If PX(A)<$7FFF and PY(A)<$7FFF
            D=(WX-PX(A))^2+(WY-PY(A))^2
            If D<MD : MD=D : P=A : End If 
         End If 
      Next 
   End If 
End Proc[P]
Procedure FINDNEARZONE[Z,WX,WY]
   MD=10000000
   P=-1
   If NP<>-1 and Between(-1,Z,MZ)
      For B=0 To ZP(Z)-1
         A=ZO(Z,B)
         If Between(-1,A,MXP)
            D=(WX-PX(A))^2+(WY-PY(A))^2
            If D<MD : MD=D : P=A : End If 
         End If 
      Next 
   End If 
End Proc[P]
Procedure _FINDNEARZONE2[Z,WX,WY]
   MD=10000000
   P=-1
   If NP<>-1
      For B=0 To ZP(Z)-1
         A=ZO(Z,B)
         If Between(-1,A,MXP)
            D=(WX-PX(A))^2+(WY-PY(A))^2
            If D<MD : MD=D : P=B : End If 
         End If 
      Next 
   End If 
End Proc[P]
Procedure FINDOBJ[WX,WY]
   MD=10000000
   P=-1
   If NO<=0 Then Goto 22
   For A=0 To NO-1
      D=(WX-OBX(A))^2+(WY-OBZ(A))^2
      If D<MD Then MD=D : P=A
   Next 
   22
End Proc[P]
Procedure ZOGET[WX,WY]
   P=-1
   If NZ=-1 Then Goto 7
   For A=0 To NZ
      If ZP(A)=0 Then Goto 3
      B=0
      Repeat 
         X1=PX(ZO(A,B))
         X2=PX(ZO(A,B+1))
         Y1=PY(ZO(A,B))
         Y2=PY(ZO(A,B+1))
         Y2=Y2-Y1 : X2=X2-X1
         X1=WX-X1 : Y1=WY-Y1
         D=(X1*Y2)-(Y1*X2)
         If D>0 Then Goto 3
         Add B,1
      Until B=ZP(A)
      P=A : A=NZ+1
      3
   Next A
   7
End Proc[P]
Procedure FINDCONT[X,Y]
   P=-1
   If NCPT<0 Then Goto 342
   SD=100000000
   For A=0 To NCPT
      D=(CPTX(A)-X)^2+(CPTY(A)-Y)^2
      If D<SD Then P=A : SD=D
   Next 
   342
End Proc[P]
'
'----------------------------------------------------------------------------  
'   Gamelinkfiles...   
'----------------------------------------------------------------------------  
'
Procedure _GL_OBJGFX
   Dim W$(29)
   Do 
      _wnd Id Open 8,0,20,_scr Id Width(1),240,$2+$8,F_IDCMP,0,"Levels.."
      _wnd Id Titles Catalog String$(500,"Select Object GFX-frames (Hold 'Alt' to set frames)"),VER$
      _wnd Id Activate 8
      Reserve As Gt Gadgets 497,30,1


      _gt Set String Mode True,80,True,False
      _gt Set Listview Mode ,,,16,0,

      _gt Listview 8,32,16,592,220,,"",Array(W$(0)),0

      _gt Gadgets Attach 497
      Do 
         For A=0 To 29
            W$(A)=Peek$(LINK+$2C0+A*64,64,Chr$(0))
         Next A
         _gt Set Listview 8,Array(W$(0)),,,
         Do 
            '
            ' Wait for event 
            '
            EV=_wnd Id Next Event
            GA=_wnd Id Event Gadget
            KS=_wnd Id Event Qualifier and %111
            KY=_wnd Id Event Code
            If EV=$40
               If GA=8 and KS=0
                  _S_FILE[0,Catalog String$(503,"Select Object-GFX frames"),"AB3:Includes/","*.wad",""]
                  F$=Param$
                  If F$<>"" and Exist(F$)
                     If File Type(F$)<0
                        If Instr(Dr File$(F$),".") : F$=Left$(F$,Bw Instr(F$,".")-1) : End If 
                        Poke$ LINK+$2C0+KY*64,Left$(F$+String$(Chr$(0),64),64)
                     End If 
                  End If 
                  Exit 
               Else If GA=8
                  Exit 2
               End If 
            End If 
            If EV=$400
               If KY=95 : _SHOW_AG["M0201"] : End If 
            End If 
            '
            ' If window closed 
            '
            Exit If EV=$200,2
            Multi Wait 
         Loop 
      Loop 
      _gt Gadgets Remove 497
      _wnd Id Close 8
      _gt Gadgets Erase 497
      Exit If EV=$200
      _GL_SETOBJFRAMES[KY]
   Loop 
End Proc
Procedure _GL_SETOBJFRAMES[NR]
   _LOAD[15,Peek$(LINK+$2C0+NR*64,64,Chr$(0))+".256pal"]
   If Param=0 : Pop Proc : End If 
   Dim C(32)

   _scr Id Open 2,0,0,_scr Id Width(1)/2,266,6,SCR_MODE and $FFFF1000,0,"Breed Editor Work"

   _wnd Id Open 8,0,20,_scr Id Width(1),250,$2+$8,F_IDCMP,0,"Levels.."
   _wnd Id Titles Catalog String$(530,"Set Object Frames"),VER$
   _wnd Id Activate 8
   _scr Id Show 2
   Reserve As Gt Gadgets 497,30,2
   _gt Set Integer Mode 1,6,1,0
   HO=134
   _gt Text 1,8,12+HO,184,12,,"","",1
   _gt Button 4,8,48+HO,312,12,,Catalog String$(531,"Copy width to previous frames")
   _gt Button 5,8,60+HO,312,12,,Catalog String$(532,"Copy height to previous frames")
   _gt Button 6,8,72+HO,312,12,,Catalog String$(533,"Copy width to subsequent frames")
   _gt Button 7,8,84+HO,312,12,,Catalog String$(534,"Copy height to subsequent frames")
   _gt Button 8,8,96+HO,312,12,,Catalog String$(535,"Generate frames from graphic data")
   _gt Image 11,192,12+HO,1,GAD24(2),GAD24(3)
   _gt Image 12,216,12+HO,1,GAD24(4),GAD24(5)
   _gt Image 13,272,12+HO,1,GAD24(2),GAD24(3)
   _gt Image 14,296,12+HO,1,GAD24(4),GAD24(5)
   _gt Integer 21,88,24+HO,64,12,0,Catalog String$(16,"Left:"),1256,1
   _gt Integer 22,88,36+HO,64,12,0,Catalog String$(17,"Top:"),1256,1
   _gt Integer 23,256,24+HO,64,12,0,Catalog String$(18,"Width:"),1256,1
   _gt Integer 24,256,36+HO,64,12,0,Catalog String$(19,"Height:"),1256,1
   For A=0 To 31
      B=Peek(Start(15)+A*2)
      DR=Deek(PALC+B*6) : DG=Deek(PALC+B*6+2) : DB=Deek(PALC+B*6+4)
      _scr Id Set Aga Pal A+8,DR*$10000+DG*$100+DB
      C(A)=A+8
   Next 
   Erase 401 : Erase 402
   FILE$=Peek$(LINK+$2C0+NR*64,64,Chr$(0))
   _LOAD[401,FILE$+".ptr"]
   _LOAD[402,FILE$+".wad"]
   W$="" : HOF=127
   WOF=Length(401)/4
   If Deek(Bank End(401)-8)=$FFFF
      NOFF=Deek(Bank End(401)-6)
      WOFF=Deek(Bank End(401)-4)
      HOFF=Deek(Bank End(401)-2)
      HOF=HOFF : WOF=NOFF*WOFF
   Else 
      If Exist(FILE$+".hqn")
         Trap Open In 1,FILE$+".hqn"
         If Errtrap=0
            W$=Input$(1,6)
         End If 
         Trap Close 1
      Else If Exist(FILE$+".dat")
         Trap Open In 1,FILE$+".hqn"
         If Errtrap=0
            W$=Input$(1,6)
         End If 
         Trap Close 1
      End If 
      If W$>""
         NOFF=_val.w(Mid$(W$,1,2))
         WOFF=_val.w(Mid$(W$,3,2))
         HOFF=_val.w(Mid$(W$,5,2))
         HOF=HOFF
      End If 
   End If 
   XOF=0
   _gt Gadgets Attach 497
   Gosub WIDTHSHOW
   CF=0 : EX=0
   Gosub FRAMEDISPLAY
   Repeat 
      '
      ' Wait for event 
      '
      EV=_wnd Id Next Event
      GA=_wnd Id Event Gadget
      KS=_wnd Id Event Qualifier and %111
      KY=_wnd Id Event Code
      '
      LY=_wnd Id Y Mouse : LX=_wnd Id X Mouse
      If Between(15,LY,160) and Between(7,LX,_wnd Id Width-8)
         If LY<>OLY or LX<>OLX
            _wnd Id Titles Catalog String$(530,"Set Object Frames")+" "+Str$(LX-8+XOF)+":"+Str$(LY-16),VER$
            OLY=LY : OLX=LX
         End If 
      Else If OLY>-1
         _wnd Id Titles Catalog String$(530,"Set Object Frames"),VER$
         OLY=-1
      End If 
      If EV=$40 : C=GA : Else : C=-1 : End If 
      If C=11
         CF=Max(CF-1,0)
         Gosub FRAMEDISPLAY
      Else If C=12
         CF=Min(63,CF+1)
         Gosub FRAMEDISPLAY
      Else If C=13 and XOF>0
         Add XOF,-160
         Gosub WIDTHSHOW
      Else If C=14 and XOF<WOF-160
         Add XOF,160
         Gosub WIDTHSHOW
      Else If C=21
         Doke LINK+$39B0+NR*256+CF*8,_gt What Integer(C) and $FFFF
         Gosub FRAMEDISPLAY
      Else If C=22
         Doke LINK+$39B0+NR*256+CF*8+2,_gt What Integer(C) and $FFFF
         Gosub FRAMEDISPLAY
      Else If C=23
         Doke LINK+$39B0+NR*256+CF*8+4,(_gt What Integer(C) and $FFFE)/2
         Gosub FRAMEDISPLAY
      Else If C=24
         Doke LINK+$39B0+NR*256+CF*8+6,(_gt What Integer(C) and $FFFE)/2
         Gosub FRAMEDISPLAY
      Else If C=4 and CF>0
         For A=0 To CF-1
            Doke LINK+$39B0+NR*256+A*8+4,Deek(LINK+$39B0+NR*256+CF*8+4)
         Next 
      Else If C=5 and CF>0
         For A=0 To CF-1
            Doke LINK+$39B0+NR*256+A*8+6,Deek(LINK+$39B0+NR*256+CF*8+6)
         Next 
      Else If C=6 and CF<63
         For A=CF+1 To 63
            Doke LINK+$39B0+NR*256+A*8+4,Deek(LINK+$39B0+NR*256+CF*8+4)
         Next 
      Else If C=7 and CF<63
         For A=CF+1 To 63
            Doke LINK+$39B0+NR*256+A*8+6,Deek(LINK+$39B0+NR*256+CF*8+6)
         Next 
      Else If C=8
         Gosub AFRAME
         If HOFF>0 and WOFF>0 and NOFF>0
            For A=0 To NOFF-1
               Doke LINK+$39B0+NR*256+A*8,A*WOFF
               Doke LINK+$39B0+NR*256+A*8+2,0
               Doke LINK+$39B0+NR*256+A*8+4,WOFF/2
               Doke LINK+$39B0+NR*256+A*8+6,HOFF/2
            Next 
            Gosub FRAMEDISPLAY
         End If 
      End If 
      If EV=$400
         If KY=95 : _SHOW_AG["M0201"] : End If 
      End If 
      Multi Wait 
   Until EV=$200
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497
   _scr Id Close 2
   _scr Id Use 1
   _scr Id Show 1
Pop Proc
FRAMEDISPLAY:
   _gt Set Text 1,Catalog String$(536,"Frame Number:")+Str$(CF),,,
   _gt Set Integer 21,Deek(LINK+$39B0+NR*256+CF*8)
   _gt Set Integer 22,Deek(LINK+$39B0+NR*256+CF*8+2)
   _gt Set Integer 23,Deek(LINK+$39B0+NR*256+CF*8+4)*2
   _gt Set Integer 24,Deek(LINK+$39B0+NR*256+CF*8+6)*2
Return 
WIDTHSHOW:
   _wnd Id Ink 0,0,0
   W=_wnd Id Width-16
   _wnd Id Bar 8,16 To W+8,128+16
   For WAA=0 To W
      WA=WAA+XOF
      If WA<WOF
         OF=Leek(Start(401)+WA*4)
         If OF>=$2000000 : SS=2
         Else If OF>=$1000000 : SS=1
         Else : SS=0
         End If 
         OF=OF and $FFFFFF
         AP=Start(402)+OF
         For WB=0 To Min(128,HOF)-1
            C=Deek(AP) : Add AP,2
            If SS=0 : _wnd Id Ink C(C mod 32),0,0 : End If 
            If SS=1 : _wnd Id Ink C((C/32) mod 32),0,0 : End If 
            If SS=2 : _wnd Id Ink C((C/1024) mod 32),0,0 : End If 
            _wnd Id Plot WAA+8,WB+16
         Next WB
      End If 
   Next WAA
Return 
AFRAME:
   Reserve As Gt Gadgets 498,10,2
   _gt Set Integer Mode 1,6,1,0

   _gt Text 7,8,14,196,12,,"",Catalog String$(505,"Number of frames:"),0
   _gt Text 8,8,28,196,12,,"",Catalog String$(506,"Width of each frame:"),0
   _gt Text 9,8,42,196,12,,"",Catalog String$(507,"Height of each frame:"),0
   _gt Integer 1,204,14,64,12,0,"",NOFF,1
   _gt Integer 2,204,28,64,12,0,"",WOFF,1
   _gt Integer 3,204,42,64,12,0,"",HOFF,1
   _gt Button 4,204,56,64,12,,"OK"

   _wnd Id Open 2,40,20,268,60,$2+$8,F_IDCMP,498,".."
   _wnd Id Titles Catalog String$(535,"Generate frames from graphic data"),VER$
   Do 
      EV=_wnd Id Next Event
      GA=_wnd Id Event Gadget
      If EV=$40 and GA=4 and _wnd Id Event Wnd=2 : Exit : End If 
      If EV=$200 and _wnd Id Event Wnd=2 : Exit : End If 
      Multi Wait 
   Loop 
   NOFF=_gt What Integer(1)
   WOFF=_gt What Integer(2)
   HOFF=_gt What Integer(3)
   _gt Gadgets Remove 498
   _wnd Id Close 2
   _gt Gadgets Erase 498
Return 
End Proc
Procedure _GL_SETVEC
   Dim W1$(29)
   _wnd Id Open 8,0,20,_scr Id Width(1),188,$2+$8,F_IDCMP,0,"Levels.."

   '  
   ' Set title of window, and the screen title when window is active
   '
   _wnd Id Titles Catalog String$(570,"Vector FileNames"),VER$
   _wnd Id Activate 8

   Reserve As Gt Gadgets 497,30,1

   '
   ' Preparing string gadgets 
   ' Tabcycle=True, MaxChars=80, ExitHelp=True, Replacemode=False 
   '  
   _gt Set String Mode True,80,True,False
   _gt Set Listview Mode ,,,16,0,
   _gt Listview 1,32,32,592,144,,"",Array(W1$(0)),0

   _gt Gadgets Attach 497

   Do 
      For A=0 To 29
         W1$(A)=Peek$(LINK+$13FE0+A*64,64,Chr$(0))
      Next A
      _gt Set Listview 1,Array(W1$(0)),,,
      Do 
         EV=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %111
         KY=_wnd Id Event Code
         If EV=$400
            If KY=95 : _SHOW_AG["M0301"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If EV=$40
            If GA=1
               R=KY
               _S_FILE[0,Catalog String$(571,"Select Vector-graphic"),"AB3:Vectobj/","",""]
               F$=Param$
               If F$<>"" and Exist(F$)
                  If File Type(F$)<0
                     Poke$ LINK+$13FE0+R*64,Left$(F$+String$(Chr$(0),64),64)
                  End If 
               End If 
               Exit 
            End If 
         End If 
         If EV=$200 : Exit 2 : End If 
         Multi Wait 
      Loop 
   Loop 
   _gt Gadgets Remove 497
   '
   ' Close down window, screen and erase gadgets from memory..
   '
   _wnd Id Close 8
   _gt Gadgets Erase 497
End Proc
Procedure _GL_SETBULLET
   Dim W$(19),W1$(1),W2$(1),W3$(2),W4$(5)
   Do 
      For A=0 To 19
         W$(A)=Peek$(LINK+$3230+A*20,20,Chr$(0))
      Next A
      Reserve As Gt Gadgets 497,5,1
      _gt Set Mode 0,"",0,1
      _gt Set Listview Mode ,,,16,0,
      _gt Set Integer Mode 1,6,1,0

      _gt Listview 1,8,12,_scr Id Width(1)-16,128,,"",Array(W$(0)),0

      _wnd Id Open 8,0,128,_scr Id Width(1),130,$2+$8,F_IDCMP,0,""
      _gt Gadgets Attach 497
      _wnd Id Titles Catalog String$(600,"Set Bullets"),VER$

      Do 
         AC=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %11111
         KY=_wnd Id Event Code
         If AC=$400
            If KY=95 : _SHOW_AG["M0501"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If AC=$40
            If GA=1 : BULNUM=KY : Exit : End If 
         End If 
         Exit If AC=$200
         Multi Wait 
      Loop 
      _gt Gadgets Remove 497
      _gt Gadgets Erase 497
      _wnd Id Close 8
      Exit If AC=$200
      Gosub CHANGEBULLETSTATS
   Loop 
Pop Proc
CHANGEBULLETSTATS:
   W1$(0)=Catalog String$(2,"NO")
   W1$(1)=Catalog String$(1,"YES")
   W2$(0)=Catalog String$(608,"INSTANT")
   W2$(1)=Catalog String$(607,"VISIBLE")
   W3$(0)=Catalog String$(20,"Bitmap")
   W3$(1)=Catalog String$(21,"Glare")
   W3$(2)=Catalog String$(22,"Additive Transparency")
   W4$(0)="0" : W4$(1)="1" : W4$(2)="2"
   W4$(3)="3" : W4$(4)="4" : W4$(5)="5"

   Do 
      Reserve As Gt Gadgets 497,60,1
      _gt Set Mode 0,"",0,1
      _gt Set Listview Mode ,,,16,0,
      _gt Set Integer Mode 1,6,1,0
      _gt Set String Mode 1,20,1,0

      _gt String 34,336,14,208,12,0,"","-",1

      _gt Text 41,8,28,328,12,,"",Catalog String$(601,"Damage to target pr. bullet:"),0
      _gt Integer 30,336,28,208,12,0,"",1256,1

      _gt Text 42,8,42,328,12,,"",Catalog String$(606,"Visible bullet or instant effect:"),0
      _gt Cycle 1,336,42,208,12,0,"",Array(W2$(0)),0

      _gt Text 43,8,56,328,12,,"",Catalog String$(602,"Gravity:"),0
      _gt Integer 31,336,56,208,12,0,"",1256,1

      _gt Text 44,8,70,328,12,,"",Catalog String$(609,"Bounce Off Walls:"),0
      _gt Cycle 2,336,70,208,12,0,"",Array(W1$(0)),0

      _gt Text 45,8,84,328,12,,"",Catalog String$(610,"Bounce Off Roofs/Floors:"),0
      _gt Cycle 3,336,84,208,12,0,"",Array(W1$(0)),0

      _gt Text 46,8,98,328,12,,"",Catalog String$(603,"Bullet Lifetime (-1=Infinite):"),0
      _gt Integer 32,336,98,208,12,0,"",1256,1

      _gt Text 47,8,112,328,12,,"",Catalog String$(604,"Explosive force:"),0
      _gt Integer 33,336,112,208,12,0,"",1256,1

      _gt Text 48,8,126,328,12,,"",Catalog String$(611,"Movement speed:"),0
      _gt Cycle 4,336,126,208,12,0,"",Array(W4$(0)),0

      _gt Text 49,8,140,328,12,,"",Catalog String$(612,"Impact noise:"),0
      _gt Text 50,336,140,192,12,,"","-",1
      _gt Image 5,528,140,1,GAD16(0),GAD16(1)

      _gt Text 51,8,154,328,12,,"",Catalog String$(613,"Bullet Graphic Type:"),0
      _gt Cycle 6,336,154,208,12,0,"",Array(W3$(0)),0

      _gt Text 52,8,168,328,12,,"",Catalog String$(614,"Impact Graphic Type:"),0
      _gt Cycle 7,336,168,208,12,0,"",Array(W3$(0)),0

      _gt Button 10,8,200,268,12,,Catalog String$(2200,"Define Bullet Animation")
      _gt Button 11,276,200,268,12,,Catalog String$(2201,"Define Bullet Impact Animation")
      _gt Button 59,8,212,536,12,,Catalog String$(2202,"Import Bullet Data")

      _wnd Id Open 8,0,128,544,216,$2+$8,F_IDCMP,497,""
      _wnd Id Titles Catalog String$(605,"Bullet statistics for:"),VER$

      BAS=LINK+$1AC0+BULNUM*300
      Do 
         _gt Gadgets Bank 497
         _gt Set Integer 30,Leek(BAS+6*4)
         _gt Set Cycle 1,,Leek(BAS)=0
         _gt Set Integer 31,Leek(BAS+4)
         _gt Set Cycle 2,,Leek(BAS+4*4)
         _gt Set Cycle 3,,Leek(BAS+5*4)
         _gt Set Integer 32,Leek(BAS+2*4)
         _gt Set Integer 33,Leek(BAS+7*4)
         _gt Set Cycle 4,,Leek(BAS+8*4)
         If Leek(BAS+12*4)=0 : _gt Set Text 50,Catalog String$(15,"<NONE>"),,,
         Else _gt Set Text 50,Dr File$(Peek$(LINK+$A40+(Leek(BAS+12*4)-1)*64,64,Chr$(0))),,,
         End If 
         _gt Set Cycle 6,,Leek(BAS+13*4)
         _gt Set Cycle 7,,Leek(BAS+14*4)
         _gt Set String 34,Right Trim$(Peek$(LINK+$3230+BULNUM*20,20,Chr$(0)))
         Do 
            AC=_wnd Id Next Event
            GA=_wnd Id Event Gadget
            KS=_wnd Id Event Qualifier and %11111
            KY=_wnd Id Event Code
            If EV=$400
               If KY=95 : _SHOW_AG["M0501"] : End If 
            End If 
            If _wnd Id Event Wnd<>8 : AC=0 : End If 
            If AC=$40
               If GA=1 : D=Leek(BAS) : Add D,1,0 To 1 : Loke BAS,D : Exit 
               Else If GA=2 : D=Leek(BAS+4*4) : Add D,1,0 To 1 : Loke BAS+4*4,D : Exit 
               Else If GA=3 : D=Leek(BAS+5*4) : Add D,1,0 To 1 : Loke BAS+5*4,D : Exit 
               Else If GA=4 : D=Leek(BAS+8*4) : Add D,1,0 To 5 : Loke BAS+8*4,D : Exit 
               Else If GA=5 : _SELSFX[1,""] : Loke(BAS+12*4),Param : Exit 
               Else If GA=6 : D=Leek(BAS+13*4) : Add D,1,0 To 2 : Loke BAS+13*4,D : Exit 
               Else If GA=7 : D=Leek(BAS+14*4) : Add D,1,0 To 2 : Loke BAS+14*4,D : Exit 
               Else If GA=10 : ANBAS=BAS+60 : PON=0 : Exit 2
               Else If GA=11 : ANBAS=BAS+60+120 : PON=1 : Exit 2
               Else If GA=30 : Loke BAS+6*4,_gt What Integer(C) : Exit 
               Else If GA=31 : Loke BAS+4,_gt What Integer(C) : Exit 
               Else If GA=32 : Loke BAS+2*4,_gt What Integer(C) : Exit 
               Else If GA=33 : Loke BAS+7*4,_gt What Integer(C) : Exit 
               Else If GA=34 : Poke$ LINK+$3230+BULNUM*20,Left$(_gt What String(C)+Space$(20),20) : Exit 
               Else If GA=59 : Exit 2
               End If 
            End If 
            Exit If AC=$200,2
            Multi Wait 
         Loop 
      Loop 
      _gt Gadgets Remove 497
      _gt Gadgets Erase 497
      _wnd Id Close 8
      Exit If AC=$200
      If GA=10 or GA=11 : Gosub BULANIM : End If 
      If GA=59 : Gosub BUIMP : End If 
   Loop 
Return 
BUIMP:
   '
   ' Import Bullet-data's 
   '
   _S_FILE[0,Catalog String$(250,"Load Linkfile"),"ab3:includes","#?.lnk","test.lnk"]
   F$=Param$
   If Exist(F$) and F$<>""
      Erase 401
      _LOAD[401,F$]
      If Length(401)=86268
         _SELBUL2[1,Start(401),""]
         N=Param
         If N>0
            CO=N-1 : L2=Start(401)
            S=L2+$3230+CO*20 : D=LINK+$3230+BULNUM*20
            Copy S,S+20 To D
            S=L2+$1AC0+CO*300 : D=LINK+$1AC0+BULNUM*300
            Copy S,S+300 To D
         End If 
      End If 
   End If 
   Erase 401
Return 
BULANIM:
   If PON=0
      T$=Catalog String$(615,"Animation frames for")+" "+Peek$(LINK+$3230+BULNUM*20,20,Chr$(0))
   Else 
      T$=Catalog String$(616,"Impact frames for")+" "+Peek$(LINK+$3230+BULNUM*20,20,Chr$(0))
   End If 
   _GL_SET_ANIM[ANBAS,1,T$,BAS+(9+PON)*4]
Return 
End Proc
Procedure _GL_SETGUN
   Dim W$(9)
   Do 
      Reserve As Gt Gadgets 497,60,1
      _gt Set Mode 0,"",0,1
      _gt Set Listview Mode ,,,16,0,
      _gt Set Integer Mode 1,6,1,0
      _gt Set String Mode 1,20,1,0

      _gt Listview 32,8,12,_scr Id Width(1)-16,88,,"",Array(W$(0)),0

      _gt Text 41,64,110,328,12,,"",Catalog String$(620,"Gun Name:"),0
      _gt String 1,392,110,208,12,0,"","-",1

      _gt Text 42,64,124,328,12,,"",Catalog String$(621,"Bullets:"),0
      _gt Text 43,392,124,192,12,,"","-",1
      _gt Image 2,584,124,1,GAD16(0),GAD16(1)

      _gt Text 44,64,138,328,12,,"",Catalog String$(622,"Bullets Fired at shot:"),0
      _gt Integer 3,392,138,208,12,0,"",1234,1

      _gt Text 45,64,152,328,12,,"",Catalog String$(623,"Delay between shots:"),0
      _gt Integer 4,392,152,208,12,0,"",1234,1

      _gt Text 46,64,166,328,12,,"",Catalog String$(624,"Gun Sound:"),0
      _gt Text 47,392,166,192,12,,"","-",1
      _gt Image 5,584,166,1,GAD16(0),GAD16(1)

      _gt Text 48,64,180,328,12,,"",Catalog String$(625,"Graphic Appearence (Object):"),0
      _gt Text 49,392,180,192,12,,"","-",1
      _gt Image 6,584,180,1,GAD16(0),GAD16(1)

      _wnd Id Open 8,0,128,_scr Id Width(1),190,$2+$8,F_IDCMP,497,""
      _wnd Id Titles Catalog String$(626,"Gun Types"),VER$

      R=0 : GB1=LINK+$33C0 : GB2=LINK+$3488
      Do 
         _gt Gadgets Bank 497
         For A=0 To 9
            W$(A)=""
            W$(A)=W$(A)+Left$(Peek$(GB1+A*20,20,Chr$(0))+Space$(20),20)+" "
            W$(A)=W$(A)+Left$(Peek$(LINK+$3230+Deek(GB2+A*8)*20,20,Chr$(0))+Space$(20),16)+" "
            W$(A)=W$(A)+Right$("0000"+Str$(Deek(GB2+A*8+4))-" ",4)+" "
            W$(A)=W$(A)+Right$("0000"+Str$(Deek(GB2+A*8+2))-" ",4)+" "
            W$(A)=W$(A)+Left$(Dr File$(Peek$(LINK+$A40+Deek(GB2+A*8+6)*64,64,Chr$(0)))+Space$(20),16)+" "
            W$(A)=W$(A)+Peek$(LINK+$57B0+Deek(LINK+$14BA8+A*2)*20,20,Chr$(0))
         Next A
         _gt Set Listview 32,Array(W$(0)),R,,
         _gt Set String 1,Peek$(GB1+R*20,20,Chr$(0))
         _gt Set Text 43,Peek$(LINK+$3230+Deek(GB2+R*8)*20,20,Chr$(0)),,,
         _gt Set Integer 3,Deek(GB2+R*8+4)
         _gt Set Integer 4,Deek(GB2+R*8+2)
         _gt Set Text 47,Dr File$(Peek$(LINK+$A40+Deek(GB2+R*8+6)*64,64,Chr$(0))),,,
         _gt Set Text 49,Peek$(LINK+$57B0+Deek(LINK+$14BA8+R*2)*20,20,Chr$(0)),,,
         Do 
            AC=_wnd Id Next Event
            GA=_wnd Id Event Gadget
            KS=_wnd Id Event Qualifier and %11111
            KY=_wnd Id Event Code
            If AC=$400
               If KY=95 : _SHOW_AG["M0601"] : End If 
            End If 
            If _wnd Id Event Wnd<>8 : AC=0 : End If 
            If AC=$40
               If GA=32 : R=KY : Exit 
               Else If GA=1 : Poke$ GB1+R*20,Left$(_gt What String(1)+String$(Chr$(0),20),20) : Exit 
               Else If GA=2 : _SELBUL[0,""] : Doke GB2+R*8,Param : Exit 
               Else If GA=3 : Doke GB2+R*8+4,_gt What Integer(3) : Exit 
               Else If GA=4 : Doke GB2+R*8+2,_gt What Integer(4) : Exit 
               Else If GA=5 : _SELSFX[0,""] : Doke GB2+R*8+6,Param : Exit 
               Else If GA=6 : _SELOBJ[0,""] : Doke LINK+$14BA8+R*2,Param : Exit 
               End If 
            End If 
            Exit If AC=$200,3
            Multi Wait 
         Loop 
      Loop 
   Loop 
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497
End Proc
Procedure _GL_SETALIEN
   Dim W$(19),AL(20),GFX$(5),DEFB$(1),RESB$(5),FOLB$(4),RETB$(2),ANM(20,10),W1$(1),W2$(2),W3$(1)
   GFX$(0)=Catalog String$(20,"Bitmap") : GFX$(1)=Catalog String$(23,"Vector") : GFX$(2)=Catalog String$(24,"Lightsourced palette 1")
   GFX$(3)=Catalog String$(25,"Lightsourced palette 2") : GFX$(4)=Catalog String$(26,"Lightsourced palette 3") : GFX$(5)=Catalog String$(27,"Lightsourced palette 4")
   DEFB$(0)=Catalog String$(630,"Prowl Randomly") : DEFB$(1)=Catalog String$(631,"Fly Randomly")
   RESB$(0)=Catalog String$(632,"Charge") : RESB$(1)=Catalog String$(633,"Charge To Side") : RESB$(2)=Catalog String$(634,"Attack with Gun")
   RESB$(3)=Catalog String$(635,"Charge (Flying)") : RESB$(4)=Catalog String$(636,"Charge To Side (Flying)") : RESB$(5)=Catalog String$(637,"Attack with Gun (Flying)")
   FOLB$(0)=Catalog String$(638,"Pause") : FOLB$(1)=Catalog String$(639,"Approach") : FOLB$(2)=Catalog String$(640,"Approach To Side") : FOLB$(3)=Catalog String$(641,"Approach (Flying)")
   FOLB$(4)=Catalog String$(642,"Approach To Side (Flying)")
   RETB$(0)=Catalog String$(638,"Pause") : RETB$(1)=Catalog String$(643,"Attack To Side (unarmed)") : RETB$(2)=Catalog String$(644,"Guard Start Control Pt")
   W1$(0)=Catalog String$(670,"Type Of Bullet Fired:") : W1$(1)=Catalog String$(671,"Type Of Alien Spawned:")
   W2$(0)="0" : W2$(1)="1" : W2$(2)="2"
   W3$(0)=Catalog String$(672,"Type Of Bullet Fired at death:") : W3$(1)=Catalog String$(673,"Type Of Alien Spawned at death:")
   Do 
      For A=0 To 19
         W$(A)=Peek$(LINK+$34D8+A*20,20,Chr$(0))
      Next A

      Reserve As Gt Gadgets 497,5,1
      _gt Set Mode 0,"",0,1
      _gt Set Listview Mode ,,,16,0,
      _gt Set Integer Mode 1,6,1,0

      _gt Listview 1,8,12,_scr Id Width(1)-16,128,,"",Array(W$(0)),0

      _wnd Id Open 8,0,128,_scr Id Width(1),130,$2+$8,F_IDCMP,497,""
      _wnd Id Titles Catalog String$(645,"Set Aliens"),VER$

      Do 
         AC=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %11111
         KY=_wnd Id Event Code
         If AC=$400
            If KY=95 : _SHOW_AG["M0701"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If AC=$40
            If GA=1
               ALNUM=KY
               Exit 
            End If 
         End If 
         Exit If AC=$200
         Multi Wait 
      Loop 
      _gt Gadgets Remove 497
      _gt Gadgets Erase 497
      _wnd Id Close 8
      Exit If AC=$200
      Gosub CHANGEALIENSTATS
   Loop 
Pop Proc
CHANGEALIENSTATS:
   If YRES=2
      SET_PAGE=1
   Else 
      SET_PAGE=0
   End If 
   Do 
      Reserve As Gt Gadgets 497,81,1
      _gt Set Mode 0,"",0,1
      _gt Set Listview Mode ,,,16,0,
      _gt Set Integer Mode 1,6,1,0
      _gt Set String Mode 1,20,1,0

      _gt String 27,336,14,272,12,0,"","-",1

      If SET_PAGE=1 or SET_PAGE=0
         _gt Text 41,8,28,328,12,,"",Catalog String$(646,"Graphic Type:"),0
         _gt Cycle 1,336,28,272,12,0,"",Array(GFX$(0)),0

         _gt Text 42,8,42,328,12,,"",Catalog String$(647,"Default Behaviour:"),0
         _gt Cycle 2,336,42,272,12,0,"",Array(DEFB$(0)),0

         _gt Text 43,8,56,328,12,,"",Catalog String$(648,"Reaction Time (50=1sec):"),0
         _gt Integer 3,336,56,272,12,0,"",1256,1

         _gt Text 44,8,70,328,12,,"",Catalog String$(649,"Default movement speed:"),0
         _gt Integer 4,336,70,272,12,0,"",1256,1

         _gt Text 45,8,84,328,12,,"",Catalog String$(650,"Response Behaviour:"),0
         _gt Cycle 5,336,84,272,12,0,"",Array(RESB$(0)),0

         _gt Text 46,8,98,328,12,,"",Catalog String$(651,"Response movement speed:"),0
         _gt Integer 6,336,98,272,12,0,"",1256,1

         _gt Text 47,8,112,328,12,,"",Catalog String$(652,"Response Timeout (50=1sec):"),0
         _gt Integer 7,336,112,272,12,0,"",1256,1

         _gt Text 48,8,126,328,12,,"",Catalog String$(653,"Damage Taken Limit -> Retreat:"),0
         _gt Integer 8,336,126,272,12,0,"",1256,1

         _gt Text 49,8,140,328,12,,"",Catalog String$(654,"Damage Inflicted Limit -> Followup:"),0
         _gt Integer 9,336,140,272,12,0,"",1256,1

         _gt Text 50,8,154,328,12,,"",Catalog String$(655,"Followup Behaviour:"),0
         _gt Cycle 10,336,154,272,12,0,"",Array(FOLB$(0)),0

         _gt Text 51,8,168,328,12,,"",Catalog String$(656,"Followup Movement Speed:"),0
         _gt Integer 11,336,168,272,12,0,"",1256,1

         _gt Text 52,8,182,328,12,,"",Catalog String$(657,"Followup Timeout (50=1sec):"),0
         _gt Integer 12,336,182,272,12,0,"",1256,1
      End If 
      If SET_PAGE=0 : B2=224+14 : Else : B2=42+14+14 : End If 
      If SET_PAGE=2 or SET_PAGE=0
         _gt Text 53,8,B2-42,328,12,,"",Catalog String$(658,"Retreat Behaviour:"),0
         _gt Cycle 13,336,B2-42,272,12,0,"",Array(RETB$(0)),0

         _gt Text 54,8,B2-28,328,12,,"",Catalog String$(659,"Retreat Movement Speed:"),0
         _gt Integer 14,336,B2-28,272,12,0,"",1256,1

         _gt Text 55,8,B2-14,328,12,,"",Catalog String$(660,"Retreat Timeout (50=1sec):"),0
         _gt Integer 15,336,B2-14,272,12,0,"",1256,1

         _gt Cycle 16,8,B2,320,12,0,"",Array(W1$(0)),0
         _gt Text 56,336,B2,256,12,,"","-",1
         _gt Image 17,592,B2,1,GAD16(0),GAD16(1)

         _gt Text 57,8,B2+14,328,12,,"",Catalog String$(661,"Number Of Hit Points:"),0
         _gt Integer 18,336,B2+14,272,12,0,"",1256,1

         _gt Text 58,8,B2+28,328,12,,"",Catalog String$(662,"Physical Height:"),0
         _gt Integer 19,336,B2+28,272,12,0,"",1256,1

         _gt Text 59,8,B2+42,328,12,,"",Catalog String$(663,"Minimum distance to walls (0/1/2):"),0
         _gt Cycle 20,336,B2+42,272,12,0,"",Array(W2$(0)),0

         _gt Cycle 21,8,B2+56,320,12,0,"",Array(W3$(0)),0
         _gt Text 60,336,B2+56,256,12,,"","-",1
         _gt Image 22,592,B2+56,1,GAD16(0),GAD16(1)

         _gt Text 61,8,B2+70,328,12,,"",Catalog String$(664,"Auxilliary Object Type:"),0
         _gt Text 62,336,B2+70,256,12,,"","-",1
         _gt Image 23,592,B2+70,1,GAD16(0),GAD16(1)

         _gt Text 63,8,B2+84,328,12,,"",Catalog String$(665,"Torch Brightness:"),0
         _gt Integer 24,336,B2+84,272,12,0,"",1256,1

         _gt Text 64,8,B2+98,328,12,,"",Catalog String$(666,"Bullet Source X Offset:"),0
         _gt Integer 25,336,B2+98,272,12,0,"",1256,1

         _gt Text 65,8,B2+112,328,12,,"",Catalog String$(667,"Bullet Source Y Offset:"),0
         _gt Integer 26,336,B2+112,272,12,0,"",1256,1
      End If 

      If SET_PAGE=0
         _gt Button 79,8,478,600,12,,Catalog String$(2212,">> Set Animations >>")
         _gt Button 78,8,492,600,12,,Catalog String$(2213,"Import Alien Data")
      Else 
         _gt Button 79,8,216,600,12,,Catalog String$(2212,">> Set Animations >>")
         _gt Button 78,8,244,600,12,,Catalog String$(2213,"Import Alien Data")
      End If 
      If SET_PAGE=1
         _gt Button 80,8,230,600,12,,Catalog String$(2210,">> MORE SETUP >>")
      End If 
      If SET_PAGE=2
         _gt Button 80,8,230,600,12,,Catalog String$(2211,"<< MORE SETUP <<")
      End If 

      If SET_PAGE=0
         _wnd Id Open 8,0,128,608,496,$2+$8,F_IDCMP,497,""
      Else 
         _wnd Id Open 8,0,128,608,248,$2+$8,F_IDCMP,497,""
      End If 

      _wnd Id Titles Catalog String$(668,"Alien statistics for:"),VER$

      BAS1=LINK+$3668+ALNUM*42
      Do 
         _gt Gadgets Bank 497
         For A=0 To 20 : AL(A)=Sdeek(BAS1+A*2) : Next A
         _gt Set String 27,Peek$(LINK+$34D8+ALNUM*20,20,Chr$(0))
         If SET_PAGE=1 or SET_PAGE=0
            _gt Set Cycle 1,,AL(0)
            _gt Set Cycle 2,,AL(1)
            _gt Set Integer 3,AL(2)
            _gt Set Integer 4,AL(3)
            _gt Set Cycle 5,,AL(4)
            _gt Set Integer 6,AL(5)
            _gt Set Integer 7,AL(6)
            _gt Set Integer 8,AL(7)
            _gt Set Integer 9,AL(8)
            _gt Set Cycle 10,,AL(9)
            _gt Set Integer 11,AL(10)
            _gt Set Integer 12,AL(11)
         End If 
         If SET_PAGE=2 or SET_PAGE=0
            _gt Set Cycle 13,,AL(12)
            _gt Set Integer 14,AL(13)
            _gt Set Integer 15,AL(14)
            If AL(15)<20
               _gt Set Cycle 16,,0
               _gt Set Text 56,Peek$(LINK+$3230+AL(15)*20,20,Chr$(0)),,,
            Else 
               _gt Set Cycle 16,,1
               _gt Set Text 56,Peek$(LINK+$34D8+(AL(15)-20)*20,20,Chr$(0)),,,
            End If 
            _gt Set Integer 18,AL(16)*4
            _gt Set Integer 19,AL(17)
            _gt Set Cycle 20,,AL(18)
            If AL(19)<20
               _gt Set Cycle 21,,0
               _gt Set Text 60,Peek$(LINK+$3230+AL(19)*20,20,Chr$(0)),,,
            Else 
               _gt Set Cycle 21,,1
               _gt Set Text 60,Peek$(LINK+$34D8+(AL(19)-20)*20,20,Chr$(0)),,,
            End If 
            If AL(20)>0 : _gt Set Text 62,Peek$(LINK+$57B0+(AL(20))*20,20,Chr$(0)),,,
            Else : _gt Set Text 62,Catalog String$(15,"<None>"),,,
            End If 
            _gt Set Integer 24,Deek(LINK+$14B80+ALNUM*2)
            _gt Set Integer 25,Leek(LINK+$14C00+ALNUM*8+4)
            _gt Set Integer 26,Leek(LINK+$14C00+ALNUM*8)
         End If 
         Do 
            AC=_wnd Id Next Event
            GA=_wnd Id Event Gadget
            KS=_wnd Id Event Qualifier and %11111
            KY=_wnd Id Event Code
            If AC=$400
               If KY=95 : _SHOW_AG["M0701"] : End If 
            End If 
            If _wnd Id Event Wnd<>8 : AC=0 : End If 
            If AC=$40
               If GA=1 : Add AL(0),1,0 To 5 : Doke BAS1,AL(0) : Exit 
               Else If GA=2 : Add AL(1),1,0 To 1 : Doke BAS1+2,AL(1) : Exit 
               Else If GA=3 : Doke BAS1+2*2,_gt What Integer(3) : Exit 
               Else If GA=4 : Doke BAS1+3*2,_gt What Integer(4) : Exit 
               Else If GA=5 : Add AL(4),1,0 To 5 : Doke BAS1+4*2,AL(4) : Exit 
               Else If GA=6 : Doke BAS1+5*2,_gt What Integer(6) : Exit 
               Else If GA=7 : Doke BAS1+6*2,_gt What Integer(7) : Exit 
               Else If GA=8 : Doke BAS1+7*2,_gt What Integer(8) : Exit 
               Else If GA=9 : Doke BAS1+8*2,_gt What Integer(9) : Exit 
               Else If GA=10 : Add AL(9),1,0 To 4 : Doke BAS1+9*2,AL(9) : Exit 
               Else If GA=11 : Doke BAS1+10*2,_gt What Integer(11) : Exit 
               Else If GA=12 : Doke BAS1+11*2,_gt What Integer(12) : Exit 
               Else If GA=13 : Add AL(12),1,0 To 2 : Doke BAS1+12*2,AL(12) : Exit 
               Else If GA=14 : Doke BAS1+13*2,_gt What Integer(14) : Exit 
               Else If GA=15 : Doke BAS1+14*2,_gt What Integer(15) : Exit 
               Else If GA=16
                  If AL(15)<20 : Doke BAS1+15*2,AL(15)+20
                  Else : Doke BAS1+15*2,AL(15)-20
                  End If : Exit 
               Else If GA=17
                  If AL(15)<20 : _SELBUL[0,""] : Doke BAS1+15*2,Param
                  Else : _SELALI[0,""] : Doke BAS1+15*2,Param+20
                  End If : Exit 
               Else If GA=18 : Doke BAS1+16*2,_gt What Integer(18)/4 : Exit 
               Else If GA=19 : Doke BAS1+17*2,_gt What Integer(19) : Exit 
               Else If GA=20 : Add AL(18),1,0 To 2 : Doke BAS1+18*2,AL(18) : Exit 
               Else If GA=21
                  If AL(19)<20 : Doke BAS1+19*2,AL(19)+20
                  Else : Doke BAS1+19*2,AL(19)-20
                  End If : Exit 
               Else If GA=22
                  If AL(19)<20 : _SELBUL[0,""] : Doke BAS1+19*2,Param
                  Else : _SELALI[0,""] : Doke BAS1+19*2,Param+20
                  End If : Exit 
               Else If GA=23 : _SELOBJ[1,""] : Doke BAS1+20*2,Param-1 : Exit 
               Else If GA=24 : Doke LINK+$14B80+ALNUM*2,_gt What Integer(24) : Exit 
               Else If GA=25 : Loke LINK+$14C00+ALNUM*8+4,_gt What Integer(25) : Exit 
               Else If GA=26 : Loke LINK+$14C00+ALNUM*8,_gt What Integer(26) : Exit 
               Else If GA=27 : Poke$ LINK+$34D8+ALNUM*20,Left$(_gt What String(27)+Space$(20),20) : Exit 
               End If 
               Exit If GA=78,2
               Exit If GA=79,2
               If GA=80
                  If SET_PAGE=1 : SET_PAGE=2
                  Else If SET_PAGE=2 : SET_PAGE=1
                  End If 
                  Exit 2
               End If 
            End If 
            Exit If AC=$200,2
            Multi Wait 
         Loop 
      Loop 
      _gt Gadgets Remove 497
      _gt Gadgets Erase 497
      _wnd Id Close 8
      Exit If AC=$200
      If GA=79
         Gosub ALIANIM
      Else If GA=78
         Gosub ALIMP
      End If 
   Loop 
Return 
ALIMP:
   '
   ' Get link phile-data
   '
   _S_FILE[0,Catalog String$(250,"Load Linkfile"),"ab3:includes","#?.lnk","test.lnk"]
   F$=Param$
   If Exist(F$) and F$<>""
      Erase 401
      _LOAD[401,F$]
      If Length(401)=86268
         _SELALI2[1,Start(401),""]
         N=Param
         If N>0
            CO=N-1 : L2=Start(401)
            S=L2+$3668+CO*42 : D=LINK+$3668+ALNUM*42
            Copy S,S+42 To D
            S=L2+$82D0+CO*2420 : D=LINK+$82D0+ALNUM*2420
            Copy S,S+2420 To D
            S=L2+$34D8+CO*20 : D=LINK+$34D8+ALNUM*20
            Copy S,S+20 To D
            Doke LINK+$14B80+ALNUM*2,Deek(L2+$14B80+CO*2)
            Loke LINK+$14C00+ALNUM*8+4,Leek(L2+$14C00+CO*8+4)
            Loke LINK+$14C00+ALNUM*8,Leek(L2+$14C00+CO*8)
         End If 
      End If 
   End If 
   Erase 401
Return 
ALIANIM:
   Do 
      Reserve As Gt Gadgets 497,60,1
      _gt Set Mode 0,"",0,1

      _gt Button 1,8,14,536,12,,Catalog String$(2220,"Front Facing Movement")
      If AL(0)<>1
         _gt Button 2,8,28,536,12,,Catalog String$(2221,"Front-Right Facing Movement")
         _gt Button 3,8,42,536,12,,Catalog String$(2222,"Right Facing Movement")
         _gt Button 4,8,56,536,12,,Catalog String$(2223,"Back-Right Facing Movement")
         _gt Button 5,8,70,536,12,,Catalog String$(2224,"Back Facing Movement")
         _gt Button 6,8,84,536,12,,Catalog String$(2225,"Back-Left Facing Movement")
         _gt Button 7,8,98,536,12,,Catalog String$(2226,"Left-Facing Movement")
         _gt Button 8,8,112,536,12,,Catalog String$(2227,"Front-Left Facing Movement")
      End If 
      _gt Button 9,8,126,536,12,,Catalog String$(2228,"Attacking Action")
      _gt Button 10,8,140,536,12,,Catalog String$(2229,"Recieving Damage Action")
      _gt Button 11,8,154,536,12,,Catalog String$(2230,"Dying Action")

      _wnd Id Open 8,0,128,544,158,$2+$8,F_IDCMP,497,""
      _wnd Id Titles Catalog String$(2214,"Animation to Edit for:")+" "+Peek$(LINK+$34D8+ALNUM*20,20,Chr$(0)),VER$
      Do 
         AC=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %11111
         KY=_wnd Id Event Code
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If AC=$40
            If Between(0,GA,12)
               Exit 
            End If 
         End If 
         Exit If AC=$200
         Multi Wait 
      Loop 
      _gt Gadgets Remove 497
      _gt Gadgets Erase 497
      _wnd Id Close 8
      Exit If AC=$200

      If AL(0)<>1
         ANBAS=LINK+$82D0+ALNUM*2420+(GA-1)*220
         _GL_SET_ANIM[ANBAS,2,Catalog String$(676,"Edit VectorAnimation"),AL(20)]
      Else 
         ANBAS=LINK+$82D0+ALNUM*2420+(GA-1)*220
         _GL_SET_ANIM[ANBAS,-2,Catalog String$(680,"Edit Animation"),AL(20)]
      End If 
   Loop 
Return 
End Proc
Procedure _GL_SETOBJECT
   Dim W$(29),OB(20),AN(20,5),W1$(3),W2$(2),W3$(1),W4$(1)
   W1$(0)=Catalog String$(716,"Collectable") : W1$(1)=Catalog String$(719,"Activatable")
   W1$(2)=Catalog String$(721,"Destructable") : W1$(3)=Catalog String$(723,"Decoration")
   W2$(0)=Catalog String$(20,"Bitmap") : W2$(1)=Catalog String$(28,"Polygon")
   W2$(2)=Catalog String$(29,"Glare/Smoke")
   W3$(0)=Catalog String$(2,"No") : W3$(1)=Catalog String$(1,"Yes")
   W4$(0)=Catalog String$(14,"FLOOR")
   W4$(1)=Catalog String$(13,"Roof")

   Do 
      For A=0 To 29
         W$(A)=Peek$(LINK+$57B0+A*20,20,Chr$(0))
      Next A

      Reserve As Gt Gadgets 497,5,1
      _gt Set Mode 0,"",0,1
      _gt Set Listview Mode ,,,16,0,
      _gt Set Integer Mode 1,6,1,0

      _gt Listview 1,8,12,_scr Id Width(1)-16,128,,"",Array(W$(0)),0

      _wnd Id Open 8,0,128,_scr Id Width(1),130,$2+$8,F_IDCMP,497,""
      _wnd Id Titles Catalog String$(700,"Set Objects"),VER$

      Do 
         AC=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %11111
         KY=_wnd Id Event Code
         If AC=$400
            If KY=95 : _SHOW_AG["M0801"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If AC=$40
            If GA=1 : OBNUM=KY : Exit : End If 
         End If 
         Exit If AC=$200
         Multi Wait 
      Loop 
      _gt Gadgets Remove 497
      _wnd Id Close 8
      _gt Gadgets Erase 497
      Exit If AC=$200
      Gosub CHANGEOBJSTATS
   Loop 
Pop Proc
CHANGEOBJSTATS:
   Do 
      Reserve As Gt Gadgets 497,81,1
      _gt Set Mode 0,"",0,1
      _gt Set Listview Mode ,,,16,0,
      _gt Set Integer Mode 1,6,1,0
      _gt Set String Mode 1,20,1,0

      _gt String 13,336,14,272,12,0,"","-",1

      _gt Text 41,8,28,328,12,,"",Catalog String$(701,"Behaviour of object:"),0
      _gt Cycle 1,336,28,272,12,0,"",Array(W1$(0)),0

      _gt Text 42,8,42,328,12,,"",Catalog String$(702,"Graphic type:"),0
      _gt Cycle 2,336,42,272,12,0,"",Array(W2$(0)),0

      _gt Text 43,8,56,328,12,,"",Catalog String$(703,"Deactivate after (50ths/sec, -1=Never):"),0
      _gt Integer 3,336,56,272,12,0,"",1256,1

      _gt Text 44,8,70,328,12,,"",Catalog String$(704,"Number of hit points:"),0
      _gt Integer 4,336,70,272,12,0,"",1256,1

      _gt Text 45,8,84,328,12,,"",Catalog String$(705,"Explosive potential:"),0
      _gt Integer 5,336,84,272,12,0,"",1256,1

      _gt Text 46,8,98,328,12,,"",Catalog String$(706,"Impassable in default state:"),0
      _gt Cycle 6,336,98,272,12,0,"",Array(W3$(0)),0

      _gt Text 47,8,112,328,12,,"",Catalog String$(707,"Collision cylinder radius:"),0
      _gt Integer 7,336,112,272,12,0,"",1256,1

      _gt Text 48,8,126,328,12,,"",Catalog String$(708,"Collision cylinder height:"),0
      _gt Integer 8,336,126,272,12,0,"",1256,1

      _gt Text 49,8,140,328,12,,"",Catalog String$(709,"Position vertically relative to:"),0
      _gt Cycle 9,336,140,272,12,0,"",Array(W4$(0)),0

      _gt Text 50,8,154,328,12,,"",Catalog String$(710,"Lock to nearest wall:"),0
      _gt Cycle 10,336,154,272,12,0,"",Array(W3$(0)),0

      _gt Text 51,8,168,328,12,,"",Catalog String$(58,"Sound FX:"),0
      _gt Text 52,336,168,256,12,,"","-",1
      _gt Image 11,592,168,1,GAD16(0),GAD16(1)

      _gt Button 26,8,190,600,12,,Catalog String$(712,"Define Gun/Jetpack/Shield given")
      _gt Button 27,8,204,600,12,,Catalog String$(713,"Define Amo/Fuel given")
      _gt Button 28,8,218,600,12,,Catalog String$(714,"Define default state animation")
      _gt Button 29,8,232,600,12,,Catalog String$(715,"Define active/destroyed animation")
      _gt Button 30,8,246,600,12,,Catalog String$(2240,"Import Object Data")

      _wnd Id Open 8,0,128,608,250,$2+$8,F_IDCMP,497,""

      _wnd Id Titles Catalog String$(711,"Object statistics for:"),VER$


      BAS1=LINK+$5A08+OBNUM*40
      Do 
         For A=0 To 19 : OB(A)=Sdeek(BAS1+A*2) : Next A
         _gt Set Cycle 1,,OB(0)
         _gt Set Cycle 2,,OB(1)
         _gt Set Integer 3,OB(2)
         _gt Set Integer 4,OB(3)
         _gt Set Integer 5,OB(4)
         _gt Set Cycle 6,,OB(5)
         _gt Set Integer 7,OB(7)
         _gt Set Integer 8,OB(8)*2
         _gt Set Cycle 9,,OB(9)
         _gt Set Cycle 10,,OB(10)
         If OB(12)<0 : _gt Set Text 52,Catalog String$(15,"<NONE>"),,, : Else : _gt Set Text 52,Left$(Dr File$(Peek$(LINK+$A40+(OB(12))*64,64,Chr$(0))),18),,, : End If 
         _gt Set String 13,Right Trim$(Peek$(LINK+$57B0+OBNUM*20,20,Chr$(0)))
         Do 
            AC=_wnd Id Next Event
            GA=_wnd Id Event Gadget
            KS=_wnd Id Event Qualifier and %11111
            KY=_wnd Id Event Code
            If AC=$400
               If KY=95 : _SHOW_AG["M0801"] : End If 
            End If 
            If _wnd Id Event Wnd<>8 : AC=0 : End If 
            If AC=$40
               If GA=1 : Add OB(0),1,0 To 3 : Doke BAS1,OB(0) : Exit 
               Else If GA=2 : Add OB(1),1,0 To 2 : Doke BAS1+2,OB(1) : Exit 
               Else If GA=3 : Doke BAS1+4,_gt What Integer(3) : Exit 
               Else If GA=4 : Doke BAS1+6,_gt What Integer(4) : Exit 
               Else If GA=5 : Doke BAS1+8,_gt What Integer(5) : Exit 
               Else If GA=6 : Add OB(5),1,0 To 1 : Doke BAS1+10,OB(5) : Exit 
               Else If GA=7 : Doke BAS1+14,_gt What Integer(7) : Exit 
               Else If GA=8 : Doke BAS1+16,_gt What Integer(8)/2 : Exit 
               Else If GA=9 : Add OB(9),1,0 To 1 : Doke BAS1+18,OB(9) : Exit 
               Else If GA=10 : Add OB(10),1,0 To 1 : Doke BAS1+20,OB(10) : Exit 
               Else If GA=12 : _SELSFX[1,""] : Doke BAS1+24,Param-1 : Exit 
               Else If GA=13 : Poke$ LINK+$57B0+OBNUM*20,Left$(_gt What String(13)+Space$(20),20) : Exit 
               Else If GA=26 : Exit 2
               Else If GA=27 : Exit 2
               Else If GA=28
                  ANBAS=LINK+$5EB8+120*OBNUM : BAS2=BAS1+6*2
                  Exit 2
               Else If GA=29
                  ANBAS=LINK+$6CC8+120*OBNUM : BAS2=BAS1+11*2
                  Exit 2
               Else If GA=30 : Exit 2
               End If 
            End If 
            Exit If AC=$200,2
            Multi Wait 
         Loop 
      Loop 
      _gt Gadgets Remove 497
      _gt Gadgets Erase 497
      _wnd Id Close 8
      Exit If AC=$200
      If GA=28 or GA=29
         If OB(1)=1
            _GL_SET_ANIM[ANBAS,-3,Catalog String$(725,"Animation frames for")+" "+Peek$(LINK+$57B0+OBNUM*20,20,Chr$(0)),BAS2]
         Else 
            _GL_SET_ANIM[ANBAS,3,Catalog String$(725,"Animation frames for")+" "+Peek$(LINK+$57B0+OBNUM*20,20,Chr$(0)),BAS2]
         End If 
      Else If GA=30
         Gosub OBIMP
      Else If GA=26
         Gosub OBJGUNGIVE
      Else If GA=27
         Gosub OBJAMOGIVE
      End If 
   Loop 
Return 
OBIMP:
   '
   ' Get link phile-data
   '
   _S_FILE[0,Catalog String$(250,"Load Linkfile"),"ab3:includes","#?.lnk","test.lnk"]
   F$=Param$
   If Exist(F$) and F$<>""
      Erase 401
      _LOAD[401,F$]
      If Length(401)=86268
         _SELOBJ2[1,Start(401),""]
         N=Param
         If N>0
            CO=N-1 : L2=Start(401)
            S=L2+$5A08+CO*40 : D=LINK+$5A08+OBNUM*40
            Copy S,S+40 To D
            S=L2+$5EB8+120*CO : D=LINK+$5EB8+120*OBNUM
            Copy S,S+120 To D
            S=L2+$6CC8+120*CO : D=LINK+$6CC8+120*OBNUM
            Copy S,S+120 To D
            S=L2+$8000+CO*24 : D=LINK+$8000+OBNUM*24
            Copy S,S+24 To D
            S=L2+$7AD8+CO*44 : D=LINK+$7AD8+OBNUM*44
            Copy S,S+44 To D
            S=L2+$57B0+CO*20 : D=LINK+$57B0+OBNUM*20
            Copy S,S+20 To D
         End If 
      End If 
   End If 
Return 
OBJGUNGIVE:
   GBAS=LINK+$8000+OBNUM*24
   Reserve As Gt Gadgets 497,81,1
   _gt Set Mode 0,"",0,1
   _gt Set Listview Mode ,,,16,0,
   _gt Set Integer Mode 1,6,1,0
   _gt Set String Mode 1,20,1,0

   For A=1 To 12
      _gt Text 20+A,8,A*14,328,12,,"","",0
      _gt Cycle A,336,A*14,272,12,0,"",Array(W3$(0)),0
   Next A

   _wnd Id Open 8,0,128,608,172,$2+$8,F_IDCMP,497,""

   _wnd Id Titles Catalog String$(726,"Equipment given by:")+" "+Peek$(LINK+$57B0+OBNUM*20,20,Chr$(0)),VER$

   Do 
      For A=0 To 11
         If A=0 : W$=Catalog String$(727,"Shield:")
         Else If A=1 : W$=Catalog String$(728,"Jetpack:")
         Else : W$=Left$(Peek$(LINK+$33C0+(A-2)*20,20,Chr$(0))+Space$(20),20)
         End If 
         _gt Set Text 21+A,W$,,,
         _gt Set Cycle 1+A,,Deek(GBAS+A*2)
      Next A
      Do 
         AC=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KY=_wnd Id Event Code
         If AC=$400
            If KY=95 : _SHOW_AG["M0801"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If AC=$40 and Between(0,GA,13)
            R=GA-1
            W=Deek(GBAS+R*2) : Add W,1,0 To 1 : Doke GBAS+R*2,W : Exit 
         End If 
         Exit If AC=$200,2
         Multi Wait 
      Loop 
   Loop 
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497
Return 
OBJAMOGIVE:
   Reserve As Gt Gadgets 497,81,1
   _gt Set Mode 0,"",0,1
   _gt Set Listview Mode ,,,16,0,
   _gt Set Integer Mode 1,6,1,0
   _gt Set String Mode 1,20,1,0

   For A=1 To 11
      _gt Text 30+A,8,A*14,232,12,,"","",0
      _gt Integer A,240,A*14,80,12,0,"",1234,1
      _gt Text 41+A,344,A*14,232,12,,"","",0
      _gt Integer 11+A,576,A*14,80,12,0,"",1234,1
   Next A

   _wnd Id Open 8,0,128,-1,158,$2+$8,F_IDCMP,497,""

   _wnd Id Titles Catalog String$(729,"Ammo given by:")+" "+Peek$(LINK+$57B0+OBNUM*20,20,Chr$(0)),VER$

   GBAS=LINK+$7AD8+OBNUM*44
   Do 
      For A=0 To 21
         If A=0 : W$=Catalog String$(730,"Health:")
         Else If A=1 : W$=Catalog String$(731,"Jetpack Fuel:")
         Else : W$=Peek$(LINK+$3230+(A-2)*20,20,Chr$(0))
         End If 
         _gt Set Text 31+A,W$,,,
         _gt Set Integer 1+A,Deek(GBAS+A*2)
      Next A
      Do 
         AC=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KY=_wnd Id Event Code
         If AC=$400
            If KY=95 : _SHOW_AG["M0801"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If AC=$40 and Between(0,GA,23)
            R=GA-1
            Doke GBAS+R*2,_gt What Integer(GA)
            Exit 
         End If 
         Exit If AC=$200,2
         Multi Wait 
      Loop 
   Loop 
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497
Return 
End Proc
Procedure _GL_SETPLAYER
   Reserve As Gt Gadgets 497,60,1
   _gt Set Mode 0,"",0,1
   _gt Set Listview Mode ,,,16,0,
   _gt Set Integer Mode 1,6,1,0
   _gt Set String Mode 1,20,1,0
   
   _gt Text 1,64,14,328,12,,"",Catalog String$(741,"Player 1:"),0
   _gt Text 2,392,14,192,12,,"","-",1
   _gt Image 3,584,14,1,GAD16(0),GAD16(1)
   
   _gt Text 4,64,28,328,12,,"",Catalog String$(742,"Player 2:"),0
   _gt Text 5,392,28,192,12,,"","-",1
   _gt Image 6,584,28,1,GAD16(0),GAD16(1)
   
   _wnd Id Open 8,0,128,_scr Id Width(1),32,$2+$8,F_IDCMP,497,""
   _wnd Id Titles Catalog String$(740,"Players appear as:"),VER$
   
   Do 
      _gt Gadgets Bank 497
      _gt Set Text 2,Peek$(LINK+$34D8+Deek(LINK+84924)*20,20,Chr$(0)),,,
      _gt Set Text 5,Peek$(LINK+$34D8+Deek(LINK+84926)*20,20,Chr$(0)),,,
      Do 
         AC=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KY=_wnd Id Event Code
         If AC=$400
            If KY=95 : _SHOW_AG["M0901"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If AC=$40
            If GA=3 : _SELALI[0,""] : Doke LINK+84924,Param : Exit 
            Else If GA=6 : _SELALI[0,""] : Doke LINK+84926,Param : Exit 
            End If 
         End If 
         Exit If AC=$200,2
         Multi Wait 
      Loop 
   Loop 
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497
End Proc
Procedure _GL_SETFLOORDAM
   If Length(700)<>65536
      _LOAD[700,Peek$(LINK+$1940,64,Chr$(0))]
   End If 

   Reserve As Gt Gadgets 497,60,1
   _gt Set Mode 0,"",0,1
   _gt Set Listview Mode ,,,16,0,
   _gt Set Integer Mode 1,6,1,0
   _gt Set String Mode 1,20,1,0

   _gt Text 1,80,42,328,12,,"",Catalog String$(751,"Floor Footstep sound:"),0
   _gt Text 2,408,42,192,12,,"","-",1
   _gt Image 3,600,42,1,GAD16(0),GAD16(1)

   _gt Text 4,80,56,328,12,,"",Catalog String$(752,"Damage to player:"),0
   _gt Integer 5,408,56,208,12,0,"",1234,1

   _gt Image 30,80,14,1,GAD10(2),GAD10(3)
   _gt Image 31,90,14,1,GAD10(4),GAD10(5)

   _wnd Id Open 8,0,128,_scr Id Width(1),68,$2+$8,F_IDCMP,497,""
   _wnd Id Titles Catalog String$(750,"Set Floor Stats.."),VER$

   NR=0
   Do 
      _wnd Id Use 8
      STQ=1
      If Btst(8,PRE1) : STQ=2 : End If 
      WXO=8 : WYO=14
      S=Start(700)+(NR mod 4)+(NR/4)*256
      _wnd Id Ink 0,0,0 : _wnd Id Bar WXO,WYO To WXO+63,WYO+63/YRES
      For WX=0 To 63 Step STQ
         For WY=0 To 63/YRES Step STQ
            C=CO(Peek(S+WX*4+WY*1024*YRES))
            _wnd Id Ink C,C,C
            _wnd Id Plot WX+WXO,WY+WYO
         Next WY
      Next WX
      Do 
         _gt Gadgets Bank 497
         _gt Set Text 2,Left$(Dr File$(Peek$(LINK+$A40+(Deek(LINK+84928+NR*4+2)-1)*64,64,Chr$(0))),34),,,
         _gt Set Integer 5,Deek(LINK+84928+NR*4)
         Do 
            AC=_wnd Id Next Event
            GA=_wnd Id Event Gadget
            KY=_wnd Id Event Code
            If AC=$400
               If KY=95 : _SHOW_AG["M1001"] : End If 
            End If 
            If _wnd Id Event Wnd<>8 : AC=0 : End If 
            If AC=$40
               If GA=30 and NR>0 : Dec NR : Exit 2 : End If 
               If GA=31 and NR<15 : Inc NR : Exit 2 : End If 
               If GA=3 : _SELSFX[1,""] : Doke LINK+84928+NR*4+2,Param : Exit 
               Else If GA=5 : Doke LINK+84928+NR*4,_gt What Integer(GA) : Exit 
               End If 
            End If 
            Exit If AC=$200,3
            Multi Wait 
         Loop 
      Loop 
   Loop 
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497
End Proc
Procedure _GL_LEVELS

   Dim W1$(15),W2$(15)
   _wnd Id Open 8,0,20,_scr Id Width(1),256,$2+$8,F_IDCMP,0,"Levels.."

   '  
   ' Set title of window, and the screen title when window is active
   '
   _wnd Id Titles Catalog String$(1122,"Levels"),VER$
   _wnd Id Activate 8

   '
   ' Prepare for gadgets
   ' Bank 497 is reserved for 30 gadgets to be used on screen 1 
   '
   Reserve As Gt Gadgets 497,30,1

   '
   ' Preparing string gadgets 
   ' Tabcycle=True, MaxChars=80, ExitHelp=True, Replacemode=False 
   '  
   _gt Set String Mode True,80,True,False
   _gt Set Listview Mode ,,,16,0,

   _gt Bevel Box 2,16,16,624,44,1
   _gt Bevel Box 2,16,64,624,100,1
   _gt Bevel Box 2,16,168,624,88,1
   _gt Text 1,32,20,576,10,,"",Catalog String$(594,"Set Levels Directory"),0
   _gt Text 2,32,32,416,12,,"","",1
   _gt Image 3,448,32,1,GAD16(0),GAD16(1)
   _gt Button 4,464,32,160,12,,Catalog String$(595,"Create Dirs")
   _gt Listview 8,32,80,592,60,,Catalog String$(593,"Set LevelNames"),Array(W1$(0)),0
   _gt String 9,32,140,592,12,,"","",
   _gt Listview 12,32,184,592,64,,Catalog String$(755,"Set Levelmusic (Shift to hear)"),Array(W2$(0)),0
   SELLEV=0

   '
   ' Use gadgets
   '
   _gt Gadgets Attach 497

   Do 
      _gt Gadgets Bank 497
      For A=0 To 15
         W2$(A)=Chr$(65+A)+"- "+Peek$(LINK+85184+A*64,64,Chr$(0))
         W1$(A)=Chr$(A+65)+"- "+Peek$(LINK+$40+A*40,40,Chr$(0))
      Next A
      W$=Peek$(LINK,64,Chr$(0))
      If W$="" : W$="ab3:Levels/" : End If 
      _gt Set Text 2,W$,,,
      _gt Set Listview 8,Array(W1$(0)),,,
      _gt Set Listview 12,Array(W2$(0)),,,
      _gt Set String 9,Peek$(LINK+$40+SELLEV*40,40,Chr$(0))
      Do 
         '
         ' Wait for event 
         '
         EV=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %111
         KY=_wnd Id Event Code
         If EV=$400
            If KY=95 : _SHOW_AG["M0101"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         '
         ' If gadget pushed 
         '
         If EV=$40
            If KY=95 : _SHOW_AG["M0101"] : End If 
            If GA=8 : SELLEV=_wnd Id Event Code : Exit : End If 
            If GA=9 : Poke$ LINK+$40+SELLEV*40,Left$(_gt What String(GA)+Space$(40),40) : Exit : End If 
            If GA=12 and KS=0
               R=_wnd Id Event Code
               _S_FILE[0,Catalog String$(756,"Select BacgroundMusic"),"AB3:Music/","",""]
               F$=Param$
               If F$<>""
                  Poke$ LINK+85184+R*64,Left$(F$+String$(Chr$(0),64),64)
               End If 
               Exit 
            Else If GA=12
               R=_wnd Id Event Code
               _PLAY_TRACK[Peek$(LINK+85184+R*64,64,Chr$(0))]
            End If 
            If GA=3
               _S_FILE[2,Catalog String$(596,"Select LevelsDirectory"),"AB3:","",""]
               F$=Dr Path$(Param$)
               If F$<>"" and Exist(F$)
                  Poke$ LINK,Left$(F$+String$(Chr$(0),64),64)
               End If 
               Exit 
            End If 
            If GA=4 : Gosub MAKEDIRS : End If 
         End If 
         '
         ' If window closed 
         '
         Exit If EV=$200,2
         Multi Wait 
      Loop 
   Loop 
   '
   ' Remove gadgets 
   '
   _gt Gadgets Remove 497
   '
   ' Close down window, screen and erase gadgets from memory..
   '
   _wnd Id Close 8
   _gt Gadgets Erase 497
Pop Proc

MAKEDIRS:
   F$=Peek$(LINK,64,Chr$(0))
   If Exist(F$) and F$<>""
      For A=Asc("A") To Asc("P")
         B$=Chr$(A)
         If Not(Exist(F$+"level_"+B$))
            Trap Mkdir F$+"LEVEL_"+B$
         End If 
      Next 
   End If 
Return 
End Proc
Procedure _GL_LGFX
   Dim W1$(15)
   _wnd Id Open 8,0,20,_scr Id Width(1),240,$2+$8,F_IDCMP,0,"Levels.."

   '  
   ' Set title of window, and the screen title when window is active
   '
   _wnd Id Titles Catalog String$(1203,"Level GFX's"),VER$
   _wnd Id Activate 8

   '
   ' Prepare for gadgets
   ' Bank 497 is reserved for 30 gadgets to be used on screen 1 
   '
   Reserve As Gt Gadgets 497,30,1

   '
   ' Preparing string gadgets 
   ' Tabcycle=True, MaxChars=80, ExitHelp=True, Replacemode=False 
   '  
   _gt Set String Mode True,80,True,False
   _gt Set Listview Mode ,,,16,0,

   _gt Bevel Box 2,16,16,624,44,1
   _gt Bevel Box 2,16,64,624,44,1
   _gt Bevel Box 2,16,112,624,136,1
   _gt Text 1,32,20,576,10,,"",Catalog String$(540,"Set FloorFile"),0
   _gt Text 2,32,32,576,12,,"","",1
   _gt Image 3,608,32,1,GAD16(0),GAD16(1)
   '_gt Button 4,464,32,160,12,,Catalog String$(595,"Create Dirs")
   _gt Text 21,32,68,576,10,,"",Catalog String$(550,"Set TextureFile"),0
   _gt Text 22,32,80,576,12,,"","",1
   _gt Image 23,608,80,1,GAD16(0),GAD16(1)
   '_gt Button 24,464,80,160,12,,Catalog String$(595,"Create Dirs") 
   _gt Listview 8,32,128,592,112,,Catalog String$(560,"Set WallGFX's"),Array(W1$(0)),0
   SELLEV=0

   '
   ' Use gadgets
   '
   _gt Gadgets Attach 497

   Do 
      _gt Gadgets Bank 497
      For A=0 To 15
         W1$(A)=Peek$(LINK+$14760+A*64,64,Chr$(0))
      Next A
      _gt Set Text 2,Peek$(LINK+$1940,64,Chr$(0)),,,
      _gt Set Text 22,Peek$(LINK+$1980,64,Chr$(0)),,,
      _gt Set Listview 8,Array(W1$(0)),,,
      Do 
         '
         ' Wait for event 
         '
         EV=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %111
         KY=_wnd Id Event Code
         If EV=$400
            If KY=95 : _SHOW_AG["M0202"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         '
         ' If gadget pushed 
         '
         If EV=$40
            If GA=3
               _S_FILE[0,Catalog String$(542,"Select FloorFile"),"AB3:Includes/","",""]
               F$=Param$
               If F$<>"" and Exist(F$)
                  If File Length(F$)>20
                     Poke$ LINK+$1940,Left$(F$+String$(Chr$(0),64),64)
                     Erase 700
                  End If 
               End If 
               Exit 
            End If 
            If GA=23
               _S_FILE[0,Catalog String$(552,"Select TextureFile"),"AB3:Includes/","",""]
               F$=Param$
               If F$<>"" and Exist(F$)
                  If File Length(F$)>20
                     Poke$ LINK+$1980,Left$(F$+String$(Chr$(0),64),64)
                  End If 
               End If 
               Exit 
            End If 
            If GA=8
               R=KY
               _S_FILE[0,Catalog String$(562,"Select wall-graphic"),"AB3:WALLINC/","*.256wad",Dr File$(Peek$(LINK+$14760+R*64,64,Chr$(0)))]
               F$=Param$
               If F$<>"" and Exist(F$)
                  T=File Length(F$)
                  If T>20 and File Type(F$)<0
                     Poke$ LINK+$14760+R*64,Left$(F$+String$(Chr$(0),64),64)
                     _LOAD[15,F$] : Erase 701+R
                     Doke LINK+$14B60+R*2,Deek(Start(15)+Param-2)
                  End If 
               Else 
                  Poke$ LINK+$14760+R*64,String$(Chr$(0),64)
                  Doke LINK+$14B60+R*2,0
                  Erase 701+R
               End If 
               Exit 
            End If 
         End If 
         '
         ' If window closed 
         '
         Exit If EV=$200,2
         Multi Wait 
      Loop 
   Loop 
   '
   ' Remove gadgets 
   '
   _gt Gadgets Remove 497
   '
   ' Close down window, screen and erase gadgets from memory..
   '
   _wnd Id Close 8
   _gt Gadgets Erase 497
End Proc
Procedure _GL_SFX
   Dim W1$(59),W2$(15),W3$(59)
   _wnd Id Open 8,0,20,_scr Id Width(1),256,$2+$8,F_IDCMP,0,"Levels.."

   '  
   ' Set title of window, and the screen title when window is active
   '
   _wnd Id Titles Catalog String$(1125,"Samples"),VER$
   _wnd Id Activate 8

   '
   ' Prepare for gadgets
   ' Bank 497 is reserved for 30 gadgets to be used on screen 1 
   '
   Reserve As Gt Gadgets 497,30,1

   '
   ' Preparing string gadgets 
   ' Tabcycle=True, MaxChars=80, ExitHelp=True, Replacemode=False 
   '  
   _gt Set String Mode True,80,True,False
   _gt Set Listview Mode ,,,16,0,

   _gt Bevel Box 2,16,16,624,80,1
   _gt Bevel Box 2,16,100,624,80,1
   _gt Bevel Box 2,16,184,624,80,1
   _gt Listview 4,32,32,592,56,,Catalog String$(580,"Select SFX-files (Hold shift to hear)"),Array(W1$(0)),0
   _gt Listview 8,32,116,592,56,,Catalog String$(590,"Set BackgroundSFX (Shift to hear)"),Array(W2$(0)),0
   _gt Listview 12,32,200,592,56,,Catalog String$(591,"Set Echoed SFX's (Hold shift to hear)"),Array(W3$(0)),0
   SELLEV=0

   '
   ' Use gadgets
   '
   _gt Gadgets Attach 497

   Do 
      _gt Gadgets Bank 497
      For A=0 To 59
         W1$(A)=Peek$(LINK+$A40+A*64,64,Chr$(0))
      Next A
      For A=0 To 15
         W2$(A)=Peek$(LINK+$A40+Deek(LINK+$14CA0+A*2)*64,64,Chr$(0))
      Next A
      For A=0 To 59
         W3$(A)=Left$(Peek$(LINK+$A40+A*64,64,Chr$(0))+Space$(64),61)+Right$("0"+Str$(Peek(LINK+$150C0+A))-" ",2)
      Next A
      _gt Set Listview 4,Array(W1$(0)),,,
      _gt Set Listview 8,Array(W2$(0)),,,
      _gt Set Listview 12,Array(W3$(0)),,,
      Do 
         '
         ' Wait for event 
         '
         EV=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %111
         KY=_wnd Id Event Code
         If EV=$400
            If KY=95 : _SHOW_AG["M0401"] : End If 
         End If 
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         '
         ' If gadget pushed 
         '
         If EV=$40
            If GA=4 and KS=0
               _S_FILE[0,Catalog String$(582,"Select SFX file"),"AB3:samples/*.fib","",""]
               F$=Param$
               If F$<>"" : Poke$ LINK+$A40+KY*64,Left$(F$+String$(Chr$(0),64),64) : End If 
               Exit 
            Else If GA=4
               _PLAY_SAMPLE[Peek$(LINK+$A40+KY*64,64,Chr$(0))]
            End If 
            If GA=8 and KS=0
               _SELSFX[0,""] : Doke(LINK+$14CA0+KY*2),Param
               Exit 
            Else If GA=8
               _PLAY_SAMPLE[Peek$(LINK+$A40+Deek(LINK+$14CA0+KY*2)*64,64,Chr$(0))]
            End If 
            If GA=12 and KS=0
               _SELSFX[0,Catalog String$(592,"Select Echoed SFX ('Shift' to hear)")]
               Poke LINK+$150C0+KY,Param
               Exit 
            Else If GA=12
               _PLAY_SAMPLE[Peek$(LINK+$A40+KY*64,64,Chr$(0))]
            End If 
         End If 
         '
         ' If window closed 
         '
         Exit If EV=$200,2
         Multi Wait 
      Loop 
   Loop 
   '
   ' Remove gadgets 
   '
   _gt Gadgets Remove 497
   '
   ' Close down window, screen and erase gadgets from memory..
   '
   _wnd Id Close 8
   _gt Gadgets Erase 497
End Proc
Procedure _GL_SET_ANIM[ANBAS,TYPE,T$,NRADR]
   '
   ' Defined animation types: 
   '
   '  01  BMP  Bullet (impact) animation  
   '  02  BMP  Alien animation
   ' -02  VEC  Alien animation
   '  03  BMP  Object animation 
   ' -03  VEC  Object animation 
   '
   Dim W1$(20),W10$(1),W30$(3),ANM(20,10)
   _scr Id Use 1
   _scr Id Show 1
   Reserve As Gt Gadgets 497,60,1
   _gt Set Mode 0,"",0,1
   _gt Set Listview Mode ,,,16,0,
   _gt Set Integer Mode 1,6,1,0

   _gt Listview 1,8,12,_scr Id Width(1)-16,112,,"",Array(W1$(0)),0

   If TYPE>0
      _gt Text 21,8,128,232,12,,"",Catalog String$(50,"Graphic File:"),0
      _gt Text 22,240,128,400,12,,"","-",1
      _gt Image 2,640,128,1,GAD16(0),GAD16(1)

      _gt Text 23,8,142,232,12,,"",Catalog String$(51,"Frame Number:"),0
      _gt Integer 3,240,142,64,12,0,"",1256,1
      _gt Image 4,304,142,1,GAD16(0),GAD16(1)

      _gt Text 24,8,156,232,12,,"",Catalog String$(52,"Scaled Width:"),0
      _gt Integer 5,240,156,80,12,0,"",1256,1

      _gt Text 25,8,170,232,12,,"",Catalog String$(53,"Scaled Height:"),0
      _gt Integer 6,240,170,80,12,0,"",1256,1

      _gt Text 26,8,184,232,12,,"",Catalog String$(54,"Vertical Offset:"),0
      _gt Integer 7,240,184,80,12,0,"",1256,1
   End If 
   If TYPE<0
      _gt Text 21,8,128,232,12,,"",Catalog String$(56,"Vector File:"),0
      _gt Text 22,240,128,400,12,,"","-",1
      _gt Image 2,640,128,1,GAD16(0),GAD16(1)

      _gt Text 23,8,142,232,12,,"",Catalog String$(51,"Frame Number:"),0
      _gt Integer 3,240,142,64,12,0,"",1256,1
      _gt Image 4,304,142,1,GAD16(0),GAD16(1)

      _gt Text 24,8,156,232,12,,"",Catalog String$(57,"Facing Angle:"),0
      _gt Integer 5,240,156,80,12,0,"",1256,1

      _gt Text 26,8,170,232,12,,"",Catalog String$(54,"Vertical Offset:"),0
      _gt Integer 7,240,170,80,12,0,"",1256,1
   End If 
   If TYPE=1
      V_J=6
      _gt Text 27,8,198,232,12,,"",Catalog String$(55,"Brightness Value:"),0
      _gt Integer 8,240,198,80,12,0,"",1256,1
   End If 
   If Abs(TYPE)=2
      V_J=11
      W10$(0)="" : W10$(1)="*"
      W30$(0)="-?-"
      W30$(1)=Catalog String$(577,"Value to store in counter (0-63):")
      W30$(2)=Catalog String$(578,"Max. random value to add (0-63):")
      W30$(3)=Catalog String$(579,"Frame to branch to at (count=0):")
      _gt Text 27,8,198,232,12,,"",Catalog String$(58,"Sound FX:"),0
      _gt Text 28,240,198,400,12,,"","-",1
      _gt Image 8,640,198,1,GAD16(0),GAD16(1)

      _gt Text 29,8,212,568,12,,"",Catalog String$(59,"Action:"),0
      _gt Cycle 9,576,212,80,12,,"",Array(W10$(0)),0

      _gt Cycle 10,8,226,568,12,,"",Array(W30$(0)),0
      _gt Integer 11,576,226,80,12,0,"",1256,1

      _gt Text 30,344,142,232,12,,"",Catalog String$(60,"Aux. Object Frame:"),0
      _gt Integer 12,576,142,64,12,0,"",1256,1
      _gt Image 13,640,142,1,GAD16(0),GAD16(1)

      _gt Text 31,344,156,232,12,,"",Catalog String$(61,"Aux. Frame X-Offset:"),0
      _gt Integer 14,576,156,80,12,0,"",1256,1

      _gt Text 32,344,170,232,12,,"",Catalog String$(62,"Aux. Frame Y-Offset:"),0
      _gt Integer 15,576,170,80,12,0,"",1256,1
   End If 
   If Abs(TYPE)=3
      V_J=6
      _gt Text 27,8,198,232,12,,"",Catalog String$(63,"Next Frame:"),0
      _gt Integer 8,240,198,80,12,0,"",1256,1
   End If 

   _gt Button 55,8,252,128,12,,Catalog String$(2310,"Insert")
   _gt Button 56,136,252,128,12,,Catalog String$(2311,"Delete")

   _wnd Id Open 8,0,128,_scr Id Width(1),256,$2+$8,F_IDCMP,497,""
   _wnd Id Titles T$,VER$

   R=-1
   Do 
      _gt Gadgets Bank 497
      If TYPE=1 : Gosub UPDTY1 : End If 
      If TYPE=2 : Gosub UPDTY2 : End If 
      If TYPE=-2 : Gosub UPDTY2V : End If 
      If TYPE=3 : Gosub UPDTY3 : End If 
      If TYPE=-3 : Gosub UPDTY3V : End If 
      Do 
         AC=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %11111
         KY=_wnd Id Event Code
         If _wnd Id Event Wnd<>8 : AC=0 : End If 
         If AC=$40
            If TYPE=1 : Gosub CHEKTYP1 : Exit : End If 
            If TYPE=2 : Gosub CHEKTYP2 : Exit : End If 
            If TYPE=-2 : Gosub CHEKTYP2V : Exit : End If 
            If TYPE=3 : Gosub CHEKTYP3 : Exit : End If 
            If TYPE=-3 : Gosub CHEKTYP3V : Exit : End If 
         End If 
         Exit If AC=$200,2
      Loop 
   Loop 

   _gt Gadgets Remove 497
   _gt Gadgets Erase 497
   _wnd Id Close 8
   If AM_HE
      Amos To Front 
   End If 
Pop Proc

UPDTY1:
   For A=0 To 19
      W1$(A)=""
      If A<=Leek(NRADR)
         W1$(A)=W1$(A)+"GF:"+Right$("0"+Str$(Peek(ANBAS+A*6)+1)-" ",2)+" "
         W1$(A)=W1$(A)+"FN:"+Right$("0"+Str$(Peek(ANBAS+A*6+1)+1)-" ",2)+" "
         W1$(A)=W1$(A)+"SW:"+Right$("0"+Str$(Peek(ANBAS+A*6+2))-" ",2)+" "
         W1$(A)=W1$(A)+"SH:"+Right$("0"+Str$(Peek(ANBAS+A*6+3))-" ",2)+" "
         W1$(A)=W1$(A)+"VO:"+Right$("0"+Str$(Speek(ANBAS+A*6+4))-" ",2)+" "
         W1$(A)=W1$(A)+"BV:"+Right$("0"+Str$(Peek(ANBAS+A*6+5))-" ",2)+" "
      End If 
   Next 
   If R=-1
      _gt Set Text 22,"",,,
      _gt Set Integer 3,0 : _gt Set Integer 5,0
      _gt Set Integer 6,0 : _gt Set Integer 7,0
      _gt Set Integer 8,0
   Else 
      _gt Set Text 22,Peek$(LINK+$2C0+Peek(ANBAS+R*6)*64,64,Chr$(0)),,,
      _gt Set Integer 3,Peek(ANBAS+R*6+1)+1 : _gt Set Integer 5,Peek(ANBAS+R*6+2)
      _gt Set Integer 6,Peek(ANBAS+R*6+3) : _gt Set Integer 7,Speek(ANBAS+R*6+4)
      _gt Set Integer 8,Peek(ANBAS+R*6+5)
   End If 
   _gt Set Listview 1,Array(W1$(0)),R,,
Return 
CHEKTYP1:
   If GA=1
      R=KY
      If R>Leek(NRADR)
         R=Leek(NRADR)+1
         Loke NRADR,R
         For A=0 To 5 : Poke ANBAS+R*6+A,Peek(ANBAS+(R-1)*6+A) : Next A
      End If 
   Else If R>-1
      If GA=2 : _SELGFX[0,""] : Poke ANBAS+R*6,Param
      Else If GA=3 : Poke ANBAS+R*6+1,_gt What Integer(3)-1
      Else If GA=4 : _FRAMEPICK[1,Peek(ANBAS+R*6),Peek(ANBAS+R*6+1)+1] : Poke ANBAS+R*6+1,Param-1
      Else If GA=5 : Poke ANBAS+R*6+2,_gt What Integer(5)
      Else If GA=6 : Poke ANBAS+R*6+3,_gt What Integer(6)
      Else If GA=7 : Poke ANBAS+R*6+4,_gt What Integer(7)
      Else If GA=8 : Poke ANBAS+R*6+5,_gt What Integer(8)
      Else If GA=55
         For A=18 To R Step -1
            Poke$ ANBAS+(A+1)*V_J,Peek$(ANBAS+A*V_J,V_J)
         Next A
         Loke NRADR,Leek(NRADR)+1
      Else If GA=56
         For A=R To 18
            Poke$ ANBAS+A*V_J,Peek$(ANBAS+(A+1)*V_J,V_J)
         Next A
         Loke NRADR,Leek(NRADR)-1
      End If 
   End If 
Return 

UPDTY2:
   ALMAX=19
   For A=0 To 19
      For B=0 To 10
         ANM(A,B)=Peek(ANBAS+A*11+B)
      Next B
      If ANM(A,0)=255 : ANM(A,0)=-1 : If ALMAX=19 : ALMAX=A-1 : End If : End If 
      If ANM(A,4)>127 : Add ANM(A,4),-256 : End If 
      If ANM(A,1)>127 : Add ANM(A,1),-256 : End If 
      If ANM(A,9)>127 : Add ANM(A,9),-256 : End If 
      If ANM(A,8)>127 : Add ANM(A,8),-256 : End If 
      If ANM(A,10)>127 : Add ANM(A,10),-256 : End If 
   Next A
   For A=0 To 19
      W1$(A)=""
      If A<=ALMAX
         W1$(A)=Right$("00"+Str$(A+1)-" ",2)
         W1$(A)=W1$(A)+" GF:"+Right$("0"+Str$(ANM(A,0)+1)-" ",2)+" "
         W1$(A)=W1$(A)+"FN:"+Right$(" "+Str$(ANM(A,1))-" ",2)+" "
         W1$(A)=W1$(A)+"SW:"+Right$(" "+Str$(ANM(A,2))-" ",2)+" "
         W1$(A)=W1$(A)+"SH:"+Right$(" "+Str$(ANM(A,3))-" ",2)+" "
         Gosub UPDTY2G1
      End If 
   Next 
   _gt Set Listview 1,Array(W1$(0)),R,,
   If R=-1
      _gt Set Text 22,"",,,
      _gt Set Integer 3,0 : _gt Set Integer 5,0
      _gt Set Integer 6,0 : _gt Set Integer 7,0
      _gt Set Text 28,"",,,
      _gt Set Cycle 9,,0 : _gt Set Cycle 10,,0
      _gt Set Integer 11,0 : _gt Set Integer 12,0
      _gt Set Integer 14,0 : _gt Set Integer 15,0
   Else 
      _gt Set Text 22,Peek$(LINK+$2C0+ANM(R,0)*64,32,Chr$(0)),,,
      _gt Set Integer 3,ANM(R,1)
      _gt Set Integer 5,ANM(R,2)
      _gt Set Integer 6,ANM(R,3)
      Gosub UPDTY2G
   End If 
Return 
UPDTY2V:
   ALMAX=19
   For A=0 To 19
      For B=0 To 10
         ANM(A,B)=Peek(ANBAS+A*11+B)
      Next B
      If ANM(A,0)=255 : ANM(A,0)=-1 : If ALMAX=19 : ALMAX=A-1 : End If : End If 
      If ANM(A,4)>127 : Add ANM(A,4),-256 : End If 
      If ANM(A,1)>127 : Add ANM(A,1),-256 : End If 
      If ANM(A,9)>127 : Add ANM(A,9),-256 : End If 
      If ANM(A,8)>127 : Add ANM(A,8),-256 : End If 
      If ANM(A,10)>127 : Add ANM(A,10),-256 : End If 
   Next A
   For A=0 To 19
      W1$(A)=""
      If A<=ALMAX
         W1$(A)=Right$("00"+Str$(A+1)-" ",2)
         W1$(A)=W1$(A)+" VF:"+Right$("0"+Str$(ANM(A,0)+1)-" ",2)+" "
         W1$(A)=W1$(A)+"FN:"+Right$(" "+Str$(ANM(A,1))-" ",2)+" "
         W1$(A)=W1$(A)+"AO:"+Right$("   "+Str$(ANM(A,2)*256+ANM(A,3) and 8190)-" ",4)+" "
         Gosub UPDTY2G1
      End If 
   Next 
   _gt Set Listview 1,Array(W1$(0)),R,,
   If R=-1
      _gt Set Text 22,"",,,
      _gt Set Integer 3,0 : _gt Set Integer 5,0
      _gt Set Integer 7,0
      _gt Set Text 28,"",,,
      _gt Set Cycle 9,,0 : _gt Set Cycle 10,,0
      _gt Set Integer 11,0 : _gt Set Integer 12,0
      _gt Set Integer 14,0 : _gt Set Integer 15,0
   Else 
      _gt Set Text 22,Peek$(LINK+$13FE0+ANM(R,0)*64,32,Chr$(0)),,,
      _gt Set Integer 3,ANM(R,1)
      _gt Set Integer 5,ANM(R,2)*256+ANM(R,3) and 8190
      Gosub UPDTY2G
   End If 
Return 
UPDTY2G1:
   W1$(A)=W1$(A)+"VO:"+Right$(" "+Str$(ANM(A,4))-" ",2)+" "
   W1$(A)=W1$(A)+"FX:"+Right$(" "+Str$(ANM(A,5))-" ",2)+"   "
   W1$(A)=W1$(A)+"AC:"
   If ANM(A,6)=1 : W1$(A)=W1$(A)+"* " : Else : W1$(A)=W1$(A)+"  " : End If 
   W1$(A)=W1$(A)+" AI:" : A7=ANM(A,7)
   If A7=0 : W1$(A)=W1$(A)+" v "
   Else If A7/64=1 : W1$(A)=W1$(A)+"S"+Right$(" "+Str$(A7 and 63)-" ",2)
   Else If A7/64=2 : W1$(A)=W1$(A)+"R"+Right$(" "+Str$(A7 and 63)-" ",2)
   Else : W1$(A)=W1$(A)+"D"+Right$("0"+Str$(A7 and 63)-" ",2)
   End If 
   W1$(A)=W1$(A)+" AUX:"
   If ANM(A,8)>=0 : W1$(A)=W1$(A)+Right$(" "+Str$(ANM(A,8)+1)-" ",2)+" "
   Else : W1$(A)=W1$(A)+"   "
   End If 
   W1$(A)=W1$(A)+" XO:"+Right$("  "+Str$(ANM(A,9)*2)-" ",3)+" "
   W1$(A)=W1$(A)+"YO:"+Right$("  "+Str$(ANM(A,10)*2)-" ",3)
Return 
UPDTY2G:
   _gt Set Integer 7,ANM(R,4)
   If ANM(R,5)=0
      _gt Set Text 28,"<NONE>",,,
   Else 
      _gt Set Text 28,Left$(Dr File$(Peek$(LINK+$A40+(ANM(R,5)-1)*64,64,Chr$(0))),18),,,
   End If 
   _gt Set Cycle 9,,ANM(R,6)
   If Between(0,ANM(R,7),64)
      _gt Set Cycle 10,,3
   Else 
      _gt Set Cycle 10,,ANM(R,7)/64
   End If 
   _gt Set Integer 11,ANM(R,7) and 63
   _gt Set Integer 12,ANM(R,8)+1
   _gt Set Integer 14,ANM(R,9)*2
   _gt Set Integer 15,ANM(R,10)*2
Return 
CHEKTYP2:
   If GA=1
      R=KY
      If R>ALMAX
         R=ALMAX+1
         For A=0 To 10 : Poke ANBAS+R*11+A,Peek(ANBAS+(R-1)*11+A) : Next A
      End If 
   Else If R>-1
      If GA=2 : _SELGFX[0,""] : Poke ANBAS+R*6,Param
      Else If GA=3 : Poke ANBAS+R*11+1,_gt What Integer(3)
      Else If GA=4 : _FRAMEPICK[1,ANM(R,0),ANM(R,1)] : Poke ANBAS+R*11+1,Param
      Else If GA=5 : Poke ANBAS+R*11+2,_gt What Integer(5)
      Else If GA=6 : Poke ANBAS+R*11+3,_gt What Integer(6)
      End If 
      Gosub CHEKTYP2G
   End If 
Return 
CHEKTYP2V:
   If GA=1
      R=KY
      If R>ALMAX
         R=ALMAX+1
         For A=0 To 10 : Poke ANBAS+R*11+A,Peek(ANBAS+(R-1)*11+A) : Next A
      End If 
   Else If R>-1
      If GA=2 : _SELVEC[0,""] : Poke ANBAS+R*6,Param
      Else If GA=3 : Poke ANBAS+R*11+1,_gt What Integer(3)
      Else If GA=4 : _VFRAMEPICK[1,ANM(R,0),ANM(R,1)] : Poke ANBAS+R*11+1,Param
      Else If GA=5 : AL=_gt What Integer(5) : Poke ANBAS+R*11+2,(AL and 8190)/256 : Poke ANBAS+R*11+3,AL and $FE
      End If 
      Gosub CHEKTYP2G
   End If 
Return 
CHEKTYP2G:
   If GA=7 : Poke ANBAS+R*11+4,_gt What Integer(7)
   Else If GA=8 : _SELSFX[1,""] : Poke ANBAS+R*11+5,Param
   Else If GA=9 : Add ANM(R,6),1,0 To 1 : Poke ANBAS+R*11+6,ANM(R,6)
   Else If GA=10
      If ANM(R,7)/64=1 : Poke ANBAS+R*11+7,(ANM(R,7) and 63)+128
      Else If ANM(R,7)/64=2 : Poke ANBAS+R*11+7,ANM(R,7) and 63
      Else : Poke ANBAS+R*11+7,(ANM(R,7) and 63)+64
      End If 
   Else If GA=11 : Poke ANBAS+R*11+7,Range(_gt What Integer(11),0 To 63)+(ANM(R,7) and 192)
   Else If GA=12 and NRADR>0 : Poke ANBAS+R*11+8,_gt What Integer(12)-1
   Else If GA=13 and NRADR>0 : _OBJFRAMEPICK[1,NRADR,ANM(R,8)+1] : Poke ANBAS+R*11+8,Param-1
   Else If GA=14 : Poke ANBAS+R*11+9,_gt What Integer(14)/2
   Else If GA=15 : Poke ANBAS+R*11+10,_gt What Integer(15)/2
   Else If GA=55
      For A=18 To R Step -1
         Poke$ ANBAS+(A+1)*V_J,Peek$(ANBAS+A*V_J,V_J)
      Next A
   Else If GA=56
      For A=R To 18
         Poke$ ANBAS+A*V_J,Peek$(ANBAS+(A+1)*V_J,V_J)
      Next A
      Loke NRADR,Leek(NRADR)-1
   End If 
Return 

UPDTY3:
   For A=0 To 19
      For B=0 To 5
         ANM(A,B)=Peek(ANBAS+A*6+B)
         If ANM(A,B)>127 and B=4 : ANM(A,B)=255-ANM(A,B) : End If 
         If ANM(A,B)>127 and B=1 : ANM(A,B)=255-ANM(A,B) : End If 
      Next B
      W1$(A)=""
      If A<=Deek(NRADR)
         W1$(A)=W1$(A)+"GF:"+Right$("  "+Str$(ANM(A,0))-" ",2)+" "
         W1$(A)=W1$(A)+"FN:"+Right$("  "+Str$(ANM(A,1)+1)-" ",2)+" "
         W1$(A)=W1$(A)+"SW:"+Right$("  "+Str$(ANM(A,2))-" ",3)+" "
         W1$(A)=W1$(A)+"SH:"+Right$("  "+Str$(ANM(A,3))-" ",3)+" "
         W1$(A)=W1$(A)+"VO:"+Right$("  "+Str$(ANM(A,4))-" ",3)+" "
         W1$(A)=W1$(A)+"NF:"+Right$("  "+Str$(ANM(A,5))-" ",3)+" "
      End If 
   Next 
   _gt Set Listview 1,Array(W1$(0)),R,,
   If R<0
      _gt Set Text 22,"",,,
      _gt Set Integer 3,0 : _gt Set Integer 5,0
      _gt Set Integer 6,0 : _gt Set Integer 7,0
      _gt Set Integer 8,0
   Else 
      _gt Set Text 22,Peek$(LINK+$2C0+ANM(R,0)*64,64,Chr$(0)),,,
      _gt Set Integer 3,ANM(R,1)+1
      _gt Set Integer 5,ANM(R,2)
      _gt Set Integer 6,ANM(R,3)
      _gt Set Integer 7,ANM(R,4)
      _gt Set Integer 8,ANM(R,5)
   End If 
Return 
UPDTY3V:
   For A=0 To 19
      For B=0 To 5
         ANM(A,B)=Peek(ANBAS+A*6+B)
         If ANM(A,B)>127 and B=4 : ANM(A,B)=255-ANM(A,B) : End If 
         If ANM(A,B)>127 and B=1 : ANM(A,B)=255-ANM(A,B) : End If 
      Next B
      W1$(A)=""
      If A<=Deek(NRADR)
         W1$(A)=W1$(A)+"VF:"+Right$("  "+Str$(ANM(A,0))-" ",2)+" "
         W1$(A)=W1$(A)+"FN:"+Right$("  "+Str$(ANM(A,1)+1)-" ",2)+" "
         W1$(A)=W1$(A)+"AO:"+Right$("    "+Str$(ANM(A,2)*256+ANM(A,3))-" ",5)+" "
         W1$(A)=W1$(A)+"SH:"+Right$("  "+Str$(ANM(A,3))-" ",3)+" "
         W1$(A)=W1$(A)+"VO:"+Right$("  "+Str$(ANM(A,4))-" ",3)+" "
         W1$(A)=W1$(A)+"NF:"+Right$("  "+Str$(ANM(A,5))-" ",3)+" "
      End If 
   Next 
   _gt Set Listview 1,Array(W1$(0)),R,,
   If R<0
      _gt Set Text 22,"",,,
      _gt Set Integer 3,0 : _gt Set Integer 5,0
      _gt Set Integer 7,0
      _gt Set Integer 8,0
   Else 
      _gt Set Text 22,Peek$(LINK+$13FE0+ANM(R,0)*64,64,Chr$(0)),,,
      _gt Set Integer 3,ANM(R,1)+1
      _gt Set Integer 5,ANM(R,2)*256+ANM(R,3)
      _gt Set Integer 7,ANM(R,4)
      _gt Set Integer 8,ANM(R,5)
   End If 
Return 
CHEKTYP3:
   If GA=1
      R=KY
      If R>Deek(NRADR)
         R=Deek(NRADR)+1
         Doke NRADR,R
         For A=0 To 5 : Poke ANBAS+R*6+A,ANM(R-1,A) : Next A
      End If 
   Else If R>-1
      If GA=2 : _SELGFX[0,""] : Poke ANBAS+R*6,Param
      Else If GA=3 : Poke ANBAS+R*6+1,_gt What Integer(3)-1
      Else If GA=4 : _FRAMEPICK[0,ANM(R,0),ANM(R,1)+1] : Poke ANBAS+R*6+1,Param-1
      Else If GA=5 : Poke ANBAS+R*6+2,_gt What Integer(5)
      Else If GA=6 : Poke ANBAS+R*6+3,_gt What Integer(6)
      Else If GA=7 : Poke ANBAS+R*6+4,_gt What Integer(7)
      Else If GA=8 : Poke ANBAS+R*6+5,_gt What Integer(8)
      Else If GA=55
         For A=18 To R Step -1
            Poke$ ANBAS+(A+1)*V_J,Peek$(ANBAS+A*V_J,V_J)
         Next A
         Doke NRADR,Deek(NRADR)+1
      Else If GA=56
         For A=R To 18
            Poke$ ANBAS+A*V_J,Peek$(ANBAS+(A+1)*V_J,V_J)
         Next A
         Doke NRADR,Deek(NRADR)-1
      End If 
   End If 
Return 
CHEKTYP3V:
   If GA=1
      R=KY
      If R>Deek(NRADR)
         R=Deek(NRADR)+1
         Doke NRADR,R
         For A=0 To 5 : Poke ANBAS+R*6+A,ANM(R-1,A) : Next A
      End If 
   Else If R>-1
      If GA=2 : _SELGFX[0,""] : Poke ANBAS+R*6,Param
      Else If GA=3 : Poke ANBAS+R*6+1,_gt What Integer(3)-1
      Else If GA=4 : _FRAMEPICK[0,ANM(R,0),ANM(R,1)+1] : Poke ANBAS+R*6+1,Param-1
      Else If GA=5 : AL=_gt What Integer(5) : Poke ANBAS+R*6+2,(AL and 8190)/256 : Poke ANBAS+R*6+3,AL and $FE
      Else If GA=7 : Poke ANBAS+R*6+4,_gt What Integer(7)
      Else If GA=8 : Poke ANBAS+R*6+5,_gt What Integer(8)
      Else If GA=55
         For A=18 To R Step -1
            Poke$ ANBAS+(A+1)*V_J,Peek$(ANBAS+A*V_J,V_J)
         Next A
         Doke NRADR,Deek(NRADR)+1
      Else If GA=56
         For A=R To 18
            Poke$ ANBAS+A*V_J,Peek$(ANBAS+(A+1)*V_J,V_J)
         Next A
         Doke NRADR,Deek(NRADR)-1
      End If 
   End If 
Return 
End Proc
'
Procedure _GL_IGETPAL[SC,DST]
   Dim PR(31),PG(31),PB(31)

   _scr Id Use 1 : _scr Id Show 1
   _N_MSG2["",2]
   _gt Set Text 1,Catalog String$(1080,"Building Shade-palette"),,,

   _scr Id Use SC
   For A=0 To 31
      C=_scr Id Get Aga Pal(A)
      PR(A)=(C/$10000) and $FF
      PG(A)=(C/$100) and $FF
      PB(A)=C and $FF
   Next 
   _scr Id Use 1

   N=DST
   For A=0 To 31
      _gt Set Text 2,Str$((A*100)/32)-" "+"%",,,
      V=32-A
      For Q=0 To 31
         R=PR(Q) : G=PG(Q) : B=PB(Q)
         R=(R*V)/32 : G=(G*V)/32 : B=(B*V)/32
         DQ=10000000
         TC=0
         For Z=0 To 255
            DR=Abs(R-Deek(PALC+Z*6))
            DG=Abs(G-Deek(PALC+Z*6+2))
            DB=Abs(B-Deek(PALC+Z*6+4))
            ND=(DR*3)+(DG*3)+(DB*3)
            If ND<DQ : DQ=ND : TC=Z : End If 
         Next 
         Doke N,TC*256
         Add N,2
      Next 
   Next 
   _scr Id Use 1
   _R_N_MSG
End Proc
'
Procedure _TL_OBJFRAMECONV
   _S_FILE[0,Catalog String$(504,"Load Object Graphics"),"ab3:graphics/","",""]
   F$=Param$
   If F$="" : Pop Proc : End If 
   If Not Exist(F$) : Pop Proc : End If 

   Erase 401
   Trap Wload F$,401
   If Errtrap : Erase 401 : Pop Proc : End If 

   _ILBM_FROM_BANK[2,401,%1]
   If Param
      Trap _scr Id Close 2 : Pop Proc
   End If 
   Reserve As Work 401,2048

   FILE$=F$
   F$=Dr File$(F$)
   _scr Id Use 1 : _scr Id Show 1

   Reserve As Gt Gadgets 497,10,1
   _gt Set Integer Mode 1,6,1,0

   _gt Text 7,8,14,196,12,,"",Catalog String$(505,"Number of frames:"),0
   _gt Text 8,8,28,196,12,,"",Catalog String$(506,"Width of each frame:"),0
   _gt Text 9,8,42,196,12,,"",Catalog String$(507,"Height of each frame:"),0
   _gt Integer 1,204,14,64,12,0,"",0,1
   _gt Integer 2,204,28,64,12,0,"",0,1
   _gt Integer 3,204,42,64,12,0,"",0,1
   _gt Button 4,204,56,64,12,,"OK"

   _wnd Id Open 8,128,20,268,60,$2+$8,F_IDCMP,497,".."
   _wnd Id Titles Catalog String$(504,"Load Object Graphics"),VER$
   Do 
      EV=_wnd Id Next Event
      GA=_wnd Id Event Gadget
      If EV=$40 and GA=4 and _wnd Id Event Wnd=8 : Exit : End If 
      If EV=$200 and _wnd Id Event Wnd=8 : Exit : End If 
      Multi Wait 
   Loop 
   NOF=_gt What Integer(1)
   WOF=_gt What Integer(2)
   HOF=_gt What Integer(3)
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497

   If WOF=0 or NOF=0 or HOF=0 or EV=$200
      _scr Id Close 2 : Pop Proc
   End If 
   WOS=_scr Id Width(2)

   N=Start(401)
   _GL_IGETPAL[2,N]

   _scr Id Use 2 : _scr Id Show 2
   SI=WOF*HOF*NOF+12
   If Length(15)<SI : Reserve As Work 15,SI : End If 
   OX=0 : OY=0
   _scr Id Ink 0,0,0
   For A=0 To NOF-1
      ST=Start(15)+6+A*WOF*HOF
      For X=OX To OX+WOF-1
         For Y=OY To OY+HOF-1
            C=_scr Id Point(X,Y) : Poke ST,C : Add ST,1 : _scr Id Plot X,Y
         Next Y
      Next X
      OX=OX+WOF : If OX+WOF>WOS Then OX=0 : Add OY,HOF
   Next 
   _scr Id Close 2
   _scr Id Use 1 : _scr Id Show 1

   _S_FILE[1,Catalog String$(509,"Save raw data file"),"ab3:includes/","",""]
   F$=Param$
   If F$="" : Pop Proc : End If 
   If Instr(Dr File$(F$),".")
      F$=Left$(F$,Bw Instr(F$,".")-1)
   End If 
   L=(NOF*WOF*HOF)-1 : T=0 : P=Start(401) : S=Start(15)
   Doke S,NOF : Doke S+2,WOF : Doke S+4,HOF : Add S,6 : Add S,L
   'Trap Bsave F$+".dat",Start(15) To S 
   'If Errtrap
   '   _ERROR[0,41,14]
   'Else  
   Trap Bsave F$+".256pal",Start(401) To Bank End(401)
   If Errtrap
      _ERROR[0,41,14]
   Else 
      _TL_PACK_FRAME_DATA[F$]
   End If 
   'End If  
End Proc
Procedure _TL_CONVHQN
   Dim SHIN(7)
   Dim PAL(255,2),PR(31),PG(31),PB(31)
   Dim RM(48)
   If Length(15)<640*640+20 : Reserve As Work 15,640*640+20 : End If 
   S=PALC
   For A=0 To 255
      PAL(A,0)=Deek(S) : Add S,2 : PAL(A,1)=Deek(S) : Add S,2 : PAL(A,2)=Deek(S) : Add S,2
   Next 
   W$="BCAAAEFGBCDEFKLGHIJKRLMNOPQRLSTUVWRSXYZ01WXY22201"
   T=0
   For A=0 To 6
      For B=1 To 7
         C=Asc(Mid$(W$,B,1))
         If C>=65 Then C=C-65 Else C=(C-48)+26
         RM(T)=C
         Add T,1
      Next 
   Next 
   _S_FILE[0,Catalog String$(504,"Load Object Graphics"),"ab3:hqn/","*.cmp",""]
   F$=Param$
   If Instr(Dr File$(F$),".")
      F$=Left$(F$,Bw Instr(F$,".")-1)
   End If 
   ER=True
   Trap Wload F$+".top",401
   If Errtrap : ER=False : End If 
   If ER
      _ILBM_FROM_BANK[2,401,%1]
      If Param : ER=False : End If 
   End If 
   If ER
      _scr Id Use 1 : _scr Id Show 1

      Reserve As Gt Gadgets 497,10,1
      _gt Set Integer Mode 1,6,1,0

      _gt Text 7,8,14,196,12,,"",Catalog String$(505,"Number of frames:"),0
      _gt Text 8,8,28,196,12,,"",Catalog String$(506,"Width of each frame:"),0
      _gt Text 9,8,42,196,12,,"",Catalog String$(507,"Height of each frame:"),0
      _gt Integer 1,204,14,64,12,0,"",SW,1
      _gt Integer 2,204,28,64,12,0,"",SH,1
      _gt Integer 3,204,42,64,12,0,"",SH,1
      _gt Button 4,204,56,64,12,,"OK"

      _wnd Id Open 8,128,20,268,60,$2+$8,F_IDCMP,497,".."
      _wnd Id Titles Catalog String$(504,"Load Object Graphics"),VER$
      Do 
         EV=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         If EV=$40 and GA=4 and _wnd Id Event Wnd=8 : Exit : End If 
         If EV=$200 and _wnd Id Event Wnd=8 : Exit : End If 
         Multi Wait 
      Loop 
      NOF=_gt What Integer(1)
      WOF=_gt What Integer(2)
      HOF=_gt What Integer(3)
      _gt Gadgets Remove 497
      _wnd Id Close 8
      _gt Gadgets Erase 497

      If WOF=0 or NOF=0 or HOF=0 or EV=$200
         _scr Id Close 2 : Pop Proc
      End If 
      WOS=_scr Id Width(2)
   End If 
   If ER
      _scr Id Use 2 : _scr Id Show 2
      X=0 : Y=0 : Z=Start(15)+6
      _scr Id Ink 0,0,0
      For A=0 To NOF-1
         For Q=0 To WOF-1
            For W=0 To HOF-1
               CT=_scr Id Point(Q+X,W+Y)/9
               Poke Z,CT : Add Z,1
               _scr Id Plot Q+X,W+Y
            Next 
         Next 
         X=X+WOF : If X+WOF>WOS : X=0 : Add Y,HOF : End If 
      Next 
      Trap Wload F$+".bot",401
      If Errtrap : ER=False : End If 
      If ER
         _ILBM_FROM_BANK[2,401,%1]
         If Param : ER=False : End If 
      End If 
   End If 
   If ER
      _scr Id Use 2 : _scr Id Show 2
      X=0 : Y=0 : Z=Start(15)+6
      _scr Id Ink 0,0,0
      For A=0 To NOF-1
         For Q=0 To WOF-1
            For W=0 To HOF-1
               CB=_scr Id Point(Q+X,W+Y)/9
               Poke Z,3+CB-Peek(Z)
               Add Z,1
               _scr Id Plot Q+X,W+Y
            Next 
         Next 
         X=X+WOF : If X+WOF>WOS : X=0 : Add Y,HOF : End If 
      Next 
      Trap Wload F$+".lft",401
      If Errtrap : ER=False : End If 
      If ER
         _ILBM_FROM_BANK[2,401,%1]
         If Param : ER=False : End If 
      End If 
   End If 
   If ER
      _scr Id Use 2 : _scr Id Show 2
      X=0 : Y=0 : Z=Start(15)+6
      _scr Id Ink 0,0,0
      For A=0 To NOF-1
         For Q=0 To WOF-1
            For W=0 To HOF-1
               CL=_scr Id Point(Q+X,W+Y)/9
               Poke Z,Peek(Z)*7+3-CL
               Add Z,1
               _scr Id Plot Q+X,W+Y
            Next 
         Next 
         X=X+WOF : If X+WOF>WOS : X=0 : Add Y,HOF : End If 
      Next 
      Trap Wload F$+".rgt",401
      If Errtrap : ER=False : End If 
      If ER
         _ILBM_FROM_BANK[2,401,%1]
         If Param : ER=False : End If 
      End If 
   End If 
   If ER
      _scr Id Use 2 : _scr Id Show 2
      X=0 : Y=0 : Z=Start(15)+6
      _scr Id Ink 0,0,0
      For A=0 To NOF-1
         For Q=0 To WOF-1
            For W=0 To HOF-1
               CR=_scr Id Point(Q+X,W+Y)/9
               Poke Z,RM(Peek(Z)+CR)
               Add Z,1
               _scr Id Plot Q+X,W+Y
            Next 
         Next 
         X=X+WOF : If X+WOF>WOS : X=0 : Add Y,HOF : End If 
      Next 
      Trap Wload F$+".cmp",401
      If Errtrap : ER=False : End If 
      If ER
         _ILBM_FROM_BANK[2,401,%1]
         If Param : ER=False : End If 
      End If 
   End If 
   If ER
      _scr Id Use 2 : _scr Id Show 2
      X=0 : Y=0 : Z=Start(15)+6
      _scr Id Ink 0,0,0
      For A=0 To NOF-1
         For Q=0 To WOF-1
            For W=0 To HOF-1
               CC=_scr Id Point(Q+X,W+Y)/9
               If CC<>0 : C=Peek(Z) : Else : C=0 : End If 
               Poke Z,(C*8)+CC
               Add Z,1
               _scr Id Plot Q+X,W+Y
            Next 
         Next 
         X=X+WOF : If X+WOF>WOS : X=0 : Add Y,HOF : End If 
      Next 
   End If 
   Trap _scr Id Close 2
   _scr Id Use 1 : _scr Id Show 1
   If ER
      _S_FILE[1,Catalog String$(509,"Save raw data file"),"ab3:includes/","",""]
      F$=Param$ : M$=F$
      If Instr(Dr File$(F$),".") : F$=Left$(F$,Bw Instr(F$,".")-1) : End If 
      L=(NOF*WOF*HOF)-1
      S=Start(15) : Doke S,NOF : Doke S+2,WOF : Doke S+4,HOF
      'Trap Bsave M$+".HQN",Start(15) To Z 
      Erase 401 : _LOAD[401,F$+".cmp"]
      S=Hunt(Start(401) To Start(401)+10000,"CMAP")+8
      For A=0 To 31
         PR(A)=Peek(S) : Add S,1 : PG(A)=Peek(S) : Add S,1 : PB(A)=Peek(S) : Add S,1
      Next 
      N=Start(12)+32*8*4
      Erase 405 : Bank Copy 513 To 405
      Loke Start(405),Varptr(PAL(0,0)) : Loke Start(405)+4,Varptr(PR(0))
      Loke Start(405)+8,Varptr(PG(0)) : Loke Start(405)+12,Varptr(PB(0))
      Loke Start(405)+16,Start(12)
      _N_MSG["",Catalog String$(524,"Calculating palette, this may take some time...")]
      Call Start(405)+20
      Trap Bsave M$+".256pal",Start(12) To N
      Erase 405
      _TL_PACK_FRAME_DATA[F$]
   End If 
End Proc
Procedure _TL_PACK_FRAME_DATA[F$]
   Dim U(128*30),T(128*30),B(128*30)
   '
   ' This procedure packs data in the special 'frame-format' for
   ' Bitmap-animation-frames for objects/aliens.. 
   '
   For A=0 To 64*30 : U(A)=0 : Next 
   Erase 405 : Bank Copy 512 To 405
   NF=Deek(Start(15)) : WF=Deek(Start(15)+2) : HF=Deek(Start(15)+4)
   S=Start(15)+6
   For A=4 To WF*HF*NF Step 4 : Loke S-6,Leek(S) : Add S,4 : Next 
   TL=WF*NF
   Reserve As Work 401,WF*HF*NF : Reserve As Work 402,WF*NF*4+8
   Reserve As Work 403,WF*NF*4 : Reserve As Work 404,WF*NF*4
   S=TL : D=NF*WF*HF
   _N_MSG["",Catalog String$(511,"Eliminating repeated strips...")]
   NS=1 : F=Start(15)+HF : D=HF
   For X=1 To S-1
      Loke Start(405),Start(15) : Loke Start(405)+4,Start(15)+D-HF
      Loke Start(405)+8,F : Doke Start(405)+12,HF
      Call Start(405)+14 : P=Leek(Start(405))
      If P=-1
         Loke Start(402)+X*4,D/HF
         For A=0 To HF-4 Step 4 : Loke Start(15)+D+A,Leek(F+A) : Next : Add NS,1
         Add D,HF
      Else 
         Loke Start(402)+X*4,P/HF
      End If 
      Add F,HF
   Next 
   S=NS : D=D+Start(401) : U(0)=1 : _N_MSG["",Catalog String$(513,"Sorting strips...")]
   F=Start(15)
   For A=0 To S-1
      Z=0 : For L=0 To HF : If Peek(F+L)=0 Then Z=L+1 Else L=1000 : Next 
      T(A)=Z
      Z=HF : For L=HF-1 To 0 Step -1 : If Peek(F+L)=0 : Z=L Else L=-10 : End If : Next 
      B(A)=Z : Add F,HF
   Next 
   F=Start(15) : D=Start(401) : E=Start(15)+(S-1)*HF : B=HF-B(0)
   For A=0 To HF-1 : Poke D,Peek(F) : Add D,1 : Add F,1 : Next 
   TD=0
   For X=1 To S-1
      DIFF=200 : AD=0 : N=0
      For J=Start(15) To E Step HF
         If U(N)=0
            T=Abs(T(N)-B)
            If T<DIFF : DIFF=T : AD=J : NU=N : End If 
            If T=0 : J=E : End If 
         End If 
         Add N,1
      Next 
      U(NU)=1
      For A=0 To HF-4 Step 4
         Loke D+A,Leek(AD+A)
      Next 
      Loke Start(403)+NU*4,(D-Start(401))/HF : B=HF-B(NU) : Add D,HF
   Next 
   '
   TD=0 : _N_MSG["",Catalog String$(514,"Packing Strips...")]
   F=Start(401) : D=Start(401)+HF
   For A=0 To HF-1 : Poke Start(401)+A,Peek(Start(15)+A) : Next 
   Z=HF : For L=HF-1 To 0 Step -1 : If Peek(F+L)=0 : Z=L Else L=-10 : End If : Next 
   B=Z : Add F,HF
   For X=1 To S-1
      Z=0 : For L=0 To HF : If Peek(F+L)=0 : Z=L+1 Else L=1000 : End If : Next 
      T=Z : J=HF-B : K=Min(J,T) : TD=TD+Abs(J-T) : D=D-K : Z=HF
      For L=HF-1 To 0 Step -1 : If Peek(F+L)=0 : Z=L Else L=-10 : End If : Next 
      B=Z
      For A=0 To HF-1 : Poke D+A,Peek(F+A) : Next 
      Loke Start(404)+X*4,D-Start(401) : Add D,HF : Add F,HF
   Next 
   '
   MD=D-Start(401)
   '
   For A=0 To TL-1
      P=Leek(Start(402)+A*4)
      P=Leek(Start(403)+P*4)
      P=Leek(Start(404)+P*4)
      Loke Start(402)+A*4,P
   Next 
   '
   LF=MD : LF=LF/3 : LF=LF+64
   For A=0 To TL-1
      P=Leek(Start(402)+A*4)
      If P<=LF and(P+HF)>LF : FT=P : End If 
      If(P<=(LF+LF)) and((P+HF)>(LF+LF)) : ST=P : End If 
   Next 
   D=Start(15) : F=Start(401)
   For A=0 To MD : Poke Start(15)+A,0 : Next 
   For A=0 To FT+HF-1 : Doke D,Peek(F) : Add D,2 : Add F,1 : Next 
   F=F-HF : BIGD=D : D=Start(15)
   For A=FT To ST+HF-1
      C=Deek(D) : C=C+(Peek(F)*32) : Doke D,C : Add D,2 : Add F,1
   Next 
   BIGD=Max(BIGD,D) : F=F-HF : D=Start(15)
   For A=ST To MD+HF-1
      C=Deek(D) : C=C+(Peek(F)*32*32)
      Doke D,C : Add D,2 : Add F,1
   Next 
   BIGD=Max(BIGD,D)
   For A=0 To TL-1
      P=Leek(Start(402)+A*4)
      If P>=ST
         P=P-ST : P=P*2 : P=P+$2000000
      Else 
         If P>=FT
            P=P-FT : P=P*2 : P=P+$1000000
         Else 
            P=P*2
         End If 
      End If 
      Loke(Start(402)+A*4),P
   Next 
   Doke Bank End(402)-8,$FFFF
   Doke Bank End(402)-6,NF
   Doke Bank End(402)-4,WF
   Doke Bank End(402)-2,HF
   Trap Bsave F$+".wad",Start(15) To BIGD
   If Errtrap
      _ERROR[0,41,14]
   Else 
      Trap Wsave F$+".ptr",402
      If Errtrap
         _ERROR[0,41,14]
      End If 
   End If 
   Erase 401 : Erase 402 : Erase 403 : Erase 404 : Erase 405
   _R_N_MSG
End Proc
'
Procedure _TL_LEVELINTRO
   Dim W1$(1)

   W1$(0)=Catalog String$(2301,"Adjust=Left")
   W1$(1)=Catalog String$(2302,"Adjust=Center")

   Fill Start(15) To Start(15)+20992+256,$20202020
   _LOAD[15,"Ab3:includes/TEXT_FILE"]
   Reserve As Gt Gadgets 497,60,1
   _gt Set Mode 0,"",0,1
   _gt Set Listview Mode ,,,16,0,
   _gt Set Integer Mode 1,6,1,0
   _gt Set String Mode 1,20,1,0

   _wnd Id Open 8,0,128,_scr Id Width(1),240,$2+$8,F_IDCMP,0,""
   _gt Bevel Box 1,8,16,648,168,1
   For B=1 To 16
      A=_tag List Alloc(10)
      _tag Set A,$80030001,12 : Rem      GA_Left 
      _tag Set A,$80030003,B*10+11 : Rem GA_Top 
      _tag Set A,$80030005,640 : Rem     GA_Width 
      _tag Set A,$80030007,8 : Rem       GA_Height  
      _tag Set A,$80030024,True
      _tag Set A,$80030025,True
      _tag Set A,$80032001,80 : Rem      STRINGA_MaxChars
      _tag Set A,$80032013,True
      _tag Done A
      _gt Boopsi B,0,"strgclass",A
      _tag List Free A
   Next B
   _gt Cycle 20,8,194,160,12,,"",Array(W1$(0)),0
   _gt Button 21,168,194,128,12,,Catalog String$(2310,"Insert")
   _gt Button 22,296,194,128,12,,Catalog String$(2311,"Delete")

   _gt Text 30,8,220,288,12,,"","-",1
   _gt Button 31,296,220,64,12,,"<"
   _gt Button 32,360,220,64,12,,">"

   _gt Gadgets Attach 497
   _wnd Id Titles Catalog String$(760,"Set Level-Intro Texts"),VER$
   
   LEV=0 : CHFL=False
   Do 
      _gt Set Text 30,Peek$(LINK+$40+LEV*40,40,Chr$(0)),,,
      OC_L=-2
      Do 
         For A=0 To 15
            T$=Right Trim$(Peek$(Start(15)+A*82+LEV*1312+2,80))+_0$
            _tag Set ,$80032012,Varptr(T$)
            _tag Done 0
            DUM=_obj Set Attrs(_gt Base(A+1),_wnd Id Base(8),,)
         Next A
         Do 
            LEV_O=LEV
            AC=_wnd Id Next Event
            GA=_wnd Id Event Gadget
            If _wnd Id Event Wnd<>8 : AC=0 : End If 
            C_L=-1
            For A=1 To 16
               If _gad What Activation(_gt Base(A)) and $4000 : C_L=A-1 : End If 
            Next A
            If C_L>-1 and C_L<>OC_L
               _gt Set Cycle 20,,Deek(Start(15)+C_L*82+LEV*1312)
               LC_L=C_L
            End If 
            If AC=$40
               If GA=31 and LEV>0 : Dec LEV : Exit 2 : End If 
               If GA=32 and LEV<15 : Inc LEV : Exit 2 : End If 
               If GA=20 and LC_L>-1
                  If Deek(Start(15)+LC_L*82+LEV*1312)<>0
                     Doke Start(15)+LC_L*82+LEV*1312,0
                  Else 
                     Doke Start(15)+LC_L*82+LEV*1312,1
                  End If 
               End If 
               If GA=22 and LC_L>-1
                  For A=LC_L To 16
                     Poke$ Start(15)+A*82+LEV*1312,Peek$(Start(15)+(A+1)*82+LEV*1312,82)
                  Next A
                  Exit 
               End If 
               If GA=21 and LC_L>-1
                  For A=15 To LC_L Step -1
                     Poke$ Start(15)+(A+1)*82+LEV*1312,Peek$(Start(15)+(A)*82+LEV*1312,82)
                  Next A
                  Exit 
               End If 
            End If 

            OC_L=C_L
            Exit If AC=$200,2
            Multi Wait 
         Loop 
      Loop 
      For A=0 To 15
         W$=Peek$(_obj What Attr(_gt Base(A+1),$80032012),,_0$)
         Poke$ Start(15)+A*82+LEV_O*1312+2,Left$(W$+Space$(80),80)
      Next A
      Exit If AC=$200
   Loop 
   Trap Bsave "Ab3:includes/TEXT_FILE",Start(15) To Start(15)+20992
   If Errtrap=0 : _PACK["Ab3:includes/TEXT_FILE"] : CHFL=False : End If 
   _gt Gadgets Remove 497
   _wnd Id Close 8
   _gt Gadgets Erase 497
End Proc
Procedure _TL_PACKFILE
   _S_FILE[0,Catalog String$(762,"Select File to Pack"),"Ab3:","",""]
   F$=Param$
   If Exist(F$) and F$>""
      If File Length(F$)>20
         _N_MSG2["",0]
         Open In 1,F$
         W$=Input$(1,4)
         Close 1
         If W$<>"=SB="
            _PACK[F$]
         Else 
            _WRONG[1,11]
         End If 
         _R_N_MSG
      End If 
   End If 
End Proc
Procedure _TL_DPFILE
   _S_FILE[0,Catalog String$(763,"Select File to UnPack"),"Ab3:","",""]
   F$=Param$
   If Exist(F$) and F$>""
      If File Length(F$)>20
         _N_MSG2["",0]
         Open In 1,F$
         W$=Input$(1,4)
         Close 1
         If W$="=SB="
            Exec "SBDepack "+F$
         Else 
            _WRONG[1,12]
         End If 
         _R_N_MSG
      End If 
   End If 
End Proc
Procedure _TL_WALL2IFF
   _S_FILE[0,Catalog String$(764,"Select wall-graphic"),"AB3:WALLINC/","*.256wad",""]
   F$=Param$
   _LOAD[15,F$]
   T=Param
   If T
      WGH=Deek(Start(15)+T-2)
      WGWW=(((T-(64*32)-2)/WGH)*3)/2
      Trap _scr Id Open 2,0,0,WGWW,WGH,5,SCR_MODE and $FFFF1000,0,VER$
      If Errtrap=0
         For A=0 To 31
            C=Peek(Start(15)+A*2)
            C=(Deek(PALC+C*6))*256+(Deek(PALC+C*6+2))*16+(Deek(PALC+C*6+4))
            _scr Id Set Aga Pal A,C
         Next 
         AP=Start(15)+64*32
         For A=0 To WGWW-1 Step 3
            For B=0 To WGH-1
               C=Deek(AP) : Add AP,2
               _scr Id Ink C mod 32,0,0
               _scr Id Plot A,B
               _scr Id Ink(C/32) mod 32,0,0
               _scr Id Plot A+1,B
               _scr Id Ink(C/1024) mod 32,0,0
               _scr Id Plot A+2,B
            Next B
         Next A
         _scr Id Use 1
         _scr Id Show 1
         _S_FILE[1,Catalog String$(765,"Save Wall-IFF as:"),"ab3:graphics/walls","",""]
         F$=Param$
         If F$>" "
            _ILBM_TO_BANK[2,401]
            Trap Wsave F$,401
            If Errtrap : _WRONG[1,14] : End If 
         Else 
            _WRONG[1,14]
         End If 
         _scr Id Close 2
      End If 
   Else 
      _WRONG[1,13]
   End If 
   _scr Id Use 1 : _scr Id Show 1
   Amos To Back 
End Proc
Procedure _TL_FRAME2IFF
   _S_FILE[0,Catalog String$(770,"Select an object-frame-file"),"ab3:includes/","*.wad",""]
   F$=Param$
   M$=F$
   If Instr(Dr File$(F$),".") : F$=Left$(F$,Bw Instr(F$,".")-1) : End If 
   Erase 401 : Erase 402 : Erase 403
   _LOAD[401,F$+".256pal"]
   If Param
      _LOAD[402,F$+".wad"]
      _LOAD[403,F$+".ptr"]
      If Param
         W$="" : HOF=256
         WOF=Length(403)/4
         If Deek(Bank End(403)-8)=$FFFF
            NOFF=Deek(Bank End(403)-6)
            WOFF=Deek(Bank End(403)-4)
            HOFF=Deek(Bank End(403)-2)
            HOF=HOFF : WOF=NOFF*WOFF
         Else 
            If Exist(F$+".hqn")
               Trap Open In 1,F$+".hqn"
               If Errtrap=0
                  W$=Input$(1,6)
               End If 
               Trap Close 1
            Else If Exist(F$+".dat")
               Trap Open In 1,F$+".hqn"
               If Errtrap=0
                  W$=Input$(1,6)
               End If 
               Trap Close 1
            End If 
            If W$>""
               NOFF=_val.w(Mid$(W$,1,2))
               WOFF=_val.w(Mid$(W$,3,2))
               HOFF=_val.w(Mid$(W$,5,2))
               HOF=HOFF
            End If 
         End If 
         Trap _scr Id Open 2,0,0,WOF,HOF,5,SCR_MODE and $FFFF1000,0,VER$
         If Errtrap=0
            For A=0 To 31
               C=Peek(Start(401)+A*2)
               R=Deek(PALC+C*6) : G=Deek(PALC+2+C*6) : B=Deek(PALC+4+C*6)
               _scr Id Set Aga Pal A,R*$100+G*$10+B
            Next 
            For WA=0 To WOF
               OF=Leek(Start(403)+WA*4)
               If OF>=$2000000 : SS=2
               Else If OF>=$1000000 : SS=1
               Else : SS=0
               End If 
               OF=OF and $FFFFFF
               AP=Start(402)+OF
               For WB=0 To HOF-1
                  C=Deek(AP) : Add AP,2
                  If SS=0 : _scr Id Ink C mod 32,0,0 : End If 
                  If SS=1 : _scr Id Ink(C/32) mod 32,0,0 : End If 
                  If SS=2 : _scr Id Ink(C/1024) mod 32,0,0 : End If 
                  _scr Id Plot WA,WB
               Next WB
            Next WA
            _scr Id Use 1 : _scr Id Show 1
            _S_FILE[1,Catalog String$(771,"Save Object Graphics"),"ab3:graphics/","",""]
            F$=Param$
            If F$>" "
               _ILBM_TO_BANK[2,401]
               Trap Wsave F$,401
               If Errtrap : _WRONG[1,14] : End If 
            Else 
               _WRONG[1,14]
            End If 
            _scr Id Close 2
         End If 
      Else 
         _WRONG[1,13]
      End If 
      Erase 401
   Else 
      _WRONG[1,13]
   End If 
   _scr Id Use 1
   _scr Id Show 1
   Amos To Back 
End Proc
Procedure _TL_FIB2SAMPLE
   '
   ' Depacker setup 
   '
   _S_FILE[0,Catalog String$(772,"Select a packed sample"),"ab3:samples/","*.fib",""]
   F$=Param$
   Dim F(15),DIFF(512)
   Pt Sam Stop %11
   Erase 401
   _LOAD[401,F$]
   If Param
      If Peek$(Start(401),4)="CSFX"
         F(0)=-34 : F(1)=-21 : F(2)=-13 : F(3)=-8 : F(4)=-5 : F(5)=-3 : F(6)=-2
         F(7)=-1 : F(8)=0 : F(9)=1 : F(10)=2 : F(11)=3 : F(12)=5 : F(13)=8
         F(14)=13 : F(15)=21
         For N=-256 To 256
            D=Abs(F(0)-N) : F=0
            For FF=1 To 15
               If Abs(F(FF)-N)<D : D=Abs(F(FF)-N) : F=FF : End If 
            Next 
            DIFF(N+256)=F
         Next 
         Reserve As Chip Work 402,Leek(Start(401)+4)
         B=Start(402) : V=Peek(Start(401)+8)
         If Btst(7,V) : V=V or $FFFFFF00 : End If 
         For A=Start(401)+9 To Bank End(401)-1
            WD1=Peek(A)/16
            WD2=Peek(A) mod 16
            If Btst(7,WD1) : WD1=WD1 or $FFFFFF00 : End If 
            If Btst(7,WD2) : WD2=WD2 or $FFFFFF00 : End If 
            Poke B,V : Inc B : V=V+F(WD1)
            Poke B,V : Inc B : V=V+F(WD2)
         Next 
      Else 
         Reserve As Chip Work 402,Length(401)
         Copy Start(401),Bank End(401) To Start(402)
      End If 
      _S_FILE[1,Catalog String$(773,"Save Sample as"),"ab3:sounds/","",""]
      F$=Param$
      If F$>" "
         Trap Bsave F$,Start(402) To Bank End(402)
         If Errtrap : _WRONG[1,14] : End If 
      Else 
         _WRONG[1,14]
      End If 
   Else 
      _WRONG[1,13]
   End If 
   Erase 402 : Erase 401
   Amos To Back 
End Proc
Procedure _TL_IFF2WALL
   _S_FILE[0,Catalog String$(563,"Load Wall Picture"),"ab3:graphics/walls","",""]
   F$=Param$
   If Exist(F$) and F$<>""
      Erase 401
      Trap Wload F$,401
      If Errtrap=0
         _ILBM_FROM_BANK[2,401,%1]
         If Param=0
            FA$=F$
            F$=Dr File$(F$)
            SW=_scr Id Width(2) : SH=_scr Id Height(2)
            _scr Id Use 1 : _scr Id Show 1

            Reserve As Gt Gadgets 497,10,1
            _gt Set Integer Mode 1,6,1,0

            _gt Text 7,8,14,196,12,,"",Catalog String$(564,"Width of chunk"),0
            _gt Text 8,8,28,196,12,,"",Catalog String$(565,"Height of chunk"),0
            _gt Integer 1,204,14,64,12,0,"",SW,1
            _gt Integer 2,204,28,64,12,0,"",SH,1
            _gt Button 3,204,42,64,12,,"OK"

            _wnd Id Open 8,128,20,268,46,$2,F_IDCMP,497,".."
            _wnd Id Titles Catalog String$(563,"Load Wall Picture"),VER$
            Do 
               EV=_wnd Id Next Event
               GA=_wnd Id Event Gadget
               If EV=$40 and GA=3 and _wnd Id Event Wnd=8 : Exit : End If 
               Multi Wait 
            Loop 
            H=_gt What Integer(2)
            W=_gt What Integer(1)
            _gt Gadgets Remove 497
            _wnd Id Close 8
            _gt Gadgets Erase 497
            H=Min(H,SH)
            If W>640 : _WRONG[20,0] : End If 
            Reserve As Work 401,32*32*2+H*W+2
            NOL=W/3 : X=0 : Y=0 : AP=Start(401)
            _GL_IGETPAL[2,AP]
            AP=Start(401)+64*32
            '
            '  Get Points
            '  
            _scr Id Use 2
            _scr Id Show 2
            D=AP
            X=0 : Y=0
            _scr Id Ink 0,0,0
            For L=0 To NOL
               For V=0 To H-1
                  C1=_scr Id Point(X,Y+V)
                  C2=_scr Id Point(X+1,Y+V)*32
                  C3=_scr Id Point(X+2,Y+V)*32*32
                  Doke D,C1+C2+C3
                  _scr Id Plot X,Y+V
                  _scr Id Plot X+1,Y+V
                  _scr Id Plot X+2,Y+V
                  Add D,2
               Next 
               Add X,3
               If X>=_scr Id Width(2) : X=X-_scr Id Width(2) : Y=Y+H : End If 
            Next 
            Doke D,H : Add D,2
            _S_FILE[1,Catalog String$(566,"Select Save Name"),"ab3:WallInc/","*.256wad",F$+".256wad"]
            F$=Param$
            If F$<>""
               If Up Case$(Right$(F$,7))<>".256WAD" : F$=F$+".256wad" : End If 
               Trap Bsave F$,Start(401) To D
               If Errtrap=0 : _PACK[F$] : End If 
            End If 
         End If 
         Trap _scr Id Close 2
      End If 
   End If 
   _scr Id Use 1 : _scr Id Show 1
   Erase 401
   Amos To Back 
End Proc
Procedure _TL_BUILDARCHIVE
   Dim W1$(2)
   W1$(0)="LhA"
   W1$(1)="LZx"
   W1$(2)="Custom"
   _wnd Id Open 8,0,20,600,232,$2+$8,F_IDCMP,0,"Levels.."

   '  
   ' Set title of window, and the screen title when window is active
   '
   _wnd Id Titles Catalog String$(1205,"Build Archive"),VER$
   _wnd Id Activate 8

   '
   ' Prepare for gadgets
   ' Bank 497 is reserved for 30 gadgets to be used on screen 1 
   '
   Reserve As Gt Gadgets 497,40,1
   _gt Set Mode 0,"",0,1

   _gt Bevel Box 2,16,16,112,224,1
   _gt Text 20,32,20,80,10,,"",Catalog String$(2100,"Levels:"),0
   For A=0 To 15
      _gt Checkbox A+1,100,A*12+32,12,12,,Chr$(A+65),0
   Next A

   _gt Bevel Box 2,144,16,272,224,1
   _gt Text 23,160,20,80,10,,"",Catalog String$(2103,"Options:"),0
   _gt Checkbox 31,388,32,12,12,,Catalog String$(2101,"Include Developer files:"),0
   _gt Checkbox 32,388,44,12,12,,Catalog String$(2102,"Include Game-SetUp:"),0

   _gt Bevel Box 2,432,16,160,192,1
   _gt Text 24,448,20,80,10,,"",Catalog String$(2104,"Archiver:"),0
   _gt Mx 22,564,32,12,12,,"",Array(W1$(0)),6

   _gt Button 21,432,228,160,12,,"Ok"
   '
   ' Use gadgets
   '
   _gt Gadgets Attach 497

   P_LEVELS=0
   P_GEN=%10
   P_PACK=0
   ESC=False
   Do 
      For A=0 To 15
         If Btst(A,P_LEVELS) : _gt Set Checkbox A+1,1 : Else _gt Set Checkbox A+1,0 : End If 
      Next A
      For A=0 To 1
         If Btst(A,P_GEN) : _gt Set Checkbox A+31,1 : Else _gt Set Checkbox A+31,0 : End If 
      Next A
      _gt Set Mx 22,P_PACK
      Do 
         '
         ' Wait for event 
         '
         EV=_wnd Id Next Event
         GA=_wnd Id Event Gadget
         KS=_wnd Id Event Qualifier and %111
         KY=_wnd Id Event Code
         '
         ' If gadget pushed 
         '
         If EV=$40
            If KY=95 : _SHOW_AG["BuildArchive"] : End If 
            If Between(0,GA,17)
               Bchg GA-1,P_LEVELS : Exit 
            End If 
            If Between(30,GA,47)
               Bchg GA-31,P_GEN : Exit 
            End If 
            If GA=21 : ESC=False : Exit 2 : End If 
         End If 
         If EV=$20
            If GA=22 : P_PACK=KY : Exit : End If 
         End If 
         If EV=$400
            If KY=95 : _SHOW_AG["BuildArchive"] : End If 
         End If 
         If EV=$200 : ESC=True : Exit 2 : End If 
         Multi Wait 
      Loop 
   Loop 
   '
   ' Remove gadgets 
   '
   _gt Gadgets Remove 497
   '
   ' Close down window, screen and erase gadgets from memory..
   '
   _wnd Id Close 8
   _gt Gadgets Erase 497
   '
   If ESC : Pop Proc : End If 
   If P_PACK=0
      ARC$="LhA a -x %a %f"
   Else If P_PACK=1
      ARC$="Lzx a -x %a %f"
   Else 
      ARC$=CPACK$
   End If 
   '
   _S_FILE[1,Catalog String$(2149,"Select Archive Name:"),"Ab3:","",""]
   AF$=Param$
   If AF$="" : Pop Proc : End If 

   ARC$=Replacestr$(ARC$,"%a" To Chr$(34)+AF$+Chr$(34))

   _N_MSG[Catalog String$(2148,"Doing Levels:"),""]
   '
   ' Do the Levels
   '
   LP$=Peek$(LINK,64,Chr$(0))
   If LP$="" : LP$="ab3:Levels/" : End If 
   For A=0 To 15
      If Btst(A,P_LEVELS)
         W1$=LP$+"LEVEL_"+Chr$(A+65)+"/twolev."
         _gt Set Text 1,W1$,,,
         W$=Replacestr$(ARC$,"%f" To Chr$(34)+W1$+"bin"+Chr$(34)) : Exec W$
         W$=Replacestr$(ARC$,"%f" To Chr$(34)+W1$+"clips"+Chr$(34)) : Exec W$
         W$=Replacestr$(ARC$,"%f" To Chr$(34)+W1$+"flymap"+Chr$(34)) : Exec W$
         W$=Replacestr$(ARC$,"%f" To Chr$(34)+W1$+"graph.bin"+Chr$(34)) : Exec W$
         W$=Replacestr$(ARC$,"%f" To Chr$(34)+W1$+"map"+Chr$(34)) : Exec W$
         If Btst(0,P_GEN)
            W$=Replacestr$(ARC$,"%f" To Chr$(34)+W1$+"dat"+Chr$(34)) : Exec W$
            W$=Replacestr$(ARC$,"%f" To Chr$(34)+W1$+"links"+Chr$(34)) : Exec W$
            W$=Replacestr$(ARC$,"%f" To Chr$(34)+W1$+"obj"+Chr$(34)) : Exec W$
         End If 
      End If 
   Next A
   '
   ' Do the Game-SetUp
   '
   If Btst(1,P_GEN)
      Gosub BA_G_SET
   End If 
   _R_N_MSG
Pop Proc

BA_G_SET:
   _N_MSG[Catalog String$(2147,"Doing Game-SetUp:"),""]
   Reserve As Work 402,100000
   _LOAD[402,"Ab3:Includes/test.lnk"]
   Do 
      Read W
      Exit If W=-1
      If W>0
         G=W
         Read WB,WS
         GNR=0
      Else 
         Read WF$,WCHK,WLEN
         WF$=Up Case$(WF$)
         WM=False
         If WB>0
            WF2$=Peek$(Start(402)+WB,100,Chr$(0))
            WF2$=Up Case$(WF2$)
            WF2$=Replacestr$(WF2$,"TKG1:" To "AB3:")
            WF2$=Replacestr$(WF2$,"TKG2:" To "AB3:")
            WF2$=Replacestr$(WF2$,"SFX:" To "AB3:")
            If G=7 : WF2W$=WF2$+".WAD" : Else WF2W$=WF2$ : End If 
            If WF$=WF2W$ : WM=True : End If 
         Else 
            WF2$=WF$ : WM=True : WF2W$=WF2$
         End If 
         _gt Set Text 1,WF2W$,,,
         WFL=0
         If Exist(WF2W$)
            WFL=File Length(WF2W$)
         End If 
         If WM
            If WFL<>WLEN
               WM=False
            Else If WFL>0
               Erase 401
               _LOAD[401,WF2W$]
               WC=Bank Checksum(401)
               Erase 401
               If WC<>WCHK
                  WM=False
               End If 
            End If 
         End If 
         If WM=False and WFL>0
            If G=3
               W$=Replacestr$(ARC$,"%f" To Chr$(34)+WF2$+".pal"+Chr$(34))
               Exec W$
            End If 
            If G=7
               W$=Replacestr$(ARC$,"%f" To Chr$(34)+WF2$+".256pal"+Chr$(34))
               Exec W$
               W$=Replacestr$(ARC$,"%f" To Chr$(34)+WF2$+".wad"+Chr$(34))
               Exec W$
               W$=Replacestr$(ARC$,"%f" To Chr$(34)+WF2$+".ptr"+Chr$(34))
               Exec W$
            End If 
            W$=Replacestr$(ARC$,"%f" To Chr$(34)+WF2W$+Chr$(34))
            Exec W$
         End If 
         Add WB,WS
         Inc GNR
      End If 
   Loop 
Return 

   Data 1,-1,0
   Data 0,"ab3:includes/test.lnk",$AF04D976,7192
   Data 0,"ab3:includes/text_file",$2982A4FC,6071
   Data 0,"ab3:includes/rawbackpacked",$1BB054DB,30612

   Data 2,$1940,0
   Data 0,"ab3:includes/floortile",$E1E1C5D4,38781

   Data 3,$1980,0
   Data 0,"ab3:includes/newtexturemaps",$2EB818AC,76311

   Data 4,85184,64
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301
   Data 0,"ab3:music/packedtest",$5C2756E6,9301

   Data 5,$13FE0,64
   Data 0,"ab3:vectobj/generator",$7360B40E,1610
   Data 0,"ab3:vectobj/switch",$FD0FB39B,866
   Data 0,"ab3:vectobj/passkey",$750F784C,869
   Data 0,"ab3:vectobj/blaster",$1BCC640D,5165
   Data 0,"ab3:vectobj/shotgun",$E639D179,2735
   Data 0,"ab3:vectobj/plink",$B20DD6DD,5740
   Data 0,"ab3:vectobj/plasmagun",$72844377,2879
   Data 0,"ab3:vectobj/glarebox",$6A905C31,302
   Data 0,"ab3:vectobj/ventfan",$2ACE3F21,754
   Data 0,"ab3:vectobj/snake",$ECB78F01,506
   Data 0,"ab3:vectobj/rifle",$1FC37523,4001
   Data 0,"ab3:vectobj/passkey",$750F784C,869
   Data 0,"ab3:vectobj/grenadelauncher",$974D2310,3026
   Data 0,"ab3:vectobj/wasp",$23EB8988,5736
   Data 0,"ab3:vectobj/mantis",$46BB8C62,14318
   Data 0,"ab3:vectobj/crab",$E607FF54,6215
   Data 0,"ab3:vectobj/passkey",$750F784C,869
   Data 0,"ab3:vectobj/rocketlauncher",$117BED2B,4256
   Data 0,"ab3:vectobj/scenery",$99637972,281
   Data 0,"ab3:vectobj/laser",$B77A4DC3,2558
   Data 0,"ab3:vectobj/jetpack",$1DF68A46,450
   Data 0,"ab3:vectobj/charger",$834A1F3B,106
   Data 0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0

   Data 6,$14760,64
   Data 0,"ab3:wallinc/stonewall.256wad",$ADAF024D,7491
   Data 0,"ab3:wallinc/brownpipes.256wad",$2BE99F7C,9643
   Data 0,"ab3:wallinc/hullmetal.256wad",$CD7DD074,15012
   Data 0,"ab3:wallinc/technotritile.256wad",$2E322660,16151
   Data 0,"ab3:wallinc/brownspeakers.256wad",$6C575292,3608
   Data 0,"ab3:wallinc/chevrondoor.256wad",$723EF86B,6907
   Data 0,"ab3:wallinc/technolights.256wad",$1A7F3208,7816
   Data 0,"ab3:wallinc/redhullmetal.256wad",$3722892B,5029
   Data 0,"ab3:wallinc/alienredwall.256wad",$8FD73240,17637
   Data 0,"ab3:wallinc/gieger.256wad",$8E8D30C6,31034
   Data 0,"ab3:wallinc/rocky.256wad",$40EE2F9E,40263
   Data 0,"ab3:wallinc/steampunk.256wad",$3A5F2D60,29177
   Data 0,"ab3:wallinc/brownstonestep.256wad",$C4498A82,1904
   Data 0,"",0,0,0,"",0,0,0,"",0,0

   Data 7,$2C0,64
   Data 0,"ab3:includes/alien2.wad",$3D08C64B,11072
   Data 0,"ab3:includes/pickups.wad",$4DF5FFD0,4422
   Data 0,"ab3:includes/bigbullet.wad",$2A32DB6C,2877
   Data 0,"ab3:hqn/triclaw.wad",$8674A9A8,3958
   Data 0,"ab3:includes/explosion.wad",$B3213160,15159
   Data 0,"ab3:includes/keys.wad",$F4CEEA80,65
   Data 0,"ab3:hqn/ashnarg.wad",$BD9963D1,51560
   Data 0,"ab3:includes/lamps.wad",$804B6C63,470
   Data 0,"ab3:includes/glare.wad",$CE932EB9,7785
   Data 0,"ab3:includes/rockets.wad",$C4788E1E,2637
   Data 0,"ab3:includes/splutch.wad",$DBC5B9FB,1376
   Data 0,"ab3:hqn/guard.wad",$265FD830,25951
   Data 0,"ab3:hqn/priest.wad",$72DFA341,21249
   Data 0,"ab3:hqn/insect.wad",$DD4BD6EB,37284
   Data 0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0
   Data 0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0

   Data 8,$A40,64
   Data 0,"ab3:samples/scream.fib",$F02B2FF0,1663
   Data 0,"ab3:samples/fire!.fib",$40AFC8BA,3196
   Data 0,"ab3:samples/door01.fib",$C8AC1206,2723
   Data 0,"ab3:samples/shoot.dm.fib",$253B0F12,2209
   Data 0,"ab3:samples/collect.fib",$7C230B86,1623
   Data 0,"ab3:samples/newdoor.fib",$6DE250AA,3323
   Data 0,"ab3:samples/splash.fib",$25D3E3FE,3689
   Data 0,"ab3:samples/footstep3.fib",$BB8C698A,1678
   Data 0,"ab3:samples/lowscream.fib",$45E3A575,4021
   Data 0,"ab3:samples/baddiegun.fib",$7CB4A1BB,2807
   Data 0,"ab3:samples/switch.fib",$7B9F059E,609
   Data 0,"ab3:samples/switch1.sfx.fib",$1FA93706,1947
   Data 0,"ab3:samples/noammo.fib",$CEC2733E,1116
   Data 0,"ab3:samples/splotch.fib",$6DCF955F,1876
   Data 0,"ab3:samples/splatpop.fib",$13EE3BA3,2692
   Data 0,"ab3:samples/boom.fib",$354CFDDB,5020
   Data 0,"ab3:samples/rumblewind.fib",$FE5416E5,5052
   Data 0,"ab3:samples/howl1.fib",$CE01C07E,2854
   Data 0,"ab3:samples/howl2.fib",$F317AC5B,3464
   Data 0,"ab3:samples/pant.fib",$CE3792A3,2295
   Data 0,"ab3:samples/spineshiver.fib",$2EC66A47,5618
   Data 0,"ab3:samples/shotgun.fib",$20A0DE2D,4166
   Data 0,"ab3:samples/dooropen.fib",$8DA92580,1587
   Data 0,"ab3:samples/muffledfoot.fib",$6B28042C,307
   Data 0,"ab3:samples/footclop.fib",$E7910453,443
   Data 0,"ab3:samples/footclank.fib",$8FE0428D,817
   Data 0,"ab3:samples/teleport.fib",$1319519E,7252
   Data 0,"ab3:samples/backrumble.fib",$1C445D47,5125
   Data 0,"ab3:samples/blasterzap.fib",$6D93E42A,2406
   Data 0,"ab3:samples/metalsqueak.fib",$A9FC14CD,5373
   Data 0,"ab3:samples/lazerzap.fib",$B2004EF2,3104
   Data 0,"ab3:samples/doorclunk.fib",$7A56559A,4111
   Data 0,"ab3:samples/footclankecho.fib",$A0897C77,982
   Data 0,"ab3:samples/footclopecho.fib",$B9F32BF3,1003
   Data 0,"ab3:samples/grindmetal.fib",$2391632B,5980
   Data 0,"ab3:samples/shortminor.fib",$5863ED44,3729
   Data 0,"ab3:samples/woodblock.fib",$79FDD8EB,2920
   Data 0,"ab3:samples/harpsichord.fib",$8BF3AF90,3545
   Data 0,"ab3:samples/roarhowl.fib",$C662F919,8042
   Data 0,"ab3:samples/shimmybibble.fib",$EE7DE9D3,3078
   Data 0,"ab3:samples/gurgle.fib",$9332C78E,5379
   Data 0,"ab3:samples/knifeedge.fib",$DD87383E,7252
   Data 0,"ab3:samples/quickchord.fib",$6142CFB6,3123
   Data 0,"ab3:samples/LongHighChord.fib",$AF54BB2A,6703
   Data 0,"ab3:samples/gong.fib",$CB18932,2947
   Data 0,"ab3:samples/twotone.fib",$1FD217D4,4543
   Data 0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0
   Data 0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0,0,"",0,0
   Data -1
End Proc
'
'
Procedure _TL_ED_CFLOOR
   _TIDYDEF
   _CLOSE_MAINSCREEN
   F$=Peek$(LINK+$1940,64,Chr$(0))
   _FLOOR2SCREEN[F$]
   If Param
      _ILBM_TO_BANK[2,401]
      _scr Id Close 2
      Trap Wsave "T:Work.IFF",401
      Erase 401
      _TL_CALL_PAINT
      If Param
         Trap Wload "T:Work.IFF",401
         If Errtrap=0
            _ILBM_FROM_BANK[2,401,%1]
            If Param=0
               _scr Id Use 2
               _SCREEN2FLOOR
               Trap Bsave F$,Start(15) To Start(15)+65536
               _PACK[F$]
            End If 
            Trap _scr Id Close 2
         End If 
      End If 
   End If 
   Amos To Back 
   _INIT_MSCREEN
   _REDRAW : _INITDEF
   MSHOW=1 : _wnd Id Activate 9
End Proc
Procedure _TL_CALL_PAINT
   E=True
   Open Out 1,"T:AB-tst"
   Print #1,"DUMMY"
   Close 1
   Open Out 1,"t:AB-Led1"
   Print #1,"FailAt 10000"+Chr$(10);
   Print #1,Replacestr$(P_PRG$,"%f" To "T:Work.IFF")+Chr$(10);
   Print #1,"Delete >nil: T:AB-tst"+Chr$(10);
   Print #1,"Endcli"+Chr$(10);
   Close 1
   Exec "Newcli from t:AB-Led1"
   WA=Eliconify Begin(0,12,VER$)
   If WA=0
      Repeat 
         For WB=0 To 10 : Multi Wait : Next WB
         If Eliconify Test : E=False : Exit : End If 
      Until Exist("T:AB-tst")=0
      Trap Eliconify End 
   End If 
End Proc[E]
'
'
Procedure _TL_N_FLOOR2IFF
   '
   '
   '
   _S_FILE[0,Catalog String$(766,"Select a Floorfile:"),"Ab3:Includes","",Dr File$(Peek$(LINK+$1940,64,Chr$(0)))]
   F$=Param$
   _FLOOR2SCREEN[F$]
   If Param
      _scr Id Show 1
      _S_FILE[1,Catalog String$(778,"Save IFF as:"),"Ab3:graphics/floors","","Floor.iff"]
      F$=Param$
      If F$>" "
         _ILBM_TO_BANK[2,401]
         Trap Wsave F$,401
      End If 
      _scr Id Close 2
   End If 
   _scr Id Show 1
End Proc
Procedure _FLOOR2SCREEN[F$]
   E=False
   _LOAD[15,F$]
   If Param=65536
      E=True
      Trap _scr Id Open 2,0,0,320,256,8,SCR_MODE and $FFFF1000,0,VER$
      If Errtrap : E=False : End If 
      If E
         _PAL2ISCREEN[2]
         _scr Id Cls 0
         ADR=Start(15) : NR=0
         For NR=0 To 15
            S=ADR+(NR mod 4)+((NR/4) and 3)*256+(NR/16)*65536
            For WX=0 To 63
               For WY=0 To 63
                  _scr Id Ink Peek(S+WX*4+WY*1024),0,0
                  _scr Id Plot(WX)+(NR mod 5)*64,(WY)+(NR/5)*64
               Next WY
            Next WX
         Next NR
      End If 
   End If 
End Proc[E]
Procedure _TL_N_IFF2FLOOR
   _S_FILE[0,Catalog String$(779,"Load Floor-IFF:"),"Ab3:graphics/floors","","Floor.iff"]
   F$=Param$
   If F$>" " and Exist(F$)
      If File Type(F$)<0 : E=True : End If 
      If E
         Trap _scr Id Open 2,0,0,656,256,8,SCR_MODE,0,"Alien Breed 3D II Editor"
         If Errtrap : E=False : End If 
      End If 
      If E
         _scr Id Cls 0
         _PAL2ISCREEN[2]
         SCR=_scr Id Base(2)
         _SCR_ID_LOAD[2,F$,False]
      End If 
      If E
         ADR=Start(15) : NR=0
         For NR=0 To 15
            S=ADR+(NR mod 4)+((NR/4) and 3)*256+(NR/16)*65536
            For WX=0 To 63
               For WY=0 To 63
                  Poke S+WX*4+WY*1024,_scr Id Point(WX+(NR mod 5)*64,WY+(NR/5)*64)
               Next WY
            Next WX
         Next NR
      End If 
      If SCR
         _scr Id Close 2
         If E
            _scr Id Show 1
            _S_FILE[1,Catalog String$(544,"Select Savefile"),"Ab3:Includes","","Floortile"]
            F$=Param$
            If F$>" "
               Trap Bsave F$,Start(15) To Start(15)+65536
               _PACK[F$]
            End If 
         End If 
      End If 
   End If 
   _scr Id Use 1
   _scr Id Show 1
End Proc
Procedure _SCREEN2FLOOR
   ADR=Start(15) : NR=0
   For NR=0 To 15
      S=ADR+(NR mod 4)+((NR/4) and 3)*256+(NR/16)*65536
      For WX=0 To 63
         For WY=0 To 63
            Poke S+WX*4+WY*1024,_scr Id Point(WX+(NR mod 5)*64,WY+(NR/5)*64)
         Next WY
      Next WX
   Next NR
   Erase 700
End Proc[65536]
Procedure _TL_N_TEXT2IFF
   '
   '
   '
   _S_FILE[0,Catalog String$(768,"Select A Texturefile:"),"Ab3:Includes","","NewTexturemaps"]
   F$=Param$
   _LOAD[15,F$]
   If Param=65536*2
      E=True
      Trap _scr Id Open 2,0,0,320,512,8,SCR_MODE,0,VER$
      If Errtrap : E=False : End If 
      If E
         _PAL2ISCREEN[2]
         MSCREENR=_scr Id Rport(2)
         ADR=Start(15) : NR=0
         For NR=0 To 31
            S=ADR+(NR mod 4)+((NR/4) and 3)*256+(NR/16)*65536
            For WX=0 To 63
               For WY=0 To 63
                  _rp A Pen MSCREENR,Peek(S+WX*4+WY*1024)
                  _rp Plot MSCREENR,(WX)+(NR mod 5)*64,(WY)+(NR/5)*64
               Next WY
            Next WX
         Next NR
         _scr Id Show 1
         _S_FILE[1,Catalog String$(778,"Save IFF as:"),"Ab3:graphics/textures","","Textures.iff"]
         F$=Param$
         If F$>" "
            _I_SAVEIFFPIC[_scr Id Base(2),F$]
         End If 
         _scr Id Close 2
      End If 
   End If 
   Amos To Back : _scr Id Show 1
End Proc
Procedure _TL_N_IFF2TEXT
   _S_FILE[0,Catalog String$(780,"Load Texture-IFF:"),"Ab3:graphics/Textures","","Textures.iff"]
   F$=Param$
   If F$>" " and Exist(F$)
      If File Type(F$)<0 : E=True : End If 
      If E
         Trap _scr Id Open 2,0,0,656,512,8,SCR_MODE,0,VER$
         If Errtrap : E=False : End If 
      End If 
      If E
         _scr Id Cls 0
         _PAL2ISCREEN[2]
         SCR=_scr Id Base(2)
         _SCR_ID_LOAD[2,F$,False]
      End If 
      If E
         MSCREENR=_scr Id Rport(2)
         ADR=Start(15) : NR=0
         For NR=0 To 31
            S=ADR+(NR mod 4)+((NR/4) and 3)*256+(NR/16)*65536
            For WX=0 To 63
               For WY=0 To 63
                  Poke S+WX*4+WY*1024,_rp Point(MSCREENR,WX+(NR mod 5)*64,WY+(NR/5)*64)
               Next WY
            Next WX
         Next NR
      End If 
      If SCR
         _scr Id Close 2
         If E
            _scr Id Show 1
            _S_FILE[1,Catalog String$(544,"Select Savefile"),"Ab3:Includes","","NewTexturemap"]
            F$=Param$
            If F$>" "
               Trap Bsave F$,Start(15) To Start(15)+65536*2
               _PACK[F$]

               _LOAD[15,"ab3:includes/textpal.backup"]
               L=Param
               If L=0
                  _LOAD[15,"ab3:includes/newtexturemaps.pal"]
                  L=Param
               End If 

               If L=0
                  _TL_BUILDGLARE
               Else 
                  N=Start(15)+L
               End If 
               Bsave "ab3:includes/textpal.backup",Start(15) To N
               Bsave F$+".pal",Start(15) To N
               _PACK[F$+".pal"]
            End If 
         End If 
      End If 
   End If 
   _scr Id Show 1
End Proc
Procedure _TL_N_BACK2IFF
   '
   '
   '
   _LOAD[15,"Ab3:Includes/rawbackpacked"]
   If Param>150000
      E=True
      Trap _scr Id Open 2,0,0,656,240,8,SCR_MODE,0,VER$
      If Errtrap : E=False : End If 
      If E
         _scr Id Show 2
         _PAL2ISCREEN[2]
         _scr Id Cls 0
         MSCREENR=_scr Id Rport(2)
         ADR=Start(15) : NR=0
         For WX=0 To 655
            For WY=0 To 239
               _rp A Pen MSCREENR,Peek(ADR+WX*240+WY)
               _rp Plot MSCREENR,WX,WY
            Next WY
         Next WX
         _scr Id Show 1
         _S_FILE[1,Catalog String$(778,"Save IFF as:"),"Ab3:graphics","","Back.iff"]
         F$=Param$
         If F$>" "
            _I_SAVEIFFPIC[_scr Id Base(2),F$]
         End If 
         _scr Id Close 2
      End If 
   End If 
   _scr Id Show 1
End Proc
Procedure _TL_N_IFF2BACK
   E=False
   _S_FILE[0,Catalog String$(781,"Load Backdrop-IFF:"),"Ab3:graphics","#?","Back.iff"]
   F$=Param$
   If F$>" " and Exist(F$)
      If File Type(F$)<0 : E=True : End If 
      If E
         Trap _scr Id Open 2,0,0,680,260,8,SCR_MODE,0,VER$
         If Errtrap : E=False : End If 
      End If 
      If E
         _scr Id Show 2
         _PAL2ISCREEN[2]
         SCR=_scr Id Base(2)
         _SCR_ID_LOAD[2,F$,False]
      End If 
      If E
         MSCREENR=_scr Id Rport(2)
         ADR=Start(15) : NR=0
         For WX=0 To 656
            For WY=0 To 240
               Poke ADR+WX*240+WY,_rp Point(MSCREENR,WX,WY)
            Next WY
         Next WX
      End If 
      If SCR
         _scr Id Close 2
         _scr Id Show 1
         If E
            _S_FILE[1,Catalog String$(544,"Select Savefile"),"Ab3:Includes","","Rawbackpacked"]
            F$=Param$
            If F$>" "
               Trap Bsave F$,Start(15) To Start(15)+155520
               _PACK[F$]
            End If 
         End If 
      End If 
   End If 
End Proc
Procedure _TL_N_SAMP2FIB
   '
   ' Setup the sample converter.. 
   '
   Dim F(63),DIFF(512)
   F(0)=-34 : F(1)=-21 : F(2)=-13 : F(3)=-8 : F(4)=-5 : F(5)=-3 : F(6)=-2
   F(7)=-1 : F(8)=0 : F(9)=1 : F(10)=2 : F(11)=3 : F(12)=5 : F(13)=8
   F(14)=13 : F(15)=21
   For N=-256 To 256
      D=Abs(F(0)-N) : F=0
      For FF=1 To 15 : If Abs(F(FF)-N)<D : D=Abs(F(FF)-N) : F=FF : End If : Next 
      DIFF(N+256)=F
   Next 
   _S_FILE[0,Catalog String$(583,"Please select a sample to convert"),"ab3:sounds/","",""]
   F$=Param$
   SAMRATE=-1 : SAMLEN=-1
   If Exist(F$)
      _LOADSAM[F$,401]
      R=Param
      If R
         SAMRATE=R : SAMLEN=Length(401) : A=Start(401)
         Dme Sam Raw %1111,Start(401),Length(401),R
      Else 
         Reserve As Work 401,File Length(F$)
         Trap Bload F$,401
         TYPE$="RAW (?)" : A=Start(401) : SAMLEN=Length(401)
      End If 
      D$=Dr Path$(F$) : FF$=Dr File$(F$)
      SAMSTART=A : Reserve As Work 402,SAMLEN
      B=Start(402)
      'store initial value 
      MYPEEK[A] : V=Param : Inc A : Poke B,V : Inc B
      Repeat 
         MYPEEK[A] : NV=Param : Inc A : DV=Min(Max(0,256+NV-V),512)
         Poke B,DIFF(DV) : Inc B : V=V+F(DIFF(DV))
      Until A=SAMSTART+SAMLEN
      B=Start(401) : Poke$ B,"CSFX" : Add B,4 : Loke B,Length(402) : Add B,4
      Poke B,Peek(Start(402)) : Inc B
      For A=Start(402)+1 To Bank End(402)-1 Step 2
         WD1=Peek(A)*16 : WD2=Peek(A+1)
         D=WD1 or WD2 : Poke B,D : Inc B
      Next 
      _S_FILE[1,Catalog String$(584,"Save sample as:"),"AB3:SAMPLES/","#?.fib",FF$+".fib"]
      NF$=Param$
      If NF$<>""
         If Up Case$(Right$(NF$,4))<>".FIB" : NF$=NF$+".fib" : End If 
         Bsave NF$,Start(401) To B : _PACK[NF$]
      End If 
      Erase 401 : Erase 402
   End If 
End Proc
Procedure _PAL2ISCREEN[N]
   '
   ' Set 256 col palette on intuition screen
   '
   For A=0 To 255
      DR=Deek(PALC+A*6) : DG=Deek(PALC+A*6+2) : DB=Deek(PALC+A*6+4)
      _scr Id Set Aga Pal A,DR*$10000+DG*$100+DB
   Next A
End Proc
Procedure _TL_BUILDGLARE
   Dim R(255),G(255),B(255)

   _scr Id Show 1
   _N_MSG["",Catalog String$(555,"Building glare Palette")]

   N=PALC
   For A=0 To 255
      R(A)=Deek(N) : Add N,2
      G(A)=Deek(N) : Add N,2
      B(A)=Deek(N) : Add N,2
   Next 
   N=Start(15)
   For D=64 To 1 Step -1
      TS=N
      WR=(134*D)/16
      WG=(204*D)/16
      WB=(255*D)/16
      For A=0 To 255
         R=R(A)
         G=G(A)
         B=B(A)
         If D>32
            V=D-32
            R=Min(255,R+(255*V)/32)
            G=Min(255,G+(255*V)/32)
            B=Min(255,B+(255*V)/32)
         End If 
         If D<33
            R=(R*D)/32
            G=(G*D)/32
            B=(B*D)/32
         End If 
         DQ=10000000
         TC=0
         For Z=0 To 255
            DR=Abs(R-R(Z))
            DG=Abs(G-G(Z))
            DB=Abs(B-B(Z))
            ND=(DR*3)+(DG*4)+(DB*2)
            If ND<DQ : DQ=ND : TC=Z : End If 
         Next 
         Poke N,TC
         Add N,1
      Next 
   Next 
   _R_N_MSG
End Proc
'
'----------------------------------------------------------------------------  
'   Show informations to user...   
'----------------------------------------------------------------------------  
'
Procedure _N_MSG[N$,TXT$]
   _N_MSG2[N$,1]
   _gt Set Text 1,TXT$,,,
End Proc
Procedure _N_MSG2[N$,NTXT]
   If N$="" : N$=Catalog String$(94,"Working, Hang On") : End If 
   If NTXT>0
      _wnd Id Open 2,160,128,320,6+NTXT*16,$2,$0,0,""
      Reserve As Gt Gadgets 498,NTXT+1,1
      _gt Set Mode 0,"",0,1
      For A=1 To NTXT
         _gt Text A,16,A*16,296,12,,"","",1
      Next A
      _gt Gadgets Attach 498
   Else 
      LTAG=_tag List Alloc(40)
      _tag Set LTAG,$80000064,160
      _tag Set LTAG,$80000065,128
      _tag Set LTAG,$80000066,320
      _tag Set LTAG,$80000067,11
      _tag Set LTAG,$8000006A,0
      _tag Set LTAG,$8000006B,$1000+$4+$2
      Trap _tag Set LTAG,$80000070,_scr Id Base(1)
      '_wnd Id Open 2,160,128,320,0,$2,$0,0,"" 
      _wnd Id Tag Open 2,LTAG
      _tag List Free LTAG
   End If 
   _wnd Id Use 2
   _wnd Id Titles N$,VER$
   _wnd Id Mouse 2,-1,0
   _wnd Id Activate 2
End Proc
Procedure _R_N_MSG
   Trap _wnd Id Use 2
   Trap _gt Gadgets Remove 498
   Trap _gt Gadgets Erase 498
   Trap _wnd Id Close 2
End Proc
Procedure _S_FILE[M,T$,D$,P$,F$]
   '
   '
   '
   AM_HE=Amos Here
   _scr Id Show 1
   REQ=0 : F$=""
   If _base Asl<>0
      Do 
         W=Instr(P$,"*")
         Exit If W=0
         P$=Left$(P$,W-1)+"#?"+Mid$(P$,W+1)
      Loop 
      T1$=T$+Chr$(0)
      D1$=D$+Chr$(0)
      P1$=P$+Chr$(0)
      F1$=F$+Chr$(0)
      LTAG=_tag List Alloc(40)
      _tag Set LTAG,$80080002,_wnd Id Base(0)
      _tag Set LTAG,$80080033,_base Topaz
      _tag Set LTAG,$80080001,Varptr(T1$)
      If Btst(0,M) : _tag Set LTAG,$80080014,$21
      Else : _tag Set LTAG,$80080014,$1
      End If 
      If Btst(1,M)
         _tag Set LTAG,$80080016,$5
      Else 
         _tag Set LTAG,$80080016,$4
      End If 
      _tag Set LTAG,$80080008,Varptr(F1$)
      _tag Set LTAG,$80080009,Varptr(D1$)
      _tag Set LTAG,$8008000A,Varptr(P1$)
      _tag Done LTAG
      REQ=_asl Alloc(0,0)
      If REQ<>0
         Amos To Back 
         F=_asl Do(REQ,LTAG)
         F$=_str Get(_asl What File(REQ))
         D$=_str Get(_asl What Drawer(REQ))
         _asl Free REQ
         If D$<>"" and(Btst(1,M)=1 or F$<>"") and F
            If Right$(D$,1)<>":" and Right$(D$,1)<>"/" : D$=D$+"/" : End If 
            F$=D$+F$
         Else 
            F$=""
         End If 
      End If 
      _tag List Free LTAG
   End If 
   If AM_HE
      Amos To Front 
   End If 
   'If REQ=0 : Change Mouse 1 : F$=Fsel$(D$+P$,F$,T$,"") : End If 
End Proc[F$]
Procedure _TLINES[T1$,T2$,T3$,T4$,T5$,T6$]
   WH=66
   If T6$<" "
      WH=56
      If T5$<" "
         WH=46
         If T4$<" "
            WH=36
            If T3$<" "
               WH=26
            End If 
         End If 
      End If 
   End If 
   _wnd Id Open 3,0,_scr Id Height(1)-WH,320,WH,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _wnd Id Ink 1,0,1
   _wnd Id Text 8,20,T1$
   _wnd Id Text 8,30,T2$
   _wnd Id Text 8,40,T3$
   _wnd Id Text 8,50,T4$
   _wnd Id Text 8,60,T5$
   _wnd Id Text 8,70,T6$
End Proc
Procedure _TLINE[T1$]
   _wnd Id Open 3,0,_scr Id Height(1)-90,320,90,$2,F_IDCMP,0,""
   _wnd Id Titles BUT$(OP),VER$
   _wnd Id Ink 1,0,1
   _wnd Id Text 8,20,T1$
End Proc
Procedure _WRONG[G,N]
   _ERROR[0,G+40,N]
End Proc
Procedure _ERROR[S,G,N]
   If S=0
      E0$=Catalog String$(802,"Error:")
   Else 
      E0$=Catalog String$(803,"Fatal Error:")
   End If 
   E1$=Catalog String$(801,"Unknown Error")
   If G=0
      '
      ' Error group 0, disc-errors 
      '
      If N=-1
      Else If N=0 : E1$=Catalog String$(842,"Can't find 'AB3:'")
      Else If N=1 : E1$=Catalog String$(843,"Can't find 'AB3:includes/256pal'")
      Else If N=2 : E1$=Catalog String$(844,"Can't find 'AB3:includes/test.lnk'")
      Else If N=3 : E1$=Catalog String$(845,"Can't find 'AB3:includes/BETPTS'")
      Else If N=4 : E1$=Catalog String$(846,"Can't find 'T:'")
      Else If N=5 : E1$=Catalog String$(808,"'Delete' MUST be in 'C:'")
      Else If N=6 : E1$=Catalog String$(809,"'Lha3' MUST be in 'C:'")
      Else If N=7 : E1$=Catalog String$(810,"'LhaConv' MUST be in 'C:'")
      Else If N=8 : E1$=Catalog String$(811,"'SBDepack' not in 'C:'")
      Else If N=9 : E1$=Catalog String$(857,"'Copy' not in 'C:'")
      Else If N=10 : E1$=Catalog String$(859,"Can't find: ")+GFILE$
      End If 
   Else If G=1
      If N=-1
      Else If N=0 : E1$=Catalog String$(851,"Sample rate <>8000")
      End If 
   Else If G=2
      If N=-1
      Else If N=0 : E1$=Catalog String$(852,"Screen Width too small")
      Else If N=1 : E1$=Catalog String$(853,"Screen Height too small")
      End If 
   Else If G=3
      If N=-1
      Else If N=0 : E1$=Catalog String$(854,"Point limit exceeded")
      Else If N=1 : E1$=Catalog String$(855,"Zone limit exceeded")
      Else If N=2 : E1$=Catalog String$(856,"Control-Point limit exceeded")
      Else If N=3 : E1$=Catalog String$(858,"Object limit exceeded")
      End If 
   Else If G=40
      '
      ' Error group  
      '
      If N=-1
      Else If N=0 : E1$=Catalog String$(804,"Lift was allready placed")
      Else If N=1 : E1$=Catalog String$(805,"Door was allready placed")
      Else If N=2 : E1$=Catalog String$(806,"This zone is a Door")
      Else If N=3 : E1$=Catalog String$(807,"This zone is a Lift")
      End If 
   Else If G=41
      If N=-1
      Else If N=4 : E1$=Catalog String$(812,"Missing '.bin' data file")
      Else If N=5 : E1$=Catalog String$(813,"Missing '.graph.bin' data file")
      Else If N=6 : E1$=Catalog String$(814,"Missing '.clip' data file")
      Else If N=7 : E1$=Catalog String$(815,"'.bin' is allready packed")
      Else If N=8 : E1$=Catalog String$(816,"'.graph.bin' is allready packed")
      Else If N=9 : E1$=Catalog String$(817,"'.clip' is allready packed")
      Else If N=10 : E1$=Catalog String$(818,"'Copy' MUST be in 'C:'")
      Else If N=11 : E1$=Catalog String$(819,"File is allready packed")
      Else If N=12 : E1$=Catalog String$(820,"File is not packed")
      Else If N=13 : E1$=Catalog String$(847,"Can't load file")
      Else If N=14 : E1$=Catalog String$(848,"Can't save file")
      End If 
   Else If G=42
      If N=-1
      Else If N=0 : E1$=Catalog String$(821,"Src/Dest Heights MUST be the same")
      End If 
   Else If G=43
      If N=-1
      Else If N=0 : E1$=Catalog String$(822,"This wall is solid.")
      Else If N=1 : E1$=Catalog String$(823,"This wall is defined for purpose.")
      Else If N=2 : E1$=Catalog String$(824,"Can't raise wall in Lift-zone.")
      Else If N=3 : E1$=Catalog String$(825,"Can't raise wall in Door-zone.")
      Else If N=4 : E1$=Catalog String$(826,"Place Door first.")
      Else If N=5 : E1$=Catalog String$(827,"Place Lift first.")
      Else If N=6 : E1$=Catalog String$(828,"This Wall isn't next to current Door.")
      Else If N=7 : E1$=Catalog String$(829,"This Wall isn't next to current lift.")
      Else If N=8 : E1$=Catalog String$(830,"Can't change an outer wall.")
      End If 
   Else If G=44
      If N=-1
      Else If N=0 : E1$=Catalog String$(831,"Can't delete point belonging to a zone.")
      Else If N=1 : E1$=Catalog String$(832,"Please define zones Clock-Wise.")
      Else If N=2 : E1$=Catalog String$(833,"Please remove Door-wall first.")
      Else If N=3 : E1$=Catalog String$(834,"Please remove Lift-wall first.")
      Else If N=4 : E1$=Catalog String$(835,"Please remove Door first.")
      Else If N=5 : E1$=Catalog String$(836,"Please remove Lift first.")
      Else If N=6 : E1$=Catalog String$(837,"Max. 10 points in a Zone.")
      End If 
   Else If G=50
      If N=-1
      Else If N=0 : E1$=Catalog String$(838,"Can't load 'twolev.dat'")
      Else If N=1 : E1$=Catalog String$(839,"Can't load 'twolev.obj'")
      Else If N=2 : E1$=Catalog String$(840,"Can't load 'twolev.links'")
      End If 
   Else If G=51
      '
      ' Error group 11 for the level-checker.. 
      '
      E0$="Check-Level Error:"
      If N=-1
      Else If N=0 : E1$=Catalog String$(841,"Illegal dest. for Teleport")
      End If 
   Else If G=60
      E0$=Catalog String$(849,"Warning:")
      If N=-1
      Else If N=0 : E1$=Catalog String$(850,"Chunk width may fail above 640")
      End If 
   End If 
   _ERRTXT[E0$,E1$]
   If S=1
      _END_PROGRAM
      End 
   End If 
End Proc
Procedure _ERRTXT[E0$,E1$]
   _scr Id Show 1
   P=_request Choice(_wnd Id Base(0),E0$,E1$,"OK")
End Proc
Procedure _SURE[T0$,T$]
   If T0$="" : T0$=Catalog String$(90,"Are You sure that you want to:") : End If 
   P=_request Choice(_wnd Id Base(0),T0$,T$,Catalog String$(2,"No")+"|"+Catalog String$(1,"Yes"))
   If P=0 : R=True : Else : R=False : End If 
End Proc[R]
'
Procedure _SHOW_AG[NO$]
   If Exist(GFILE$)
      Trap O=_ag Show(_scr Id Base(1),GFILE$+"/"+NO$)
   Else 
      _ERROR[0,0,10]
   End If 
End Proc
'
Procedure _I_SAVEIFFPIC[SCR,F$]
   '-------------------------------------------------------------------------   
   '              J V P  P R O C E D U R E  L I B R A R Y . . . 
   '   Inituition procedure:  Save Intuition screen as IFF-ILBM (unpacked)
   '              Written By: Jens Vang Petersen, 21-12-1997... 
   '------------------------------------------------------------------------- 
   ' Options: 
   ' SCR = Pointer to screen structure
   '       (The value returned from '_scr Open' 
   ' F$  = Filename 
   '
   '------------------------------------------------------------------------- 
   ' Internal variables:
   ' SCRB = Screen Width
   ' SCRH = Screen Height 
   ' SCRD = Screen Depth (Nr. of colours is 2^SCRD) 
   ' SCRM = Screen Modes (Hires/Lowres, Laced/NoLace) 
   '
   ' The procedure uses bank 401 & 402
   '------------------------------------------------------------------------- 
   ' This procedure uses _rgb32 commands and needs V39+ of the OS 
   '
   If _sys Version<39 : Pop Proc : End If 
   '
   ' Get the screen datas 
   '
   SCRB=_scr What Width(SCR)
   SCRH=_scr What Height(SCR)
   SCRD=_scr What Depth(SCR)
   SCRM=_scr What Vmodes(SCR)
   '
   ' Calc. app. length of file and reserve a bank to store it in
   '
   BYTES=SCRB*SCRH/8*SCRD
   ZUS=52+8+2^SCRD*3
   Reserve As Work 401,(BYTES+ZUS)+64
   PO=Start(401)
   '
   ' Write main header of file (Actual length is stored at the end) 
   '
   Poke$ PO,"FORM" : Add PO,4
   Loke PO,BYTES+ZUS : Add PO,4
   Poke$ PO,"ILBM" : Add PO,4
   '
   ' Write picture header 
   '
   Poke$ PO,"BMHD" : Add PO,4
   Loke PO,20 : Add PO,4
   Doke PO,SCRB : Add PO,2
   Doke PO,SCRH : Add PO,2
   Loke PO,0 : Add PO,4
   Poke PO,SCRD : Inc PO
   Poke PO,0 : Inc PO
   Doke PO,0 : Add PO,2
   Doke PO,0 : Add PO,2
   Poke PO,10 : Inc PO
   Poke PO,10 : Inc PO
   Doke PO,SCRB : Add PO,2
   Doke PO,SCRH : Add PO,2
   '
   ' Obtain 32bit colourmap and put it down in file 
   '
   Poke$ PO,"CMAP" : Add PO,4
   Loke PO,2^SCRD*3 : Add PO,4
   Reserve As Work 402,2^SCRD*4*3+22
   _rgb32 Get _vp What Cmap(_scr What Vport(SCR)),0,2^SCRD,Start(402)
   C=Start(402)
   For A=0 To 2^SCRD*3-1
      Poke PO,Leek(C) and $FF : Inc PO : Add C,4
   Next A
   Erase 402
   '
   ' Get the main picture 
   '
   Poke$ PO,"BODY" : Add PO,4
   Loke PO,BYTES : Add PO,4
   CBM=_rp What Bmap(_scr What Rport(SCR))
   SCRBB=_bm What Modulo(CBM)
   For WA=0 To SCRH-1
      For WB=0 To SCRD-1
         BAD=_bm What Plane(CBM,WB)
         For WC=0 To SCRB/8-1 Step 2
            Doke PO,Deek(BAD+WA*SCRBB+WC)
            Add PO,2
         Next WC
      Next WB
   Next WA

   '
   ' Store filelength-header length in file 
   ' The save it and clean up.. 
   '
   Loke Start(401)+4,PO-Start(401)-8
   Trap Bsave F$,Start(401) To PO
   Erase 401

End Proc
'
'
'
'
'
Procedure _ILBM_FROM_BANK[W_SCR,W_BNK,W_FLGS]
   '-------------------------------------------------------------------------'  
   '        
   '                               p R O C E D U R E  l I B R A R Y   
   '                        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~             
   '                                   
   '                                    FreeWare Procedure by: 
   '                     Jens Vang Petersen <top_cat@post8.tele.dk>   
   '             
   '           -*- OS_DevKit V2.00 tools: IFF-ILBM From Bank V1.01 -*-
   '-------------------------------------------------------------------------'  
   ' Display IFF-ILBM from BANK on an OS-DevKit id-screen   
   ' !!!! Ordinary "ByteRun1"-packing is supported !!!! 
   ' This procedure is freeware, use/change/delete it as you like.. 
   '-------------------------------------------------------------------------'  
   ' Parameters Description:  
   ' ~~~~~~~~~~~~~~~~~~~~~~~  
   '  W_SCR = Screen Number to open on..
   '  W_BNK = BankNumber to find data in..  
   '  W_FLGS= ControlFlags
   '    Bit 0 : Ignore Viewmodes defined in IFF-ILBM file   
   '
   ' Returned Error-codes in 'Param':   
   '  00 = No Error 
   '  01 = Not An IFF file..  
   '  02 = Not An ILBM picture..  
   '  03 = Screen Open failed.. 
   '  04 = Unknown packing of file..
   '  05 = Can't find bitmap-data (Screen will be left open.).. 
   '  06 = Can't find colour-map (Image will be shown with default colours) 
   '-------------------------------------------------------------------------'  
   '
   ' Ok, There's no error to begin with ;-) 
   '
   W_ERR=0

   '
   ' Check for filetype 
   '
   If Length(W_BNK)<20 : W_ERR=1 : Goto FIN : End If 
   W_H$=Peek$(Start(W_BNK),4)
   If W_H$<>"FORM" : W_ERR=1 : Goto FIN : End If 
   W_H$=Peek$(Start(W_BNK)+8,4)
   If W_H$<>"ILBM" : W_ERR=2 : Goto FIN : End If 

   W_BNKS=Start(W_BNK)
   W_BNKE=Start(W_BNK)+Length(W_BNK)

   '
   ' Find and Decode "BMHD" chunk, hosts general information  
   ' (Cancel work if not found) 
   '
   W_PO=Hunt(W_BNKS To W_BNKE,"BMHD")
   If W_PO<W_BNKS : W_ERR=2 : Goto FIN : End If 
   Add W_PO,8

   W_PW=_struct Word(W_PO,0) : Rem      Picture Width 
   W_PH=_struct Word(W_PO,2) : Rem      Picture Height
   W_PD=_struct Byte(W_PO,8) : Rem      Depth (Planes)
   W_PCOMP=_struct Byte(W_PO,10) : Rem  Compression 
   W_PSW=_struct Word(W_PO,16) : Rem    Screen Width
   W_PSH=_struct Word(W_PO,18) : Rem    Screen Height 
   If PCOMP>1 : W_ERR=4 : Goto FIN : End If 


   '
   ' Find & Decode "CAMG" chunk, holding the viewmode.. 
   '
   If Not Btst(0,W_FLGS)
      W_PO=Hunt(W_BNKS To W_BNKE,"CAMG")
      If W_PO>W_BNKS
         Add W_PO,8
         W_MODE=_struct Long(W_PO,0)
         W_FL=True
         Trap _scr Id Open W_SCR,0,0,Max(32,W_PW),Max(16,W_PH),W_PD,W_MODE,0,""
         If Errtrap : W_FL=False : End If 
      End If 
   End If 
   If Not W_FL
      W_MODE=0
      If W_PSW>340 : W_MODE=Hires : End If 
      If W_PSH>278 : W_MODE=W_MODE2+Laced : End If 
      Trap _scr Id Open W_SCR,0,0,Max(32,W_PW),Max(16,W_PH),W_PD,W_MODE,0,""
      If Errtrap : W_ERR=3 : Goto FIN : End If 
   End If 


   '
   ' Find & Decode "CMAP" chunk, holding the Colours..  
   '
   W_PO=Hunt(W_BNKS To W_BNKE,"CMAP")
   If W_PO<W_BNKS
      _W_ERR=6
   Else 
      Add W_PO,8
      W_P=0 : WB=0
      For WA=0 To 2^W_PD-1
         W_R=_struct Ubyte(W_PO,W_P)
         W_G=_struct Ubyte(W_PO,W_P+1)
         W_B=_struct Ubyte(W_PO,W_P+2)
         Add W_P,3
         _scr Id Set Aga Pal WB,W_R*$10000+W_G*$100+W_B
         Inc WB
      Next WA
   End If 

   '
   ' Find & Decode "BODY" part, this hosts the picture data.. 
   '
   W_PO=Hunt(W_BNKS To W_BNKE,"BODY")
   If W_PO<W_BNKS : W_ERR=5 : Goto FIN : End If 

   W_S=Leek(W_PO+4)
   Add W_PO,8

   W_P=0
   W_CBM=_rp What Bmap(_scr Id Rport(W_SCR))
   W_SCRBB=_bm What Modulo(W_CBM)
   For WA=0 To W_PH-1
      For WB=0 To W_PD-1
         W_BAD=_bm What Plane(W_CBM,WB)
         If W_PCOMP=1
            '
            ' Depack ByteRun1-coded data.. 
            '
            WC=0
            While WC<=(W_PW+7)/8-1
               WW=_struct Byte(W_PO,W_P) : Inc W_P
               If WW=-128
               Else If WW>=0
                  For WD=0 To WW
                     If WC<=W_SCRBB
                        Poke(W_BAD+WA*W_SCRBB+WC),_struct Byte(W_PO,W_P)
                     End If 
                     Inc WC : Inc W_P
                  Next WD
               Else If WW<0
                  WV=_struct Byte(W_PO,W_P) : Inc W_P
                  For WD=0 To Abs(WW)
                     Poke(W_BAD+WA*W_SCRBB+WC),WV
                     Inc WC
                     Exit If WC>W_SCRBB
                  Next WD
               End If 
            Wend 
         Else 
            '
            '  Put plain data on screen..
            '
            For WC=0 To(W_PW+7)/8-1
               Poke(W_BAD+WA*W_SCRBB+WC),_struct Byte(W_PO,W_P)
               Add W_P,1
            Next WC
         End If 
      Next WB
   Next WA
FIN:
End Proc[W_ERR]
Procedure _ILBM_TO_BANK[W_SCR,W_BNK]
   '-------------------------------------------------------------------------'  
   '        
   '                               p R O C E D U R E  l I B R A R Y   
   '                        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~             
   '                                   
   '                                    FreeWare Procedure by: 
   '                     Jens Vang Petersen <top_cat@post8.tele.dk>   
   '             
   '           -*- OS_DevKit V2.00 tools: IFF-ILBM 2 Bank V1.01 -*- 
   '-------------------------------------------------------------------------'  
   ' Put IFF-ILBM in a BANK from an OS-DevKit id-screen 
   ' !!!! No packing is supported at this time !!!! 
   ' This procedure is freeware, use/change/delete it as you like.. 
   '-------------------------------------------------------------------------'  
   ' Parameters Description:  
   ' ~~~~~~~~~~~~~~~~~~~~~~~  
   '  W_SCR = Screen Number to get on.. 
   '  W_BNK = BankNumber to put data in..   
   '-------------------------------------------------------------------------'  
   Trap _scr Id Use W_SCR
   If Errtrap : Goto FIN : End If 

   '
   ' Get Screen sizes 
   '
   W_PW=_scr Id Width(W_SCR)
   W_PH=_scr Id Height(W_SCR)
   W_PD=_scr Id Depth(W_SCR)

   '
   ' Calculate resulting file-size..  
   '
   W_SIZE=8+4+8+20+8+2^W_PD*3+8+4+8+W_PW/8*W_PH*W_PD
   '      ---HD--- ---CMAP--- -V- -------BMAP-------

   Reserve As Work W_BNK,W_SIZE
   W_PO=Start(W_BNK)

   '
   ' Build header-structure:
   '
   Poke$ W_PO,"FORM"+_chr$.l(W_SIZE-8)+"ILBM" : Add W_PO,12

   '
   ' Build "BMHD" Chunk (General information):
   '
   Poke$ W_PO,"BMHD"+_chr$.l(20) : Add W_PO,8
   Doke W_PO,W_PW : Add W_PO,2
   Doke W_PO,W_PH : Add W_PO,2 : Add W_PO,4
   Poke W_PO,W_PD : Add W_PO,2
   Poke W_PO,0 : Add W_PO,1 : Add W_PO,5
   Doke W_PO,W_PW : Add W_PO,2
   Doke W_PO,W_PH : Add W_PO,2

   '
   ' Build "CMAP" Chunk (Colour-maps):
   '
   Poke$ W_PO,"CMAP"+_chr$.l(2^W_PD*3) : Add W_PO,8
   For WA=0 To 2^W_PD-1
      WB=_scr Id Get Aga Pal(WA)
      Poke W_PO,(WB/$10000) and $FF : Inc W_PO
      Poke W_PO,(WB/$100) and $FF : Inc W_PO
      Poke W_PO,WB and $FF : Inc W_PO
   Next WA

   '
   ' Build "CAMG" Chunk (Viewmode, AMIGA only): 
   '
   Poke$ W_PO,"CAMG"+_chr$.l(4) : Add W_PO,8
   Loke W_PO,_scr Id Mode(W_SCR) : Add W_PO,4

   '
   ' Build "BODY" Chunk (Bitmap stored in raster-format): 
   '
   Poke$ W_PO,"BODY"+_chr$.l(W_PW/8*W_PH*W_PD) : Add W_PO,8
   W_P=0
   W_CBM=_rp What Bmap(_scr Id Rport(W_SCR))
   W_SCRBB=_bm What Modulo(W_CBM)
   For WA=0 To W_PH-1
      For WB=0 To W_PD-1
         W_BAD=_bm What Plane(W_CBM,WB)
         For WC=0 To(W_PW+7)/8-1
            Poke W_PO,Peek(W_BAD+WA*W_SCRBB+WC)
            Add W_PO,1
         Next WC
      Next WB
   Next WA
FIN:
End Proc

'
' OS DevKit 2.0 Helpfull Procedures
' ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'
' ID Screens Procedures
' ~~~~~~~~~~~~~~~~~~~~~
Procedure _SCR_ID_LOAD[SCRNB,FILE$,MAP]
   '
   ' PARAMETERS DESCRIPTION 
   ' ~~~~~~~~~~~~~~~~~~~~~~ 
   ' SCRNB -> Screen ID to load picture in. 
   ' FILE$ -> Picture filename. 
   ' MAP   -> Remap picture to screen ID. 
   
   ' RETURN DESCRIPTION 
   ' ~~~~~~~~~~~~~~~~~~ 
   ' = 0  -> Failure  
   ' <> 0 -> Success
   
   '
   ' Datatypes Init 
   ' ~~~~~~~~~~~~~~ 
   DTBASE=_dt Init
   If DTBASE=0 Then Goto FIN
   
   '
   ' Memory Allocations 
   ' ~~~~~~~~~~~~~~~~~~ 
   NAME$=FILE$+_0$
   
   RP=_struct Alloc(100)
   If RP=0 Then Goto FIN
   Areg(1)=RP : OK=Gfxcall(-198)
   
   GPL=_struct Alloc(12)
   If GPL=0 Then Goto FIN
   
   If MAP
      '
      ' Load Picture 
      ' ~~~~~~~~~~~~ 
      SCR=_scr Id Base(SCRNB)
      
      _tag Set ,$84000000,-1
      _tag Set ,$8000101F,_val.l("pict")
      _tag Set ,$800010D3,1
      _tag Set ,$800010D4,SCR
      _tag Done 0
      
      DTO=_dt Create(Varptr(NAME$),)
      If DTO=0 : Goto FIN : End If 
   Else 
      '
      ' Load Picture 
      ' ~~~~~~~~~~~~ 
      _tag Set ,$8000101F,_val.l("pict")
      _tag Set ,$800010D3,0
      _tag Done 0
      
      DTO=_dt Create(Varptr(NAME$),)
      If DTO=0 : Goto FIN : End If 
      
      '
      ' Get Informations 
      ' ~~~~~~~~~~~~~~~~       
      _tag Set ,$800010C8,Varptr(IDMODE)
      _tag Set ,$800010C9,Varptr(BMH)
      _tag Done 0
      OK=_dt What Attrs(DTO,)

      If MAP=1
         _tag Set ,$8000000A,IDMODE
         _tag Done 0
         IDMODE=_mode Best Id(_base Tag)
               '
         ' Open Screen
         ' ~~~~~~~~~~~      
         _tag Set ,$80000021,_struct Word(BMH,4)
         _tag Set ,$80000022,_struct Word(BMH,6)
         _tag Set ,$80000023,_struct Uword(BMH,0)
         _tag Set ,$80000024,_struct Uword(BMH,2)
         _tag Set ,$80000025,_struct Ubyte(BMH,8)
         _tag Set ,$80000032,IDMODE
         _tag Done 0
      
         _scr Id Tag Open SCRNB,
      End If 
   End If 
   
   '
   ' Layout Picture 
   ' ~~~~~~~~~~~~~~ 
   _struct Long(GPL,0)=$603
   _struct Long(GPL,4)=0
   _struct Long(GPL,8)=1
   OK=_dt Do(DTO,0,0,GPL)
   
   '
   ' Get Picture Informations 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   _tag Set ,$800010C8,Varptr(IDMODE)
   _tag Set ,$800010C9,Varptr(BMH)
   _tag Set ,$800010CA,Varptr(BM)
   _tag Set ,$800010CC,Varptr(CTABLE)
   _tag Set ,$800010D1,Varptr(NBC)
   _tag Done 0
   OK=_dt What Attrs(DTO,)
   
   '
   ' Display Image
   ' ~~~~~~~~~~~~~
   _rp Set Bmap RP,BM
   W=Min(_scr Id Width(SCRNB),_struct Uword(BMH,0))
   H=Min(_scr Id Height(SCRNB),_struct Uword(BMH,2))
   _blt Clip RP,0,0 To _scr Id Rport(SCRNB),0,0,W,H,$C0
   
   '
   ' Report Color to Screen 
   ' ~~~~~~~~~~~~~~~~~~~~~~ 
   If MAP=0
      Dec NBC
      For C=0 To NBC
         R=Peek(CTABLE) : Add CTABLE,4
         G=Peek(CTABLE) : Add CTABLE,4
         B=Peek(CTABLE) : Add CTABLE,4
         _scr Id Set Aga Pal C,R*$10000+G*$100+B
      Next C
   End If 
   
   Pop Proc[1]
   '
   ' Error Handling 
   ' ~~~~~~~~~~~~~~ 
   FIN:
   _struct Free RP
   _struct Free GPL
   _dt Delete DTO
End Proc[0]
Procedure _LOADSAM[NAME$,BNK]
   '
   ' WARNING, THIS FUNCTION USES DATATYPES, SO V39 IS NEED
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   '
   ' Parameters Description 
   ' ~~~~~~~~~~~~~~~~~~~~~~ 
   ' NAME$ -> Name of Image to Load 
   '
   ' OutPut Description 
   ' ~~~~~~~~~~~~~~~~~~ 
   SAMRATE=0
   '
   ' Preliminary Tests
   ' ~~~~~~~~~~~~~~~~~
   '
   ' Datatypes Init 
   ' ~~~~~~~~~~~~~~ 
   DTBASE=_dt Init
   If DTBASE=0 Then Goto FIN
   NAME$=NAME$+_0$

   _tag Set ,$8000101F,_val.l("soun")
   _tag Set ,$800010D3,0
   _tag Done 0
      
   DTO=_dt Create(Varptr(NAME$),)
   If DTO=0 : Goto FIN : End If 


   '
   ' Get Attributes 
   ' ~~~~~~~~~~~~~~ 
   _tag Set ,$800011F5,Varptr(VHEAD)
   _tag Set ,$800011F6,Varptr(SAMADR)
   _tag Set ,$800011F7,Varptr(SAMLEN)
   _tag Set ,$80001067,Varptr(DT)
   _tag Done 0
   OK=_dt What Attrs(DTO,)

   '
   ' Test if DataType is sample ('soun')  
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
   DTH=Leek(DT+$1C)
   GROUPID=Leek(DTH+$10)
   If GROUPID<>$736F756E : Goto FIN : End If 
   Reserve As Chip Work BNK,SAMLEN
   Copy SAMADR,SAMADR+SAMLEN To Start(BNK)
   SAMRATE=Deek(VHEAD+12)
   '
   '
   ' FreeIng
   ' ~~~~~~~
FIN:
   _dt Delete DTO
End Proc[SAMRATE]
'
'
' Help Procs V1.20.00
' ~~~~~~~~~~~~~~~~~~~
'
' Gestion & Cration de Structures Clefs 
' ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
Procedure _ALLOCSPRDATA[BNK,BNB]
   '
   ' N'utiliser que si < V39
   ' ~~~~~~~~~~~~~~~~~~~~~~~
   ' Test Existence Bob 
   ' ~~~~~~~~~~~~~~~~~~ 
   If BNB<1
      Goto FIN
   End If 
   If Length(BNK)=0
      Goto FIN
   End If 
   ID$="" : SBNK=Start(BNK)-8
   For I=0 To 7
      ID$=ID$+Chr$(Peek(SBNK+I))
   Next 
   If(ID$<>"Sprites ") and(ID$<>"Icons   ")
      Goto FIN
   End If 
   BOFF=BNB*8
   BLEN=Leek(SBNK-12)-82
   If BOFF>BLEN
      Goto FIN
   End If 
   BBASE=Leek(SBNK+2+BOFF)
   If BBASE=0
      Goto FIN
   End If 
   '
   ' Extraction des Donnes 
   ' ~~~~~~~~~~~~~~~~~~~~~~ 
   WW=Deek(BBASE)
   LH=Deek(BBASE+2)
   D=Deek(BBASE+4)
   '
   ' Mmoire Ncessaire 
   ' ~~~~~~~~~~~~~~~~~~ 
   MEM=4*LH+12
   SPRDATA=_mem Alloc(MEM,2)
   If SPRDATA=0
      Goto FIN
   End If 
   '
   ' Remplissage de la Structure
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~~~
   SPRPTR=SPRDATA
   Loke SPRPTR,MEM : Add SPRPTR,4
   Loke SPRPTR,0 : Add SPRPTR,4 : Rem Posct
   '
   ' Transfert Mmoire Pose -> Sprite 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   PLAN0=BBASE+10
   If D>1
      PLAN1=PLAN0+WW*2*LH
   Else 
      PLAN1=0
   End If 
   Dec LH
   For I=0 To LH
      A=Deek(PLAN0+WW*I*2)
      If PLAN1=0
         B=0
      Else 
         B=Deek(PLAN1+WW*I*2)
      End If 
      Doke SPRPTR,A : Add SPRPTR,2
      Doke SPRPTR,B : Add SPRPTR,2
   Next I
   Loke SPRPTR,0
   FIN:
End Proc[SPRDATA+4]
'
Procedure _AMOS2STR[A$]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' A$ -> Content of String
   '
   ' OutPut Description : 
   ' ~~~~~~~~~~~~~~~~~~~~ 
   ' STRING -> Pointer of a System String ('_str' Functions)
   '           MUST BE FREE WITH '_str Free' function 
   '
   ' Test 
   ' ~~~~ 
   If A$=""
      Goto FIN
   End If 
   '
   ' Alloc String with Transfered Length
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   STRING=_str Alloc(Len(A$))
   '
   ' Inject AMOS String in STRING 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
   _str Put A$,STRING
   '
   FIN:
End Proc[STRING]
'
Procedure _AMOS2ITXT[CE,CF,MD,X,Y,FONT,A$]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' CE   -> Front Pen
   ' CF   -> Back Pen 
   ' MD   -> Draw Mode
   ' X, Y -> Coordinates of Text
   ' FONT -> Pointer to a TextAttrib Structure
   ' A$   -> Text to Display
   '
   ' OutPut Description : 
   ' ~~~~~~~~~~~~~~~~~~~~ 
   ' ITXT -> Pointer of an IntuiText Structure
   '         MUST BE FREE WITH '_FREEALLITXT[]' procedure 
   '
   ' Alloc Structure IntuiText  
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~  
   ITXT=_vec Alloc($14,$10001)
   '
   ' Sys Error Test 
   ' ~~~~~~~~~~~~~~ 
   If ITXT=0
      Goto FIN
   End If 
   '
   ' Alloc String 
   ' ~~~~~~~~~~~~ 
   _AMOS2STR[A$] : STR=Param
   If STR=0
      _vec Free ITXT
      ITXT=0
      Goto FIN
   End If 
   '
   ' Init IntuiText 
   ' ~~~~~~~~~~~~~~ 
   _it Set ITXT,CE,CF,MD,X,Y,FONT,STR,0
   '
   FIN:
End Proc[ITXT]
'
Procedure _FREEALLITXT[ITXT]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' ITXT -> Pointer to an IntuiText Structure previously 
   '         allocated by _AMOS2ITXT procedure
   '
   ' Test 
   ' ~~~~ 
   While ITXT<>0
      '
      ' Search strutures to Free 
      ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
      STR=_it What Str(ITXT)
      ITXT0=_it What Next(ITXT)
      '
      ' Freeing structures 
      ' ~~~~~~~~~~~~~~~~~~ 
      _str Free STR
      _vec Free ITXT
      '
      ' Again  
      ' ~~~~~  
      ITXT=ITXT0
   Wend 
End Proc
'
'
' Les Requesters 
' ~~~~~~~~~~~~~~ 
Procedure _LOCKWINDOW[WND]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' WND -> Pointer of a Window 
   '
   ' OutPut Description : 
   ' ~~~~~~~~~~~~~~~~~~~~ 
   ' REQ -> Pointer of a Requester Structure
   '        MUST BE FREE WITH 'UNLOCKWINDOW' procedure
   '
   ' Alloc Requester Structure
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~
   REQ=_vec Alloc(112,$10001)
   '
   ' Request
   ' ~~~~~~~
   OK=_req Do(REQ,WND)
   '
   ' Fix Busy Pointer if OS3.0
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~
   If _sys Version>=39
      TAG=_tag List Alloc(1)
      If TAG<>0
         _tag Set TAG,$80000098,True
         _wnd Set Pointera WND,TAG
         _tag List Free TAG
      End If 
   End If 
End Proc[REQ]
'
Procedure _UNLOCKWINDOW[WND,REQ]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' WND -> Pointer of a Window 
   ' REQ -> Pointer of a Requester previously 
   '        allocated by _LOCKWINDOW procedure
   If WND=0 : Pop Proc : End If 
   '
   ' Unlock Window
   ' ~~~~~~~~~~~~~  
   _req End REQ,WND
   '
   ' Free Structure 
   ' ~~~~~~~~~~~~~~ 
   _vec Free REQ
   '
   ' Fix Normal Pointer if OS3.0
   ' ~~~~~~~~~~~~~~~~~~~~~~~~~~~
   If(_sys Version>=39) and(_wnd What First Req(WND)=0)
      TAG=_tag List Alloc(1)
      If TAG<>0
         _tag Set TAG,$80000098,False
         _wnd Set Pointera WND,TAG
         _tag List Free TAG
      End If 
   End If 
End Proc
'
Procedure _REQUESTCHOICE[WND,TITLE$,BODY$,GAD$]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' WND    -> Pointer of Attach Window (LOCK)  
   ' TITLE$ -> Title of requester 
   ' BODY$  -> Text of the body of requester
   ' GAD$   -> Text of the Buttons of requester 
   '           ex: "OK|No" is 2 Buttons "OK" "No" , '|' is the separator
   '
   ' OutPut Description : 
   ' ~~~~~~~~~~~~~~~~~~~~ 
   ' RESULT -> Button Number (0 To X) 
   '
   ' Acquire Datas
   ' ~~~~~~~~~~~~~
   TITLE$=TITLE$+Chr$(0)
   BODY$=BODY$+Chr$(0)
   GAD$=GAD$+Chr$(0)
   '
   ' Request if Gadgets OK
   ' ~~~~~~~~~~~~~~~~~~~~~
   If STR2<>0
      _LOCKWINDOW[WND] : LREQ=Param
      '
      ' Request
      ' ~~~~~~~
      RESULT=_req Easy(WND,Varptr(TITLE$),Varptr(BODY$),Varptr(GAD$))
      _UNLOCKWINDOW[WND,LREQ]
   End If 
End Proc[RESULT]
'
Procedure _REQUESTCHOICE_PTR[WND,TITLE,BODY,GAD]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' WND   -> Pointer of Attach Window (LOCK)   
   ' TITLE -> Pointer of the Title String of requester  
   ' BODY  -> Pointer of the Text of the body of requester  
   ' GAD   -> Pointer of the Text of the Buttons of requester   
   '           ex: "OK|No" is 2 Buttons "OK" "No" , '|' is the separator
   '
   ' OutPut Description : 
   ' ~~~~~~~~~~~~~~~~~~~~ 
   ' RESULT -> Button Number (0 To X) 
   '
   ' Request if Gadgets OK
   ' ~~~~~~~~~~~~~~~~~~~~~
   If GAD<>0
      _LOCKWINDOW[WND] : LREQ=Param
      '
      ' Request
      ' ~~~~~~~
      RESULT=_req Easy(WND,TITLE,BODY,GAD)
      _UNLOCKWINDOW[WND,LREQ]
   End If 
End Proc[RESULT]
'
'
Procedure _REQUESTFONT[WND,TITLE$]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' WND    -> Pointer of Attach Window (LOCK)  
   ' TITLE$ -> Title of requester 
   '
   ' OutPut Description : 
   ' ~~~~~~~~~~~~~~~~~~~~ 
   ' TXTATTR -> Pointer of a TextAttrib Structure 
   ' MUST BE FREE WITH '_FREETEXTATTR' procedure
   '
   ' Test if Asl
   ' ~~~~~~~~~~~
   If _base Asl=0 : Goto FIN : End If 
   '
   ' Get Memory 
   ' ~~~~~~~~~~ 
   TITLE$=TITLE$+Chr$(0)
   '
   ' Setting TAG
   ' ~~~~~~~~~~~
   LTAG=_tag List Alloc(3)
   _tag Set LTAG,$80080002,WND
   _tag Set LTAG,$8008002B,True
   _tag Set LTAG,$80080001,Varptr(TITLE$)
   '
   ' Request File 
   ' ~~~~~~~~~~~~ 
   REQ=_asl Alloc(1,0)
   RES=_asl Do(REQ,TAG)
   '
   ' Process Copy 
   ' ~~~~~~~~~~~~ 
   If RES<>0
      _AMOS2STR[_str Get(RES)] : NAMEFONT=Param
      TXTATTR=_vec Alloc(8,$10001)
      If TXTATTR<>0
         '
         ' Copy Text Attributes 
         ' ~~~~~~~~~~~~~~~~~~~~ 
         TASL=_asl What Font(REQ)
         H=_ta What Height(TASL)
         STYLE=_ta What Style(TASL)
         FLAGS=_ta What Flags(TASL)
         _ta Set TXTATTR,NAMEFONT,H,STYLE,FLAGS
      End If 
   Else 
      FT$=""
   End If 
   '
   ' Free Mem 
   ' ~~~~~~~~ 
   _tag List Free LTAG
   _asl Free REQ
   '
   FIN:
End Proc[TXTATTR]
'
Procedure _REQUESTSCREEN[WND]
   '
   ' Parameters Description : 
   ' ~~~~~~~~~~~~~~~~~~~~~~~~ 
   ' WND    -> Pointer of Attach Window (LOCK)  
   ' TITLE$ -> Title of requester 
   '
   ' OutPut Description : 
   ' ~~~~~~~~~~~~~~~~~~~~ 
   ' TXTATTR -> Pointer of a TextAttrib Structure 
   ' MUST BE FREE WITH '_FREETEXTATTR' procedure
   '
   ' Test if Asl
   ' ~~~~~~~~~~~
   If _base Asl=0
      Goto FIN
   End If 
   '
   ' Get Memory 
   ' ~~~~~~~~~~ 
   TITLE$=TITLE$+Chr$(0)
   '
   ' Setting TAG
   ' ~~~~~~~~~~~
   LTAG=_tag List Alloc(7)
   _tag Set LTAG,$80080002,WND
   _tag Set LTAG,$8008002B,True
   _tag Set LTAG,$80080064,Hires+Laced
   _tag Set LTAG,$80080065,656
   _tag Set LTAG,$80080066,532
   _tag Set LTAG,$800800D2,True
   _tag Set LTAG,$80080071,True
   '
   ' Request Screen 
   ' ~~~~~~~~~~~~~~ 
   REQ=_asl Alloc(2,0)
   RES=_asl Do(REQ,LTAG)
   '
   ' Process Copy 
   ' ~~~~~~~~~~~~ 
   S_MODE=0
   If RES<>0
      S_MODE=Leek(REQ)
   Else 
      FT$=""
   End If 
   '
   ' Free Mem 
   ' ~~~~~~~~ 
   _tag List Free LTAG
   _asl Free REQ
   '
   FIN:
End Proc[S_MODE]
'
Procedure _FREETEXTATTRIB[TA]
   '
   ' TA -> Pointer of a TextAttr Structure previously 
   '       allocated by _REQUESTFONT procedure
   If TA<>0
      NAMEFONT=_ta What Name(TA)
      _str Free NAMEFONT
      _vec Free TA
   End If 
End Proc
'


